---
title: "SHOC-humain"
format: html
editor: visual
---

```{r}
#| message: false
#| warning: false
#| include: false
library(readr)
library(tidyverse)
library(tidyr)
library(stringr)
library(dplyr)
library(stringi)
library(purrr)
library(readxl)
library(lme4)
library(MuMIn)
library(corrplot)
library(Hmisc)
library(vcd)
library(performance)
library(beepr)
library(DT)
library(ggplot2)
library(MASS)
library(forcats)
library(ordinal)
library(emmeans)
library(patchwork)
library(tidyverse)
library(FactoMineR)
library(factoextra)
```

```{r}
#| echo: false
load("SHOC-humain.RData")
# size
# sort(sapply(ls(), function(x) object.size(get(x))), decreasing = TRUE)
# alphabet
# obj_sizes <- sapply(ls(), function(x) object.size(get(x)))
# sorted_names <- names(sort(obj_sizes))  # Tri par nom (ordre alphab√©tique)
# obj_sizes[sorted_names]
# rm(m_full_2.1,m_full_2,m_full_4,m_full_3,m_full_2.2,m_full_1)
# rm(list = ls(pattern = "^niv1_fixed_"))
# save.image(file = "SHOC-humain.RData")
```

# DATA

## quiz

```{r}
#| message: false
#| warning: false
#| include: false

# quiz__________________________________________________________________________
quiz <- read_csv("Data/Quiz SHOC.csv")

quiz_2 <- quiz %>% 
  rename(datetime = "Horodateur", 
         email = "Nom d'utilisateur", 
         departement = "Merci de renseigner votre code de d√©partement", 
         participation_stoc = "Participez-vous √† : [STOC]", 
         participation_shoc = "Participez-vous √† : [SHOC]", 
         participation_epoc = "Participez-vous √† : [EPOC]", 
         participation_odj = "Participez-vous √† : [Oiseaux des Jardins]", 
         anciennete = "Si vous participez √† l'un de ces programmes, pr√©cisez le nombre d'ann√©es de participation. \n(Si vous participez √† plusieurs programmes, renseignez celui dans lequel vous √™tes actif depuis le plus longtemps.)")
  
participant <- quiz_2 %>% 
  dplyr::select(datetime, email, departement, participation_stoc, participation_shoc,
                participation_epoc, participation_odj, anciennete)

avis_large <- quiz_2 %>% 
  rename(`Accenteur mouchet` = "Quelle est la tendance hivernale de l'Accenteur mouchet depuis 2014 ?",
         `Accenteur mouchet fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....10", 
         `Alouette des champs` = "Quelle est la tendance hivernale de l'Alouette des champs ?",
         `Alouette des champs fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....12",
         `Bruant zizi` = "Quelle est la tendance hivernale du Bruant zizi ?", 
         `Bruant zizi fac` =  "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....14", 
         `Chardonneret √©l√©gant` = "Quelle est la tendance hivernale du Chardonneret √©l√©gant ?",
         `Chardonneret √©l√©gant fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....16",
         `Choucas des tours` = "Quelle est la tendance hivernale du Choucas des tours ?",
         `Choucas des tours fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....18", 
         `Etourneau sansonnet` = "Quelle est la tendance hivernale de l'Etourneau sansonnet ?",
         `Etourneau sansonnet fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....20",
         `Geai des ch√™nes` = "Quelle est la tendance hivernale du Geai des ch√™nes ?",
         `Geai des ch√™nes fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....22", 
         `Grimpereau des jardins` = "Quelle est la tendance hivernale du Grimpereau des jardins ?",
         `Grimpereau des jardins fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....24",
         `Grive draine` = "Quelle est la tendance hivernale de la Grive draine ?",
         `Grive draine fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....26",       
         `Grive litorne` = "Quelle est la tendance hivernale de la Grive litorne ?",
         `Grive litorne fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....28", 
         `Grive mauvis` = "Quelle est la tendance hivernale de la Grive mauvis ?",
         `Grive mauvis fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....30",
         `Grosbec cassenoyaux` = "Quelle est la tendance hivernale du Grosbec cassenoyaux ?",
         `Grosbec cassenoyaux fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....32",
         `Merle noir` = "Quelle est la tendance hivernale du Merle noir ?", 
         `Merle noir fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....34",
         `M√©sange bleue` = "Quelle est la tendance hivernale de la M√©sange bleue ?",
         `M√©sange bleue fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....36",                                                                        `M√©sange nonnette` = "Quelle est la tendance hivernale de la M√©sange nonnette ?",
         `M√©sange nonnette fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....38",
         `M√©sange noire` = "Quelle est la tendance hivernale de la M√©sange noire ?",
         `M√©sange noire fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....40",
         `Pic vert` = "Quelle est la tendance hivernale du Pic vert ?",
         `Pic vert fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....42",
         `Pie bavarde` = "Quelle est la tendance hivernale de la Pie bavarde ?",
         `Pie bavarde fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....44",
         `Pigeon ramier` = "Quelle est la tendance hivernale du Pigeon ramier?",
         `Pigeon ramier fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....46",
         `Pinson des arbres` = "Quelle est la tendance hivernale du Pinson des arbres ?",
         `Pinson des arbres fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....48",
         `Pipit farlouse` = "Quelle est la tendance hivernale du Pipit farlouse ?",
         `Pipit farlouse fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....50",
         `Pouillot v√©loce` = "Quelle est la tendance hivernale du Pouillot v√©loce ?",
         `Pouillot v√©loce fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....52",
         `Roitelet √† triple bandeau` = "Quelle est la tendance hivernale du Roitelet √† triple bandeau ?",
         `Roitelet √† triple bandeau fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....54",
         `Roitelet hupp√©` = "Quelle est la tendance hivernale du Roitelet hupp√© ?",
         `Roitelet hupp√© fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....56",
         `Rougegorge familier` = "Quelle est la tendance hivernale du Rougegorge familier ?",
         `Rougegorge familier fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....58",
         `Tarin des aulnes` = "Quelle est la tendance hivernale du Tarin des aulnes ?",
         `Tarin des aulnes fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....60",
         `Tourterelle turque` = "Quelle est la tendance hivernale de la Tourterelle turque ?",
         `Tourterelle turque fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....62",
         `Troglodyte mignon` = "Quelle est la tendance hivernale du Troglodyte mignon ?",
         `Troglodyte mignon fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....64",
         `Verdier d'Europe` = "Quelle est la tendance hivernale du Verdier d'Europe ?",
         `Verdier d'Europe fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....66",
         `Bouscarle de Cetti` = "Quelle est la tendance hivernale de la Bourscarle de Cetti ?",
         `Bouscarle de Cetti fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....68") %>% 
         dplyr::select(-datetime, -departement, -participation_stoc, -participation_shoc,
                       -participation_epoc, -participation_odj, -anciennete) 

avis <- avis_large %>%
  pivot_longer(
    cols = -email,
    names_to = "variable",
    values_to = "avis"
  ) %>%
  mutate(
    # d√©terminer si c'√©tait une colonne niveau 2 (avec "fac")
    niv2 = str_detect(variable, "fac$"),

    # nom de l'esp√®ce sans " fac"
    espece = str_remove(variable, " fac$")
  ) %>%
  # passer en format large : avis_niv1 / avis_niv2
  mutate(
    avis_niv1 = if_else(!niv2, avis, NA_character_),
    avis_niv2 = if_else(niv2, avis, NA_character_)
  ) %>%
  dplyr::select(email, espece, avis_niv1, avis_niv2) %>%
  distinct() %>%
  group_by(email, espece) %>%
  # fusionner les doublons niveau1/niveau2
  summarise(
    avis_niv1 = first(na.omit(avis_niv1)),
    avis_niv2 = first(na.omit(avis_niv2)),
    .groups = "drop"
  ) %>%
  arrange(email, espece)

# rm(quiz, quiz_2, longTermTrends, avis_large)

head(avis)
```

## participant.es

**Sexe** 

Femme, homme, NA, en fonction des pr√©noms d√©tect√©s dans les emails.

```{r}
#| include: false
prenoms_h <- c(
  "adrien","alain","alban","albert","alessandro","alex","alexandre","alexis",
  "alfred","allan","alphonse","amaury","ambroise","andr√©","anthony","antoine",
  "antonin","arnaud","arthur","auguste","augustin","axel","baptiste","benjamin",
  "bernard","bertrand","bruno","c√©dric","cesar","charles","christian","christophe",
  "claude","cl√©ment","colin","damien","dan","daniel","dany","david","denis",
  "didier","dimitri","dorian","edgar","edmond","edouard","eliot","elliot","emile",
  "emmanuel","enzo","etienne","fabien","fabio","fabrice","felix","fernand",
  "flavien","florian","francis","franck","francois","gabriel","gael","gaetan",
  "gaspard","gaston","gautier","georges","gerald","g√©rard","ghislain","gilbert",
  "gilles","gregoire","guillaume","gustave","guy","henri","herman","herv√©","hugo",
  "hugues","ismail","jacques","jean","j√©r√©mie","jeremy","j√©r√¥me","joachim","joel",
  "jonathan","jordan","joseph","jules","julien","karl","kevin","laurent","l√©o",
  "leon","lilian","louis","loic","luca","lucas","ludovic","malik","malik","marc",
  "marcel","marius","martial","martin","mathieu","matheo","mathias","mathis",
  "matthias","matthieu","max","maxence","maxime","mehdi","michel","mickael",
  "milan","mohamed","nathan","nicolas","noe","noah","norbert","olivier","oscar",
  "pablo","paul","pierre","quentin","rafael","raphael","raymond","remi","r√©mi",
  "ren√©","richard","robert","robin","roger","romain","rom√©o","samuel","sebastien",
  "serge","simon","stephane","sylvain","tanguy","teo","th√©odore","thibault",
  "thomas","tim","timothe","tom","tony","tristan","valentin","victor","vincent",
  "yann","yannis","yohan","yves","zac","zacharie","pascal","manuel","thierry","willy",
  "eloi","andre","jerome","patrick","gerard","bastout","philippe","eric","rodolphe",
  "herve","yoann","theophile","joris","benoit","ancelin","Thibaud","jacob","regis","nico",
  "mark","jeff","henry","yoan","leo","corentin","vivian","clement","stanislas","remy","ugo",
  "gilmon","teddy"
)

prenoms_f <- c(
  "adele","adeline","ad√®le","agathe","agn√®s","aicha","aline","alice","alicia",
  "alison","amandine","amelie","ana√Øs","anais","anastasia","andr√©e","anita",
  "anna","anne","annette","annie","anth√©a","antoinette","apolline","ariane",
  "arielle","armelle","astrid","audrey","augustine","aur√©lie","aurore",
  "babette","barbara","b√©atrice","blandine","brigitte","camille","capucine",
  "carine","caroline","cassandra","catherine","cecile","c√©cile","celeste",
  "celia","c√©line","chlo√©","chloe","christelle","christiane","christine",
  "clara","clarisse","claudine","colette","coline","constance","coralie",
  "corinne","danielle","daphne","daphn√©","delphine","denise","diane","djemila",
  "dominique","doroth√©e","edith","elaine","elea","elena","eliane","elisa",
  "elise","√©lise","elodie","elvira","emilie","emma","emmanuelle","estelle",
  "eugenie","eva","fabienne","fantine","felicie","fernande","flavie","flore",
  "florence","france","francesca","francoise","gabrielle","garance",
  "genevi√®ve","georgette","geraldine","gis√®le","gloria","hanna","h√©l√®ne",
  "helena","henriette","huguette","imy","ines","ingrid","irma","isabelle",
  "jade","janine","jeanne","jennifer","jessica","joelle","josephine",
  "josiane","judith","julie","julienne","julia","juliette","justine","karine",
  "laetitia","laetitia","laetitia","laura","laure","laurence","lea","l√©a",
  "leila","lena","lene","line","lisa","lisette","lorraine","lou","louise",
  "lucette","lucie","lucile","lucille","lydia","maelle","maelle","magali",
  "maeva","manon","margaux","margot","marguerite","maria","mariama","marie",
  "marina","marine","marion","marjorie","marl√®ne","marthe","martine","maryse",
  "mathilde","m√©lanie","melinda","meline","melissa","melodie","mercedes",
  "micheline","michelle","mireille","miriam","morgane","nad√®ge","nadine",
  "naomi","nathalie","nicole","no√©mie","noemie","oc√©ane","odette","odile",
  "olivia","ophelie","oph√©lie","paola","patricia","paulette","pauline",
  "peggy","perrine","pierretta","priscilla","rachel","raphaelle","raymonde",
  "rebeca","rene","ren√©e","romy","rosa","rosalie","rose","roxane","sabine",
  "sabrina","salom√©","salome","samira","sandrine","sarah","scarlett",
  "s√©verine","sidonie","simone","sonia","sophie","stephanie","suzanne",
  "sylvie","tania","tatiana","th√©r√®se","therese","valentina","valentine",
  "val√©rie","vanessa","v√©ronique","victoria","virginie","viviane","yasmina",
  "yvette","yvonne","zoe","zo√©","iris","julienne","jullienne","jocelyne",
  "claire","cathy","aurelie","maude","gervaise","armel","chantal","myriam",
  "monica","reine","lili","cecilia","marysia","lydie","valerie"
)

detect_prenom <- function(email, prenoms_h, prenoms_f) {
  deb <- tolower(str_extract(email, "^[^@]+"))  # partie avant @
  
  # concat√©ner tous les pr√©noms dans un seul vecteur
  all_names <- c(prenoms_h, prenoms_f)
  
  # chercher tous les pr√©noms pr√©sents quelque part dans l'adresse
  matches <- all_names[str_detect(deb, all_names)]
  
  if (length(matches) == 0) return(NA_character_)
  
  # s'il y a plusieurs pr√©noms trouv√©s ‚Üí on garde le plus long (meilleure pr√©cision)
  prenom <- matches[which.max(nchar(matches))]
  return(prenom)
}

participant <- participant %>%
  rowwise() %>%
  mutate(
    prenom = detect_prenom(email, prenoms_h, prenoms_f),
    sexe = case_when(
      !is.na(prenom) & prenom %in% prenoms_h ~ "H",
      !is.na(prenom) & prenom %in% prenoms_f ~ "F",
      TRUE ~ NA_character_
    )
  ) %>%
  ungroup()

# a changer manuellement :

participant$sexe[participant$email %in% c("aurelie.laurent.971@gmail.com","degomouss@gmail.com",
                                          "briemuller@gmail.com","birgit.tollner@gmail.com","angele.bally@lpo.fr",
                                          "l.gourdel@free.fr","jplrousselet@orange.fr","isagiraud75@gmail.com",
                                          "chrisdieulafait@orange.fr","perdub@aol.com","ccressent@gmail.com",
                                          "benchomel@netcourrier.com","duvernay_fr@yahoo.fr","vers.un.voiseau@orange.fr",
                                          "mcrossard@yahoo.fr","vd.dousset@wanadoo.fr")] <- "F"

participant$sexe[participant$email %in% c("duchenne.f@gmail.com","jluc.a1@orange.fr","equilibre.var@gmail.com",
                                          "ybrouillard@orange.fr","cjm.chartendrault@gmail.com","delemonte.th@orange.fr",
                                          "orever@free.fr","mudirme@sfr.fr","gil.jacotot@gmail.com",
                                          "dufour.famili@orange.fr","fyvert@gmail.com","dphil2001@aol.com",
                                          "vmallet2@wanadoo.fr","vmallet3@yahoo.fr","jluc28800@yahoo.fr",
                                          "privallin@orange.fr","m.berges@natureo.org","bdinatale69@gmail.com",
                                          "Thibauddaumal@gmail.com","carle.coste@wanadoo.fr","y.detonquedec@free.fr",
                                          "manceaulionel@gmail.com","vincelecalvez@yahoo.fr","paris.oliv@wanadoo.fr",
                                          "jf.cherel@free.fr","julliard@mnhn.fr","nvissyrias@gmail.com",
                                          "siblet@mnhn.fr","delzons@mnhn.fr","fournier@mnhn.fr",
                                          "sachfldy@hotmail.com","dmuret@yahoo.fr","l.rouschmeyer@acer-campestre.fr",
                                          "fred.pelsy@gmail.com","jsouriou@gmail.com","dom.hemery@wanadoo.fr",
                                          "jp.gans@sfr.fr","dbizet@cogard.org","valsp@yahoo.fr",
                                          "auseth.gascon@yahoo.fr","gamineau@gmail.com","ghisr@otmail.fr",
                                          "xh12@outlook.fr","matprioul@wanadoo.fr","osoldi84@gmail.com",
                                          "blafargue46@gmail.com","ezzo33@gmail.com","urbi.pat@free.fr","fournip1@hotmail.com",
                                          "grimaudjpf@aol.com","dm.huyghe@gmail.com","fasuperla@riseup.net",
                                          "f.toulotte@gmail.com","tipoire@hotmail.com","f-grunert@netc.fr",
                                          "s_gardien@yahoo.fr","jc.dudicourt@gmail.com","botellas9135@sfr.fr",
                                          "gaaubry@wanadoo.fr","ldelpit@laposte.ner","d.svinarenko@trans-faire.net")] <- "H"

table(participant$sexe, useNA = "always")

participant$email[is.na(participant$sexe)==T]

rm(prenoms_h, prenoms_f)
```

```{r}
#| echo: false
print("sexe")
table(dataset$sexe, useNA = "always")
```

**Cocheurs**

Correspondance des emails entre les r√©pondant.es au quiz et les 1741 cocheurs sur cocheurs.fr

```{r}
#| echo: false
#| message: false
#| warning: false
cocheurs <- read_excel("Data/cocheurs.xlsx")
cocheurs <- cocheurs %>% 
  dplyr::select(Membres, France)

# --- Preparation des cocheurs ---
cocheurs2 <- cocheurs %>%
  mutate(
    clean = stri_trans_general(Membres, "Latin-ASCII") %>% tolower() %>% str_squish(),
    prenom = str_extract(clean, "^[a-z]+"),
    nom    = str_extract(clean, "[a-z]+$"),
    init   = substr(prenom, 1, 1)
  )

find_match <- function(email_start, ref) {
  
  if (is.na(email_start))
    return(list(member = NA, rule = NA))
  
  # tokens propres
  tokens <- str_split(email_start, "[._\\-+@]")[[1]] %>%
    str_remove_all("[0-9]") %>%
    str_remove_all("[^a-z]") %>%
    discard(~ .x == "" | is.na(.x) | nchar(.x) < 2)
  
  if (length(tokens) == 0)
    return(list(member = NA, rule = NA))
  
  # --- 1) MATCHS SUR NOM avec obligation d'avoir prenom ou initiale ---
  for (i in seq_len(nrow(ref))) {
    
    pr  <- ref$prenom[i]
    nm  <- ref$nom[i]
    ini <- ref$init[i]
    
    if (is.na(nm) || nm == "") next
    
    # A. nom et prenom/initiale presents comme tokens distincts
    if (any(tokens == nm) && (any(tokens == pr) || any(tokens == ini)))
      return(list(member = ref$Membres[i], rule = "nom_token + prenom_token"))
    
    # B. initiale + nom (ex jdupont)
    if (!is.na(ini) && ini != "" &&
        any(tokens == paste0(ini, nm)))
      return(list(member = ref$Membres[i], rule = "init+nom"))
    
    # C. prenom + nom colles (ex jeandupont)
    if (!is.na(pr) && pr != "" &&
        any(tokens == paste0(pr, nm)))
      return(list(member = ref$Membres[i], rule = "prenom_nom_colle"))
    
    # D. nom + prenom colles (ex dupontjean)
    if (!is.na(pr) && pr != "" &&
        any(tokens == paste0(nm, pr)))
      return(list(member = ref$Membres[i], rule = "nom_prenom_colle"))
    
    # E. token commence par nom + se poursuit par initiale ou prenom
    if (nchar(nm) >= 3 &&
        any(startsWith(tokens, nm))) {
      
      suffixes <- str_replace(tokens[startsWith(tokens, nm)], paste0("^", nm), "")
      
      if (any(suffixes == ini) || any(suffixes == pr))
        return(list(member = ref$Membres[i], rule = "nom_start + prenom"))
    }
  }
  
  # --- 2) prenom seul ‚Üí NON ---
  for (i in seq_len(nrow(ref))) {
    pr <- ref$prenom[i]
    if (!is.na(pr) && pr != "" &&
        any(tokens == pr))
      return(list(member = ref$Membres[i], rule = "prenom_only"))
  }
  
  return(list(member = NA, rule = NA))
}

participant <- participant %>%
  mutate(
    email_clean = stri_trans_general(email, "Latin-ASCII") %>% tolower(),
    email_start = str_extract(email_clean, "^[^@]+")
  ) %>%
  rowwise() %>%
  mutate(
    out = list(find_match(email_start, cocheurs2)),
    matched_member = out$member,
    match_rule     = out$rule
  ) %>%
  ungroup() %>%
  mutate(
    cocheur = case_when(
      match_rule %in% c("nom_exact", "init+nom",
                        "prenom_nom_colle_oui", "nom_start", 
                        "nom_token + prenom_token", "prenom_nom_colle") ~ "Oui",
      TRUE ~ "Non"
    )
    ) %>%
  dplyr::select(-out)

participant <- participant %>%
  left_join(
    cocheurs %>% dplyr::select(Membres, France),
    by = c("matched_member" = "Membres")
  ) %>%
  mutate(
    nb_obs_cocheurs = if_else(cocheur == "Oui", France, NA_real_)
  )

participant <- participant %>% 
  dplyr::select(-match_rule, -matched_member, -email_clean, -email_start, -prenom, -France)
```

```{r}
#| echo: false
print("cocheur")
table(dataset$cocheur, useNA = "always")
```

**Anciennet√©**

Anciennet√© d√©clar√© par les r√©pondant.es pour le.s suivis participatifs

```{r}
#| echo: false
#| message: false
#| warning: false
participant <- participant %>% 
  mutate(anciennete_clean = as.numeric(gsub(".*?([0-9]+).*", "\\1", anciennete)))  

participant$anciennete_clean[participant$anciennete_clean=="2028"] <- NA
participant$anciennete_clean[participant$anciennete_clean=="2024"] <- 2025-2024
participant$anciennete_clean[participant$anciennete_clean=="2023"] <- 2025-2023
participant$anciennete_clean[participant$anciennete_clean=="2022"] <- 2025-2022
participant$anciennete_clean[participant$anciennete_clean=="2021"] <- 2025-2021
participant$anciennete_clean[participant$anciennete_clean=="2020"] <- 2025-2020
participant$anciennete_clean[participant$anciennete_clean=="2019"] <- 2025-2019
participant$anciennete_clean[participant$anciennete_clean=="2018"] <- 2025-2018
participant$anciennete_clean[participant$anciennete_clean=="2017"] <- 2025-2017
participant$anciennete_clean[participant$anciennete_clean=="2016"] <- 2025-2016
participant$anciennete_clean[participant$anciennete_clean=="2015"] <- 2025-2015
participant$anciennete_clean[participant$anciennete_clean=="2014"] <- 2025-2014
participant$anciennete_clean[participant$anciennete_clean=="2013"] <- 2025-2013
participant$anciennete_clean[participant$anciennete_clean=="2012"] <- 2025-2012
participant$anciennete_clean[participant$anciennete_clean=="2007"] <- 2025-2007
participant$anciennete_clean[participant$anciennete_clean=="2002"] <- 2025-2002
participant$anciennete_clean[participant$anciennete_clean=="2001"] <- 2025-2001
participant$anciennete_clean[participant$anciennete_clean=="1984"] <- 2025-1984

participant <- participant %>% 
  dplyr::select(-anciennete, -datetime) %>% 
  rename(anciennete = anciennete_clean)

participant$anciennete[is.na(participant$anciennete)] <- 0

hist(participant$anciennete)
```

**Departement**

D√©partement fran√ßais m√©tropolitain + suisse

```{r}
#| echo: false
participant <- participant %>% 
  filter(departement != "Je souhaiterais supprimer mes r√©ponses svp (au questionnaire pr√©c√©dent). J'avais mal compris le principe de ce questionnaire ! Mes r√©ponses n'avaient donc aucune pertinence car je n'ai pas assez de recul. Dommage qu'il n'y ait pas un email de contact.")

participant <- participant %>% 
  mutate(departement = case_when(departement == "04 et 06" ~ "04",
                                 departement == "2" ~ "02",
                                 departement == "maxjouve@hotmail.com" ~ NA,
                                 departement == "Eure-et-Loir (28)" ~ "28",
                                 departement %in% c("Allier") ~ "03",
                                 departement %in% c("Aube") ~ "10",
                                 departement %in% c("Finist√®re") ~ "29",
                                 departement %in% c("Gironde") ~ "33",
                                 departement %in% c("haute-garonne") ~ "31",
                                 departement %in% c("Ille et Vilaine") ~ "35",
                                 departement %in% c("Loir-et-cher") ~ "41",
                                 departement %in% c("Loire") ~ "42",
                                 departement %in% c("pyr√©√©nes orientales") ~ "66",
                                 departement %in% c("suisse") ~ "suisse",
                                 departement %in% c("Suisse GE") ~ "suisse",
                                 TRUE ~ departement),
         departement = strtrim(departement, 2))

table(participant$departement, useNA = "always")

participant <- participant[!is.na(participant$departement),]
```

**R√©gion et bior√©gion**

D√©partements associ√©s √† une r√©gion admin, √† une bior√©gion (INPN)

```{r}
#| echo: false
#| message: false
#| warning: false

code = c(
"01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","2A","2B",
"21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40",
"41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60",
"61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80",
"81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","su")

region = c(
"Auvergne-Rh√¥ne-Alpes","Hauts-de-France","Auvergne-Rh√¥ne-Alpes","Provence-Alpes-C√¥te d‚ÄôAzur","Provence-Alpes-C√¥te d‚ÄôAzur","Provence-Alpes-C√¥te d‚ÄôAzur","Auvergne-Rh√¥ne-Alpes","Grand Est","Occitanie","Grand Est","Occitanie","Occitanie","Provence-Alpes-C√¥te d‚ÄôAzur","Normandie","Auvergne-Rh√¥ne-Alpes","Nouvelle-Aquitaine","Nouvelle-Aquitaine","Centre-Val de Loire","Nouvelle-Aquitaine","Corse","Corse",
"Bourgogne-Franche-Comt√©","Bretagne","Nouvelle-Aquitaine","Nouvelle-Aquitaine","Bourgogne-Franche-Comt√©","Auvergne-Rh√¥ne-Alpes","Normandie","Centre-Val de Loire","Bretagne","Occitanie","Occitanie","Nouvelle-Aquitaine","Occitanie","Bretagne","Centre-Val de Loire","Centre-Val de Loire","Auvergne-Rh√¥ne-Alpes","Bourgogne-Franche-Comt√©","Nouvelle-Aquitaine",
"Centre-Val de Loire","Auvergne-Rh√¥ne-Alpes","Auvergne-Rh√¥ne-Alpes","Pays de la Loire","Centre-Val de Loire","Occitanie","Nouvelle-Aquitaine","Occitanie","Pays de la Loire","Normandie","Grand Est","Normandie","Grand Est","Grand Est","Bretagne","Grand Est","Bourgogne-Franche-Comt√©","Hauts-de-France","Hauts-de-France","Normandie",
"Hauts-de-France","Hauts-de-France","Auvergne-Rh√¥ne-Alpes","Nouvelle-Aquitaine","Occitanie","Occitanie","Grand Est","Grand Est","Auvergne-Rh√¥ne-Alpes","Bourgogne-Franche-Comt√©","Bourgogne-Franche-Comt√©","Pays de la Loire","Auvergne-Rh√¥ne-Alpes","Auvergne-Rh√¥ne-Alpes","√éle-de-France","Normandie","√éle-de-France","√éle-de-France","Nouvelle-Aquitaine","Hauts-de-France",
"Occitanie","Occitanie","Provence-Alpes-C√¥te d‚ÄôAzur","Provence-Alpes-C√¥te d‚ÄôAzur","Pays de la Loire","Nouvelle-Aquitaine","Nouvelle-Aquitaine","Grand Est","Bourgogne-Franche-Comt√©","Bourgogne-Franche-Comt√©","√éle-de-France","√éle-de-France","√éle-de-France","√éle-de-France","√éle-de-France","√éle-de-France","su")

# Codes des bior√©gions (INPN) 
# ALP : alpin
# ATL : atlantique
# MATL : atlantique marin 
# CON : continental 
# MED : m√©diterran√©en
# MMED : m√©diterran√©en marin

bioregion <- c(
  # 01 √† 09
  "CON","CON","CON","ALP","ALP","MMED","MED","CON","CON",
  # 10 √† 19
  "CON","MED","CON","MMED","ATL","CON","MATL","MATL","CON","CON",
  # 2A, 2B
  "MMED","MMED",
  # 21 √† 29
  "CON","MATL","CON","ATL","CON","ALP","ATL","CON","MATL",
  # 30 √† 39
  "MMED","CON","CON","ATL","MMED","ATL","CON","ALP","CON",
  # 40 √† 49
  "MATL","CON","ALP","CON","CON","ATL","ATL","MED","ATL","MATL",
  # 50 √† 59
  "MATL","CON","MATL","CON","CON","MATL","CON","CON","CON","CON",
  # 60 √† 69
  "CON","MATL","CON","MATL","CON","MED","CON","CON","CON","CON",
  # 70 √† 79
  "CON","CON","ALP","ALP","CON","MATL","CON","CON","MATL","CON",
  # 80 √† 89
  "MATL","CON","MMED","MMED","MATL","ATL","CON","CON","CON","CON",
  # 90 √† 95
  "CON","CON","CON","CON","CON","CON","CON","ALP"
)

departement_info <- data.frame(
  departement = code,
  region = region,
  bioregion = bioregion)

participant <- participant %>% 
  left_join(departement_info)

participant$bioregion[participant$departement=="su"] <- "ALP"

departement_info %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

**Bagueurs** 

Correspondances des emails entre les participant.es et les 32 premiers bagueurs (CRBPO)

```{r}
#| echo: false
#| message: false
#| warning: false
bagueurs <- read_excel("Data/bagueurs.xlsx", col_names = FALSE)

bagueurs <- bagueurs %>% 
  rename(email = "...1") %>% 
  mutate(bagueur = 1)

participant <- participant %>% 
  left_join(bagueurs)

participant$bagueur[participant$bagueur == 1] <- "Oui"
participant$bagueur[is.na(participant$bagueur)] <- "Non"

head(participant$email[participant$bagueur == "Oui"])
```

**Expert sciences participatives**

Si participation_stoc == "Oui", participation_shoc == "Oui", participation_epoc == "Oui", bagueur == "Oui" ou nb_obs_cocheurs \>= 300, alors la¬∑e participant¬∑e est consid√©r√©¬∑e comme expert¬∑e.

```{r}
#| echo: false
participant <- participant %>% 
  mutate(expert = case_when(participation_stoc == "Oui" | 
                              participation_shoc == "Oui" | 
                              participation_epoc == "Oui" | 
                              bagueur == "Oui" |
                              nb_obs_cocheurs >= 300 ~ "Oui",
                        TRUE ~ "Non"))

head(participant$email[participant$expert == "Oui"])
```

**Species**

Nom vernatuclaire et code esp√®ce

```{r}
#| echo: false
#| message: false
#| warning: false
species <- read_csv("Data/species.csv", locale = locale(encoding = "ISO-8859-1"))

species$french_name[species$french_name=="Grosbec casse-noyaux"] <- "Grosbec cassenoyaux"

species_2 <- species %>% 
  dplyr::select(pk_species, french_name) %>% 
  rename(espece = french_name,
         code_espece = pk_species)

species_2 %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

**Shoc**

Tendances SHOC

```{r}
#| echo: false
#| message: false
#| warning: false
longTermTrends <- read_csv("Data/longTermTrends.csv")

tendances <- longTermTrends %>% 
  dplyr::select(species, trend) %>% 
  rename(code_espece = species,
         tendance_shoc = trend)

tendances <- tendances %>% 
  left_join(species_2)

tendances %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

table(tendances$tendance_shoc)
```

**Stoc**

Tendances SHOC et STOC

```{r}
#| echo: false
#| message: false
#| warning: false
tendances_stoc <- readr::read_csv("Data/STOC/shortTermTrends.csv", locale = locale(encoding = "UTF-8"))

tendances_stoc <- tendances_stoc %>% 
  dplyr::select(french_name, trend, perc) %>% 
  rename(espece = french_name, tendances_stoc = trend) %>% 
  mutate(tendances_stoc_simplifie = case_when(tendances_stoc %in% c("Augmentation forte","Augmentation mod√©r√©e",
                                                                    "Augmentation mod√©r√©e √† forte") ~ "Augmentation",
                                              tendances_stoc %in% c("D√©clin fort","D√©clin mod√©r√©",
                                                                    "D√©clin mod√©r√© √† fort") ~ "D√©clin",
                                              TRUE ~ tendances_stoc),
         tendances_stoc_simplifie_2 = case_when(tendances_stoc_simplifie %in% c("Augmentation","D√©clin") ~ "Changement",
                                              TRUE ~ "incertain ou stable"))

pourcentage <- as.numeric(scale(parse_number(tendances_stoc$perc)))

tendances_stoc$pourcentage_stoc <- pourcentage

tendances <- tendances %>% 
  left_join(tendances_stoc) %>% 
  dplyr::select(-perc, -tendances_stoc_simplifie_2)

tendances %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

## traits

```{r}
#| echo: false
#| message: false
#| warning: false
trait_SHOC_HUMAIN <- read_excel("Data/trait_SHOC-HUMAIN.xlsx")

trait_SHOC_HUMAIN$abondance_log <- log(trait_SHOC_HUMAIN$abondance)
fauneFrance_vec <- as.numeric(scale(trait_SHOC_HUMAIN$fauneFrance))
trait_SHOC_HUMAIN$fauneFrance <- fauneFrance_vec

trait_SHOC_HUMAIN %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

## cat√©gories de tendances

```{r}
#| echo: false
#| message: false
#| warning: false

# avis__________________________________________________________________________

print("avis quiz shoc")

table(avis$avis_niv1, useNA = "always")
table(avis$avis_niv2, useNA = "always")

avis$avis_niv1[avis$avis_niv1=="En augmentation"] <- "Augmentation"
avis$avis_niv1[avis$avis_niv1=="En d√©clin"] <- "D√©clin"
avis$avis_niv1[avis$avis_niv1=="Je ne sais pas"] <- "Incertain"
table(avis$avis_niv1, useNA = "always")

avis$avis_niv2[avis$avis_niv2=="Fort"] <- "fort"
avis$avis_niv2[avis$avis_niv2=="Mod√©r√©"] <- "mod√©r√©"
avis$avis_niv2[avis$avis_niv2=="Mod√©r√© √† fort"] <- "mod√©r√© √† fort"
avis$avis_niv2 <- trimws(paste(
  ifelse(is.na(avis$avis_niv1), "", avis$avis_niv1),
  ifelse(is.na(avis$avis_niv2), "", avis$avis_niv2)
))
table(avis$avis_niv2, useNA = "always")

avis$avis_niv2[avis$avis_niv2=="Fluctuante mod√©r√©"] <- "Fluctuante"
avis$avis_niv2[avis$avis_niv2 %in% c("Incertain mod√©r√©","Incertain mod√©r√© √† fort")] <- "Incertain"
avis$avis_niv2[avis$avis_niv2 %in% c("Stable fort","Stable mod√©r√©","Stable mod√©r√© √† fort")] <- "Stable"
table(avis$avis_niv2, useNA = "always")

avis$avis_niv2[avis$avis_niv2=="Augmentation"] <- NA
avis$avis_niv2[avis$avis_niv2=="D√©clin"] <- NA


print("cat√©goies quiz shoc apr√®s transformation en 2 nouveaux")
print("niveau 1")
table(avis$avis_niv1)
print("niveau 2")
table(avis$avis_niv2)

# tendances_____________________________________________________________________

tendances$tendance_shoc[tendances$tendance_shoc=="Augmentation mod√©r√©e"] <- "Augmentation mod√©r√©"
tendances$tendance_shoc[tendances$tendance_shoc=="Augmentation mod√©r√©e √† forte"] <- "Augmentation mod√©r√© √† fort"
tendances$tendance_shoc[tendances$tendance_shoc=="Augmentation forte"] <- "Augmentation fort"

tendances <- tendances %>% 
  mutate(tendance_shoc_niv1 = case_when(tendance_shoc %in% c("Augmentation fort","Augmentation mod√©r√©","Augmentation mod√©r√© √† fort") ~ "Augmentation",
                                         tendance_shoc %in% c("D√©clin fort","D√©clin mod√©r√©","D√©clin mod√©r√© √† fort") ~ "D√©clin",
                                         tendance_shoc %in% c("Incertain", "Fluctuante") ~ "Incertain",
                                         tendance_shoc == "Stable" ~ "Stable"),
         tendance_shoc_niv2 = tendance_shoc)

print("cat√©goies des tendances shoc")
print("niveau 1")
table(tendances$tendance_shoc_niv1)
print("niveau 2")
table(tendances$tendance_shoc_niv2)
```

## dataset

```{r}
#| echo: false
#| message: false
#| warning: false
dataset <- avis %>% 
  left_join(trait_SHOC_HUMAIN) %>% 
  left_join(participant) %>% 
  left_join(tendances) %>% 
  dplyr::select(-code_espece)

# on garde que les esp√®ce en commun entre le quiz et le shoc
dataset <- dataset %>% 
  filter(espece != "Etourneau sansonnet") %>% 
  filter(espece != "Grive mauvis")

dataset <- dataset[!is.na(dataset$departement),]
  
```

## comparaison SHOC vs Humain

Si tendances SHOC et r√©ponses identiques ou diff√©rentes

**Niveau 1 :**

Augmentation = augmentation

D√©clin = d√©clin

Stable = stable

Incertain = je ne sais pas, fluctuante ou incertain

```{r}
#| echo: false
#| message: false
#| warning: false
dataset <- dataset %>%
  mutate(
    comparaison_niv1 = if_else(
      str_trim(avis_niv1) == str_trim(tendance_shoc_niv1), 
      "identique", 
      "different"
    ),
    comparaison_niv2 = if_else(
      str_trim(avis_niv2) == str_trim(tendance_shoc_niv2), 
      "identique", 
      "different"
    )
  )

# dataset <- dataset %>% 
#   dplyr::select(-avis_niv1, -avis_niv2, -participation_odj, -tendance_shoc, -tendance_shoc_niv1, -tendance_shoc_niv2) %>% 
#   na.omit()

# jeu de donn√©es propres √† analyser :
print("Jeu de donn√©es propres √† analyser")
dataset %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

verif_dt <- dataset %>% 
  dplyr::select(avis_niv1, avis_niv2, tendance_shoc, tendance_shoc_niv1, tendance_shoc_niv2, comparaison_niv1, comparaison_niv2)

rm(verif_dt)
```

```{r}
#| echo: false
rm(avis, avis_large, bagueurs, cocheurs, cocheurs2, departement_info, longTermTrends, participant, quiz, quiz_2,
   species, species_2, tendances, tendances_stoc)
```

## exploration donn√©es

```{r}
#| echo: false
summary(dataset)

table(dataset$departement, useNA = "always")
print("participation_stoc")
table(dataset$participation_stoc, useNA = "always")
print("participation_shoc")
table(dataset$participation_shoc, useNA = "always")
print("participation_epoc")
table(dataset$participation_epoc, useNA = "always")
table(dataset$expert, useNA = "always")
print("tendances_stoc")
table(dataset$tendances_stoc, useNA = "always")
print("pourcentage_stoc")
table(dataset$pourcentage_stoc, useNA = "always")
print("tendances_stoc_simplifie")
table(dataset$tendances_stoc_simplifie, useNA = "always")
print("tendances_stoc_simplifie_2")
table(dataset$tendances_stoc_simplifie_2, useNA = "always")
print("detectabilite")
table(dataset$detectabilite, useNA = "always")
print("gregaire")
table(dataset$gregaire, useNA = "always")
print("fluctuante")
table(dataset$fluctuante, useNA = "always")
print("migrateur")
table(dataset$migrateur, useNA = "always")
print("migrateur simplifi√©")
table(dataset$migrateur_simplifie, useNA = "always")
print("abondance")
table(dataset$abondance, useNA = "always")
hist(dataset$abondance)
print("abondance log")
table(dataset$abondance_log, useNA = "always")
hist(dataset$abondance_log)
print("fauneFrance")
table(dataset$fauneFrance, useNA = "always")
print("regime")
table(dataset$regime, useNA = "always")
print("popularite")
table(dataset$popularite, useNA = "always")
print("comparaison_niv1")
table(dataset$comparaison_niv1, useNA = "always")
print("comparaison_niv2")
table(dataset$comparaison_niv2, useNA = "always")

# variable type
dataset$comparaison_niv1 <- as.factor(dataset$comparaison_niv1)
dataset$comparaison_niv2 <- as.factor(dataset$comparaison_niv2)
```

# FREQUENCES

**Shoc vs hasard**

```{r}
#| echo: false

obs_shoc <- table(dataset$tendance_shoc_niv1)

chisq.test(obs_shoc)

res_shoc <- chisq.test(obs_shoc)

data.frame(
  Tendance = names(obs_shoc),
  Observ√© = as.numeric(obs_shoc),
  Attendu = res_shoc$expected,
  R√©sidu_std = res_shoc$stdres
)
```

p-value \< 0.05 ‚Üí la distribution est significativement diff√©rente du hasard

**Niv 1 vs hasard**

```{r}
#| echo: false

obs_avis_niv1 <- table(dataset$avis_niv1)

chisq.test(obs_avis_niv1)

res_avis_niv1 <- chisq.test(obs_avis_niv1)

data.frame(
  Tendance = names(obs_avis_niv1),
  Observ√© = as.numeric(obs_avis_niv1),
  Attendu = res_avis_niv1$expected,
  R√©sidu_std = res_avis_niv1$stdres
)
```

p-value \< 0.05 ‚Üí la distribution est significativement diff√©rente du hasard

**Shoc vs niv 1**

```{r}
#| echo: false
categories_communes <- intersect(names(obs_shoc), names(obs_avis_niv1))

obs_shoc_c <- obs_shoc[categories_communes]
obs_avis_c <- obs_avis_niv1[categories_communes]

tab_chi2 <- rbind(
  SHOC = obs_shoc_c,
  AVIS = obs_avis_c
)

tab_chi2

chisq.test(tab_chi2)

res <- chisq.test(tab_chi2)

print("r√©sidus")
res$stdres

print("proportions")
prop.table(tab_chi2, margin = 1)
```

p-value \< 0.05 ‚Üí les distributions diff√®rent significativement entre SHOC et AVIS

**Conclusions :**

üîπ Augmentation

R√©sidus : SHOC +27.6, AVIS ‚àí27.6

Proportions : SHOC 30.0 %, AVIS 16.1 %

üëâ Augmentation est massivement plus fr√©quente dans SHOC que dans AVIS C‚Äôest l‚Äôun des moteurs principaux du œá¬≤.

üîπ D√©clin

R√©sidus : SHOC +0.92, AVIS ‚àí0.92

Proportions : SHOC 26.7 %, AVIS 26.2 %

üëâ Aucune diff√©rence r√©elle D√©clin se comporte de la m√™me mani√®re dans les deux sources.

üîπ Incertain

R√©sidus : SHOC +16.1, AVIS ‚àí16.1

Proportions : SHOC 26.7 %, AVIS 18.6 %

üëâ Incertain est fortement sur-repr√©sent√© dans SHOC Clairement diff√©rent entre les deux distributions.

üîπ Stable

R√©sidus : SHOC ‚àí42.2, AVIS +42.2

Proportions : SHOC 16.7 %, AVIS 39.1 %

üëâ Stable est massivement plus fr√©quent dans AVIS que dans SHOC C‚Äôest le contraste le plus fort du tableau.

En r√©sum√© : 

Les distributions de tendances diff√®rent fortement entre SHOC et AVIS (œá¬≤, p \< 0.001). Les √©carts sont principalement dus √† une sur-repr√©sentation des modalit√©s ¬´ Augmentation ¬ª et ¬´ Incertain ¬ª dans SHOC, tandis que la modalit√© ¬´ Stable ¬ª est largement dominante dans AVIS. La modalit√© ¬´ D√©clin ¬ª ne montre pas de diff√©rence significative entre les deux sources.

SHOC ‚Üí profil plus dynamique / incertain : plus d‚ÄôAugmentation, plus d‚ÄôIncertain, peu de Stable

AVIS ‚Üí profil nettement plus stable, Stable ‚âà 40 %, moins d‚ÄôAugmentation

üëâ Ce n‚Äôest pas un effet d‚Äô√©chantillon, mais un changement structurel de profil.

Interpr√©tations possibles ? 

Chez les participant.es, biais vers le stable, et peu d'aumgmentation. En demandant de r√©pondre pour des tendances, on pense moins facilement √† r√©pondre stable ? Et oin parle beaucoup des d√©clins (m√©dia, crise ecolo...), mais peu des augmentations, donc les gens n'y pensent pas ?

# PROPORTION IDENTIQUE vs DIFFERENT

```{r}
#| echo: false
print("proportion de tendances d'identiques vs diff√©rentes, niveau 1")

print("toutes les tendances")
dt_prop_niv_1 <- as.data.frame(table(dataset$comparaison_niv1, useNA = "always"))
dt_prop_niv_1$prop <- dt_prop_niv_1$Freq / sum(dt_prop_niv_1$Freq)
dt_prop_niv_1

print("declin et augmentation seulement")
dataset_DA <- dataset[dataset$tendance_shoc_niv1 %in% c("D√©clin","Augmentation"),]
dt_prop_niv_1_DA <- as.data.frame(table(dataset_DA$comparaison_niv1, useNA = "always"))
dt_prop_niv_1_DA$prop <- dt_prop_niv_1_DA$Freq / sum(dt_prop_niv_1_DA$Freq)
dt_prop_niv_1_DA
```

# ANALYSES ORDINALES

Analyses faites ici uniquement sur le niveau 1 "d√©clin, stable, augmentation), mais les r√©sultats √©taient qualitativement les m√™mes au niveau 2, m√™me si moins de puissance statistiques.

## donn√©es

```{r}
#| include: false

dt1 <- dataset %>% 
  dplyr::select("email","espece","avis_niv1","migrateur","migrateur_simplifie", "regime","fluctuante",
                "detectabilite","gregaire","popularite",
                "abondance_log","departement","sexe",
                "anciennete","region","bioregion","expert",
                "tendances_stoc", "pourcentage_stoc","fauneFrance",
                "tendance_shoc_niv1") %>% 
  filter(avis_niv1 != "Fluctuante",
         avis_niv1 != "Incertain") %>% 
  filter(tendance_shoc_niv1 != "Fluctuante",
         tendance_shoc_niv1 != "Incertain") %>%
  na.omit()

unique(dt1$avis_niv1)

dt1 <- dt1 %>%
  mutate(
    avis_niv1 = factor(
      avis_niv1,
      levels = c("D√©clin" ,"Stable", "Augmentation"),
      ordered = TRUE
    ),
    tendance_shoc_niv1 = factor(
      tendance_shoc_niv1,
      levels = c("D√©clin" ,"Stable", "Augmentation"),
      ordered = TRUE
    )
  ) %>% 
  na.omit()

dt1 <- dt1 %>%
  mutate(
    popularite    = factor(popularite),
    detectabilite = factor(detectabilite),
    sexe = factor(sexe),
    expert = factor(expert)
  )

dt1 <- dt1 %>% 
  mutate(abondance_log = scale(abondance_log),
         anciennete = scale(anciennete),
         pourcentage_stoc = scale(pourcentage_stoc),
         fauneFrance = scale(pourcentage_stoc))

head(dt1)
```

## al√©atoire

S√©lection de mod√®le pour les effets al√©atoires : email, r√©gion, bior√©gion, departement, email + region, email + bioregion, email + departement

```{r}
#| include: false

m_n1.1 <- clmm(avis_niv1 ~ 1 + 
                    (1 | email), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.2 <- clmm(avis_niv1 ~ 1 + 
                    (1 | region), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.3 <- clmm(avis_niv1 ~ 1 + 
                    (1 | bioregion), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.4 <- clmm(avis_niv1 ~ 1 + 
                    (1 | departement), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.5 <- clmm(avis_niv1 ~ 1 + 
                     (1 | email) + (1 | region), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.6 <- clmm(avis_niv1 ~ 1 + 
                     (1 | email) + (1 | bioregion), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.7 <- clmm(avis_niv1 ~ 1 + 
                     (1 | email) + (1 | departement), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
```

Meilleur mod√®le avec uniquement effets al√©atoires :

```{r}
#| echo: false
AIC_dt_n1_aleatoire <- as.data.frame(AIC(m_n1.1, m_n1.2, m_n1.3, m_n1.4, m_n1.5, m_n1.6, m_n1.7))

AIC_dt_n1_aleatoire <- AIC_dt_n1_aleatoire %>% 
  arrange(AIC) ; AIC_dt_n1_aleatoire

summary(m_n1.1)
```

Effet al√©atoire "email" dans tous les mod√®les par la suite.

## perception ~ stats

Mod√®le estimant la correlation ordinale entre les perceptions et les tendances statistiques.

```{r}
#| include: false
m_n1_base <- clmm(avis_niv1 ~ tendance_shoc_niv1 + (1 | email), data = dt1, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
summary(m_n1_base)
```

## espece

Mod√®le estimant la correlation ordinale entre les perceptions et les tendances statistiques en fonction de chaque esp√®ce.

ATTTENTION : tous les coefficient pour chacunes des esp√®ces ne sont pas estimables (mod√®le √† prendre avec des pincettes)

```{r}
#| eval: false
#| include: false
m_n1_esp <- clmm(avis_niv1 ~ tendance_shoc_niv1*espece + (1 | email), data = dt1, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
summary(m_n1_esp)
```

## variables de type "trait" des esp√®ces 

### abondance 
```{r}
#| echo: false
# abondance *** int ***
m_n1_trait_1 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + abondance_log + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_1, m_n1_base)
m_n1_trait_1int <- clmm(avis_niv1 ~ 1 + tendance_shoc_niv1*abondance_log + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_1, m_n1_trait_1int)
m_n1_trait_1int_no_random <- clm(avis_niv1 ~ 1 + tendance_shoc_niv1*abondance_log, data = dt1, link = "logit", Hess = TRUE)
summary(m_n1_trait_1)
summary(m_n1_trait_1int)
```

### popularit√© 

```{r}
#| echo: false
# popularite *** int ***
m_n1_trait_2 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + popularite + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_2, m_n1_base)
m_n1_trait_2int <- clmm(avis_niv1 ~ tendance_shoc_niv1*popularite + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_2, m_n1_trait_2int) 
m_n1_trait_2int_no_random <- clm(avis_niv1 ~ tendance_shoc_niv1*popularite, data = dt1, link = "logit", Hess = TRUE)
summary(m_n1_trait_2)
summary(m_n1_trait_2int)
```

### d√©tectabilit√©

```{r}
#| echo: false
# detectabilite *** int ***
m_n1_trait_3 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + detectabilite + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_3, m_n1_base)
m_n1_trait_3int <- clmm(avis_niv1 ~ tendance_shoc_niv1*detectabilite + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_3, m_n1_trait_3int) 
m_n1_trait_3int_no_random <- clm(avis_niv1 ~ tendance_shoc_niv1*detectabilite, data = dt1, link = "logit", Hess = TRUE)
summary(m_n1_trait_3)
summary(m_n1_trait_3int)
```

### r√©gime

```{r}
#| echo: false
# regime *** int ***
m_n1_trait_4 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + regime + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_4, m_n1_base)
m_n1_trait_4int <- clmm(avis_niv1 ~ tendance_shoc_niv1*regime + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_4, m_n1_trait_4int)
m_n1_trait_4int_no_random <- clm(avis_niv1 ~ tendance_shoc_niv1*regime, data = dt1, link = "logit", Hess = TRUE)
summary(m_n1_trait_4)
summary(m_n1_trait_4int)
```

### migrateur

```{r}
#| echo: false
# migrateur *** int ***
m_n1_trait_5 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + migrateur + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_5, m_n1_base)
m_n1_trait_5int <- clmm(avis_niv1 ~ tendance_shoc_niv1*migrateur + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_5, m_n1_trait_5int) 
m_n1_trait_5int_no_random <- clm(avis_niv1 ~ tendance_shoc_niv1*migrateur, data = dt1, link = "logit", Hess = TRUE)
summary(m_n1_trait_5)
summary(m_n1_trait_5int)
```

### gregaire 

```{r}
#| echo: false
# gregaire *** int ***
m_n1_trait_6 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + gregaire + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_6, m_n1_base)
m_n1_trait_6int <- clmm(avis_niv1 ~ tendance_shoc_niv1*gregaire + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_6, m_n1_trait_6int) 
m_n1_trait_6int_no_random <- clm(avis_niv1 ~ tendance_shoc_niv1*gregaire, data = dt1, link = "logit", Hess = TRUE)
summary(m_n1_trait_6)
summary(m_n1_trait_6int)
```

### fauneFrance

```{r}
#| echo: false
# fauneFrance *** int ***
m_n1_trait_7 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + fauneFrance + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_7, m_n1_base)
m_n1_trait_7int <- clmm(avis_niv1 ~ tendance_shoc_niv1*fauneFrance + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_7, m_n1_trait_7int)
m_n1_trait_7int_no_random <- clm(avis_niv1 ~ tendance_shoc_niv1*fauneFrance, data = dt1, link = "logit", Hess = TRUE)
summary(m_n1_trait_7)
summary(m_n1_trait_7int)
```

### pourcentage tendance stoc

```{r}
#| echo: false
# pourcentage_stoc *** int ***
m_n1_trait_8 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + pourcentage_stoc + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_8, m_n1_base)
m_n1_trait_8int <- clmm(avis_niv1 ~ tendance_shoc_niv1*pourcentage_stoc + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_8, m_n1_trait_8int)
m_n1_trait_8int_no_random <- clm(avis_niv1 ~ tendance_shoc_niv1*pourcentage_stoc, data = dt1, link = "logit", Hess = TRUE)
summary(m_n1_trait_8)
summary(m_n1_trait_8int)
```

### comparaison mod√®le par AIC

```{r}
#| echo: false
AIC_dt_trait <- as.data.frame(AIC(m_n1_base, 
                                  m_n1_trait_1, m_n1_trait_2, m_n1_trait_3, 
                                  m_n1_trait_4, m_n1_trait_5, m_n1_trait_6,
                                  m_n1_trait_7,m_n1_trait_8,
                                  m_n1_trait_1int, m_n1_trait_2int, m_n1_trait_3int, 
                                  m_n1_trait_4int, m_n1_trait_5int, m_n1_trait_6int, 
                                  m_n1_trait_7int, m_n1_trait_8int
                             ))

AIC_dt_trait <- AIC_dt_trait %>% 
  arrange(AIC) ; AIC_dt_trait
```

## variables li√©es aux participants

### sexe

```{r}
#| echo: false
# sexe *** int ***
m_n1_participant_1 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + sexe + 
                                (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_1, m_n1_base)
m_n1_participant_1int <- clmm(avis_niv1 ~ tendance_shoc_niv1*sexe + 
                                   (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_1, m_n1_participant_1int) 
m_n1_participant_1int_no_random <- clm(avis_niv1 ~ tendance_shoc_niv1*sexe, data = dt1, link = "logit", Hess = TRUE)
summary(m_n1_participant_1)
summary(m_n1_participant_1int)
```

### anciennete

```{r}
#| echo: false
# anciennete int ***
m_n1_participant_2 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + anciennete + 
                                (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_2, m_n1_base)
m_n1_participant_2int <- clmm(avis_niv1 ~ tendance_shoc_niv1*anciennete + 
                                   (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_2, m_n1_participant_2int) 
m_n1_participant_2int_no_random <- clm(avis_niv1 ~ tendance_shoc_niv1*anciennete, data = dt1, link = "logit", Hess = TRUE)
summary(m_n1_participant_2)
summary(m_n1_participant_2int)
```

### expert

```{r}
#| echo: false
# expert int ***
m_n1_participant_3 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + expert + 
                                (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_3, m_n1_base)
m_n1_participant_3int <- clmm(avis_niv1 ~ tendance_shoc_niv1*expert + 
                                   (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_3, m_n1_participant_3int) 
m_n1_participant_3int_no_random <- clm(avis_niv1 ~ tendance_shoc_niv1*expert, data = dt1, link = "logit", Hess = TRUE)
summary(m_n1_participant_3)
summary(m_n1_participant_3int)
```

### comparaison mod√®le par AIC

```{r}
#| echo: false
AIC_dt_n1_participant <- as.data.frame(AIC(m_n1_base, 
                                m_n1_participant_1, m_n1_participant_2, m_n1_participant_3,
                                m_n1_participant_1int, m_n1_participant_2int, m_n1_participant_3int))

AIC_dt_n1_participant <- AIC_dt_n1_participant %>% 
  arrange(AIC) ; AIC_dt_n1_participant
```

## graphiques des r√©sultats 

### coeffients des mod√®les

```{r}
#| echo: false
#| fig-height: 7
#| fig-width: 10

results_model_dt1 <- list(
  abondance_log    = summary(m_n1_trait_1int)$coefficients,
  popularite       = summary(m_n1_trait_2int)$coefficients,
  detectabilite    = summary(m_n1_trait_3int)$coefficients,
  # regime           = m_n1_trait_4int,
  # migrateur        = m_n1_trait_5int,
  # gregaire         = m_n1_trait_6int
  fauneFrance      = summary(m_n1_trait_7int)$coefficients,
  pourcentage_stoc = summary(m_n1_trait_8int)$coefficients,
  sexe             = summary(m_n1_participant_1int)$coefficients,
  anciennete       = summary(m_n1_participant_2int)$coefficients,
  expert           = summary(m_n1_participant_3int)$coefficients
)

# Initialiser une liste vide pour stocker les data frames modifi√©s
results_model_dt2_list <- list()

# Parcourir chaque √©l√©ment de la liste results_model_dt1
for (name in names(results_model_dt1)) {
  # Convertir l'objet en data frame
  df <- as.data.frame(results_model_dt1[[name]])
  # Ajouter une colonne "variable" avec le nom de l'√©l√©ment
  df$variable <- name
  # Ajouter le data frame modifi√© √† la liste
  results_model_dt2_list[[name]] <- df
}

# Combiner tous les data frames en un seul
results_model_dt2 <- do.call(rbind, results_model_dt2_list)

coef_df <- data.frame(
  Term = rownames(results_model_dt2),
  Estimate = results_model_dt2[, "Estimate"],
  Std.Error = results_model_dt2[, "Std. Error"],
  p.value = results_model_dt2[, "Pr(>|z|)"],
  variable = results_model_dt2$variable
)

# Afficher le r√©sultat
head(coef_df)

# Filtrer les "Threshold coefficients" (lignes contenant "|")
coef_df <- coef_df %>%
  filter(!grepl("\\|", Term))

# Ajout d'une colonne pour indiquer si le coefficient est significatif
coef_df$significatif <- ifelse(coef_df$p.value < 0.05, "Oui", "Non")


coef_df$Type <- case_when(
  grepl("^tendance_shoc_niv1\\.[LQ]$", coef_df$Term) ~ "Tendance SHOC",
  grepl("tendance_shoc_niv1\\.Q:", coef_df$Term) ~ "Interaction avec SHOC (quadratique)",
  grepl(":", coef_df$Term) ~ "Interaction avec SHOC (lin√©aire)",
  TRUE ~ "Variable"
)

# Nettoyage des noms de termes (optionnel)
coef_df$Term <- gsub("tendance_shoc_niv1\\.", "tendance_shoc_niv1_", coef_df$Term)
coef_df$Term <- gsub("\\:", "_", coef_df$Term)

# Fonction pour simplifier les noms
simplifier_nom <- function(nom) {
  if (grepl("tendance_shoc_niv1_L$", nom)) {
    return("SHOC (lin√©aire)")
  } else if (grepl("tendance_shoc_niv1_Q$", nom)) {
    return("SHOC (quadratique)")
  } else if (grepl("tendance_shoc_niv1_L_", nom)) {
    suffixe <- strsplit(nom, "tendance_shoc_niv1_L_")[[1]][2]
    return(paste("SHOC (lin√©aire) :", suffixe))
  } else if (grepl("tendance_shoc_niv1_Q_", nom)) {
    suffixe <- strsplit(nom, "tendance_shoc_niv1_Q_")[[1]][2]
    return(paste("SHOC (quadratique) :", suffixe))
  } else {
    # Si aucune r√®gle ne s'applique, retourner le nom original
    return(gsub(".*\\.", "", nom))
  }
}

# Appliquer la fonction √† la colonne Term
coef_df$Term_simplifie <- sapply(coef_df$Term, simplifier_nom)

# Trier les termes par ordre alphab√©tique dans chaque facette
coef_df <- coef_df %>%
  group_by(Type) %>%
  mutate(Term = factor(Term_simplifie, levels = sort(unique(Term_simplifie)))) %>%
  ungroup()

coef_df %>% 
  group_by(Type) %>% 
  mutate(Term_simplifie = fct_reorder(Term_simplifie, Estimate, .fun='median')) %>% 
  ggplot(aes(x = Estimate, y = reorder(Term_simplifie, Estimate))) +
  geom_errorbarh(
    aes(xmin = Estimate - 1.96 * Std.Error,
        xmax = Estimate + 1.96 * Std.Error),
    height = 0,
    color = "black"
  ) +
  geom_point(
    aes(shape = significatif, fill = significatif),
    size = 1,
    color = "black"
  ) +
  scale_shape_manual(
    values = c("Oui" = 21, "Non" = 21)
  ) +
  scale_fill_manual(
    values = c("Oui" = "black", "Non" = "white")
  ) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "grey", size = 1) +
  scale_x_continuous(breaks = seq(-100, 100, by = 1)) + 
  facet_wrap(~ variable, scales = "free_y", ncol = 2) +
  labs(
    x = "Valeur du coefficient",
    y = "Variable",
    title = "Coefficients du mod√®le et intervalles de confiance √† 95%",
    shape = "Significatif",
    fill = "Significatif"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 8),
    legend.position = "bottom"
  )
```

**Interpr√©tation**

**1**. Mod√®le avec abondance_log

Effet principal

L‚Äôabondance (log-transform√©e) a un effet positif significatif sur la r√©ponse ordinale.

üëâ Plus l‚Äôabondance augmente, plus la probabilit√© d‚Äôappartenir √† une cat√©gorie √©lev√©e de la variable r√©ponse augmente.

Effet du SHOC

Le terme lin√©aire du SHOC est positif.

Le terme quadratique du SHOC est n√©gatif.

üëâ Relation non lin√©aire : l‚Äôeffet du SHOC augmente jusqu‚Äô√† un certain niveau puis diminue.

Interaction SHOC √ó abondance

Les interactions sont faibles ou non significatives.

üëâ L‚Äôeffet de l‚Äôabondance est globalement stable quel que soit le niveau du SHOC.

**2**. Mod√®le avec anciennete

Effet principal

L‚Äôanciennet√© a un effet positif significatif.

üëâ Les individus/sites plus anciens sont associ√©s √† des niveaux plus √©lev√©s de la r√©ponse ordinale.

Effet du SHOC

Effet lin√©aire positif et effet quadratique n√©gatif.

üëâ R√©ponse maximale pour des valeurs interm√©diaires du SHOC.

Interaction SHOC √ó anciennet√©

Interaction lin√©aire significative et n√©gative.
üëâ L‚Äôeffet positif de l‚Äôanciennet√© diminue lorsque le SHOC augmente.

**3**. Mod√®le avec detectabilite

Effet principal

Une forte d√©tectabilit√© a un effet positif tr√®s marqu√©.

üëâ Les observations plus d√©tectables sont associ√©es √† des cat√©gories plus √©lev√©es de la r√©ponse.

Effet du SHOC

Effet lin√©aire positif.

Effet quadratique n√©gatif.

üëâ Effet non lin√©aire du SHOC, coh√©rent avec un optimum interm√©diaire.

Interaction SHOC √ó d√©tectabilit√©

Interaction quadratique significative.

üëâ Le r√¥le de la d√©tectabilit√© varie selon le niveau du SHOC, surtout aux valeurs extr√™mes.

**4**. Mod√®le avec expert

Effet principal

Le statut d‚Äôexpert a un effet faible ou non significatif.

üëâ √ätre expert n‚Äôinfluence pas directement la r√©ponse ordinale.

Effet du SHOC

Effet lin√©aire positif, quadratique n√©gatif.

üëâ Relation non lin√©aire robuste.

Interaction SHOC √ó expert

Non significative.

üëâ L‚Äôeffet du SHOC est similaire chez les experts et non-experts.

**5**. Mod√®le avec fauneFrance

Effet principal

FauneFrance a un effet positif significatif.

üëâ Les donn√©es issues de FauneFrance sont associ√©es √† des niveaux plus √©lev√©s de la r√©ponse.

Effet du SHOC

Effet lin√©aire positif, quadratique n√©gatif.

Interaction SHOC √ó FauneFrance

Interaction quadratique n√©gative significative.

üëâ L‚Äôeffet positif de FauneFrance est att√©nu√© lorsque le SHOC est √©lev√©.

**6**. Mod√®le avec popularite

Effet principal

La popularit√© a un effet positif significatif.

üëâ Les esp√®ces/objets plus populaires ont une probabilit√© plus √©lev√©e d‚Äô√™tre dans une cat√©gorie ordinale √©lev√©e.

Effet du SHOC

Effet lin√©aire positif.

Effet quadratique n√©gatif.

Interaction SHOC √ó popularit√©

Interaction quadratique n√©gative.

üëâ L‚Äôeffet de la popularit√© est moins marqu√© aux niveaux √©lev√©s de SHOC.

**7**. Mod√®le avec pourcentage_stoc

Effet principal

Le pourcentage STOC a un effet positif significatif.

üëâ Une plus forte repr√©sentation STOC est associ√©e √† des cat√©gories plus √©lev√©es.

Effet du SHOC

Effet lin√©aire positif, quadratique n√©gatif.

Interaction SHOC √ó pourcentage STOC

Interaction quadratique n√©gative.

üëâ L‚Äôeffet du STOC diminue lorsque le SHOC devient √©lev√©.

**8**. Mod√®le avec sexe

Effet principal

Le sexe (H) a un effet faible ou mod√©r√©, parfois significatif.

üëâ Le sexe peut influencer la r√©ponse, mais l‚Äôeffet reste limit√©.

Effet du SHOC

Effet lin√©aire positif.

Effet quadratique n√©gatif.

Interaction SHOC √ó sexe

Non significative.

üëâ La relation SHOC‚Äìr√©ponse ne d√©pend pas du sexe.

**Conclusion g√©n√©rale (tr√®s important)**

Le SHOC est un d√©terminant majeur, avec un effet non lin√©aire coh√©rent dans tous les mod√®les.

La plupart des variables explicatives ont un effet positif direct sur la r√©ponse ordinale.

Les interactions sont g√©n√©ralement faibles, mais certaines montrent une att√©nuation de l‚Äôeffet des variables lorsque le SHOC est √©lev√©.

Les r√©sultats sont stables, coh√©rents et biologiquement/interpr√©tativement plausibles.

### probabilit√© (non cumulative) d'√™tre dans une cat√©gorie donn√©e

```{r}
#| echo: false

# fonction ----------------------------------------------------------------------

#' Cr√©er des graphiques de pr√©dictions pour mod√®les ordinaux
#'
#' @param models_list Liste nomm√©e des mod√®les (noms = noms des variables)
#' @param x_values_list Liste nomm√©e des valeurs x √† utiliser pour chaque variable
#' @param data Dataframe original utilis√© pour l'ajustement
#' @param n_points Nombre de points pour la s√©quence (par d√©faut 50)
#' @param save_plots Sauvegarder les graphiques individuels (par d√©faut TRUE)
#' @param output_dir R√©pertoire de sortie pour les graphiques (par d√©faut "plots")
#'
#' @return Liste contenant les graphiques individuels et combin√©s
plot_ordinal_predictions <- function(models_list,
                                     x_values_list,
                                     data,
                                     n_points = 50,
                                     save_plots = TRUE,
                                     output_dir = "plots") {
  
  # Cr√©er le r√©pertoire de sortie si n√©cessaire
  if (save_plots && !dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
  }
  
  # Liste pour stocker les graphiques
  plot_list <- list()
  
  # Boucle sur chaque variable/mod√®le
  for (var_name in names(models_list)) {
    
    cat("\nTraitement de:", var_name, "\n")
    
    model <- models_list[[var_name]]
    x_vals <- x_values_list[[var_name]]
    
    # Obtenir le mod√®le sans effets al√©atoires
    model_no_random <- model
    
    # Cr√©er newdata
    newdat <- model.frame(terms(model_no_random), data = data)
    
    # Identifier la variable pr√©dictrice principale (celle qui n'est pas tendance_shoc_niv1)
    all_vars <- names(newdat)
    predictor_var <- setdiff(
      all_vars[!grepl("tendance|avis", all_vars)],
      c()
    )[1]
    
    cat("Variable pr√©dictrice identifi√©e:", predictor_var, "\n")
    cat("Classe dans data:", class(data[[predictor_var]]), "\n")
    
    # V√©rifier si c'est une variable continue ou cat√©gorielle
    is_continuous <- is.numeric(data[[predictor_var]])
    
    if (is_continuous) {
      # Variable continue
      newdat <- expand.grid(
        tendance_shoc_niv1 = levels(newdat$tendance_shoc_niv1),
        x_var = seq(
          min(newdat[[predictor_var]], na.rm = TRUE),
          max(newdat[[predictor_var]], na.rm = TRUE),
          length.out = n_points
        )
      )
      names(newdat)[names(newdat) == "x_var"] <- predictor_var
      newdat[[predictor_var]] <- matrix(newdat[[predictor_var]], ncol = 1)
      
    } else {
      # Variable cat√©gorielle
      cat("Niveaux de la variable:", levels(data[[predictor_var]]), "\n")
      newdat <- expand.grid(
        tendance_shoc_niv1 = levels(newdat$tendance_shoc_niv1),
        x_var = levels(data[[predictor_var]])
      )
      names(newdat)[names(newdat) == "x_var"] <- predictor_var
    }
    
    cat("Dimensions de newdat:", nrow(newdat), "lignes\n")
    
    # Pr√©dictions
    pred <- predict(model_no_random, newdata = newdat, type = "prob")
    pred_df <- cbind(newdat, as.data.frame(pred))
    
    cat("Colonnes de pred_df:", paste(names(pred_df), collapse = ", "), "\n")
    cat("Premi√®res lignes de pred_df:\n")
    print(head(pred_df))
    
    # Transformer en format long
    pred_long <- pred_df %>%
      pivot_longer(
        cols = starts_with("fit."),
        names_to = "categorie",
        values_to = "prob"
      ) %>%
      mutate(
        categorie = gsub("^fit\\.", "", categorie),
        categorie = factor(
          categorie,
          levels = levels(data$avis_niv1),
          ordered = TRUE
        )
      )
    
    cat("Dimensions de pred_long:", nrow(pred_long), "lignes\n")
    cat("R√©sum√© des probabilit√©s:\n")
    print(summary(pred_long$prob))
    
    # Cr√©er le label de l'axe x
    x_label <- switch(
      var_name,
      "abondance_log" = "Abondance (log)",
      "popularite" = "Popularit√©",
      "detectabilite" = "D√©tectabilit√©",
      "fauneFrance" = "Faune de France",
      "pourcentage_stoc" = "Pourcentage STOC",
      "sexe" = "Sexe",
      "anciennete" = "Anciennet√© (ann√©es)",
      "expert" = "Expert",
      var_name
    )
    
    # Cr√©er le graphique
    p <- ggplot(pred_long,
                aes(x = .data[[predictor_var]],
                    y = prob,
                    color = tendance_shoc_niv1)) +
      facet_wrap(~ categorie, nrow = 1) +
      scale_y_continuous(limits = c(0, 1)) +
      labs(
        x = x_label,
        y = "Probabilit√© pr√©dite",
        color = "Tendance SHOC",
        title = paste("Pr√©dictions pour:", x_label)
      ) +
      theme_minimal(base_size = 14) +
      theme(
        strip.background = element_blank(),
        strip.text = element_text(face = "bold"),
        legend.position = "bottom"
      )
    
    # Ajouter geom_line pour continu, geom_point + geom_line pour cat√©goriel
    if (is_continuous) {
      p <- p + geom_line(linewidth = 1)
    } else {
      # Pour les variables cat√©gorielles, utiliser une position num√©rique
      p <- ggplot(pred_long,
                  aes(x = .data[[predictor_var]],
                      y = prob,
                      color = tendance_shoc_niv1,
                      group = tendance_shoc_niv1)) +
        # geom_point(size = 3) +
        geom_line(linewidth = 1) +
        facet_wrap(~ categorie, nrow = 1) +
        scale_y_continuous(limits = c(0, 1)) +
        labs(
          x = x_label,
          y = "Probabilit√© pr√©dite",
          color = "Tendance SHOC",
          title = paste("Pr√©dictions pour:", x_label)
        ) +
        theme_minimal(base_size = 14) +
        theme(
          strip.background = element_blank(),
          strip.text = element_text(face = "bold"),
          legend.position = "bottom"
        )
    }
    
    # Ajouter des points verticaux pour les valeurs sp√©cifiques si fournies
    if (!is.null(x_vals) && is_continuous) {
      p <- p + 
        geom_vline(xintercept = x_vals, 
                   linetype = "dashed", 
                   alpha = 0.5,
                   color = "gray30")
    }
    
    # Stocker le graphique
    plot_list[[var_name]] <- p
    
    # Sauvegarder si demand√©
    if (save_plots) {
      ggsave(
        filename = file.path(output_dir, paste0("pred_", var_name, ".png")),
        plot = p,
        width = 12,
        height = 6,
        dpi = 300
      )
      cat("Graphique sauvegard√©:", file.path(output_dir, paste0("pred_", var_name, ".png")), "\n")
    }
  }
  
  # Cr√©er un graphique combin√©
  combined_plot <- wrap_plots(plot_list, ncol = 1) +
    plot_annotation(
      title = "Pr√©dictions pour tous les mod√®les",
      theme = theme(plot.title = element_text(size = 16, face = "bold"))
    )
  
  if (save_plots) {
    ggsave(
      filename = file.path(output_dir, "pred_combined.png"),
      plot = combined_plot,
      width = 12,
      height = 6 * length(plot_list),
      dpi = 300
    )
    cat("\nGraphique combin√© sauvegard√©:", file.path(output_dir, "pred_combined.png"), "\n")
  }
  
  return(list(
    individual_plots = plot_list,
    combined_plot = combined_plot
  ))
}

# D√©finir les listes de mod√®les et valeurs x
models_list <- list(
  abondance_log    = m_n1_trait_1int_no_random,
  popularite       = m_n1_trait_2int_no_random,
  detectabilite    = m_n1_trait_3int_no_random,
  fauneFrance      = m_n1_trait_7int_no_random,
  pourcentage_stoc = m_n1_trait_8int_no_random,
  sexe             = m_n1_participant_1int_no_random,
  anciennete       = m_n1_participant_2int_no_random,
  expert           = m_n1_participant_3int_no_random
)

# range des variables √† simuler
x_values_list <- list(
  abondance_log    = c(min(dt1$abondance_log), median(dt1$abondance_log), max(dt1$abondance_log)),
  popularite       = NULL,
  detectabilite    = NULL,
  fauneFrance      = c(min(dt1$fauneFrance), median(dt1$fauneFrance), max(dt1$fauneFrance)),
  pourcentage_stoc = c(min(dt1$pourcentage_stoc), median(dt1$pourcentage_stoc), max(dt1$pourcentage_stoc)),
  sexe             = NULL,
  anciennete       = c(min(dt1$anciennete), median(dt1$anciennete), max(dt1$anciennete)),
  expert           = NULL
)

# G√©n√©rer tous les graphiques
results <- plot_ordinal_predictions(
  models_list = models_list,
  x_values_list = x_values_list,
  data = dt1,
  n_points = 50,
  save_plots = TRUE,
  output_dir = "plots_predictions"
)

# Acc√©der aux graphiques individuels
results$individual_plots$abondance_log
results$individual_plots$popularite
results$individual_plots$detectabilite
results$individual_plots$fauneFrance
results$individual_plots$pourcentage_stoc
results$individual_plots$sexe
results$individual_plots$anciennete
results$individual_plots$expert

# Afficher le graphique combin√©
# results$combined_plot
```

**Interpr√©tation**

**1**. Mod√®le Abondance (log)

Ce que montrent les pr√©dictions

Quand l‚Äôabondance augmente :

La probabilit√© de D√©clin diminue

La probabilit√© de Stable augmente l√©g√®rement

La probabilit√© d‚ÄôAugmentation augmente clairement

Effet progressif et monotone, surtout visible pour D√©clin et Augmentation

üëâ Les esp√®ces/sites plus abondants ont une probabilit√© plus √©lev√©e d‚Äô√™tre associ√©s √† une tendance SHOC positive, et moins souvent √† un d√©clin.

**2**. Mod√®le Popularit√©

Ce que montrent les pr√©dictions

Les esp√®ces populaires :

Ont une probabilit√© plus √©lev√©e d‚ÄôAugmentation

Ont une probabilit√© plus faible de D√©clin

Effet mod√©r√© mais net

Peu de changement pour la cat√©gorie Stable

üëâ La popularit√© est associ√©e √† une meilleure d√©tection ou un suivi plus favorable, conduisant √† des tendances SHOC plus positives.

**3**. Mod√®le D√©tectabilit√©

Ce que montrent les pr√©dictions

Une forte d√©tectabilit√© :

R√©duit la probabilit√© de D√©clin

Augmente fortement la probabilit√© d‚ÄôAugmentation

Effet tr√®s marqu√© et coh√©rent

Peu d‚Äôeffet sur Stable

üëâ Les esp√®ces mieux d√©tectables sont plus souvent associ√©es √† des tendances positives, probablement via une meilleure estimation ou un biais de d√©tection.

**4**. Mod√®le Faune France

Ce que montrent les pr√©dictions

Effet fortement non lin√©aire

Pour D√©clin :

Forte probabilit√© √† faibles valeurs

Chute rapide ensuite

Pour Stable :

Pic √† des valeurs interm√©diaires

Pour Augmentation :

Forte augmentation aux valeurs √©lev√©es

üëâ Faune de France agit comme un gradient structurant, avec :

D√©clin dominant √† faibles niveaux

Stabilit√© √† niveaux interm√©diaires

Augmentation √† niveaux √©lev√©s

**5**. Mod√®le Pourcentage STOC

Ce que montrent les pr√©dictions

Structure quasi identique √† Faune de France :

D√©clin dominant √† faible pourcentage

Stable √† valeurs interm√©diaires

Augmentation √† fort pourcentage

Effets tr√®s marqu√©s et lisibles

üëâ Une plus forte int√©gration au STOC est associ√©e √† des tendances SHOC plus favorables, avec une zone de transition interm√©diaire.

**6**. Mod√®le Sexe

Ce que montrent les pr√©dictions

Diff√©rences faibles entre F et H

L√©g√®re augmentation de la probabilit√© d‚ÄôAugmentation chez H

Effets quasi parall√®les

üëâ Le sexe a un effet marginal, sans modifier fortement la distribution des cat√©gories SHOC.

**7**. Mod√®le Anciennet√©

Ce que montrent les pr√©dictions

Quand l‚Äôanciennet√© augmente :

Probabilit√© de D√©clin augmente

Probabilit√© de Stable diminue

Probabilit√© d‚ÄôAugmentation augmente l√©g√®rement

Effet progressif mais r√©el

üëâ L‚Äôanciennet√© modifie la structure des probabilit√©s, avec un d√©placement depuis la stabilit√© vers les cat√©gories extr√™mes.

**8**. Mod√®le Expert

Ce que montrent les pr√©dictions

Diff√©rences tr√®s faibles entre Non et Oui

L√©g√®re hausse d‚ÄôAugmentation chez les experts

Cat√©gorie Stable quasi inchang√©e

üëâ Le statut d‚Äôexpert n‚Äôinfluence que marginalement la tendance SHOC.

**Conclusion g√©n√©rale**

‚úî Les pr√©dictions sont enti√®rement coh√©rentes avec les coefficients

‚úî Les mod√®les √† effets non lin√©aires (FauneFrance, STOC) sont les plus informatifs

‚úî Les variables observationnelles (d√©tectabilit√©, popularit√©) ont des effets clairs

‚úî Les variables individuelles (sexe, expert) jouent un r√¥le secondaire

### probabilit√© cumulative (d'√™tre dans une cat√©gorie sup√©rieure)

```{r}
#| echo: false
#| fig-height: 15
#| fig-width: 10

# fonction ---------------------------------------------------------------------

plot_clmm_predictions_multi_x <- function(
  models,
  x_values,
  subtitle = NULL
) {
  emm_all <- purrr::imap_dfr(
    models,
    function(model, x_var) {
      mf <- model.frame(model)
      if (!x_var %in% names(mf)) {
        stop(sprintf("La variable '%s' n'est pas dans le mod√®le.", x_var))
      }
      x_is_factor <- is.factor(mf[[x_var]])
      x_vals <- x_values[[x_var]]
      emm <- if (x_is_factor) {
        emmeans(
          model,
          as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
          mode = "latent"
        )
      } else {
        emmeans(
          model,
          as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
          at = setNames(list(x_vals), x_var),
          mode = "latent"
        )
      }
      emm_summary <- summary(emm, type = "response")
      emm_summary %>%
        mutate(
          probabilite = plogis(emmean),
          tendance = tendance_shoc_niv1,
          x_level = factor(.data[[x_var]]),
          variable = x_var,
          lower = plogis(asymp.LCL),
          upper = plogis(asymp.UCL),
          # Logique pour la significativit√© (exemple : si l'intervalle de confiance contient 0)
          significatif = !(asymp.LCL < 0 & asymp.UCL > 0)
        )
    }
  )

  # Cr√©er un graphique par variable
  plots <- split(emm_all, emm_all$variable) %>%
    imap(~ {
      # D√©terminer si toutes les interactions pour ce niveau sont non significatives
      all_non_significatif <- all(!.x$significatif)

      p <- ggplot(.x, aes(
        x = tendance,
        y = probabilite,
        color = x_level,
        group = x_level
      )) +
        # Ruban d'erreur
        geom_ribbon(
          aes(ymin = lower, ymax = upper, fill = x_level),
          alpha = 0.2,
          color = NA
        ) +
        # Lignes continues ou pointill√©es (selon la significativit√© globale)
        geom_line(
          aes(linetype = ifelse(all_non_significatif, "dashed", "solid")),
          linewidth = 1.2
        ) +
        scale_linetype_manual(values = c("solid" = "solid", "dashed" = "dashed")) +
        scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
        scale_fill_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "fill") +
        scale_color_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "color") +
        theme_bw() +
        theme(
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
          legend.position = "bottom"
        ) +
        labs(
          x = "Tendance SHOC",
          y = "Probabilit√© pr√©dite",
          color = "",
          fill = "",
          linetype = ifelse(all_non_significatif, "Non significatif", "Significatif"),
          title = .y
        )
      p
    })

  # Combiner les graphiques avec patchwork
  wrap_plots(plots, ncol = 3, nrow = 4) +
    plot_annotation(subtitle = subtitle) &
    theme(legend.position = "top")
}

# plot -------------------------------------------------------------------------

models <- list(
  abondance_log    = m_n1_trait_1int,
  popularite       = m_n1_trait_2int,
  detectabilite    = m_n1_trait_3int,
  # regime           = m_n1_trait_4int,
  # migrateur        = m_n1_trait_5int,
  # gregaire         = m_n1_trait_6int
  fauneFrance      = m_n1_trait_7int,
  pourcentage_stoc = m_n1_trait_8int,
  sexe             = m_n1_participant_1int,
  anciennete       = m_n1_participant_2int,
  expert           = m_n1_participant_3int
)

x_values <- list(
  abondance_log    = c(10, 13, 16),
  popularite       = NULL,
  detectabilite    = NULL,
  # regime           = NULL,
  # migrateur        = NULL,
  # gregaire         = NULL
  fauneFrance      = c(-1, 0, 2.5),
  pourcentage_stoc = c(-1, 0, 1.5),
  sexe = NULL,
  anciennete = c(0, 5, 40),
  expert = NULL
)

plot_clmm_predictions_multi_x(
  models = models,
  x_values = x_values,
  subtitle = "Probabilit√© cumulative d'√™tre dans une des cat√©gories sup√©rieures"
)

```

Interp√©tation difficile de ces graphiques.... prendre les autres...

```{r}
#| echo: false
AIC_dt_all_n1 <- as.data.frame(AIC(m_n1_base,
                                   m_n1_trait_1, m_n1_trait_2, m_n1_trait_3, m_n1_trait_4, m_n1_trait_5, m_n1_trait_6,
                                   m_n1_trait_1int, m_n1_trait_2int, m_n1_trait_3int, m_n1_trait_4int, m_n1_trait_5int, m_n1_trait_6int,
                                   m_n1_trait_all, m_n1_trait_allint, 
                                   m_n1_participant_1, m_n1_participant_2, m_n1_participant_3,
                                   m_n1_participant_1int, m_n1_participant_2int, m_n1_participant_3int,
                                   m_n1_participant_all, m_n1_participant_allint))

AIC_dt_all_n1 <- AIC_dt_all_n1 %>% 
  arrange(AIC) ; AIC_dt_all_n1
```

# ACP

```{r}
#| echo: false
set.seed(42)
# n <- 100  # Nombre d'observations

ACP_dt1 <- dataset %>% 
  filter(avis_niv1 %in% c("D√©clin", "Stable", "Augmentation")) %>% 
  dplyr::select(avis_niv1,abondance_log,fauneFrance,anciennete,pourcentage_stoc,popularite,detectabilite,
                regime,migrateur,gregaire,sexe,expert,bioregion) %>% 
  na.omit()

# 1. Pr√©paration des donn√©es : encodage des variables cat√©gorielles
# On utilise dummy coding pour les variables cat√©gorielles (sauf "avis_niv1")
ACP_dt_dummy <- ACP_dt1 %>%
  mutate(across(c(popularite, detectabilite, regime, migrateur, gregaire, sexe, expert, bioregion), as.factor)) %>%
  fastDummies::dummy_cols(select_columns = c("popularite", "detectabilite", "regime", "migrateur", "gregaire", "sexe",
                                             "expert", "bioregion")) %>%
  dplyr::select(-"abondance_log",-"fauneFrance",-"anciennete",-"pourcentage_stoc",-"popularite",-"detectabilite",-"regime",
                -"migrateur",-"gregaire",-"sexe",-"expert",-"bioregion")

# On s√©pare les variables continues et les variables cat√©gorielles encod√©es
X <- ACP_dt_dummy %>%
  dplyr::select(-avis_niv1)  # On exclut "avis_niv1" pour l'ACP

# 2. ACP avec FactoMineR
# On utilise "avis_niv1" comme variable illustrative
res.pca <- FactoMineR::PCA(X, scale.unit = TRUE, ncp = 5, graph = FALSE)

# 3. Visualisation des r√©sultats

# a) Projection des individus (color√©s par "avis_niv1")
fviz_pca_ind(res.pca,
             col.ind = as.factor(ACP_dt1$avis_niv1),
             addEllipses = TRUE,
             title = "Projection des individus (ACP)")

fviz_pca_ind(res.pca, axes = c(1, 3), col.ind = as.factor(ACP_dt1$avis_niv1), addEllipses = TRUE)
fviz_pca_ind(res.pca, axes = c(2, 3), col.ind = as.factor(ACP_dt1$avis_niv1), addEllipses = TRUE)

# b) Cercle des corr√©la# b) Cercle des corr√©la# b) Cercle des corr√©lations (variables continues uniquement)
fviz_pca_var(res.pca,
             col.var = "black",
             title = "Cercle des corr√©lations (variables continues)")

# c) Variance expliqu√©e
fviz_eig(res.pca,
         addlines = TRUE,
         ylim = c(0, 50),
         title = "Variance expliqu√©e par les composantes principales")

# d) Contribution des variables cat√©gorielles (si besoin)
# Pour voir la contribution des modalit√©s des variables cat√©gorielles, on peut utiliser :
fviz_contrib(res.pca, choice = "var", axes = 1)
fviz_contrib(res.pca, choice = "var", axes = 2)
```

**Conclusion**

Les participants n'associent pas une perception de tendances de populations en fonction des traits des esp√®ces ni en fonction de leur caract√©ristiques personnelles.

La perceptions des participants est relativement ind√©pendantes des variables test√©es.

Cela veut dire que les participants ne sont pas influencer pas le types 

# INTELLIGENCE COLLECTIVE

## variables

avis_niv1 = "D√©clin" \~ -1,"Augmentation" \~ 1, "Stable" \~ 0

round

ou

mean avis \<= -0.2 \~ "D√©clin", mean avis \>= 0.2 \~ "Augmentation", -0.2 \< mean avis \> 0.2 \~ "Stable"

```{r}
#| echo: false
dataset_intel <- dataset %>% 
  filter(avis_niv1 != "Incertain") %>% 
  mutate(avis_niv1_intel = case_when(avis_niv1 == "D√©clin" ~ -1,
                                     avis_niv1 == "Augmentation" ~ 1,
                                     avis_niv1 == "Stable" ~ 0))

dataset_intel <- dataset_intel[!is.na(dataset_intel$avis_niv1_intel),]

table(dataset_intel$avis_niv1_intel, useNA = "always")

mean_intel_dt <- dataset_intel %>% 
  group_by(espece) %>%
  summarise(mean_avis_niv1_intel = mean(avis_niv1_intel),
            sd_avis_niv1_intel = sd(avis_niv1_intel)) %>% 
  # round
  mutate(round_avis_niv1_intel = round(mean_avis_niv1_intel),
         round_avis_niv1_intel_cat = case_when(round_avis_niv1_intel == "-1" ~ "D√©clin",
                                     round_avis_niv1_intel == "1" ~ "Augmentation",
                                     round_avis_niv1_intel == "0" ~ "Stable")) %>%    
  # quartile02
  mutate(quantile02_avis_niv1_intel = round(mean_avis_niv1_intel),
         quantile02_avis_niv1_intel_cat = case_when(mean_avis_niv1_intel <= -0.2 ~ "D√©clin",
                                          mean_avis_niv1_intel >= 0.2 ~ "Augmentation",
                                          between(mean_avis_niv1_intel, -0.2,0.2) ~ "Stable"))
  
```

## Chi¬≤ : shoc vs round

```{r}
#| echo: false
obs_round <- table(mean_intel_dt$round_avis_niv1_intel_cat)

tendance_shoc <- dataset %>% 
  dplyr::select(espece, tendance_shoc_niv1) %>% 
  distinct() 

obs_shoc <- table(tendance_shoc$tendance_shoc_niv1)

categories_communes <- intersect(names(obs_shoc), names(obs_round))

obs_shoc_c <- obs_shoc[categories_communes]
obs_round_c <- obs_round[categories_communes]

tab_chi2_round <- rbind(
  SHOC = obs_shoc_c,
  AVIS = obs_round
)

tab_chi2_round

chisq.test(tab_chi2_round)

res_round <- chisq.test(tab_chi2_round)

print("r√©sidus")
res_round$stdres

print("proportions")
prop.table(tab_chi2_round, margin = 1)
```

## Chi¬≤ : shoc vs quantile 0.2

```{r}
#| echo: false
obs_quantile02 <- table(mean_intel_dt$quantile02_avis_niv1_intel_cat)

tendance_shoc <- dataset %>% 
  dplyr::select(espece, tendance_shoc_niv1) %>% 
  distinct() 

obs_shoc <- table(tendance_shoc$tendance_shoc_niv1)

categories_communes <- intersect(names(obs_shoc), names(obs_quantile02))

obs_shoc_c <- obs_shoc[categories_communes]
obs_quantile02_c <- obs_quantile02[categories_communes]

tab_chi2_quantile02 <- rbind(
  SHOC = obs_shoc_c,
  AVIS = obs_quantile02
)

tab_chi2_quantile02

chisq.test(tab_chi2_quantile02)

res_quantile02 <- chisq.test(tab_chi2_quantile02)

print("r√©sidus")
res_quantile02$stdres

print("proportions")
prop.table(tab_chi2_quantile02, margin = 1)
```

## tendances par espece

```{r}
#| echo: false
mean_intel_dt <- mean_intel_dt %>% 
  left_join(tendance_shoc)

dt_intel_quantile02 <- mean_intel_dt %>% 
  dplyr::select(espece, round_avis_niv1_intel_cat, quantile02_avis_niv1_intel_cat, tendance_shoc_niv1) %>% 
  rename(espece = espece, 
         `tendance moyenne arrondie quiz` = round_avis_niv1_intel_cat, 
         `tendance moyenne quantile (-0.2, 0.2) quiz` = quantile02_avis_niv1_intel_cat, 
         `tendance stat SHOC` = tendance_shoc_niv1)

dt_intel_quantile02 %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

dt_intel_quantile02
```

## variabilit√© des r√©ponses par espece

Pas de correlation entre le tendances moyennes estim√©es collectivement et la variation (√©cart-type) dans les r√©ponses

```{r}
#| echo: false
plot(mean_intel_dt$mean_avis_niv1_intel, mean_intel_dt$sd_avis_niv1_intel)
summary(lm(mean_intel_dt$mean_avis_niv1_intel ~ mean_intel_dt$sd_avis_niv1_intel))
```

```{r}
# save environnement

#| eval: false
#| include: false
save.image(file = "SHOC-humain.RData")
# load("SHOC-humain.RData")
```
