---
title: "SHOC-humain"
format: html
editor: visual
---

```{r}
#| message: false
#| warning: false
#| include: false
library(readr)
library(tidyverse)
library(tidyr)
library(stringr)
library(dplyr)
library(stringi)
library(purrr)
library(readxl)
library(lme4)
library(MuMIn)
library(corrplot)
library(Hmisc)
library(vcd)
library(performance)
library(beepr)
library(DT)
library(ggplot2)
library(MASS)
library(forcats)
library(ordinal)
library(emmeans)
library(patchwork)
library(tidyverse)
library(FactoMineR)
library(factoextra)
```

```{r}
load("SHOC-humain.RData")
# size
# sort(sapply(ls(), function(x) object.size(get(x))), decreasing = TRUE)
# alphabet
# obj_sizes <- sapply(ls(), function(x) object.size(get(x)))
# sorted_names <- names(sort(obj_sizes))  # Tri par nom (ordre alphab√©tique)
# obj_sizes[sorted_names]
# rm(m_full_2.1,m_full_2,m_full_4,m_full_3,m_full_2.2,m_full_1)
# rm(list = ls(pattern = "^niv1_fixed_"))
# save.image(file = "SHOC-humain.RData")
```

# DATA

## quiz

```{r}
#| message: false
#| warning: false
#| include: false

# quiz__________________________________________________________________________
quiz <- read_csv("Data/Quiz SHOC.csv")

quiz_2 <- quiz %>% 
  rename(datetime = "Horodateur", 
         email = "Nom d'utilisateur", 
         departement = "Merci de renseigner votre code de d√©partement", 
         participation_stoc = "Participez-vous √† : [STOC]", 
         participation_shoc = "Participez-vous √† : [SHOC]", 
         participation_epoc = "Participez-vous √† : [EPOC]", 
         participation_odj = "Participez-vous √† : [Oiseaux des Jardins]", 
         anciennete = "Si vous participez √† l'un de ces programmes, pr√©cisez le nombre d'ann√©es de participation. \n(Si vous participez √† plusieurs programmes, renseignez celui dans lequel vous √™tes actif depuis le plus longtemps.)")
  
participant <- quiz_2 %>% 
  dplyr::select(datetime, email, departement, participation_stoc, participation_shoc,
                participation_epoc, participation_odj, anciennete)

avis_large <- quiz_2 %>% 
  rename(`Accenteur mouchet` = "Quelle est la tendance hivernale de l'Accenteur mouchet depuis 2014 ?",
         `Accenteur mouchet fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....10", 
         `Alouette des champs` = "Quelle est la tendance hivernale de l'Alouette des champs ?",
         `Alouette des champs fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....12",
         `Bruant zizi` = "Quelle est la tendance hivernale du Bruant zizi ?", 
         `Bruant zizi fac` =  "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....14", 
         `Chardonneret √©l√©gant` = "Quelle est la tendance hivernale du Chardonneret √©l√©gant ?",
         `Chardonneret √©l√©gant fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....16",
         `Choucas des tours` = "Quelle est la tendance hivernale du Choucas des tours ?",
         `Choucas des tours fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....18", 
         `Etourneau sansonnet` = "Quelle est la tendance hivernale de l'Etourneau sansonnet ?",
         `Etourneau sansonnet fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....20",
         `Geai des ch√™nes` = "Quelle est la tendance hivernale du Geai des ch√™nes ?",
         `Geai des ch√™nes fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....22", 
         `Grimpereau des jardins` = "Quelle est la tendance hivernale du Grimpereau des jardins ?",
         `Grimpereau des jardins fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....24",
         `Grive draine` = "Quelle est la tendance hivernale de la Grive draine ?",
         `Grive draine fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....26",       
         `Grive litorne` = "Quelle est la tendance hivernale de la Grive litorne ?",
         `Grive litorne fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....28", 
         `Grive mauvis` = "Quelle est la tendance hivernale de la Grive mauvis ?",
         `Grive mauvis fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....30",
         `Grosbec cassenoyaux` = "Quelle est la tendance hivernale du Grosbec cassenoyaux ?",
         `Grosbec cassenoyaux fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....32",
         `Merle noir` = "Quelle est la tendance hivernale du Merle noir ?", 
         `Merle noir fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....34",
         `M√©sange bleue` = "Quelle est la tendance hivernale de la M√©sange bleue ?",
         `M√©sange bleue fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....36",                                                                        `M√©sange nonnette` = "Quelle est la tendance hivernale de la M√©sange nonnette ?",
         `M√©sange nonnette fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....38",
         `M√©sange noire` = "Quelle est la tendance hivernale de la M√©sange noire ?",
         `M√©sange noire fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....40",
         `Pic vert` = "Quelle est la tendance hivernale du Pic vert ?",
         `Pic vert fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....42",
         `Pie bavarde` = "Quelle est la tendance hivernale de la Pie bavarde ?",
         `Pie bavarde fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....44",
         `Pigeon ramier` = "Quelle est la tendance hivernale du Pigeon ramier?",
         `Pigeon ramier fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....46",
         `Pinson des arbres` = "Quelle est la tendance hivernale du Pinson des arbres ?",
         `Pinson des arbres fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....48",
         `Pipit farlouse` = "Quelle est la tendance hivernale du Pipit farlouse ?",
         `Pipit farlouse fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....50",
         `Pouillot v√©loce` = "Quelle est la tendance hivernale du Pouillot v√©loce ?",
         `Pouillot v√©loce fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....52",
         `Roitelet √† triple bandeau` = "Quelle est la tendance hivernale du Roitelet √† triple bandeau ?",
         `Roitelet √† triple bandeau fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....54",
         `Roitelet hupp√©` = "Quelle est la tendance hivernale du Roitelet hupp√© ?",
         `Roitelet hupp√© fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....56",
         `Rougegorge familier` = "Quelle est la tendance hivernale du Rougegorge familier ?",
         `Rougegorge familier fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....58",
         `Tarin des aulnes` = "Quelle est la tendance hivernale du Tarin des aulnes ?",
         `Tarin des aulnes fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....60",
         `Tourterelle turque` = "Quelle est la tendance hivernale de la Tourterelle turque ?",
         `Tourterelle turque fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....62",
         `Troglodyte mignon` = "Quelle est la tendance hivernale du Troglodyte mignon ?",
         `Troglodyte mignon fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....64",
         `Verdier d'Europe` = "Quelle est la tendance hivernale du Verdier d'Europe ?",
         `Verdier d'Europe fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....66",
         `Bouscarle de Cetti` = "Quelle est la tendance hivernale de la Bourscarle de Cetti ?",
         `Bouscarle de Cetti fac` = "Facultatif : si vous avez coch√© \"En d√©clin\" ou \"En augmentation\", vous pouvez pr√©ciser votre r√©ponse....68") %>% 
         dplyr::select(-datetime, -departement, -participation_stoc, -participation_shoc,
                       -participation_epoc, -participation_odj, -anciennete) 

avis <- avis_large %>%
  pivot_longer(
    cols = -email,
    names_to = "variable",
    values_to = "avis"
  ) %>%
  mutate(
    # d√©terminer si c'√©tait une colonne niveau 2 (avec "fac")
    niv2 = str_detect(variable, "fac$"),

    # nom de l'esp√®ce sans " fac"
    espece = str_remove(variable, " fac$")
  ) %>%
  # passer en format large : avis_niv1 / avis_niv2
  mutate(
    avis_niv1 = if_else(!niv2, avis, NA_character_),
    avis_niv2 = if_else(niv2, avis, NA_character_)
  ) %>%
  dplyr::select(email, espece, avis_niv1, avis_niv2) %>%
  distinct() %>%
  group_by(email, espece) %>%
  # fusionner les doublons niveau1/niveau2
  summarise(
    avis_niv1 = first(na.omit(avis_niv1)),
    avis_niv2 = first(na.omit(avis_niv2)),
    .groups = "drop"
  ) %>%
  arrange(email, espece)

# rm(quiz, quiz_2, longTermTrends, avis_large)
```

## participant.es

**Sexe** 

Femme, homme, NA, en fonction des pr√©noms d√©tect√©s dans les emails.

```{r}
#| include: false
prenoms_h <- c(
  "adrien","alain","alban","albert","alessandro","alex","alexandre","alexis",
  "alfred","allan","alphonse","amaury","ambroise","andr√©","anthony","antoine",
  "antonin","arnaud","arthur","auguste","augustin","axel","baptiste","benjamin",
  "bernard","bertrand","bruno","c√©dric","cesar","charles","christian","christophe",
  "claude","cl√©ment","colin","damien","dan","daniel","dany","david","denis",
  "didier","dimitri","dorian","edgar","edmond","edouard","eliot","elliot","emile",
  "emmanuel","enzo","etienne","fabien","fabio","fabrice","felix","fernand",
  "flavien","florian","francis","franck","francois","gabriel","gael","gaetan",
  "gaspard","gaston","gautier","georges","gerald","g√©rard","ghislain","gilbert",
  "gilles","gregoire","guillaume","gustave","guy","henri","herman","herv√©","hugo",
  "hugues","ismail","jacques","jean","j√©r√©mie","jeremy","j√©r√¥me","joachim","joel",
  "jonathan","jordan","joseph","jules","julien","karl","kevin","laurent","l√©o",
  "leon","lilian","louis","loic","luca","lucas","ludovic","malik","malik","marc",
  "marcel","marius","martial","martin","mathieu","matheo","mathias","mathis",
  "matthias","matthieu","max","maxence","maxime","mehdi","michel","mickael",
  "milan","mohamed","nathan","nicolas","noe","noah","norbert","olivier","oscar",
  "pablo","paul","pierre","quentin","rafael","raphael","raymond","remi","r√©mi",
  "ren√©","richard","robert","robin","roger","romain","rom√©o","samuel","sebastien",
  "serge","simon","stephane","sylvain","tanguy","teo","th√©odore","thibault",
  "thomas","tim","timothe","tom","tony","tristan","valentin","victor","vincent",
  "yann","yannis","yohan","yves","zac","zacharie","pascal","manuel","thierry","willy",
  "eloi","andre","jerome","patrick","gerard","bastout","philippe","eric","rodolphe",
  "herve","yoann","theophile","joris","benoit","ancelin","Thibaud","jacob","regis","nico",
  "mark","jeff","henry","yoan","leo","corentin","vivian","clement","stanislas","remy","ugo",
  "gilmon","teddy"
)

prenoms_f <- c(
  "adele","adeline","ad√®le","agathe","agn√®s","aicha","aline","alice","alicia",
  "alison","amandine","amelie","ana√Øs","anais","anastasia","andr√©e","anita",
  "anna","anne","annette","annie","anth√©a","antoinette","apolline","ariane",
  "arielle","armelle","astrid","audrey","augustine","aur√©lie","aurore",
  "babette","barbara","b√©atrice","blandine","brigitte","camille","capucine",
  "carine","caroline","cassandra","catherine","cecile","c√©cile","celeste",
  "celia","c√©line","chlo√©","chloe","christelle","christiane","christine",
  "clara","clarisse","claudine","colette","coline","constance","coralie",
  "corinne","danielle","daphne","daphn√©","delphine","denise","diane","djemila",
  "dominique","doroth√©e","edith","elaine","elea","elena","eliane","elisa",
  "elise","√©lise","elodie","elvira","emilie","emma","emmanuelle","estelle",
  "eugenie","eva","fabienne","fantine","felicie","fernande","flavie","flore",
  "florence","france","francesca","francoise","gabrielle","garance",
  "genevi√®ve","georgette","geraldine","gis√®le","gloria","hanna","h√©l√®ne",
  "helena","henriette","huguette","imy","ines","ingrid","irma","isabelle",
  "jade","janine","jeanne","jennifer","jessica","joelle","josephine",
  "josiane","judith","julie","julienne","julia","juliette","justine","karine",
  "laetitia","laetitia","laetitia","laura","laure","laurence","lea","l√©a",
  "leila","lena","lene","line","lisa","lisette","lorraine","lou","louise",
  "lucette","lucie","lucile","lucille","lydia","maelle","maelle","magali",
  "maeva","manon","margaux","margot","marguerite","maria","mariama","marie",
  "marina","marine","marion","marjorie","marl√®ne","marthe","martine","maryse",
  "mathilde","m√©lanie","melinda","meline","melissa","melodie","mercedes",
  "micheline","michelle","mireille","miriam","morgane","nad√®ge","nadine",
  "naomi","nathalie","nicole","no√©mie","noemie","oc√©ane","odette","odile",
  "olivia","ophelie","oph√©lie","paola","patricia","paulette","pauline",
  "peggy","perrine","pierretta","priscilla","rachel","raphaelle","raymonde",
  "rebeca","rene","ren√©e","romy","rosa","rosalie","rose","roxane","sabine",
  "sabrina","salom√©","salome","samira","sandrine","sarah","scarlett",
  "s√©verine","sidonie","simone","sonia","sophie","stephanie","suzanne",
  "sylvie","tania","tatiana","th√©r√®se","therese","valentina","valentine",
  "val√©rie","vanessa","v√©ronique","victoria","virginie","viviane","yasmina",
  "yvette","yvonne","zoe","zo√©","iris","julienne","jullienne","jocelyne",
  "claire","cathy","aurelie","maude","gervaise","armel","chantal","myriam",
  "monica","reine","lili","cecilia","marysia","lydie","valerie"
)

detect_prenom <- function(email, prenoms_h, prenoms_f) {
  deb <- tolower(str_extract(email, "^[^@]+"))  # partie avant @
  
  # concat√©ner tous les pr√©noms dans un seul vecteur
  all_names <- c(prenoms_h, prenoms_f)
  
  # chercher tous les pr√©noms pr√©sents quelque part dans l'adresse
  matches <- all_names[str_detect(deb, all_names)]
  
  if (length(matches) == 0) return(NA_character_)
  
  # s'il y a plusieurs pr√©noms trouv√©s ‚Üí on garde le plus long (meilleure pr√©cision)
  prenom <- matches[which.max(nchar(matches))]
  return(prenom)
}

participant <- participant %>%
  rowwise() %>%
  mutate(
    prenom = detect_prenom(email, prenoms_h, prenoms_f),
    sexe = case_when(
      !is.na(prenom) & prenom %in% prenoms_h ~ "H",
      !is.na(prenom) & prenom %in% prenoms_f ~ "F",
      TRUE ~ NA_character_
    )
  ) %>%
  ungroup()

# a changer manuellement :

participant$sexe[participant$email %in% c("aurelie.laurent.971@gmail.com","degomouss@gmail.com",
                                          "briemuller@gmail.com","birgit.tollner@gmail.com","angele.bally@lpo.fr",
                                          "l.gourdel@free.fr","jplrousselet@orange.fr","isagiraud75@gmail.com",
                                          "chrisdieulafait@orange.fr","perdub@aol.com","ccressent@gmail.com",
                                          "benchomel@netcourrier.com","duvernay_fr@yahoo.fr","vers.un.voiseau@orange.fr",
                                          "mcrossard@yahoo.fr","vd.dousset@wanadoo.fr")] <- "F"

participant$sexe[participant$email %in% c("duchenne.f@gmail.com","jluc.a1@orange.fr","equilibre.var@gmail.com",
                                          "ybrouillard@orange.fr","cjm.chartendrault@gmail.com","delemonte.th@orange.fr",
                                          "orever@free.fr","mudirme@sfr.fr","gil.jacotot@gmail.com",
                                          "dufour.famili@orange.fr","fyvert@gmail.com","dphil2001@aol.com",
                                          "vmallet2@wanadoo.fr","vmallet3@yahoo.fr","jluc28800@yahoo.fr",
                                          "privallin@orange.fr","m.berges@natureo.org","bdinatale69@gmail.com",
                                          "Thibauddaumal@gmail.com","carle.coste@wanadoo.fr","y.detonquedec@free.fr",
                                          "manceaulionel@gmail.com","vincelecalvez@yahoo.fr","paris.oliv@wanadoo.fr",
                                          "jf.cherel@free.fr","julliard@mnhn.fr","nvissyrias@gmail.com",
                                          "siblet@mnhn.fr","delzons@mnhn.fr","fournier@mnhn.fr",
                                          "sachfldy@hotmail.com","dmuret@yahoo.fr","l.rouschmeyer@acer-campestre.fr",
                                          "fred.pelsy@gmail.com","jsouriou@gmail.com","dom.hemery@wanadoo.fr",
                                          "jp.gans@sfr.fr","dbizet@cogard.org","valsp@yahoo.fr",
                                          "auseth.gascon@yahoo.fr","gamineau@gmail.com","ghisr@otmail.fr",
                                          "xh12@outlook.fr","matprioul@wanadoo.fr","osoldi84@gmail.com",
                                          "blafargue46@gmail.com","ezzo33@gmail.com","urbi.pat@free.fr","fournip1@hotmail.com",
                                          "grimaudjpf@aol.com","dm.huyghe@gmail.com","fasuperla@riseup.net",
                                          "f.toulotte@gmail.com","tipoire@hotmail.com","f-grunert@netc.fr",
                                          "s_gardien@yahoo.fr","jc.dudicourt@gmail.com","botellas9135@sfr.fr",
                                          "gaaubry@wanadoo.fr","ldelpit@laposte.ner","d.svinarenko@trans-faire.net")] <- "H"

table(participant$sexe, useNA = "always")

participant$email[is.na(participant$sexe)==T]

rm(prenoms_h, prenoms_f)
```

**Cocheurs**

Correspondance des emails entre les r√©pondant.es au quiz et les 1741 cocheurs sur cocheurs.fr

```{r}
#| echo: false
#| message: false
#| warning: false
cocheurs <- read_excel("Data/cocheurs.xlsx")
cocheurs <- cocheurs %>% 
  dplyr::select(Membres, France)

# --- Preparation des cocheurs ---
cocheurs2 <- cocheurs %>%
  mutate(
    clean = stri_trans_general(Membres, "Latin-ASCII") %>% tolower() %>% str_squish(),
    prenom = str_extract(clean, "^[a-z]+"),
    nom    = str_extract(clean, "[a-z]+$"),
    init   = substr(prenom, 1, 1)
  )

find_match <- function(email_start, ref) {
  
  if (is.na(email_start))
    return(list(member = NA, rule = NA))
  
  # tokens propres
  tokens <- str_split(email_start, "[._\\-+@]")[[1]] %>%
    str_remove_all("[0-9]") %>%
    str_remove_all("[^a-z]") %>%
    discard(~ .x == "" | is.na(.x) | nchar(.x) < 2)
  
  if (length(tokens) == 0)
    return(list(member = NA, rule = NA))
  
  # --- 1) MATCHS SUR NOM avec obligation d'avoir prenom ou initiale ---
  for (i in seq_len(nrow(ref))) {
    
    pr  <- ref$prenom[i]
    nm  <- ref$nom[i]
    ini <- ref$init[i]
    
    if (is.na(nm) || nm == "") next
    
    # A. nom et prenom/initiale presents comme tokens distincts
    if (any(tokens == nm) && (any(tokens == pr) || any(tokens == ini)))
      return(list(member = ref$Membres[i], rule = "nom_token + prenom_token"))
    
    # B. initiale + nom (ex jdupont)
    if (!is.na(ini) && ini != "" &&
        any(tokens == paste0(ini, nm)))
      return(list(member = ref$Membres[i], rule = "init+nom"))
    
    # C. prenom + nom colles (ex jeandupont)
    if (!is.na(pr) && pr != "" &&
        any(tokens == paste0(pr, nm)))
      return(list(member = ref$Membres[i], rule = "prenom_nom_colle"))
    
    # D. nom + prenom colles (ex dupontjean)
    if (!is.na(pr) && pr != "" &&
        any(tokens == paste0(nm, pr)))
      return(list(member = ref$Membres[i], rule = "nom_prenom_colle"))
    
    # E. token commence par nom + se poursuit par initiale ou prenom
    if (nchar(nm) >= 3 &&
        any(startsWith(tokens, nm))) {
      
      suffixes <- str_replace(tokens[startsWith(tokens, nm)], paste0("^", nm), "")
      
      if (any(suffixes == ini) || any(suffixes == pr))
        return(list(member = ref$Membres[i], rule = "nom_start + prenom"))
    }
  }
  
  # --- 2) prenom seul ‚Üí NON ---
  for (i in seq_len(nrow(ref))) {
    pr <- ref$prenom[i]
    if (!is.na(pr) && pr != "" &&
        any(tokens == pr))
      return(list(member = ref$Membres[i], rule = "prenom_only"))
  }
  
  return(list(member = NA, rule = NA))
}

participant <- participant %>%
  mutate(
    email_clean = stri_trans_general(email, "Latin-ASCII") %>% tolower(),
    email_start = str_extract(email_clean, "^[^@]+")
  ) %>%
  rowwise() %>%
  mutate(
    out = list(find_match(email_start, cocheurs2)),
    matched_member = out$member,
    match_rule     = out$rule
  ) %>%
  ungroup() %>%
  mutate(
    cocheur = case_when(
      match_rule %in% c("nom_exact", "init+nom",
                        "prenom_nom_colle_oui", "nom_start", 
                        "nom_token + prenom_token", "prenom_nom_colle") ~ "Oui",
      TRUE ~ "Non"
    )
    ) %>%
  dplyr::select(-out)

participant <- participant %>%
  left_join(
    cocheurs %>% dplyr::select(Membres, France),
    by = c("matched_member" = "Membres")
  ) %>%
  mutate(
    nb_obs_cocheurs = if_else(cocheur == "Oui", France, NA_real_)
  )

participant <- participant %>% 
  dplyr::select(-match_rule, -matched_member, -email_clean, -email_start, -prenom, -France)
```

**Anciennet√©**

Anciennet√© d√©clar√© par les r√©pondant.es pour le.s suivis participatifs

```{r}
#| echo: false
#| message: false
#| warning: false
participant <- participant %>% 
  mutate(anciennete_clean = as.numeric(gsub(".*?([0-9]+).*", "\\1", anciennete)))  

participant$anciennete_clean[participant$anciennete_clean=="2028"] <- NA
participant$anciennete_clean[participant$anciennete_clean=="2024"] <- 2025-2024
participant$anciennete_clean[participant$anciennete_clean=="2023"] <- 2025-2023
participant$anciennete_clean[participant$anciennete_clean=="2022"] <- 2025-2022
participant$anciennete_clean[participant$anciennete_clean=="2021"] <- 2025-2021
participant$anciennete_clean[participant$anciennete_clean=="2020"] <- 2025-2020
participant$anciennete_clean[participant$anciennete_clean=="2019"] <- 2025-2019
participant$anciennete_clean[participant$anciennete_clean=="2018"] <- 2025-2018
participant$anciennete_clean[participant$anciennete_clean=="2017"] <- 2025-2017
participant$anciennete_clean[participant$anciennete_clean=="2016"] <- 2025-2016
participant$anciennete_clean[participant$anciennete_clean=="2015"] <- 2025-2015
participant$anciennete_clean[participant$anciennete_clean=="2014"] <- 2025-2014
participant$anciennete_clean[participant$anciennete_clean=="2013"] <- 2025-2013
participant$anciennete_clean[participant$anciennete_clean=="2012"] <- 2025-2012
participant$anciennete_clean[participant$anciennete_clean=="2007"] <- 2025-2007
participant$anciennete_clean[participant$anciennete_clean=="2002"] <- 2025-2002
participant$anciennete_clean[participant$anciennete_clean=="2001"] <- 2025-2001
participant$anciennete_clean[participant$anciennete_clean=="1984"] <- 2025-1984

participant <- participant %>% 
  dplyr::select(-anciennete, -datetime) %>% 
  rename(anciennete = anciennete_clean)

participant$anciennete[is.na(participant$anciennete)] <- 0
```

**Departement**

D√©partement fran√ßais m√©tropolitain + suisse

```{r}
#| echo: false
participant <- participant %>% 
  filter(departement != "Je souhaiterais supprimer mes r√©ponses svp (au questionnaire pr√©c√©dent). J'avais mal compris le principe de ce questionnaire ! Mes r√©ponses n'avaient donc aucune pertinence car je n'ai pas assez de recul. Dommage qu'il n'y ait pas un email de contact.")

participant <- participant %>% 
  mutate(departement = case_when(departement == "04 et 06" ~ "04",
                                 departement == "2" ~ "02",
                                 departement == "maxjouve@hotmail.com" ~ NA,
                                 departement == "Eure-et-Loir (28)" ~ "28",
                                 departement %in% c("Allier") ~ "03",
                                 departement %in% c("Aube") ~ "10",
                                 departement %in% c("Finist√®re") ~ "29",
                                 departement %in% c("Gironde") ~ "33",
                                 departement %in% c("haute-garonne") ~ "31",
                                 departement %in% c("Ille et Vilaine") ~ "35",
                                 departement %in% c("Loir-et-cher") ~ "41",
                                 departement %in% c("Loire") ~ "42",
                                 departement %in% c("pyr√©√©nes orientales") ~ "66",
                                 departement %in% c("suisse") ~ "suisse",
                                 departement %in% c("Suisse GE") ~ "suisse",
                                 TRUE ~ departement),
         departement = strtrim(departement, 2))

table(participant$departement, useNA = "always")

participant <- participant[!is.na(participant$departement),]
```

**R√©gion et bior√©gion**

D√©partements associ√©s √† une r√©gion admin, √† une bior√©gion (INPN)

```{r}
#| echo: false
#| message: false
#| warning: false

code = c(
"01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","2A","2B",
"21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40",
"41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60",
"61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80",
"81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","su")

region = c(
"Auvergne-Rh√¥ne-Alpes","Hauts-de-France","Auvergne-Rh√¥ne-Alpes","Provence-Alpes-C√¥te d‚ÄôAzur","Provence-Alpes-C√¥te d‚ÄôAzur","Provence-Alpes-C√¥te d‚ÄôAzur","Auvergne-Rh√¥ne-Alpes","Grand Est","Occitanie","Grand Est","Occitanie","Occitanie","Provence-Alpes-C√¥te d‚ÄôAzur","Normandie","Auvergne-Rh√¥ne-Alpes","Nouvelle-Aquitaine","Nouvelle-Aquitaine","Centre-Val de Loire","Nouvelle-Aquitaine","Corse","Corse",
"Bourgogne-Franche-Comt√©","Bretagne","Nouvelle-Aquitaine","Nouvelle-Aquitaine","Bourgogne-Franche-Comt√©","Auvergne-Rh√¥ne-Alpes","Normandie","Centre-Val de Loire","Bretagne","Occitanie","Occitanie","Nouvelle-Aquitaine","Occitanie","Bretagne","Centre-Val de Loire","Centre-Val de Loire","Auvergne-Rh√¥ne-Alpes","Bourgogne-Franche-Comt√©","Nouvelle-Aquitaine",
"Centre-Val de Loire","Auvergne-Rh√¥ne-Alpes","Auvergne-Rh√¥ne-Alpes","Pays de la Loire","Centre-Val de Loire","Occitanie","Nouvelle-Aquitaine","Occitanie","Pays de la Loire","Normandie","Grand Est","Normandie","Grand Est","Grand Est","Bretagne","Grand Est","Bourgogne-Franche-Comt√©","Hauts-de-France","Hauts-de-France","Normandie",
"Hauts-de-France","Hauts-de-France","Auvergne-Rh√¥ne-Alpes","Nouvelle-Aquitaine","Occitanie","Occitanie","Grand Est","Grand Est","Auvergne-Rh√¥ne-Alpes","Bourgogne-Franche-Comt√©","Bourgogne-Franche-Comt√©","Pays de la Loire","Auvergne-Rh√¥ne-Alpes","Auvergne-Rh√¥ne-Alpes","√éle-de-France","Normandie","√éle-de-France","√éle-de-France","Nouvelle-Aquitaine","Hauts-de-France",
"Occitanie","Occitanie","Provence-Alpes-C√¥te d‚ÄôAzur","Provence-Alpes-C√¥te d‚ÄôAzur","Pays de la Loire","Nouvelle-Aquitaine","Nouvelle-Aquitaine","Grand Est","Bourgogne-Franche-Comt√©","Bourgogne-Franche-Comt√©","√éle-de-France","√éle-de-France","√éle-de-France","√éle-de-France","√éle-de-France","√éle-de-France","su")

# Codes des bior√©gions (INPN) 
# ALP : alpin
# ATL : atlantique
# MATL : atlantique marin 
# CON : continental 
# MED : m√©diterran√©en
# MMED : m√©diterran√©en marin

bioregion <- c(
  # 01 √† 09
  "CON","CON","CON","ALP","ALP","MMED","MED","CON","CON",
  # 10 √† 19
  "CON","MED","CON","MMED","ATL","CON","MATL","MATL","CON","CON",
  # 2A, 2B
  "MMED","MMED",
  # 21 √† 29
  "CON","MATL","CON","ATL","CON","ALP","ATL","CON","MATL",
  # 30 √† 39
  "MMED","CON","CON","ATL","MMED","ATL","CON","ALP","CON",
  # 40 √† 49
  "MATL","CON","ALP","CON","CON","ATL","ATL","MED","ATL","MATL",
  # 50 √† 59
  "MATL","CON","MATL","CON","CON","MATL","CON","CON","CON","CON",
  # 60 √† 69
  "CON","MATL","CON","MATL","CON","MED","CON","CON","CON","CON",
  # 70 √† 79
  "CON","CON","ALP","ALP","CON","MATL","CON","CON","MATL","CON",
  # 80 √† 89
  "MATL","CON","MMED","MMED","MATL","ATL","CON","CON","CON","CON",
  # 90 √† 95
  "CON","CON","CON","CON","CON","CON","CON","ALP"
)

departement_info <- data.frame(
  departement = code,
  region = region,
  bioregion = bioregion)

participant <- participant %>% 
  left_join(departement_info)

participant$bioregion[participant$departement=="su"] <- "ALP"

departement_info %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

**Bagueurs** 

Correspondances des emails entre les participant.es et les 32 premiers bagueurs (CRBPO)

```{r}
#| echo: false
#| message: false
#| warning: false
bagueurs <- read_excel("Data/bagueurs.xlsx", col_names = FALSE)

bagueurs <- bagueurs %>% 
  rename(email = "...1") %>% 
  mutate(bagueur = 1)

participant <- participant %>% 
  left_join(bagueurs)

participant$bagueur[participant$bagueur == 1] <- "Oui"
participant$bagueur[is.na(participant$bagueur)] <- "Non"
```

**Expert sciences participatives**

Si participation_stoc == "Oui", participation_shoc == "Oui", participation_epoc == "Oui", bagueur == "Oui" ou nb_obs_cocheurs \>= 300, alors la¬∑e participant¬∑e est consid√©r√©¬∑e comme expert¬∑e.

```{r}
#| echo: false
participant <- participant %>% 
  mutate(expert = case_when(participation_stoc == "Oui" | 
                              participation_shoc == "Oui" | 
                              participation_epoc == "Oui" | 
                              bagueur == "Oui" |
                              nb_obs_cocheurs >= 300 ~ "Oui",
                        TRUE ~ "Non"))
```

**Species**

Nom vernatuclaire et code esp√®ce

```{r}
#| echo: false
#| message: false
#| warning: false
species <- read_csv("Data/species.csv", locale = locale(encoding = "ISO-8859-1"))

species$french_name[species$french_name=="Grosbec casse-noyaux"] <- "Grosbec cassenoyaux"

species_2 <- species %>% 
  dplyr::select(pk_species, french_name) %>% 
  rename(espece = french_name,
         code_espece = pk_species)

species_2 %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

**Shoc**

Tendances SHOC

```{r}
#| echo: false
#| message: false
#| warning: false
longTermTrends <- read_csv("Data/longTermTrends.csv")

tendances <- longTermTrends %>% 
  dplyr::select(species, trend) %>% 
  rename(code_espece = species,
         tendance_shoc = trend)

tendances <- tendances %>% 
  left_join(species_2)

tendances %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

table(tendances$tendance_shoc)
```

**Stoc**

Tendances SHOC et STOC

```{r}
#| echo: false
#| message: false
#| warning: false
tendances_stoc <- readr::read_csv("Data/STOC/shortTermTrends.csv", locale = locale(encoding = "UTF-8"))

tendances_stoc <- tendances_stoc %>% 
  dplyr::select(french_name, trend, perc) %>% 
  rename(espece = french_name, tendances_stoc = trend) %>% 
  mutate(tendances_stoc_simplifie = case_when(tendances_stoc %in% c("Augmentation forte","Augmentation mod√©r√©e",
                                                                    "Augmentation mod√©r√©e √† forte") ~ "Augmentation",
                                              tendances_stoc %in% c("D√©clin fort","D√©clin mod√©r√©",
                                                                    "D√©clin mod√©r√© √† fort") ~ "D√©clin",
                                              TRUE ~ tendances_stoc),
         tendances_stoc_simplifie_2 = case_when(tendances_stoc_simplifie %in% c("Augmentation","D√©clin") ~ "Changement",
                                              TRUE ~ "incertain ou stable"))

pourcentage <- as.numeric(scale(parse_number(tendances_stoc$perc)))

tendances_stoc$pourcentage_stoc <- pourcentage

tendances <- tendances %>% 
  left_join(tendances_stoc) %>% 
  dplyr::select(-perc, -tendances_stoc_simplifie_2)

tendances %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

## traits

```{r}
#| echo: false
#| message: false
#| warning: false
trait_SHOC_HUMAIN <- read_excel("Data/trait_SHOC-HUMAIN.xlsx")

trait_SHOC_HUMAIN$abondance_log <- log(trait_SHOC_HUMAIN$abondance)
fauneFrance_vec <- as.numeric(scale(trait_SHOC_HUMAIN$fauneFrance))
trait_SHOC_HUMAIN$fauneFrance <- fauneFrance_vec

trait_SHOC_HUMAIN %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

## cat√©gories de tendances

```{r}
#| echo: false
#| message: false
#| warning: false

# avis__________________________________________________________________________

print("avis quiz shoc")

table(avis$avis_niv1, useNA = "always")
table(avis$avis_niv2, useNA = "always")

avis$avis_niv1[avis$avis_niv1=="En augmentation"] <- "Augmentation"
avis$avis_niv1[avis$avis_niv1=="En d√©clin"] <- "D√©clin"
avis$avis_niv1[avis$avis_niv1=="Je ne sais pas"] <- "Incertain"
table(avis$avis_niv1, useNA = "always")

avis$avis_niv2[avis$avis_niv2=="Fort"] <- "fort"
avis$avis_niv2[avis$avis_niv2=="Mod√©r√©"] <- "mod√©r√©"
avis$avis_niv2[avis$avis_niv2=="Mod√©r√© √† fort"] <- "mod√©r√© √† fort"
avis$avis_niv2 <- trimws(paste(
  ifelse(is.na(avis$avis_niv1), "", avis$avis_niv1),
  ifelse(is.na(avis$avis_niv2), "", avis$avis_niv2)
))
table(avis$avis_niv2, useNA = "always")

avis$avis_niv2[avis$avis_niv2=="Fluctuante mod√©r√©"] <- "Fluctuante"
avis$avis_niv2[avis$avis_niv2 %in% c("Incertain mod√©r√©","Incertain mod√©r√© √† fort")] <- "Incertain"
avis$avis_niv2[avis$avis_niv2 %in% c("Stable fort","Stable mod√©r√©","Stable mod√©r√© √† fort")] <- "Stable"
table(avis$avis_niv2, useNA = "always")

avis$avis_niv2[avis$avis_niv2=="Augmentation"] <- NA
avis$avis_niv2[avis$avis_niv2=="D√©clin"] <- NA


print("cat√©goies quiz shoc apr√®s transformation en 2 nouveaux")
print("niveau 1")
table(avis$avis_niv1)
print("niveau 2")
table(avis$avis_niv2)

# tendances_____________________________________________________________________

tendances$tendance_shoc[tendances$tendance_shoc=="Augmentation mod√©r√©e"] <- "Augmentation mod√©r√©"
tendances$tendance_shoc[tendances$tendance_shoc=="Augmentation mod√©r√©e √† forte"] <- "Augmentation mod√©r√© √† fort"
tendances$tendance_shoc[tendances$tendance_shoc=="Augmentation forte"] <- "Augmentation fort"

tendances <- tendances %>% 
  mutate(tendance_shoc_niv1 = case_when(tendance_shoc %in% c("Augmentation fort","Augmentation mod√©r√©","Augmentation mod√©r√© √† fort") ~ "Augmentation",
                                         tendance_shoc %in% c("D√©clin fort","D√©clin mod√©r√©","D√©clin mod√©r√© √† fort") ~ "D√©clin",
                                         tendance_shoc %in% c("Incertain", "Fluctuante") ~ "Incertain",
                                         tendance_shoc == "Stable" ~ "Stable"),
         tendance_shoc_niv2 = tendance_shoc)

print("cat√©goies des tendances shoc")
print("niveau 1")
table(tendances$tendance_shoc_niv1)
print("niveau 2")
table(tendances$tendance_shoc_niv2)
```

## dataset

```{r}
#| echo: false
#| message: false
#| warning: false
dataset <- avis %>% 
  left_join(trait_SHOC_HUMAIN) %>% 
  left_join(participant) %>% 
  left_join(tendances) %>% 
  dplyr::select(-code_espece)

# on garde que les esp√®ce en commun entre le quiz et le shoc
dataset <- dataset %>% 
  filter(espece != "Etourneau sansonnet") %>% 
  filter(espece != "Grive mauvis")

dataset <- dataset[!is.na(dataset$departement),]
  
```

## comparaison SHOC vs Humain

Si tendances SHOC et r√©ponses identiques ou diff√©rentes

**Niveau 1 :**

Augmentation = augmentation

D√©clin = d√©clin

Stable = stable

Incertain = je ne sais pas, fluctuante ou incertain

```{r}
#| echo: false
#| message: false
#| warning: false
dataset <- dataset %>%
  mutate(
    comparaison_niv1 = if_else(
      str_trim(avis_niv1) == str_trim(tendance_shoc_niv1), 
      "identique", 
      "different"
    ),
    comparaison_niv2 = if_else(
      str_trim(avis_niv2) == str_trim(tendance_shoc_niv2), 
      "identique", 
      "different"
    )
  )

# dataset <- dataset %>% 
#   dplyr::select(-avis_niv1, -avis_niv2, -participation_odj, -tendance_shoc, -tendance_shoc_niv1, -tendance_shoc_niv2) %>% 
#   na.omit()

# jeu de donn√©es propres √† analyser :
print("Jeu de donn√©es propres √† analyser")
dataset %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

verif_dt <- dataset %>% 
  dplyr::select(avis_niv1, avis_niv2, tendance_shoc, tendance_shoc_niv1, tendance_shoc_niv2, comparaison_niv1, comparaison_niv2)

rm(verif_dt)
```

```{r}
#| echo: false
rm(avis, avis_large, bagueurs, cocheurs, cocheurs2, departement_info, longTermTrends, participant, quiz, quiz_2,
   species, species_2, tendances, tendances_stoc)
```

## exploration donn√©es

```{r}
#| echo: false
summary(dataset)

# table(dataset$email, useNA = "always")
print("espece")
table(dataset$espece, useNA = "always")
print("departement")
table(dataset$departement, useNA = "always")
print("participation_stoc")
table(dataset$participation_stoc, useNA = "always")
print("participation_shoc")
table(dataset$participation_shoc, useNA = "always")
print("participation_epoc")
table(dataset$participation_epoc, useNA = "always")
print("sexe")
table(dataset$sexe, useNA = "always")
print("cocheur")
table(dataset$cocheur, useNA = "always")
print("anciennete")
table(dataset$anciennete, useNA = "always")
print("region")
table(dataset$region, useNA = "always")
print("bioregion")
table(dataset$bioregion, useNA = "always")
print("bagueur")
table(dataset$bagueur, useNA = "always")
print("expert")
table(dataset$expert, useNA = "always")
print("tendances_stoc")
table(dataset$tendances_stoc, useNA = "always")
print("pourcentage_stoc")
table(dataset$pourcentage_stoc, useNA = "always")
print("tendances_stoc_simplifie")
table(dataset$tendances_stoc_simplifie, useNA = "always")
print("tendances_stoc_simplifie_2")
table(dataset$tendances_stoc_simplifie_2, useNA = "always")
print("detectabilite")
table(dataset$detectabilite, useNA = "always")
print("gregaire")
table(dataset$gregaire, useNA = "always")
print("fluctuante")
table(dataset$fluctuante, useNA = "always")
print("migrateur")
table(dataset$migrateur, useNA = "always")
print("migrateur simplifi√©")
table(dataset$migrateur_simplifie, useNA = "always")
print("abondance")
table(dataset$abondance, useNA = "always")
print("abondance log")
table(dataset$abondance_log, useNA = "always")
print("fauneFrance")
table(dataset$fauneFrance, useNA = "always")
print("regime")
table(dataset$regime, useNA = "always")
print("popularite")
table(dataset$popularite, useNA = "always")
print("comparaison_niv1")
table(dataset$comparaison_niv1, useNA = "always")
print("comparaison_niv2")
table(dataset$comparaison_niv2, useNA = "always")

# variable type
dataset$comparaison_niv1 <- as.factor(dataset$comparaison_niv1)
dataset$comparaison_niv2 <- as.factor(dataset$comparaison_niv2)
```

# FREQUENCES

## niv 1

**Shoc vs hasard**

```{r}
#| echo: false

obs_shoc <- table(dataset$tendance_shoc_niv1)

chisq.test(obs_shoc)

res_shoc <- chisq.test(obs_shoc)

data.frame(
  Tendance = names(obs_shoc),
  Observ√© = as.numeric(obs_shoc),
  Attendu = res_shoc$expected,
  R√©sidu_std = res_shoc$stdres
)
```

p-value \< 0.05 ‚Üí la distribution est significativement diff√©rente du hasard

**Niv 1 vs hasard**

```{r}
#| echo: false

obs_avis_niv1 <- table(dataset$avis_niv1)

chisq.test(obs_avis_niv1)

res_avis_niv1 <- chisq.test(obs_avis_niv1)

data.frame(
  Tendance = names(obs_avis_niv1),
  Observ√© = as.numeric(obs_avis_niv1),
  Attendu = res_avis_niv1$expected,
  R√©sidu_std = res_avis_niv1$stdres
)
```

p-value \< 0.05 ‚Üí la distribution est significativement diff√©rente du hasard

**Shoc vs niv 1**

```{r}
#| echo: false
categories_communes <- intersect(names(obs_shoc), names(obs_avis_niv1))

obs_shoc_c <- obs_shoc[categories_communes]
obs_avis_c <- obs_avis_niv1[categories_communes]

tab_chi2 <- rbind(
  SHOC = obs_shoc_c,
  AVIS = obs_avis_c
)

tab_chi2

chisq.test(tab_chi2)

res <- chisq.test(tab_chi2)

print("r√©sidus")
res$stdres

print("proportions")
prop.table(tab_chi2, margin = 1)
```

p-value \< 0.05 ‚Üí les distributions diff√®rent significativement entre SHOC et AVIS

**Conclusions :**

üîπ Augmentation

R√©sidus : SHOC +27.6, AVIS ‚àí27.6

Proportions : SHOC 30.0 %, AVIS 16.1 %

üëâ Augmentation est massivement plus fr√©quente dans SHOC que dans AVIS C‚Äôest l‚Äôun des moteurs principaux du œá¬≤.

üîπ D√©clin

R√©sidus : SHOC +0.92, AVIS ‚àí0.92

Proportions : SHOC 26.7 %, AVIS 26.2 %

üëâ Aucune diff√©rence r√©elle D√©clin se comporte de la m√™me mani√®re dans les deux sources.

üîπ Incertain

R√©sidus : SHOC +16.1, AVIS ‚àí16.1

Proportions : SHOC 26.7 %, AVIS 18.6 %

üëâ Incertain est fortement sur-repr√©sent√© dans SHOC Clairement diff√©rent entre les deux distributions.

üîπ Stable

R√©sidus : SHOC ‚àí42.2, AVIS +42.2

Proportions : SHOC 16.7 %, AVIS 39.1 %

üëâ Stable est massivement plus fr√©quent dans AVIS que dans SHOC C‚Äôest le contraste le plus fort du tableau.

En r√©sum√© : 

Les distributions de tendances diff√®rent fortement entre SHOC et AVIS (œá¬≤, p \< 0.001). Les √©carts sont principalement dus √† une sur-repr√©sentation des modalit√©s ¬´ Augmentation ¬ª et ¬´ Incertain ¬ª dans SHOC, tandis que la modalit√© ¬´ Stable ¬ª est largement dominante dans AVIS. La modalit√© ¬´ D√©clin ¬ª ne montre pas de diff√©rence significative entre les deux sources.

SHOC ‚Üí profil plus dynamique / incertain : plus d‚ÄôAugmentation, plus d‚ÄôIncertain, peu de Stable

AVIS ‚Üí profil nettement plus stable, Stable ‚âà 40 %, moins d‚ÄôAugmentation

üëâ Ce n‚Äôest pas un effet d‚Äô√©chantillon, mais un changement structurel de profil.

Interpr√©tations possibles ? 

Chez les participant.es, biais vers le stable, et peu d'aumgmentation. En demandant de r√©pondre pour des tendances, on pense moins facilement √† r√©pondre stable ? Et oin parle beaucoup des d√©clins (m√©dia, crise ecolo...), mais peu des augmentations, donc les gens n'y pensent pas ?

## !!! niv 2

# PROPORTION IDENTIQUE vs DIFFERENT

## niv 1

```{r}
#| echo: false
print("proportion de tendances d'identiques vs diff√©rentes, niveau 1")

print("toutes les tendances")
dt_prop_niv_1 <- as.data.frame(table(dataset$comparaison_niv1, useNA = "always"))
dt_prop_niv_1$prop <- dt_prop_niv_1$Freq / sum(dt_prop_niv_1$Freq)
dt_prop_niv_1

print("declin et augmentation seulement")
dataset_DA <- dataset[dataset$tendance_shoc_niv1 %in% c("D√©clin","Augmentation"),]
dt_prop_niv_1_DA <- as.data.frame(table(dataset_DA$comparaison_niv1, useNA = "always"))
dt_prop_niv_1_DA$prop <- dt_prop_niv_1_DA$Freq / sum(dt_prop_niv_1_DA$Freq)
dt_prop_niv_1_DA
```

## !!! niv 2 

```{r}
#| echo: false
print("proportion de tendances d'identiques vs diff√©rentes, niveau 2")

print("toutes les tendances")
dt_prop_niv_2 <- as.data.frame(table(dataset$comparaison_niv2, useNA = "always"))
dt_prop_niv_2$prop <- dt_prop_niv_2$Freq / sum(dt_prop_niv_2$Freq)
dt_prop_niv_2

print("declin et augmentation seulement")
dataset_DA <- dataset[dataset$tendance_shoc_niv1 %in% c("D√©clin","Augmentation"),]
dt_prop_niv_2_DA <- as.data.frame(table(dataset_DA$comparaison_niv1, useNA = "always"))
dt_prop_niv_2_DA$prop <- dt_prop_niv_2_DA$Freq / sum(dt_prop_niv_2_DA$Freq)
dt_prop_niv_2_DA
```

# ANALYSES ORDINALES

## niv 1

### donn√©es

```{r}
#| include: false

dt1 <- dataset %>% 
  dplyr::select("email","espece","avis_niv1","migrateur","migrateur_simplifie", "regime","fluctuante",
                "detectabilite","gregaire","popularite",
                "abondance_log","departement","sexe",
                "anciennete","region","bioregion","expert",
                "tendances_stoc", "pourcentage_stoc","fauneFrance",
                "tendance_shoc_niv1") %>% 
  filter(avis_niv1 != "Fluctuante",
         avis_niv1 != "Incertain") %>% 
  filter(tendance_shoc_niv1 != "Fluctuante",
         tendance_shoc_niv1 != "Incertain") %>%
  na.omit()

unique(dt1$avis_niv1)

dt1 <- dt1 %>%
  mutate(
    avis_niv1 = factor(
      avis_niv1,
      levels = c("D√©clin" ,"Stable", "Augmentation"),
      ordered = TRUE
    ),
    tendance_shoc_niv1 = factor(
      tendance_shoc_niv1,
      levels = c("D√©clin" ,"Stable", "Augmentation"),
      ordered = TRUE
    )
  ) %>% 
  na.omit()

dt1 <- dt1 %>%
  mutate(
    popularite    = factor(popularite),
    detectabilite = factor(detectabilite),
    sexe = factor(sexe),
    expert = factor(expert)
  )
```

### al√©atoire

```{r}
#| include: false

m_n1.1 <- clmm(avis_niv1 ~ 1 + 
                    (1 | email), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.2 <- clmm(avis_niv1 ~ 1 + 
                    (1 | region), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.3 <- clmm(avis_niv1 ~ 1 + 
                    (1 | bioregion), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.4 <- clmm(avis_niv1 ~ 1 + 
                    (1 | departement), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.5 <- clmm(avis_niv1 ~ 1 + 
                     (1 | email) + (1 | region), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.6 <- clmm(avis_niv1 ~ 1 + 
                     (1 | email) + (1 | bioregion), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.7 <- clmm(avis_niv1 ~ 1 + 
                     (1 | email) + (1 | departement), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
```

```{r}
#| echo: false
AIC_dt_n1_aleatoire <- as.data.frame(AIC(m_n1.1, m_n1.2, m_n1.3, m_n1.4, m_n1.5, m_n1.6, m_n1.7))

AIC_dt_n1_aleatoire <- AIC_dt_n1_aleatoire %>% 
  arrange(AIC) ; AIC_dt_n1_aleatoire

summary(m_n1.1)
```

### base

```{r}
#| include: false
m_n1_base <- clmm(avis_niv1 ~ tendance_shoc_niv1 + (1 | email), data = dt1, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
summary(m_n1_base)
```

### espece

```{r}
#| eval: false
#| include: false
m_n1_esp <- clmm(avis_niv1 ~ tendance_shoc_niv1*espece + (1 | email), data = dt1, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
summary(m_n1_esp)
```

### trait

```{r}
#| eval: false
#| include: false

# abondance *** int ***
m_n1_trait_1 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + abondance_log + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_1, m_n1_base)
m_n1_trait_1int <- clmm(avis_niv1 ~ tendance_shoc_niv1*abondance_log + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_1, m_n1_trait_1int)

# popularite *** int ***
m_n1_trait_2 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + popularite + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_2, m_n1_base)
m_n1_trait_2int <- clmm(avis_niv1 ~ tendance_shoc_niv1*popularite + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_2, m_n1_trait_2int) 

# detectabilite *** int ***
m_n1_trait_3 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + detectabilite + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_3, m_n1_base)
m_n1_trait_3int <- clmm(avis_niv1 ~ tendance_shoc_niv1*detectabilite + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_3, m_n1_trait_3int) 

# regime *** int ***
m_n1_trait_4 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + regime + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_4, m_n1_base)
m_n1_trait_4int <- clmm(avis_niv1 ~ tendance_shoc_niv1*regime + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_4, m_n1_trait_4int)

# migrateur *** int ***
m_n1_trait_5 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + migrateur + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_5, m_n1_base)
m_n1_trait_5int <- clmm(avis_niv1 ~ tendance_shoc_niv1*migrateur + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_5, m_n1_trait_5int) 

# gregaire *** int ***
m_n1_trait_6 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + gregaire + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_6, m_n1_base)
m_n1_trait_6int <- clmm(avis_niv1 ~ tendance_shoc_niv1*gregaire + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_6, m_n1_trait_6int) 

# fauneFrance *** int ***
m_n1_trait_7 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + fauneFrance + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_7, m_n1_base)
m_n1_trait_7int <- clmm(avis_niv1 ~ tendance_shoc_niv1*fauneFrance + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_7, m_n1_trait_7int)

# pourcentage_stoc *** int ***
m_n1_trait_8 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + pourcentage_stoc + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_8, m_n1_base)
m_n1_trait_8int <- clmm(avis_niv1 ~ tendance_shoc_niv1*pourcentage_stoc + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_8, m_n1_trait_8int)

# all
m_n1_trait_all <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + popularite + detectabilite + regime + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
                    (1 | email), data = dt1, link = "logit", Hess = TRUE)
# m_n1_trait_allint <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
#                     abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
#                     tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + 
#                                           migrateur + gregaire + fauneFrance + pourcentage_stoc) + (1 | email), 
#                     data = dt1, link = "logit", Hess = TRUE)
# m_n1_trait_allint_1 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
#                     abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
#                     tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + 
#                                           migrateur + gregaire + fauneFrance) + (1 | email), 
#                     data = dt1, link = "logit", Hess = TRUE)
# m_n1_trait_allint_2 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
#                     abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
#                     tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + 
#                                           migrateur + gregaire) + (1 | email), 
#                     data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_allint_3 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_allint_4 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
                    tendance_shoc_niv1:(abondance_log + popularite) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_allint_5 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
                    tendance_shoc_niv1:(abondance_log) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_allint_6 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + gregaire) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_allint_7 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + pourcentage_stoc) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_allint_8 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
                    tendance_shoc_niv1:(abondance_log + popularite + gregaire + pourcentage_stoc) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_allint_9 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + pourcentage_stoc + 
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + pourcentage_stoc) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_allint_10 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + popularite + detectabilite + pourcentage_stoc + 
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + pourcentage_stoc) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_allint_11 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + pourcentage_stoc + 
                    tendance_shoc_niv1:(abondance_log + pourcentage_stoc) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_allint_12 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + pourcentage_stoc + 
                    tendance_shoc_niv1:(abondance_log + pourcentage_stoc) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
AIC_dt_trait <- as.data.frame(AIC(m_n1_base, 
                                  m_n1_trait_1, m_n1_trait_2, m_n1_trait_3, m_n1_trait_4, m_n1_trait_5, m_n1_trait_6,m_n1_trait_7,m_n1_trait_8,
                                  m_n1_trait_3int, m_n1_trait_4int, m_n1_trait_5int, m_n1_trait_6int, m_n1_trait_7int, m_n1_trait_8int, 
                                  m_n1_trait_all,
                                  m_n1_trait_allint_3, m_n1_trait_allint_4, m_n1_trait_allint_5, m_n1_trait_allint_6, m_n1_trait_allint_7,
                                  m_n1_trait_allint_8, m_n1_trait_allint_9, m_n1_trait_allint_10, m_n1_trait_allint_11, m_n1_trait_allint_12))

AIC_dt_trait <- AIC_dt_trait %>% 
  arrange(AIC) ; AIC_dt_trait

summary(m_n1_trait_allint_9)

vif(m_n1_trait_allint_9)
```

### participant

```{r}
#| eval: false
#| include: false

# sexe *** int ***
m_n1_participant_1 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + sexe + 
                                (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_1, m_n1_base)
m_n1_participant_1int <- clmm(avis_niv1 ~ tendance_shoc_niv1*sexe + 
                                   (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_1, m_n1_participant_1int) 

# anciennete int ***
m_n1_participant_2 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + anciennete + 
                                (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_2, m_n1_base)
m_n1_participant_2int <- clmm(avis_niv1 ~ tendance_shoc_niv1*anciennete + 
                                   (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_2, m_n1_participant_2int) 

# expert int ***
m_n1_participant_3 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + expert + 
                                (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_3, m_n1_base)
m_n1_participant_3int <- clmm(avis_niv1 ~ tendance_shoc_niv1*expert + 
                                   (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_3, m_n1_participant_3int) 

# all 
m_n1_participant_all <- clmm(avis_niv1 ~ tendance_shoc_niv1 +
                    sexe + anciennete + expert +
                    (1 | email), data = dt1, link = "logit", Hess = TRUE)
m_n1_participant_allint <- clmm(avis_niv1 ~ tendance_shoc_niv1 +
                    sexe + anciennete + expert + 
                    tendance_shoc_niv1:(sexe + anciennete + expert) +
                    (1 | email), data = dt1, link = "logit", Hess = TRUE)

```

```{r}
#| echo: false
AIC_dt_n1_participant <- as.data.frame(AIC(m_n1_base, 
                                m_n1_participant_1, m_n1_participant_2, m_n1_participant_3,
                                m_n1_participant_1int, m_n1_participant_2int, m_n1_participant_3int,
                                m_n1_participant_all, m_n1_participant_allint))

AIC_dt_n1_participant <- AIC_dt_n1_participant %>% 
  arrange(AIC) ; AIC_dt_n1_participant

summary(m_n1_participant_allint)
```

### plot (latente)

```{r}
#| echo: false
#| fig-height: 15
#| fig-width: 10

# dt1 <- dt1 %>%
#   mutate(
#     popularite    = factor(popularite),
#     detectabilite = factor(detectabilite),
#     sexe = factor(sexe),
#     expert = factor(expert)
#   )

# fonction ---------------------------------------------------------------------

# plot_clmm_predictions_multi_x <- function(
#   models,
#   x_values,
#   subtitle = NULL
# ) {
# 
#   emm_all <- purrr::imap_dfr(
#     models,
#     function(model, x_var) {
#       mf <- model.frame(model)
#       if (!x_var %in% names(mf)) {
#         stop(sprintf("La variable '%s' n'est pas dans le mod√®le.", x_var))
#       }
#       x_is_factor <- is.factor(mf[[x_var]])
#       x_vals <- x_values[[x_var]]
#       emm <- if (x_is_factor) {
#         emmeans(
#           model,
#           as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
#           mode = "latent"
#         )
#       } else {
#         emmeans(
#           model,
#           as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
#           at = setNames(list(x_vals), x_var),
#           mode = "latent"
#         )
#       }
#       summary(emm, type = "response") %>%
#         mutate(
#           probabilite = plogis(emmean),
#           tendance = tendance_shoc_niv1,
#           x_level = factor(.data[[x_var]]),
#           variable = x_var
#         )
#     }
#   )
# 
#   # Cr√©er un graphique par variable
#   plots <- split(emm_all, emm_all$variable) %>%
#     imap(~ {
#       ggplot(.x, aes(
#         x = tendance,
#         y = probabilite,
#         color = x_level,
#         group = x_level
#       )) +
#         geom_line(linewidth = 1.2) +
#         geom_point(size = 2) +
#         scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
#         theme_bw() +
#         theme(
#           axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
#           legend.position = "bottom"
#         ) +
#         labs(
#           x = "Tendance SHOC",
#           y = "Probabilit√© pr√©dite",
#           color = "Niveau",
#           title = .y
#         )
#     })
# 
#   # Combiner les graphiques avec patchwork
#   wrap_plots(plots, ncol = 3, nrow = 4) +
#     plot_annotation(subtitle = subtitle) &
#     theme(legend.position = "top")
# }

# ruban error

# plot_clmm_predictions_multi_x <- function(
#   models,
#   x_values,
#   subtitle = NULL
# ) {
# 
#   emm_all <- purrr::imap_dfr(
#     models,
#     function(model, x_var) {
#       mf <- model.frame(model)
#       if (!x_var %in% names(mf)) {
#         stop(sprintf("La variable '%s' n'est pas dans le mod√®le.", x_var))
#       }
#       x_is_factor <- is.factor(mf[[x_var]])
#       x_vals <- x_values[[x_var]]
#       emm <- if (x_is_factor) {
#         emmeans(
#           model,
#           as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
#           mode = "latent"
#         )
#       } else {
#         emmeans(
#           model,
#           as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
#           at = setNames(list(x_vals), x_var),
#           mode = "latent"
#         )
#       }
#       emm_summary <- summary(emm, type = "response")
#       emm_summary %>%
#         mutate(
#           probabilite = plogis(emmean),
#           tendance = tendance_shoc_niv1,
#           x_level = factor(.data[[x_var]]),
#           variable = x_var,
#           lower = plogis(asymp.LCL),
#           upper = plogis(asymp.UCL)
#         )
#     }
#   )
# 
#   # Cr√©er un graphique par variable
#   plots <- split(emm_all, emm_all$variable) %>%
#     imap(~ {
#       p <- ggplot(.x, aes(
#         x = tendance,
#         y = probabilite,
#         color = x_level,
#         fill = x_level,
#         group = x_level
#       )) +
#         # Ruban d'erreur
#         geom_ribbon(
#           aes(ymin = lower, ymax = upper),
#           alpha = 0.2,
#           color = NA
#         ) +
#         # Points (toujours affich√©s)
#         geom_point(size = 2) +
#         # Ligne (seulement si plusieurs valeurs de tendance par x_level)
#         geom_line(linewidth = 1.2, data = function(d) {
#           d[!ave(d$tendance, d$x_level, FUN = function(x) length(x) < 2), ]
#         }) +
#         scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
#         scale_fill_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "fill") +
#         scale_color_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "color") +
#         theme_bw() +
#         theme(
#           axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
#           legend.position = "bottom"
#         ) +
#         labs(
#           x = "Tendance SHOC",
#           y = "Probabilit√© pr√©dite",
#           color = "Niveau",
#           fill = "Niveau",
#           title = .y
#         )
#       p
#     })
# 
#   # Combiner les graphiques avec patchwork
#   wrap_plots(plots, ncol = 3, nrow = 4) +
#     plot_annotation(subtitle = subtitle) &
#     theme(legend.position = "top")
# }

# ruban en ligne 

# plot_clmm_predictions_multi_x <- function(
#   models,
#   x_values,
#   subtitle = NULL
# ) {
#   emm_all <- purrr::imap_dfr(
#     models,
#     function(model, x_var) {
#       mf <- model.frame(model)
#       if (!x_var %in% names(mf)) {
#         stop(sprintf("La variable '%s' n'est pas dans le mod√®le.", x_var))
#       }
#       x_is_factor <- is.factor(mf[[x_var]])
#       x_vals <- x_values[[x_var]]
#       emm <- if (x_is_factor) {
#         emmeans(
#           model,
#           as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
#           mode = "latent"
#         )
#       } else {
#         emmeans(
#           model,
#           as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
#           at = setNames(list(x_vals), x_var),
#           mode = "latent"
#         )
#       }
#       emm_summary <- summary(emm, type = "response")
#       emm_summary %>%
#         mutate(
#           probabilite = plogis(emmean),
#           tendance = tendance_shoc_niv1,
#           x_level = factor(.data[[x_var]]),
#           variable = x_var,
#           lower = plogis(asymp.LCL),
#           upper = plogis(asymp.UCL)
#         )
#     }
#   )
# 
#   # Cr√©er un graphique par variable
#   plots <- split(emm_all, emm_all$variable) %>%
#     imap(~ {
#       p <- ggplot(.x, aes(
#         x = tendance,
#         y = probabilite,
#         color = x_level,
#         fill = x_level,
#         group = x_level
#       )) +
#         # Ruban d'erreur
#         geom_ribbon(
#           aes(ymin = lower, ymax = upper),
#           alpha = 0.2,
#           color = NA
#         ) +
#         # Lignes continues pour chaque niveau de x_level
#         geom_line(linewidth = 1.2) +
#         scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
#         scale_fill_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "fill") +
#         scale_color_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "color") +
#         theme_bw() +
#         theme(
#           axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
#           legend.position = "bottom"
#         ) +
#         labs(
#           x = "Tendance SHOC",
#           y = "Probabilit√© pr√©dite",
#           color = "",
#           fill = "",
#           title = .y
#         )
#       p
#     })
# 
#   # Combiner les graphiques avec patchwork
#   wrap_plots(plots, ncol = 3, nrow = 4) +
#     plot_annotation(subtitle = subtitle) &
#     theme(legend.position = "top")
# }

# p-value 

plot_clmm_predictions_multi_x <- function(
  models,
  x_values,
  subtitle = NULL
) {
  emm_all <- purrr::imap_dfr(
    models,
    function(model, x_var) {
      mf <- model.frame(model)
      if (!x_var %in% names(mf)) {
        stop(sprintf("La variable '%s' n'est pas dans le mod√®le.", x_var))
      }
      x_is_factor <- is.factor(mf[[x_var]])
      x_vals <- x_values[[x_var]]
      emm <- if (x_is_factor) {
        emmeans(
          model,
          as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
          mode = "latent"
        )
      } else {
        emmeans(
          model,
          as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
          at = setNames(list(x_vals), x_var),
          mode = "latent"
        )
      }
      emm_summary <- summary(emm, type = "response")
      emm_summary %>%
        mutate(
          probabilite = plogis(emmean),
          tendance = tendance_shoc_niv1,
          x_level = factor(.data[[x_var]]),
          variable = x_var,
          lower = plogis(asymp.LCL),
          upper = plogis(asymp.UCL),
          # Logique pour la significativit√© (exemple : si l'intervalle de confiance contient 0)
          significatif = !(asymp.LCL < 0 & asymp.UCL > 0)
        )
    }
  )

  # Cr√©er un graphique par variable
  plots <- split(emm_all, emm_all$variable) %>%
    imap(~ {
      # D√©terminer si toutes les interactions pour ce niveau sont non significatives
      all_non_significatif <- all(!.x$significatif)

      p <- ggplot(.x, aes(
        x = tendance,
        y = probabilite,
        color = x_level,
        group = x_level
      )) +
        # Ruban d'erreur
        geom_ribbon(
          aes(ymin = lower, ymax = upper, fill = x_level),
          alpha = 0.2,
          color = NA
        ) +
        # Lignes continues ou pointill√©es (selon la significativit√© globale)
        geom_line(
          aes(linetype = ifelse(all_non_significatif, "dashed", "solid")),
          linewidth = 1.2
        ) +
        scale_linetype_manual(values = c("solid" = "solid", "dashed" = "dashed")) +
        scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
        scale_fill_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "fill") +
        scale_color_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "color") +
        theme_bw() +
        theme(
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
          legend.position = "bottom"
        ) +
        labs(
          x = "Tendance SHOC",
          y = "Probabilit√© pr√©dite",
          color = "",
          fill = "",
          linetype = ifelse(all_non_significatif, "Non significatif", "Significatif"),
          title = .y
        )
      p
    })

  # Combiner les graphiques avec patchwork
  wrap_plots(plots, ncol = 3, nrow = 4) +
    plot_annotation(subtitle = subtitle) &
    theme(legend.position = "top")
}

# plot -------------------------------------------------------------------------

models <- list(
  abondance_log    = m_n1_trait_1int,
  popularite       = m_n1_trait_2int,
  detectabilite    = m_n1_trait_3int,
  # regime           = m_n1_trait_4int,
  # migrateur        = m_n1_trait_5int,
  # gregaire         = m_n1_trait_6int
  fauneFrance      = m_n1_trait_7int,
  pourcentage_stoc = m_n1_trait_8int,
  sexe             = m_n1_participant_1int,
  anciennete       = m_n1_participant_2int,
  expert           = m_n1_participant_3int
)

x_values <- list(
  abondance_log    = c(10, 13, 16),
  popularite       = NULL,
  detectabilite    = NULL,
  # regime           = NULL,
  # migrateur        = NULL,
  # gregaire         = NULL
  fauneFrance      = c(-1, 0, 2.5),
  pourcentage_stoc = c(-1, 0, 1.5),
  sexe = NULL,
  anciennete = c(0, 5, 40),
  expert = NULL
)

plot_clmm_predictions_multi_x(
  models = models,
  x_values = x_values,
  subtitle = "Proabilit√© cumulative d'√™tre dans une des cat√©gories sup√©rieures (niveau 1)"
)

```

### plot (response)

```{r}
#| eval: false
#| fig-height: 15
#| fig-width: 10
#| include: false


# p-value 

plot_clmm_predictions_multi_x <- function(
  models,
  x_values,
  subtitle = NULL
) {
  emm_all <- purrr::imap_dfr(
    models,
    function(model, x_var) {
      mf <- model.frame(model)
      if (!x_var %in% names(mf)) {
        stop(sprintf("La variable '%s' n'est pas dans le mod√®le.", x_var))
      }
      x_is_factor <- is.factor(mf[[x_var]])
      x_vals <- x_values[[x_var]]
      
emm <- if (x_is_factor) {
  emmeans(
    model,
    as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
    mode = "prob"
  )
} else {
  emmeans(
    model,
    as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
    at = setNames(list(x_vals), x_var),
    mode = "prob"
  )
}

# Extraire prob + IC
emm_summary <- as.data.frame(confint(emm))

# Ajouter la colonne cat√©gorie et covariables
categories <- levels(dt1$avis_niv1)  # ou unique() si non-facteur
emm_summary <- emm_summary %>%
  mutate(
    probabilite = prob,           # normalement la colonne issue de confint()
    lower = asymp.LCL,
    upper = asymp.UCL,
    categorie = factor(rep(categories, length.out = n())),
    tendance = tendance_shoc_niv1,
    x_level = factor(.data[[x_var]]),
    variable = x_var,
    significatif = !(asymp.LCL < 0 & asymp.UCL > 0)

  )




          # probabilite = plogis(emmean),
          # tendance = tendance_shoc_niv1,
          # x_level = factor(.data[[x_var]]),
          # variable = x_var,
          # lower = plogis(asymp.LCL),
          # upper = plogis(asymp.UCL),
          # # Logique pour la significativit√© (exemple : si l'intervalle de confiance contient 0)
          # significatif = !(asymp.LCL < 0 & asymp.UCL > 0)
        
    }
  )

  # Cr√©er un graphique par variable
  plots <- split(emm_all, emm_all$variable) %>%
    imap(~ {
      # D√©terminer si toutes les interactions pour ce niveau sont non significatives
      all_non_significatif <- all(!.x$significatif)

      p <- ggplot(.x, aes(
        x = tendance,
        y = probabilite,
        color = x_level,
        group = x_level
      )) +
        # Ruban d'erreur
        geom_ribbon(
          aes(ymin = lower, ymax = upper, fill = x_level),
          alpha = 0.2,
          color = NA
        ) +
        # Lignes continues ou pointill√©es (selon la significativit√© globale)
        geom_line(
          aes(linetype = ifelse(all_non_significatif, "dashed", "solid")),
          linewidth = 1.2
        ) +
        scale_linetype_manual(values = c("solid" = "solid", "dashed" = "dashed")) +
        # scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
        scale_fill_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "fill") +
        scale_color_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "color") +
        theme_bw() +
        theme(
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
          legend.position = "bottom"
        ) +
        labs(
          x = "Tendance SHOC",
          y = "Probabilit√© pr√©dite",
          color = "",
          fill = "",
          linetype = ifelse(all_non_significatif, "Non significatif", "Significatif"),
          title = .y
        )
      p
    })

  # Combiner les graphiques avec patchwork
  wrap_plots(plots, ncol = 3, nrow = 4) +
    plot_annotation(subtitle = subtitle) &
    theme(legend.position = "top")
}

# plot -------------------------------------------------------------------------

models <- list(
  abondance_log    = m_n1_trait_1int,
  popularite       = m_n1_trait_2int,
  detectabilite    = m_n1_trait_3int,
  # regime           = m_n1_trait_4int,
  # migrateur        = m_n1_trait_5int,
  # gregaire         = m_n1_trait_6int
  fauneFrance      = m_n1_trait_7int,
  pourcentage_stoc = m_n1_trait_8int,
  sexe             = m_n1_participant_1int,
  anciennete       = m_n1_participant_2int,
  expert           = m_n1_participant_3int
)

x_values <- list(
  abondance_log    = c(10, 13, 16),
  popularite       = NULL,
  detectabilite    = NULL,
  # regime           = NULL,
  # migrateur        = NULL,
  # gregaire         = NULL
  fauneFrance      = c(-1, 0, 2.5),
  pourcentage_stoc = c(-1, 0, 1.5),
  sexe = NULL,
  anciennete = c(0, 5, 40),
  expert = NULL
)

plot_clmm_predictions_multi_x(
  models = models,
  x_values = x_values,
  subtitle = "Probabilit√© pour chaque cat√©gorie (niveau 1)"
)

```

### 2 plot (response)

```{r}
#| eval: false
#| fig-height: 15
#| fig-width: 10
#| include: false


# p-value 

plot_clmm_predictions_multi_x <- function(
  models,
  x_values,
  subtitle = NULL
) {
  emm_all <- purrr::imap_dfr(
    models,
    function(model, x_var) {
      mf <- model.frame(model)
      if (!x_var %in% names(mf)) {
        stop(sprintf("La variable '%s' n'est pas dans le mod√®le.", x_var))
      }
      x_is_factor <- is.factor(mf[[x_var]])
      x_vals <- x_values[[x_var]]
      
emm <- if (x_is_factor) {
  emmeans(
    model,
    as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
    mode = "prob"
  )
} else {
  emmeans(
    model,
    as.formula(paste("~ tendance_shoc_niv1 |", x_var)),
    at = setNames(list(x_vals), x_var),
    mode = "prob"
  )
}

# Extraire prob + IC
emm_summary <- as.data.frame(confint(emm))

# Ajouter la colonne cat√©gorie et covariables
categories <- levels(dt1$avis_niv1)  # ou unique() si non-facteur
emm_df <- as.data.frame(emm)              # contient emmean et autres colonnes
emm_ci <- as.data.frame(confint(emm))     # contient asymp.LCL / asymp.UCL

emm_summary <- as.data.frame(emm, type = "response") %>%
  rename(probabilite = prob) %>%   # ou response selon la version
  mutate(
    tendance = tendance_shoc_niv1,  # <- cr√©er explicitement tendance
    categorie = factor(tendance_shoc_niv1),
    x_level = factor(.data[[x_var]]),
    variable = x_var,
    significatif = !(asymp.LCL < 0 & asymp.UCL > 0)

  )


# emm_summary <- emm_df %>%
#   bind_cols(emm_ci %>% select(asymp.LCL, asymp.UCL)) %>%
#   mutate(
#     probabilite = plogis(emmean),          # logits -> probabilit√©
#     lower = plogis(asymp.LCL),
#     upper = plogis(asymp.UCL),
#     categorie = factor(tendance_shoc_niv1),
#     tendance = tendance_shoc_niv1,
#     x_level = factor(.data[[x_var]]),
#     variable = x_var,
#     significatif = !(asymp.LCL < 0 & asymp.UCL > 0)
#   )






          # probabilite = plogis(emmean),
          # tendance = tendance_shoc_niv1,
          # x_level = factor(.data[[x_var]]),
          # variable = x_var,
          # lower = plogis(asymp.LCL),
          # upper = plogis(asymp.UCL),
          # # Logique pour la significativit√© (exemple : si l'intervalle de confiance contient 0)
          # significatif = !(asymp.LCL < 0 & asymp.UCL > 0)
        
    }
  )

  # Cr√©er un graphique par variable
  plots <- split(emm_all, emm_all$variable) %>%
    imap(~ {
      # D√©terminer si toutes les interactions pour ce niveau sont non significatives
      all_non_significatif <- all(!.x$significatif)

      p <- ggplot(.x, aes(
        x = tendance,
        y = probabilite,
        color = x_level,
        group = x_level
      )) +
        # Ruban d'erreur
        # geom_ribbon(
        #   aes(ymin = lower, ymax = upper, fill = x_level),
        #   alpha = 0.2,
        #   color = NA
        # ) +
        # Lignes continues ou pointill√©es (selon la significativit√© globale)
        geom_line(
          aes(linetype = ifelse(all_non_significatif, "dashed", "solid")),
          linewidth = 1.2
        ) +
        scale_linetype_manual(values = c("solid" = "solid", "dashed" = "dashed")) +
        # scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
        scale_fill_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "fill") +
        scale_color_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "color") +
        theme_bw() +
        theme(
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
          legend.position = "bottom"
        ) +
        labs(
          x = "Tendance SHOC",
          y = "Probabilit√© pr√©dite",
          color = "",
          fill = "",
          linetype = ifelse(all_non_significatif, "Non significatif", "Significatif"),
          title = .y
        )
      p
    })

  # Combiner les graphiques avec patchwork
  wrap_plots(plots, ncol = 3, nrow = 4) +
    plot_annotation(subtitle = subtitle) &
    theme(legend.position = "top")
}

# plot -------------------------------------------------------------------------

models <- list(
  abondance_log    = m_n1_trait_1int,
  popularite       = m_n1_trait_2int,
  detectabilite    = m_n1_trait_3int,
  # regime           = m_n1_trait_4int,
  # migrateur        = m_n1_trait_5int,
  # gregaire         = m_n1_trait_6int
  fauneFrance      = m_n1_trait_7int,
  pourcentage_stoc = m_n1_trait_8int,
  sexe             = m_n1_participant_1int,
  anciennete       = m_n1_participant_2int,
  expert           = m_n1_participant_3int
)

x_values <- list(
  abondance_log    = c(10, 13, 16),
  popularite       = NULL,
  detectabilite    = NULL,
  # regime           = NULL,
  # migrateur        = NULL,
  # gregaire         = NULL
  fauneFrance      = c(-1, 0, 2.5),
  pourcentage_stoc = c(-1, 0, 1.5),
  sexe = NULL,
  anciennete = c(0, 5, 40),
  expert = NULL
)

plot_clmm_predictions_multi_x(
  models = models,
  x_values = x_values,
  subtitle = "Probabilit√© pour chaque cat√©gorie (niveau 1)"
)

```


### 3 plot (response)

```{r}
#| eval: false
#| fig-height: 15
#| fig-width: 10
#| include: false


predict_clmm_multi <- function(
  models,
  x_values,
  response_levels,
  n_boot = 500,
  seed = 123
) {

  library(dplyr)
  library(tidyr)
  library(purrr)

  set.seed(seed)

  # =========================
  # fonctions internes
  # =========================

  make_newdata <- function(model, x_var, x_vals) {
    mf <- model.frame(model)
    nd <- mf[rep(1, length(x_vals)), , drop = FALSE]
    nd[[x_var]] <- x_vals
    nd
  }

  predict_prob <- function(model, newdata) {
    p <- predict(model, newdata = newdata, type = "prob")
    as.data.frame(p)
  }

  # =========================
  # pr√©dictions + bootstrap
  # =========================

  results <- imap_dfr(
    models,
    function(model, x_var) {

      x_vals <- x_values[[x_var]]
      if (is.null(x_vals)) stop(paste("x_values manquant pour", x_var))

      nd <- make_newdata(model, x_var, x_vals)

      # pr√©diction point
      p_hat <- predict_prob(model, nd)

      base <- p_hat %>%
        mutate(x_level = rep(x_vals, each = length(response_levels))) %>%
        pivot_longer(
          cols = everything(),
          names_to = "categorie",
          values_to = "probabilite"
        )

      # bootstrap
      boot_mat <- replicate(n_boot, {
        b <- sample(seq_len(nrow(model$frame)), replace = TRUE)
        mod_b <- suppressWarnings(update(model, data = model$frame[b, ]))
        predict_prob(mod_b, nd)
      }, simplify = FALSE)

      boot_df <- bind_rows(boot_mat, .id = "boot") %>%
        mutate(x_level = rep(x_vals, times = n_boot, each = length(response_levels))) %>%
        pivot_longer(
          cols = -c(boot, x_level),
          names_to = "categorie",
          values_to = "prob"
        )

      ci <- boot_df %>%
        group_by(x_level, categorie) %>%
        summarise(
          lower = quantile(prob, 0.025),
          upper = quantile(prob, 0.975),
          .groups = "drop"
        )

      base %>%
        left_join(ci, by = c("x_level", "categorie")) %>%
        mutate(
          variable = x_var
        )
    }
  )

  results
}

plot_clmm_probs <- function(pred_df) {

  library(ggplot2)

  ggplot(
    pred_df,
    aes(
      x = x_level,
      y = probabilite,
      group = categorie,
      color = categorie
    )
  ) +
    geom_ribbon(
      aes(ymin = lower, ymax = upper, fill = categorie),
      alpha = 0.2,
      color = NA
    ) +
    geom_line(linewidth = 1.1) +
    geom_point(size = 2) +
    facet_grid(
      categorie ~ variable,
      scales = "free_x"
    ) +
    scale_y_continuous(
      labels = scales::percent,
      limits = c(0, 1)
    ) +
    theme_bw() +
    theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 45, hjust = 1)
    ) +
    labs(
      x = "Valeur du pr√©dicteur",
      y = "Probabilit√© pr√©dite"
    )
}

contrast_probabilities <- function(pred_df, ref_level) {

  pred_df %>%
    group_by(variable, categorie) %>%
    mutate(
      ref_prob = probabilite[x_level == ref_level],
      ref_lower = lower[x_level == ref_level],
      ref_upper = upper[x_level == ref_level]
    ) %>%
    ungroup() %>%
    filter(x_level != ref_level) %>%
    mutate(
      diff = probabilite - ref_prob,
      diff_lower = lower - ref_upper,
      diff_upper = upper - ref_lower,
      significatif = !(diff_lower < 0 & diff_upper > 0)
    )
}

make_publication_table <- function(pred_df) {

  pred_df %>%
    mutate(
      estimate = sprintf(
        "%.2f [%.2f ; %.2f]",
        probabilite * 100,
        lower * 100,
        upper * 100
      )
    ) %>%
    select(
      variable,
      categorie,
      x_level,
      estimate
    ) %>%
    pivot_wider(
      names_from = x_level,
      values_from = estimate
    ) %>%
    arrange(variable, categorie)
}

models <- list(
  abondance_log    = m_n1_trait_1int,
  popularite       = m_n1_trait_2int,
  detectabilite    = m_n1_trait_3int,
  # regime           = m_n1_trait_4int,
  # migrateur        = m_n1_trait_5int,
  # gregaire         = m_n1_trait_6int
  fauneFrance      = m_n1_trait_7int,
  pourcentage_stoc = m_n1_trait_8int,
  sexe             = m_n1_participant_1int,
  anciennete       = m_n1_participant_2int,
  expert           = m_n1_participant_3int
)

x_values <- list(
  abondance_log    = c(10, 13, 16),
  popularite       = NULL,
  detectabilite    = NULL,
  # regime           = NULL,
  # migrateur        = NULL,
  # gregaire         = NULL
  fauneFrance      = c(-1, 0, 2.5),
  pourcentage_stoc = c(-1, 0, 1.5),
  sexe = NULL,
  anciennete = c(0, 5, 40),
  expert = NULL
)

pred <- predict_clmm_multi(
  models = models,
  x_values = x_values,
  response_levels = levels(dt1$avis_niv1),
  n_boot = 500
)

plot_clmm_probs(pred)

table_pub <- make_publication_table(pred)
table_pub



```

### espece + participant

```{r}
#| eval: false
#| include: false

# m_n1_trait_participant_allint <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
#                     abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
#                       sexe + anciennete + expert +
                    # tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + migrateur + gregaire + sexe + anciennete + expert + fauneFrance + pourcentage_stoc) + (1 | email), data = dt1, link = "logit", Hess = TRUE)
# m_n1_trait_participant_allint_1 <- clmm(avis_niv1 ~ tendance_shoc_niv1 +
#                     abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
#                       sexe + anciennete + expert +
#                     tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + migrateur + gregaire) + (1 | email),
#                     data = dt1, link = "logit", Hess = TRUE)
# m_n1_trait_participant_allint_2 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
#                     abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
#                       sexe + anciennete + expert +
#                     tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + migrateur + gregaire + sexe) + (1 | email), 
#                     data = dt1, link = "logit", Hess = TRUE)
# 
# m_n1_trait_participant_allint_3 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
#                     abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
#                       sexe + anciennete + expert +
#                     tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + migrateur + gregaire + sexe + anciennete) + (1 | email), 
#                     data = dt1, link = "logit", Hess = TRUE)
# m_n1_trait_participant_allint_4 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
#                     abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
#                       sexe + anciennete + expert +
#                     tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + migrateur + gregaire + sexe + expert) + (1 | email), 
#                     data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_participant_allint_5 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
                      sexe + anciennete + expert +
                    tendance_shoc_niv1:(sexe + anciennete + expert) + (1 | email), data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_participant_allint_6 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
                      sexe + anciennete + expert +
                    tendance_shoc_niv1:(sexe + anciennete + expert + fauneFrance + pourcentage_stoc) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_participant_allint_7 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
                      sexe + anciennete + expert + tendance_shoc_niv1:(sexe + anciennete + expert) + 
                      (1 | email), data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_participant_allint_8 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
                      sexe + anciennete + expert + tendance_shoc_niv1:(sexe + anciennete + expert + fauneFrance) + 
                      (1 | email), data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_participant_allint_9 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
                      sexe + anciennete + expert + tendance_shoc_niv1:(sexe + anciennete + expert + pourcentage_stoc) + 
                      (1 | email), data = dt1, link = "logit", Hess = TRUE)


m_n1_trait_participant_allint_10 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + pourcentage_stoc + 
                      sexe + anciennete + expert + 
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + pourcentage_stoc + 
                                          sexe + anciennete + expert) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)

m_n1_trait_participant_allint_11 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + pourcentage_stoc + 
                      sexe + anciennete +  
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + pourcentage_stoc + 
                                          sexe + anciennete) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)

m_n1_trait_participant_allint_12 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + pourcentage_stoc + 
                      sexe +  
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + pourcentage_stoc + 
                                          sexe) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)

m_n1_trait_participant_allint_13 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + pourcentage_stoc + 
                      sexe + anciennete + expert + 
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + pourcentage_stoc + 
                                          sexe + anciennete) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)

m_n1_trait_participant_allint_14 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + pourcentage_stoc + 
                      sexe + anciennete + expert + 
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + pourcentage_stoc + 
                                          sexe + expert) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)

m_n1_trait_participant_allint_15 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + pourcentage_stoc + 
                      sexe + anciennete + expert + 
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + pourcentage_stoc + 
                                          sexe) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)

m_n1_trait_participant_allint_16 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + pourcentage_stoc + 
                      sexe + anciennete + expert +
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + pourcentage_stoc + 
                                          sexe + anciennete) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)

m_n1_trait_participant_allint_17 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + pourcentage_stoc + 
                      sexe +   
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + pourcentage_stoc + 
                                          sexe) + (1 | email), 
                    data = dt1, link = "logit", Hess = TRUE)


# au propre 

m_n1_0 <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    (1 | email), data = dt1, link = "logit")

m_n1_abondance_log <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(abondance_log) +
    (1 | email), data = dt1, link = "logit")

m_n1_popularite <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(popularite) +
    (1 | email), data = dt1, link = "logit")

m_n1_detectabilite <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(detectabilite) +
    (1 | email), data = dt1, link = "logit")

# m_n1_migrateur <- clmm(
#   avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
#     sexe + anciennete + expert +
#     tendance_shoc_niv1:(migrateur) +
#     (1 | email), data = dt1, link = "logit")

m_n1_gregaire <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime +  popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(gregaire) +
    (1 | email), data = dt1, link = "logit")

m_n1_fauneFrance <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(fauneFrance) +
    (1 | email), data = dt1, link = "logit")

m_n1_pourcentage_stoc <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(pourcentage_stoc) +
    (1 | email), data = dt1, link = "logit")

m_n1_sexe <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(sexe) +
    (1 | email), data = dt1, link = "logit")

m_n1_anciennete <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(anciennete) +
    (1 | email), data = dt1, link = "logit")

m_n1_expert <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime + popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(expert) +
    (1 | email), data = dt1, link = "logit")





m_n1_gregaire_abondance_log <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime +  popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(gregaire + abondance_log) +
    (1 | email), data = dt1, link = "logit")

m_n1_gregaire_popularite <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime +  popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(gregaire + popularite) +
    (1 | email), data = dt1, link = "logit")

m_n1_gregaire_detectabilite <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime +  popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(gregaire + detectabilite) +
    (1 | email), data = dt1, link = "logit")

# m_n1_gregaire_migrateur <- clmm(
#   avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime +  popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
#     sexe + anciennete + expert +
#     tendance_shoc_niv1:(gregaire + migrateur) +
#     (1 | email), data = dt1, link = "logit")

m_n1_gregaire_fauneFrance <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime +  popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(gregaire + fauneFrance) +
    (1 | email), data = dt1, link = "logit")

m_n1_gregaire_pourcentage_stoc <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime +  popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(gregaire + pourcentage_stoc) +
    (1 | email), data = dt1, link = "logit")

m_n1_gregaire_sexe <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime +  popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(gregaire + sexe) +
    (1 | email), data = dt1, link = "logit")

m_n1_gregaire_anciennete <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime +  popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(gregaire + anciennete) +
    (1 | email), data = dt1, link = "logit")

m_n1_gregaire_expert <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + abondance_log + regime +  popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc +
    sexe + anciennete + expert +
    tendance_shoc_niv1:(gregaire + expert) +
    (1 | email), data = dt1, link = "logit")

```

```{r}
#| echo: false
AIC_dt_all_n1 <- as.data.frame(AIC(m_n1_base,
                                   m_n1_trait_1, m_n1_trait_2, m_n1_trait_3, m_n1_trait_4, m_n1_trait_5, m_n1_trait_6,
                                   m_n1_trait_1int, m_n1_trait_2int, m_n1_trait_3int, m_n1_trait_4int, m_n1_trait_5int, m_n1_trait_6int,
                                   m_n1_trait_all, 
                                   m_n1_trait_allint, 
                                   m_n1_participant_1, m_n1_participant_2, m_n1_participant_3,
                                   m_n1_participant_1int, m_n1_participant_2int, m_n1_participant_3int,
                                   m_n1_participant_all, m_n1_participant_allint,
                                   m_n1_0,m_n1_abondance_log,m_n1_popularite,m_n1_detectabilite,
                                   # m_n1_migrateur,
                                   m_n1_gregaire,m_n1_fauneFrance,
                                   m_n1_pourcentage_stoc,m_n1_sexe,m_n1_anciennete,m_n1_expert))

AIC_dt_all_n1 <- AIC_dt_all_n1 %>% 
  arrange(AIC) ; AIC_dt_all_n1

summary(m_n1_trait_participant_allint_11)
```

```{r}
#| echo: false
AIC_dt_all_n1 <- as.data.frame(AIC(m_n1_base,
                                   m_n1_trait_1, m_n1_trait_2, m_n1_trait_3, m_n1_trait_4, m_n1_trait_5, m_n1_trait_6,
                                   m_n1_trait_1int, m_n1_trait_2int, m_n1_trait_3int, m_n1_trait_4int, m_n1_trait_5int, m_n1_trait_6int,
                                   m_n1_trait_all, m_n1_trait_allint, 
                                   m_n1_participant_1, m_n1_participant_2, m_n1_participant_3,
                                   m_n1_participant_1int, m_n1_participant_2int, m_n1_participant_3int,
                                   m_n1_participant_all, m_n1_participant_allint,
                                   m_n1_trait_participant_allint_5, m_n1_trait_participant_allint_6,
                                   m_n1_trait_participant_allint_7, m_n1_trait_participant_allint_8, m_n1_trait_participant_allint_9,
                                   m_n1_trait_participant_allint_10, m_n1_trait_participant_allint_11, m_n1_trait_participant_allint_12,
                                   m_n1_trait_participant_allint_13, m_n1_trait_participant_allint_14, m_n1_trait_participant_allint_15,
                                   m_n1_trait_participant_allint_16, m_n1_trait_participant_allint_17))

AIC_dt_all_n1 <- AIC_dt_all_n1 %>% 
  arrange(AIC) ; AIC_dt_all_n1

summary(m_n1_trait_participant_allint_11)
```

```{r}
#| fig-height: 7
#| fig-width: 10

# R√©cup√©ration des coefficients, erreurs standards et p-values depuis le summary
coefs <- summary(m_n1_trait_participant_allint_3)$coefficients
coef_df <- data.frame(
  Term = rownames(coefs),
  Estimate = coefs[, "Estimate"],
  Std.Error = coefs[, "Std. Error"],
  p.value = coefs[, "Pr(>|z|)"]
)

# Filtrer les "Threshold coefficients" (lignes contenant "|")
coef_df <- coef_df %>%
  filter(!grepl("\\|", Term))

# Ajout d'une colonne pour indiquer si le coefficient est significatif
coef_df$significatif <- ifelse(coef_df$p.value < 0.05, "Oui", "Non")

# Ajout d'une colonne pour distinguer les variables, tendances, interactions et interactions de type Q
coef_df$Type <- case_when(
  grepl("^tendance_shoc_niv1\\.[LQ]$", coef_df$Term) ~ "Tendance SHOC",
  grepl("tendance_shoc_niv1\\.Q:", coef_df$Term) ~ "Interaction avec SHOC (quadratique)",
  grepl(":", coef_df$Term) ~ "Interaction avec SHOC (lin√©aire)",
  TRUE ~ "Variable"
)

# Nettoyage des noms de termes (optionnel)
coef_df$Term <- gsub("tendance_shoc_niv1\\.", "tendance_shoc_niv1_", coef_df$Term)
coef_df$Term <- gsub("\\:", "_", coef_df$Term)

# D√©finir l'ordre des facettes
coef_df$Type <- factor(coef_df$Type, levels = c("Tendance SHOC", "Variable", 
                                                "Interaction avec SHOC (lin√©aire)", "Interaction avec SHOC (quadratique)"))

coef_df$Term[coef_df$Term == "tendance_shoc_niv1_L"] <- "lin√©aire"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_Q"] <- "quadratique"
coef_df$Term[coef_df$Term == "abondance_log"] <- "Abondance"
coef_df$Term[coef_df$Term == "regimeInsectivore"] <- "Regime (insectivore)"
coef_df$Term[coef_df$Term == "regimeOmnivore"] <- "Regime (omnivore)"
coef_df$Term[coef_df$Term == "populariteOui"] <- "Popularite (oui)"
coef_df$Term[coef_df$Term == "populariteNon"] <- "Popularite (non)"
coef_df$Term[coef_df$Term == "detectabiliteForte"] <- "Detectabilite (forte)"
coef_df$Term[coef_df$Term == "migrateurOui"] <- "Migrateur (oui)"
coef_df$Term[coef_df$Term == "migrateurPartiel"] <- "Migrateur (partiel)"
coef_df$Term[coef_df$Term == "pourcentage_stoc"] <- " STOC"
coef_df$Term[coef_df$Term == "gregaireOui"] <- "Gregaire (oui)"
coef_df$Term[coef_df$Term == "fauneFrance"] <- "Faune-France"
coef_df$Term[coef_df$Term == "sexeH"] <- "Sexe (homme)"
coef_df$Term[coef_df$Term == "sexeF"] <- "Sexe (femme)"
coef_df$Term[coef_df$Term == "anciennete"] <- "Anciennete"
coef_df$Term[coef_df$Term == "expertOui"] <- "Expert (Oui)"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_L_abondance_log"] <- ": Abondance"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_Q_abondance_log"] <- ": Abondance"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_L_populariteOui"] <- ": Popularit√© (oui)"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_Q_populariteOui"] <- ": Popularit√© (oui)"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_L_detectabiliteForte"] <- ": D√©tectabilit√© (forte)"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_Q_detectabiliteForte"] <- ": D√©tectabilit√© (forte)"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_L_regimeInsectivore"] <- ": R√©gime (insectivore)"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_L_regimeOmnivore"] <- ": R√©gime (omnivore)"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_L_migrateurPartiel"] <- ": Migrateur (partiel)"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_L_sexeH"] <- ": Sexe (homme)"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_Q_sexeH"] <- ": Sexe (homme)"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_L_anciennete"] <- ": Anciennet√©"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_Q_anciennete"] <- ": Anciennet√©"
coef_df$Term[coef_df$Term == "tendance_shoc_niv1_Q_sexeH"] <- ": Anciennet√©"

# Trier les termes par ordre alphab√©tique dans chaque facette
coef_df <- coef_df %>%
  group_by(Type) %>%
  mutate(Term = factor(Term, levels = sort(unique(Term)))) %>%
  ungroup()

# coef_df <- coef_df %>%
#   group_by(Type) %>%
#   arrange(Term) %>%
#   ungroup()
# 
# coef_df <- coef_df %>%
#   group_by(Type) %>%
#   arrange(Estimate)

# coef_df$Term = with(coef_df, reorder(Term, Estimate))
coef_df %>% 
  group_by(Type) %>% 
  mutate(Term = fct_reorder(Term, Estimate, .fun='median')) %>% 
  ggplot(aes(x = Estimate, y = reorder(Term, Estimate))) +
  geom_errorbarh(
    aes(xmin = Estimate - 1.96 * Std.Error,
        xmax = Estimate + 1.96 * Std.Error),
    height = 0,
    color = "black"
  ) +
  geom_point(
    aes(shape = significatif, fill = significatif),
    size = 3,
    color = "black"
  ) +
  scale_shape_manual(
    values = c("Oui" = 21, "Non" = 21)
  ) +
  scale_fill_manual(
    values = c("Oui" = "black", "Non" = "white")
  ) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "grey", size = 1) +
  scale_x_continuous(breaks = seq(-100, 100, by = 5)) + 
  facet_wrap(~ Type, scales = "free", ncol = 2) +
  labs(
    x = "Valeur du coefficient",
    y = "Variable",
    title = "Coefficients du mod√®le et intervalles de confiance √† 95%",
    shape = "Significatif",
    fill = "Significatif"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 8),
    legend.position = "bottom"
  )



```



**Interpr√©tation** 

1Ô∏è‚É£ Ce que mod√©lise exactement ce CLMM

Variable r√©ponse : avis_niv1
‚Üí variable ordinale √† 3 niveaux (D√©clin < Stable < Augmentation).

Mod√®le : Cumulative Link Mixed Model
‚Üí on mod√©lise la probabilit√© cumul√©e d‚Äô√™tre dans une cat√©gorie plus √©lev√©e.

Effet al√©atoire : (1 | email)
‚Üí chaque r√©pondant a une propension personnelle √† r√©pondre plus pessimiste/optimiste
‚Üí variance = 0.45, non n√©gligeable ‚Üí bon choix de mod√®le mixte.

2Ô∏è‚É£ Comment lire un coefficient dans ce type de mod√®le

üëâ Signe du coefficient

positif ‚Üí augmente la probabilit√© d‚Äôun avis plus favorable (vers Augmentation)

n√©gatif ‚Üí pousse vers un avis plus d√©favorable (D√©clin)

üëâ Attention

Les coefficients sont sur l‚Äô√©chelle du log-odds cumulatif

Leur valeur absolue n‚Äôest pas directement intuitive

Les interactions sont centrales ici ‚Üí les effets simples ne s‚Äôinterpr√®tent jamais seuls

3Ô∏è‚É£ Effet cl√© : tendance_shoc_niv1

Tu as cod√© cette variable comme ordinale polynomiale :

.L = tendance lin√©aire

.Q = tendance quadratique

Effets principaux
tendance_shoc_niv1.L  = -32.6 ***
tendance_shoc_niv1.Q  = +8.2  ***


üëâ Interpr√©tation

Plus la tendance SHOC est per√ßue comme n√©gative, plus l‚Äôavis est tr√®s fortement tir√© vers le d√©clin

L‚Äôeffet n‚Äôest pas lin√©aire : il y a une courbure importante (Q significatif)

‚ö†Ô∏è MAIS : ces effets sont massivement modul√©s par les interactions ‚Üí ils ne valent que pour la modalit√© de r√©f√©rence de toutes les autres variables.

4Ô∏è‚É£ Effets principaux des esp√®ces (hors interactions)

√Ä lire comme des biais syst√©matiques ind√©pendants de SHOC :

Effets allant vers Augmentation

regimeInsectivore +++

populariteOui +++

detectabiliteForte +++

migrateurOui / Partiel +++

pourcentage_stoc +

sexeH +

üëâ Ces esp√®ces (ou r√©pondants) sont structurellement jug√©s plus positivement

Effets allant vers D√©clin

abondance_log ---

gregaireOui ---

fauneFrance ---

üëâ Plus une esp√®ce est abondante, gr√©gaire ou bien connue, plus l‚Äôavis est s√©v√®re
‚Üí biais classique de baseline shifting / exigence accrue

Effets non significatifs

anciennete

expert

üëâ Pas de diff√©rence nette d‚Äôavis entre experts et non-experts, ni selon l‚Äôanciennet√© en moyenne

5Ô∏è‚É£ Le c≈ìur du mod√®le : les interactions avec tendance_shoc_niv1

C‚Äôest l√† que ton mod√®le devient int√©ressant scientifiquement.

Exemple cl√© : abondance
tendance.L : abondance_log   +++
tendance.Q : abondance_log   ---


üëâ Lecture

Quand la tendance SHOC devient n√©gative :

les esp√®ces abondantes sont encore plus p√©nalis√©es

effet non lin√©aire
‚Üí les r√©pondants semblent dire :

‚ÄúSi m√™me une esp√®ce abondante d√©cline, alors c‚Äôest tr√®s grave.‚Äù

Popularit√©
tendance.L : populariteOui   ---
tendance.Q : populariteOui   +++


üëâ Les esp√®ces populaires :

b√©n√©ficient d‚Äôun effet de seuil

mais subissent une chute brutale quand SHOC est n√©gatif

R√©gime alimentaire
tendance.L : Insectivore  ---
tendance.L : Omnivore     ---


üëâ Les insectivores (et omnivores) :

sont beaucoup plus sensibles √† une tendance SHOC n√©gative

signal per√ßu comme √©cologiquement alarmant

Migration
tendance.L : migrateurPartiel  ---


üëâ Les migrateurs partiels :

subissent une surp√©nalisation d√®s que SHOC se d√©grade

Sexe et anciennet√©
tendance.L : sexeH        +
tendance.L : anciennete  +


üëâ Les hommes et les r√©pondants exp√©riment√©s :

r√©agissent plus fortement √† la d√©gradation SHOC

mais pas de diff√©rence moyenne, seulement dans la r√©action au signal

6Ô∏è‚É£ Seuils (thresholds)
D√©clin | Stable        = -14.1
Stable | Augmentation  = -10.8


üëâ Ces valeurs indiquent que :

il faut une tr√®s forte combinaison d‚Äôeffets positifs pour atteindre Augmentation

le mod√®le est asym√©trique, avec un biais structurel vers D√©clin

üëâ Coh√©rent avec :

une variable r√©ponse d√©s√©quilibr√©e

ou une perception globalement pessimiste

7Ô∏è‚É£ Message scientifique synth√©tique (si tu dois l‚Äô√©crire)

Les avis ne d√©pendent pas seulement de la tendance observ√©e (SHOC), mais de la coh√©rence per√ßue entre cette tendance et les caract√©ristiques √©cologiques de l‚Äôesp√®ce.
Une d√©gradation est jug√©e d‚Äôautant plus s√©v√®rement qu‚Äôelle concerne une esp√®ce abondante, populaire, insectivore ou migratrice, sugg√©rant un raisonnement fond√© sur la plausibilit√© √©cologique et la gravit√© implicite du signal.

### simplifi√© comme il faut

```{r}
library(ordinal)

run_clmm_moderators <- function(
  data,
  response,
  focal,
  moderators,
  random_effect,
  link = "logit"
) {

  models <- list()

  for (mod in moderators) {
    
    print(mod)
    df <- data

    # Centrage automatique si variable num√©rique
    if (is.numeric(df[[mod]])) {
      mod_c <- paste0(mod, "_c")
      df[[mod_c]] <- scale(df[[mod]], scale = FALSE)
      mod_term <- mod_c
    } else {
      mod_term <- mod
    }

    # Formule : 1 mod√©rateur √† la fois
    form <- as.formula(
      paste0(
        response, " ~ ",
        focal, " * ", mod_term,
        " + (1 | ", random_effect, ")"
      )
    )

    # Ajustement du mod√®le
    models[[mod]] <- clmm(
      formula = form,
      data = df,
      link = link,
      Hess = TRUE
    )
  }

  return(models)
}

moderateurs <- c(
  "abondance_log",
  "popularite",
  "detectabilite",
  "regime",
  # "migrateur",
  "migrateur_simplifie",
  "gregaire",
  "fauneFrance",
  "pourcentage_stoc",
  "sexe",
  "anciennete",
  "expert",
  # "fluctuante"
)

models_mod <- run_clmm_moderators(
  data = dt1,
  response = "avis_niv1",
  focal = "tendance_shoc_niv1",
  moderators = moderateurs,
  random_effect = "email"
)

AICs <- sapply(models_mod, AIC)
sort(AICs)

library(MuMIn)
AICcs <- sapply(models_mod, AICc)
sort(AICcs)

m0 <- clmm(
  avis_niv1 ~ tendance_shoc_niv1 + (1 | email),
  data = dt1,
  link = "logit",
  Hess = TRUE
)

AICc(c(m0, models_mod))

```


## niv 2

### donn√©es

```{r}
#| include: false

dt2 <- dataset %>% 
  dplyr::select("email","espece","avis_niv2","migrateur","regime",
                "detectabilite","gregaire","popularite",
                "abondance_log","departement","sexe",
                "anciennete","region","bioregion","expert",
                "tendances_stoc", "pourcentage_stoc", "fauneFrance",
                "tendance_shoc_niv2") %>% 
  filter(avis_niv2 != "Fluctuante",
         avis_niv2 != "Incertain") %>% 
  filter(tendance_shoc_niv2 != "Fluctuante",
         tendance_shoc_niv2 != "Incertain") %>%
  na.omit()

unique(dt2$avis_niv2)

dt2 <- dt2 %>%
  mutate(
    avis_niv2 = factor(
      avis_niv2,
      levels = c("D√©clin fort", "D√©clin mod√©r√© √† fort", "D√©clin mod√©r√©", 
                 "Stable", 
                 "Augmentation mod√©r√©", "Augmentation mod√©r√© √† fort", "Augmentation fort"),
      ordered = TRUE
    ),
    tendance_shoc_niv2 = factor(
      tendance_shoc_niv2,
      levels = c("D√©clin fort", "D√©clin mod√©r√© √† fort", "D√©clin mod√©r√©", 
                 "Stable", 
                 "Augmentation mod√©r√©", "Augmentation mod√©r√© √† fort", "Augmentation fort"),
      ordered = TRUE
    )
  ) %>% 
  na.omit()

dt2 <- dt2 %>%
  mutate(
    # popularite    = factor(popularite),
    # detectabilite = factor(detectabilite),
    sexe = factor(sexe),
    expert = factor(expert)
  )
```

### al√©atoire

```{r}
#| include: false

m_n2.1 <- clmm(avis_niv2 ~ 1 + (1 | email), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
m_n2.2 <- clmm(avis_niv2 ~ 1 + (1 | region), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
m_n2.3 <- clmm(avis_niv2 ~ 1 + (1 | bioregion), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
m_n2.4 <- clmm(avis_niv2 ~ 1 + (1 | departement), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
m_n2.5 <- clmm(avis_niv2 ~ 1 + (1 | email) + (1 | region), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
m_n2.6 <- clmm(avis_niv2 ~ 1 + (1 | email) + (1 | bioregion), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
m_n2.7 <- clmm(avis_niv2 ~ 1 + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
```

```{r}
#| echo: false

AIC_dt_n2_aleatoire <- as.data.frame(AIC(m_n2.1, m_n2.2, m_n2.3, m_n2.4, m_n2.5, m_n2.6, m_n2.7))

AIC_dt_n2_aleatoire <- AIC_dt_n2_aleatoire %>% 
  arrange(AIC) ; AIC_dt_n2_aleatoire

summary(m_n2.1)
```

### base

```{r}
#| include: false
m_n2_base <- clmm(avis_niv2 ~ tendance_shoc_niv2 + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
```

```{r}
#| eval: false
#| include: false
summary(m_n2_base)
```

### espece

```{r}
#| eval: false
#| include: false

m_n2_esp <- clmm(avis_niv2 ~ tendance_shoc_niv2*espece + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
summary(m_n2_esp)
```

### trait

```{r}
#| eval: false
#| include: false

# abondance ***
m_n2_trait_2 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + abondance_log + (1 | email) + (1 | departement), 
                     data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_2, m_n2_base)
# m_n2_trait_2int <- clmm(avis_niv2 ~ tendance_shoc_niv2*abondance_log + (1 | email) + (1 | departement), 
# data = dt2, link = "logit", Hess = TRUE)
# anova(m_n2_trait_2, m_n2_trait_2int)

# popularite *** int ***
m_n2_trait_3 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + popularite + (1 | email) + (1 | departement), 
                     data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_3, m_n2_base)
m_n2_trait_3int <- clmm(avis_niv2 ~ tendance_shoc_niv2*popularite + (1 | email) + (1 | departement), 
                        data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_3, m_n2_trait_3int) 

# detectabilite *** int ***
m_n2_trait_4 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + detectabilite + (1 | email) + (1 | departement), 
                     data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_4, m_n2_base)
m_n2_trait_4int <- clmm(avis_niv2 ~ tendance_shoc_niv2*detectabilite + (1 | email) + (1 | departement), 
                        data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_4, m_n2_trait_4int) 

# regime ***
m_n2_trait_5 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + regime + (1 | email) + (1 | departement), 
                     data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_5, m_n2_base)
m_n2_trait_5int <- clmm(avis_niv2 ~ tendance_shoc_niv2*regime + (1 | email) + (1 | departement), 
                        data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_5, m_n2_trait_5int)

# migrateur *** int ***
m_n2_trait_6 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + migrateur + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_6, m_n2_base)
m_n2_trait_6int <- clmm(avis_niv2 ~ tendance_shoc_niv2*migrateur + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_6, m_n2_trait_6int) 

# gregaire *** int ***
m_n2_trait_7 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + gregaire + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_7, m_n2_base)
m_n2_trait_7int <- clmm(avis_niv2 ~ tendance_shoc_niv2*gregaire + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_7, m_n2_trait_7int) 

# fauneFrance *** int ***
m_n2_trait_8 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + fauneFrance + (1 | email), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_8, m_n2_base)
m_n2_trait_8int <- clmm(avis_niv2 ~ tendance_shoc_niv2*fauneFrance + (1 | email), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_8, m_n2_trait_8int)

# pourcentage_stoc *** int ***
m_n2_trait_9 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + pourcentage_stoc + (1 | email), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_9, m_n2_base)
m_n2_trait_9int <- clmm(avis_niv2 ~ tendance_shoc_niv2*pourcentage_stoc + (1 | email), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_trait_9, m_n2_trait_9int)

# all
m_n2_trait_all <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
                    abondance_log + popularite + detectabilite + regime + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
# m_n2_trait_allint <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
#                     abondance_log + regime + 
#                       popularite + detectabilite + migrateur + gregaire + fauneFrance + pourcentage_stoc + 
#                     tendance_shoc_niv2:(popularite + detectabilite + fauneFrance + pourcentage_stoc) + 
#                     (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
m_n2_trait_allint_2 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
                    abondance_log + regime + 
                      popularite + detectabilite + migrateur + gregaire + 
                    tendance_shoc_niv2:(popularite + migrateur) + 
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
m_n2_trait_allint_3 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
                    abondance_log + regime + 
                      popularite + detectabilite + migrateur + gregaire + 
                    tendance_shoc_niv2:(popularite + gregaire) + 
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
# m_n2_trait_allint_4 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
#                     abondance_log + regime + 
#                       popularite + detectabilite + migrateur + gregaire + 
#                     tendance_shoc_niv2:(detectabilite + migrateur) + 
#                     (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
# m_n2_trait_allint_5 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
#                     abondance_log + regime + 
#                       popularite + detectabilite + migrateur + gregaire + 
#                     tendance_shoc_niv2:(detectabilite + gregaire) + 
#                     (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
# m_n2_trait_allint_6 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
#                     abondance_log + regime + 
#                       popularite + detectabilite + migrateur + gregaire + 
#                     tendance_shoc_niv2:(migrateur + gregaire) + 
#                     (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
m_n2_trait_allint_7 <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
                    abondance_log + regime +
                      popularite + detectabilite + migrateur + gregaire + fauneFrance + 
                    tendance_shoc_niv2:(popularite + fauneFrance) +
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
# m_n2_trait_allint_8 <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
#                     abondance_log + regime +
#                       popularite + detectabilite + migrateur + gregaire + pourcentage_stoc + 
#                     tendance_shoc_niv2:(popularite + pourcentage_stoc) + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
# m_n2_trait_allint_9 <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
#                     abondance_log + regime +
#                       popularite + detectabilite + migrateur + gregaire + fauneFrance + 
#                     tendance_shoc_niv2:(gregaire + fauneFrance) +
#                     (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
# m_n2_trait_allint_10 <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
#                     abondance_log + regime +
#                       popularite + detectabilite + migrateur + gregaire + pourcentage_stoc + 
#                     tendance_shoc_niv2:(gregaire + pourcentage_stoc) +
#                     (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false

AIC_dt_trait_niv_2 <- as.data.frame(AIC(m_n2_trait_2, m_n2_trait_3, m_n2_trait_4, m_n2_trait_5, m_n2_trait_6,
    m_n2_trait_3int, m_n2_trait_4int, m_n2_trait_5int, m_n2_trait_6int, m_n2_trait_7int, m_n2_trait_8int, m_n2_trait_9int,
    m_n2_trait_all, 
    # m_n2_trait_allint, 
    m_n2_trait_allint_2, m_n2_trait_allint_3,
    # m_n2_trait_allint_4, m_n2_trait_allint_5, m_n2_trait_allint_6,
    m_n2_trait_allint_7 
    # m_n2_trait_allint_8, m_n2_trait_allint_9, m_n2_trait_allint_10
    ))

AIC_dt_trait_niv_2 <- AIC_dt_trait_niv_2 %>% 
  arrange(AIC) ; AIC_dt_trait_niv_2

summary(m_n2_trait_allint_7)
```

### participant

```{r}
#| eval: false
#| include: false

# sexe *** int ***
m_n2_participant_1 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + sexe + 
                                (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_participant_1, m_n2_base)
m_n2_participant_1int <- clmm(avis_niv2 ~ tendance_shoc_niv2*sexe + 
                                   (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_participant_1, m_n2_participant_1int) 

# anciennete int ***
m_n2_participant_2 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + anciennete + 
                                (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_participant_2, m_n2_base)
m_n2_participant_2int <- clmm(avis_niv2 ~ tendance_shoc_niv2*anciennete + 
                                   (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_participant_2, m_n2_participant_2int) 

# expert int ***
m_n2_participant_3 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + expert + 
                                (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_participant_3, m_n2_base)
m_n2_participant_3int <- clmm(avis_niv2 ~ tendance_shoc_niv2*expert + 
                                   (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_n2_participant_3, m_n2_participant_3int) 

# all 
m_n2_participant_all <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
                    sexe + anciennete + expert +
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
m_n2_participant_allint <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
                    sexe + anciennete + expert + 
                    tendance_shoc_niv2:(sexe + anciennete + expert) +
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false 
AIC_dt_niv_2_participant <- as.data.frame(AIC(
  m_n2_base,
                                m_n2_participant_1, m_n2_participant_2, m_n2_participant_3,
                                m_n2_participant_1int, m_n2_participant_2int, m_n2_participant_3int,
                                m_n2_participant_all, m_n2_participant_allint))

AIC_dt_niv_2_participant <- AIC_dt_niv_2_participant %>% 
  arrange(AIC) ; AIC_dt_niv_2_participant

summary(m_n2_participant_allint)
```

### plot

```{r}
#| echo: false
#| fig-height: 15
#| fig-width: 10

# dt2 <- dt2 %>%
#   mutate(
#     # popularite    = factor(popularite),
#     # detectabilite = factor(detectabilite),
#     sexe = factor(sexe),
#     expert = factor(expert)
#   )

# fonction ---------------------------------------------------------------------

# p-value 

plot_clmm_predictions_multi_x <- function(
  models,
  x_values,
  subtitle = NULL
) {
  emm_all <- purrr::imap_dfr(
    models,
    function(model, x_var) {
      mf <- model.frame(model)
      if (!x_var %in% names(mf)) {
        stop(sprintf("La variable '%s' n'est pas dans le mod√®le.", x_var))
      }
      x_is_factor <- is.factor(mf[[x_var]])
      x_vals <- x_values[[x_var]]
      emm <- if (x_is_factor) {
        emmeans(
          model,
          as.formula(paste("~ tendance_shoc_niv2 |", x_var)),
          mode = "latent"
        )
      } else {
        emmeans(
          model,
          as.formula(paste("~ tendance_shoc_niv2 |", x_var)),
          at = setNames(list(x_vals), x_var),
          mode = "latent"
        )
      }
      emm_summary <- summary(emm, type = "response")
      emm_summary %>%
        mutate(
          probabilite = plogis(emmean),
          tendance = tendance_shoc_niv2,
          x_level = factor(.data[[x_var]]),
          variable = x_var,
          lower = plogis(asymp.LCL),
          upper = plogis(asymp.UCL),
          # Logique pour la significativit√© (exemple : si l'intervalle de confiance contient 0)
          significatif = !(asymp.LCL < 0 & asymp.UCL > 0)
        )
    }
  )

  # Cr√©er un graphique par variable
  plots <- split(emm_all, emm_all$variable) %>%
    imap(~ {
      # D√©terminer si toutes les interactions pour ce niveau sont non significatives
      all_non_significatif <- all(!.x$significatif)

      p <- ggplot(.x, aes(
        x = tendance,
        y = probabilite,
        color = x_level,
        group = x_level
      )) +
        # Ruban d'erreur
        geom_ribbon(
          aes(ymin = lower, ymax = upper, fill = x_level),
          alpha = 0.2,
          color = NA
        ) +
        # Lignes continues ou pointill√©es (selon la significativit√© globale)
        geom_line(
          aes(linetype = ifelse(all_non_significatif, "dashed", "solid")),
          linewidth = 1.2
        ) +
        scale_linetype_manual(values = c("solid" = "solid", "dashed" = "dashed")) +
        scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
        scale_fill_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "fill") +
        scale_color_manual(values = scales::hue_pal()(length(unique(.x$x_level))), aesthetics = "color") +
        theme_bw() +
        theme(
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
          legend.position = "bottom"
        ) +
        labs(
          x = "Tendance SHOC",
          y = "Probabilit√© pr√©dite",
          color = "",
          fill = "",
          linetype = ifelse(all_non_significatif, "Non significatif", "Significatif"),
          title = .y
        )
      p
    })

  # Combiner les graphiques avec patchwork
  wrap_plots(plots, ncol = 3, nrow = 4) +
    plot_annotation(subtitle = subtitle) &
    theme(legend.position = "top")
}

# plot -------------------------------------------------------------------------

models <- list(
  # popularite              = m_n2_3int,
  # detectabilite           = m_n2_4int,
  # regime                  = m_n2_5int,
  # migrateur               = m_n2_6int,
  # gregaire                = m_n2_7int,
  # fauneFrance             = m_n2_trait_7int,
  # pourcentage_stoc        = m_n2_trait_8int
  sexe = m_n2_participant_1int,
  anciennete = m_n2_participant_2int,
  expert = m_n2_participant_3int
)

x_values <- list(
  # popularite              = NULL,
  # detectabilite           = NULL,
  # regime                  = NULL,
  # migrateur               = NULL,
  # gregaire                = NULL,
  # fauneFrance             = c(-1, 0, 2.5),
  # pourcentage_stoc        = c(-1, 0, 1.5)
  sexe = NULL,
  anciennete = c(0, 5, 40),
  expert = NULL
)

plot_clmm_predictions_multi_x(
  models = models,
  x_values = x_values,
  subtitle = "Effet de la tendance SHOC selon diff√©rentes variables (niveau 2)"
)

```

### espece + participant

```{r}
#| eval: false
#| include: false

m_n2_trait_participant_all <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
                    abondance_log + popularite + detectabilite + migrateur + gregaire + regime +  sexe + anciennete + expert + fauneFrance + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

# m_n2_trait_participant_allint <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
#                     abondance_log + popularite + detectabilite + migrateur + gregaire + regime +  sexe + anciennete + expert + fauneFrance + pourcentage_stoc + 
#                     tendance_shoc_niv2:(popularite + detectabilite + sexe + anciennete + expert + fauneFrance + pourcentage_stoc) + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

# m_n2_trait_participant_allint_1 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
#                     abondance_log + popularite + detectabilite + migrateur + gregaire + regime +  sexe + anciennete + expert + fauneFrance + pourcentage_stoc + 
#                     tendance_shoc_niv2:(popularite + detectabilite + sexe + anciennete + expert + fauneFrance) + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

# m_n2_trait_participant_allint_2 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
#                     abondance_log + popularite + detectabilite + migrateur + gregaire + regime +  sexe + anciennete + expert + fauneFrance + pourcentage_stoc + 
#                     tendance_shoc_niv2:(popularite + detectabilite + sexe + anciennete + expert + pourcentage_stoc) + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

# m_n2_trait_participant_allint_3 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
#                     abondance_log + popularite + detectabilite + migrateur + gregaire + regime +  sexe + anciennete + expert + fauneFrance + 
#                     tendance_shoc_niv2:(popularite + detectabilite + sexe + anciennete + expert) + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

# m_n2_trait_participant_allint_4 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
#                     abondance_log + popularite + detectabilite + migrateur + gregaire + regime +  sexe + anciennete + expert + pourcentage_stoc + 
#                     tendance_shoc_niv2:(popularite + detectabilite + sexe + anciennete + expert + pourcentage_stoc) + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

m_n2_trait_participant_allint_5 <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
                    abondance_log + popularite + detectabilite + migrateur + gregaire + regime + sexe + anciennete + expert + pourcentage_stoc +
                    tendance_shoc_niv2:(popularite) + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

m_n2_trait_participant_allint_6 <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
                    abondance_log + popularite + detectabilite + migrateur + gregaire + regime + sexe + anciennete + expert +
                    tendance_shoc_niv2:(popularite + detectabilite) + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

# m_n2_trait_participant_allint_7 <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
#                     abondance_log + popularite + detectabilite + migrateur + gregaire + regime + sexe + anciennete +
#                     tendance_shoc_niv2:(popularite + detectabilite + migrateur) + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

# m_n2_trait_participant_allint_8 <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
#                     abondance_log + popularite + detectabilite + migrateur + gregaire + regime + sexe +
#                     tendance_shoc_niv2:(popularite + detectabilite + migrateur + gregaire) + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)


# m_n2_trait_participant_allint_8 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
#                     abondance_log + popularite + detectabilite + migrateur + gregaire + regime +  sexe + anciennete + expert + fauneFrance + 
#                       tendance_shoc_niv2:(popularite + fauneFrance) + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

m_n2_trait_participant_allint_9 <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
                    abondance_log + regime +
                      popularite + detectabilite + migrateur + gregaire + fauneFrance + sexe + anciennete + expert +
                    tendance_shoc_niv2:(sexe + anciennete + expert + popularite) +
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

m_n2_trait_participant_allint_10 <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
                    abondance_log + regime +
                      popularite + detectabilite + migrateur + gregaire + fauneFrance + sexe + anciennete + expert +
                    tendance_shoc_niv2:(sexe + anciennete + expert + fauneFrance) +
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

m_n2_trait_participant_allint_11 <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
                    abondance_log + regime +
                      popularite + detectabilite + migrateur + gregaire + fauneFrance + sexe + anciennete + expert +
                    tendance_shoc_niv2:(sexe + anciennete + fauneFrance) +
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

m_n2_trait_participant_allint_12 <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
                    abondance_log + regime +
                      popularite + detectabilite + migrateur + gregaire + fauneFrance + sexe + anciennete + expert +
                    tendance_shoc_niv2:(sexe + fauneFrance) +
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
AIC_dt_trait_niv_2 <- as.data.frame(AIC(
  m_n2_base,
                                m_n2_participant_1, m_n2_participant_2, m_n2_participant_3,
                                m_n2_participant_1int, m_n2_participant_2int,
                                m_n2_participant_3int,
                                m_n2_participant_all, 
                                # m_n2_participant_allint,
                                m_n2_trait_2, m_n2_trait_3, m_n2_trait_4, m_n2_trait_5, m_n2_trait_6,
                                m_n2_trait_3int, m_n2_trait_4int, m_n2_trait_5int, m_n2_trait_6int,
                                m_n2_trait_all, 
                                # m_n2_trait_allint, 
                                m_n2_trait_allint_2, m_n2_trait_allint_3,
                                # m_n2_trait_allint_4, m_n2_trait_allint_5, m_n2_trait_allint_6,
                                m_n2_trait_allint_7, 
                                m_n2_trait_participant_all,
                                # m_n2_trait_participant_allint,
                                m_n2_trait_participant_allint_5,
                                m_n2_trait_participant_allint_6,
                                # m_n2_trait_participant_allint_7,
                                # m_n2_trait_participant_allint_8, 
                                m_n2_trait_participant_allint_9, m_n2_trait_participant_allint_10, m_n2_trait_participant_allint_11,
                                m_n2_trait_participant_allint_12
                                ))

AIC_dt_trait_niv_2 <- AIC_dt_trait_niv_2 %>% 
  arrange(AIC) ; AIC_dt_trait_niv_2

summary(m_n2_trait_participant_allint_11)
```

# ACP

## niv 1

```{r}
set.seed(42)
# n <- 100  # Nombre d'observations

ACP_dt1 <- dataset %>% 
  filter(avis_niv1 %in% c("D√©clin", "Stable", "Augmentation")) %>% 
  dplyr::select(avis_niv1,abondance_log,fauneFrance,anciennete,pourcentage_stoc,popularite,detectabilite,
                regime,migrateur,gregaire,sexe,expert,bioregion) %>% 
  na.omit()

# 1. Pr√©paration des donn√©es : encodage des variables cat√©gorielles
# On utilise dummy coding pour les variables cat√©gorielles (sauf "avis_niv1")
ACP_dt_dummy <- ACP_dt1 %>%
  mutate(across(c(popularite, detectabilite, regime, migrateur, gregaire, sexe, expert, bioregion), as.factor)) %>%
  fastDummies::dummy_cols(select_columns = c("popularite", "detectabilite", "regime", "migrateur", "gregaire", "sexe",
                                             "expert", "bioregion")) %>%
  dplyr::select(-"abondance_log",-"fauneFrance",-"anciennete",-"pourcentage_stoc",-"popularite",-"detectabilite",-"regime",
                -"migrateur",-"gregaire",-"sexe",-"expert",-"bioregion")

# On s√©pare les variables continues et les variables cat√©gorielles encod√©es
X <- ACP_dt_dummy %>%
  dplyr::select(-avis_niv1)  # On exclut "avis_niv1" pour l'ACP

# 2. ACP avec FactoMineR
# On utilise "avis_niv1" comme variable illustrative
res.pca <- FactoMineR::PCA(X, scale.unit = TRUE, ncp = 5, graph = FALSE)

# 3. Visualisation des r√©sultats

# a) Projection des individus (color√©s par "avis_niv1")
fviz_pca_ind(res.pca,
             col.ind = as.factor(ACP_dt1$avis_niv1),
             addEllipses = TRUE,
             title = "Projection des individus (ACP)")

fviz_pca_ind(res.pca, axes = c(1, 3), col.ind = as.factor(ACP_dt1$avis_niv1), addEllipses = TRUE)
fviz_pca_ind(res.pca, axes = c(2, 3), col.ind = as.factor(ACP_dt1$avis_niv1), addEllipses = TRUE)

# b) Cercle des corr√©la# b) Cercle des corr√©la# b) Cercle des corr√©lations (variables continues uniquement)
fviz_pca_var(res.pca,
             col.var = "black",
             title = "Cercle des corr√©lations (variables continues)")

# c) Variance expliqu√©e
fviz_eig(res.pca,
         addlines = TRUE,
         ylim = c(0, 50),
         title = "Variance expliqu√©e par les composantes principales")

# d) Contribution des variables cat√©gorielles (si besoin)
# Pour voir la contribution des modalit√©s des variables cat√©gorielles, on peut utiliser :
fviz_contrib(res.pca, choice = "var", axes = 1)
fviz_contrib(res.pca, choice = "var", axes = 2)
```

**Conclusion**

Les participants n'associent pas une perception de tendances de populations en fonction des traits des esp√®ces ni en fonction de leur caract√©ristiques personnelles.

La perceptions des participants est relativement ind√©pendantes des variables test√©es.

Cela veut dire que les participants ne sont pas influencer pas le types 

## niv 2

```{r}
set.seed(42)
# n <- 100  # Nombre d'observations

ACP_dt1 <- dataset %>% 
  filter(avis_niv1 %in% c("D√©clin", "Stable", "Augmentation")) %>% 
  dplyr::select(avis_niv2,abondance_log,fauneFrance,anciennete,pourcentage_stoc,popularite,detectabilite,
                regime,migrateur,gregaire,sexe,expert,bioregion) %>% 
  na.omit()

# 1. Pr√©paration des donn√©es : encodage des variables cat√©gorielles
# On utilise dummy coding pour les variables cat√©gorielles (sauf "avis_niv2")
ACP_dt_dummy <- ACP_dt1 %>%
  mutate(across(c(popularite, detectabilite, regime, migrateur, gregaire, sexe, expert, bioregion), as.factor)) %>%
  fastDummies::dummy_cols(select_columns = c("popularite", "detectabilite", "regime", "migrateur", "gregaire", "sexe",
                                             "expert", "bioregion")) %>%
  dplyr::select(-"abondance_log",-"fauneFrance",-"anciennete",-"pourcentage_stoc",-"popularite",-"detectabilite",-"regime",
                -"migrateur",-"gregaire",-"sexe",-"expert",-"bioregion")

# On s√©pare les variables continues et les variables cat√©gorielles encod√©es
X <- ACP_dt_dummy %>%
  dplyr::select(-avis_niv2)  # On exclut "avis_niv2" pour l'ACP

# 2. ACP avec FactoMineR
# On utilise "avis_niv2" comme variable illustrative
res.pca <- FactoMineR::PCA(X, scale.unit = TRUE, ncp = 5, graph = FALSE)

# 3. Visualisation des r√©sultats

# a) Projection des individus (color√©s par "avis_niv2")
fviz_pca_ind(res.pca,
             col.ind = as.factor(ACP_dt1$avis_niv2),
             addEllipses = TRUE,
             title = "Projection des individus (ACP)")

fviz_pca_ind(res.pca, axes = c(1, 3), col.ind = as.factor(ACP_dt1$avis_niv2), addEllipses = TRUE)
fviz_pca_ind(res.pca, axes = c(2, 3), col.ind = as.factor(ACP_dt1$avis_niv2), addEllipses = TRUE)

# b) Cercle des corr√©la# b) Cercle des corr√©la# b) Cercle des corr√©lations (variables continues uniquement)
fviz_pca_var(res.pca,
             col.var = "black",
             title = "Cercle des corr√©lations (variables continues)")

# c) Variance expliqu√©e
fviz_eig(res.pca,
         addlines = TRUE,
         ylim = c(0, 50),
         title = "Variance expliqu√©e par les composantes principales")

# d) Contribution des variables cat√©gorielles (si besoin)
# Pour voir la contribution des modalit√©s des variables cat√©gorielles, on peut utiliser :
fviz_contrib(res.pca, choice = "var", axes = 1)
fviz_contrib(res.pca, choice = "var", axes = 2)
```

**Conclusion**

Same que niv 1.

# COLLECTIF

## variables

avis_niv1 = "D√©clin" \~ -1,"Augmentation" \~ 1, "Stable" \~ 0

round

ou

mean avis \<= -0.2 \~ "D√©clin", mean avis \>= 0.2 \~ "Augmentation", -0.2 \< mean avis \> 0.2 \~ "Stable"

```{r}
#| echo: false
dataset_intel <- dataset %>% 
  filter(avis_niv1 != "Incertain") %>% 
  mutate(avis_niv1_intel = case_when(avis_niv1 == "D√©clin" ~ -1,
                                     avis_niv1 == "Augmentation" ~ 1,
                                     avis_niv1 == "Stable" ~ 0))

dataset_intel <- dataset_intel[!is.na(dataset_intel$avis_niv1_intel),]

table(dataset_intel$avis_niv1_intel, useNA = "always")

mean_intel_dt <- dataset_intel %>% 
  group_by(espece) %>%
  summarise(mean_avis_niv1_intel = mean(avis_niv1_intel),
            sd_avis_niv1_intel = sd(avis_niv1_intel)) %>% 
  # round
  mutate(round_avis_niv1_intel = round(mean_avis_niv1_intel),
         round_avis_niv1_intel_cat = case_when(round_avis_niv1_intel == "-1" ~ "D√©clin",
                                     round_avis_niv1_intel == "1" ~ "Augmentation",
                                     round_avis_niv1_intel == "0" ~ "Stable")) %>%    
  # quartile02
  mutate(quantile02_avis_niv1_intel = round(mean_avis_niv1_intel),
         quantile02_avis_niv1_intel_cat = case_when(mean_avis_niv1_intel <= -0.2 ~ "D√©clin",
                                          mean_avis_niv1_intel >= 0.2 ~ "Augmentation",
                                          between(mean_avis_niv1_intel, -0.2,0.2) ~ "Stable"))
  
```

## Chi¬≤ : shoc vs round

```{r}
#| echo: false
obs_round <- table(mean_intel_dt$round_avis_niv1_intel_cat)

tendance_shoc <- dataset %>% 
  dplyr::select(espece, tendance_shoc_niv1) %>% 
  distinct() 

obs_shoc <- table(tendance_shoc$tendance_shoc_niv1)

categories_communes <- intersect(names(obs_shoc), names(obs_round))

obs_shoc_c <- obs_shoc[categories_communes]
obs_round_c <- obs_round[categories_communes]

tab_chi2_round <- rbind(
  SHOC = obs_shoc_c,
  AVIS = obs_round
)

tab_chi2_round

chisq.test(tab_chi2_round)

res_round <- chisq.test(tab_chi2_round)

print("r√©sidus")
res_round$stdres

print("proportions")
prop.table(tab_chi2_round, margin = 1)
```

## Chi¬≤ : shoc vs quantile 0.2

```{r}
#| echo: false
obs_quantile02 <- table(mean_intel_dt$quantile02_avis_niv1_intel_cat)

tendance_shoc <- dataset %>% 
  dplyr::select(espece, tendance_shoc_niv1) %>% 
  distinct() 

obs_shoc <- table(tendance_shoc$tendance_shoc_niv1)

categories_communes <- intersect(names(obs_shoc), names(obs_quantile02))

obs_shoc_c <- obs_shoc[categories_communes]
obs_quantile02_c <- obs_quantile02[categories_communes]

tab_chi2_quantile02 <- rbind(
  SHOC = obs_shoc_c,
  AVIS = obs_quantile02
)

tab_chi2_quantile02

chisq.test(tab_chi2_quantile02)

res_quantile02 <- chisq.test(tab_chi2_quantile02)

print("r√©sidus")
res_quantile02$stdres

print("proportions")
prop.table(tab_chi2_quantile02, margin = 1)
```

## tendances par espece

```{r}
mean_intel_dt <- mean_intel_dt %>% 
  left_join(tendance_shoc)

dt_intel_quantile02 <- mean_intel_dt %>% 
  dplyr::select(espece, round_avis_niv1_intel_cat, quantile02_avis_niv1_intel_cat, tendance_shoc_niv1) %>% 
  rename(espece = espece, 
         `tendance moyenne arrondie quiz` = round_avis_niv1_intel_cat, 
         `tendance moyenne quantile (-0.2, 0.2) quiz` = quantile02_avis_niv1_intel_cat, 
         `tendance stat SHOC` = tendance_shoc_niv1)

dt_intel_quantile02 %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

dt_intel_quantile02
```

## variabilit√© des r√©ponses par espece

Pas de correlation entre le tendances moyennes estim√©es collectivement et la variation (√©cart-type) dans les r√©ponses

```{r}
plot(mean_intel_dt$mean_avis_niv1_intel, mean_intel_dt$sd_avis_niv1_intel)
summary(lm(mean_intel_dt$mean_avis_niv1_intel ~ mean_intel_dt$sd_avis_niv1_intel))
```

# save environnement

```{r}
#| eval: false
#| include: false
save.image(file = "SHOC-humain.RData")
# load("SHOC-humain.RData")
```

# matrice de corr√©lation

```{r}
#| eval: false
#| include: false

# toutes les variables__________________________________________________________

colnames(dataset)

library(vcd)
library(corrplot)
library(Hmisc)

# Fonction robuste pour calculer V de Cramer et p-value
cramers_v_pval <- function(x, y) {
  tbl <- table(x, y)
  if (nrow(tbl) < 2 || ncol(tbl) < 2) return(list(cv = NA, pval = NA))

  test <- tryCatch(
    {
      chisq.test(tbl)
    },
    error = function(e) NULL
  )

  if (is.null(test) || any(is.na(test$expected)) || any(test$expected < 5)) {
    return(list(cv = NA, pval = NA))
  }

  cv <- suppressWarnings(assocstats(tbl)$cramer)
  pval <- test$p.value
  return(list(cv = cv, pval = pval))
}

# Pr√©paration des donn√©es
X_categ <- dataset[, c("email","espece","detectabilite","departement","participation_stoc","participation_shoc",
                       "participation_epoc","participation_odj","cocheur","bagueur","sexe","fluctuante",
                       "tendance_shoc_niv1","tendance_shoc_niv2","tendances_stoc")]
X_categ <- X_categ[, sapply(X_categ, function(x) is.factor(x) || is.character(x))]
X_categ <- lapply(X_categ, as.factor)
X_categ <- as.data.frame(X_categ)

# Calcul des matrices
vars <- colnames(X_categ)
n <- length(vars)
v_matrix <- matrix(NA, nrow = n, ncol = n, dimnames = list(vars, vars))
p_matrix <- matrix(NA, nrow = n, ncol = n, dimnames = list(vars, vars))

for (i in 1:n) {
  for (j in i:n) {
    res <- cramers_v_pval(X_categ[[i]], X_categ[[j]])
    v_matrix[i, j] <- res$cv^2
    v_matrix[j, i] <- res$cv^2
    p_matrix[i, j] <- res$pval
    p_matrix[j, i] <- res$pval
  }
}

# Affichage
corrplot(v_matrix,
         method = "color",
         type = "upper",
         tl.cex = 0.8,
         tl.col = "black",
         p.mat = p_matrix,
         insig = "label_sig",
         sig.level = c(0.001, 0.01, 0.05),
         pch.cex = 0.7,
         pch.col = "black",
         addCoef.col = "transparent",
         na.label = " ")

# subset des variables__________________________________________________________

# colnames(dataset)
# 
# # Fonction robuste pour calculer V de Cramer et p-value
# cramers_v_pval <- function(x, y) {
#   tbl <- table(x, y)
#   if (nrow(tbl) < 2 || ncol(tbl) < 2) return(list(cv = NA, pval = NA))
# 
#   test <- tryCatch(
#     {
#       chisq.test(tbl)
#     },
#     error = function(e) NULL
#   )
# 
#   if (is.null(test) || any(is.na(test$expected)) || any(test$expected < 5)) {
#     return(list(cv = NA, pval = NA))
#   }
# 
#   cv <- suppressWarnings(assocstats(tbl)$cramer)
#   pval <- test$p.value
#   return(list(cv = cv, pval = pval))
# }
# 
# cramers_v_pval <- function(x, y) {
#   tbl <- table(x, y)
#   if (nrow(tbl) < 2 || ncol(tbl) < 2) return(list(cv = NA, pval = NA))
# 
#   # Test du chi¬≤ avec simulation si effectifs < 5
#   if (any(table(x, y) < 5, na.rm = TRUE)) {
#     test <- chisq.test(tbl, simulate.p.value = TRUE, B = 10000)
#   } else {
#     test <- chisq.test(tbl)
#   }
# 
#   cv <- suppressWarnings(assocstats(tbl)$cramer)
#   pval <- test$p.value
#   return(list(cv = cv, pval = pval))
# }
# 
# # Pr√©paration des donn√©es
# X_categ <- dataset[, c("email","espece","detectabilite","departement","participation_stoc","participation_shoc",
#                        "participation_epoc","participation_odj","cocheur","bagueur")]
# X_categ <- X_categ[, sapply(X_categ, function(x) is.factor(x) || is.character(x))]
# X_categ <- lapply(X_categ, as.factor)
# X_categ <- as.data.frame(X_categ)
# 
# # Calcul des matrices
# vars <- colnames(X_categ)
# n <- length(vars)
# v_matrix <- matrix(NA, nrow = n, ncol = n, dimnames = list(vars, vars))
# p_matrix <- matrix(NA, nrow = n, ncol = n, dimnames = list(vars, vars))
# 
# for (i in 1:n) {
#   for (j in i:n) {
#     res <- cramers_v_pval(X_categ[[i]], X_categ[[j]])
#     v_matrix[i, j] <- res$cv^2
#     v_matrix[j, i] <- res$cv^2
#     p_matrix[i, j] <- res$pval
#     p_matrix[j, i] <- res$pval
#   }
# }
# 
# # Affichage
# corrplot(v_matrix,
#          method = "color",
#          type = "upper",
#          tl.cex = 0.8,
#          tl.col = "black",
#          p.mat = p_matrix,
#          insig = "label_sig",
#          sig.level = c(0.001, 0.01, 0.05),
#          pch.cex = 0.7,
#          pch.col = "black",
#          addCoef.col = "transparent",
#          na.label = " ")

```

# niveau 1

```{r}
#| eval: false
#| include: false

# 1. Pr√©paration________________________________________________________________

colnames(dataset)

# On force toutes les colonnes en facteur (sauf email d√©j√† en facteur al√©atoire)
vars <- c("detectabilite","participation_stoc","participation_shoc",
                       "participation_epoc","participation_odj","cocheur","bagueur","sexe","fluctuante",
                       "tendance_shoc_niv1","tendance_shoc_niv2","tendances_stoc","anciennete")

dataset[vars] <- lapply(dataset[vars], as.factor)

# cible binaire
dataset$comparaison_niv1 <- as.factor(dataset$comparaison_niv1)

# 2. Formule automatique avec toutes les interactions 2√ó2_______________________

# variables explicatives
X <- paste(vars, collapse = " + ")

# # interactions 2 √† 2
# form <- as.formula(
#   paste("comparaison_niv1 ~ (", X, ")^2 + (1|email) + (1|departement)")
# )

# sans interaction
form <- as.formula(
  paste("comparaison_niv1 ~", X, "+ (1|espece)")
)

form

# 3. Mod√®le global GLMM binomial________________________________________________

dataset$anciennete <- as.numeric(as.character(dataset$anciennete))

dt_model <- dataset %>% 
  na.omit("detectabilite","participation_stoc","participation_shoc",
                       "participation_epoc","participation_odj","cocheur","bagueur","sexe","fluctuante",
                       "tendance_shoc_niv1","tendance_shoc_niv2","tendances_stoc","anciennete")

options(na.action = "na.fail")  # obligatoire pour dredge

m_full <- glmer(
  form,
  data = dt_model,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa")
)

# 4. Dredge automatique AIC_____________________________________________________

dd <- dredge(m_full, rank = "AIC")
dd

# 5. Mod√®le s√©lectionn√© (AIC min)_______________________________________________
best <- get.models(dd, 1)[[1]]
summary(best)

```

# niveau 2

```{r}
#| eval: false
#| include: false

# 1. Pr√©paration________________________________________________________________

colnames(dataset)

# On force toutes les colonnes en facteur (sauf email d√©j√† en facteur al√©atoire)
vars <- c("detectabilite","participation_stoc",
          "participation_shoc","bagueur")

dataset[vars] <- lapply(dataset[vars], as.factor)

# cible binaire
dataset$comparaison_niv2 <- as.factor(dataset$comparaison_niv2)

# 2. Formule automatique avec toutes les interactions 2√ó2_______________________

# variables explicatives
X <- paste(vars, collapse = " + ")

# # interactions 2 √† 2
# form <- as.formula(
#   paste("comparaison_niv2 ~ (", X, ")^2 + (1|email) + (1|departement)")
# )

# sans interaction
form <- as.formula(
  paste("comparaison_niv2 ~", X, "+ (1|espece)")
)

form

# 3. Mod√®le global GLMM binomial________________________________________________

dt_model <- dataset %>% 
  na.omit("detectabilite","participation_stoc",
          "participation_shoc","bagueur")

options(na.action = "na.fail")  # obligatoire pour dredge

m_full <- glmer(
  form,
  data = dt_model,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa")
)

# 4. Dredge automatique AIC_____________________________________________________

dd <- dredge(m_full, rank = "AIC")
dd

# 5. Mod√®le s√©lectionn√© (AIC min)_______________________________________________
best <- get.models(dd, 1)[[1]]
summary(best)

```

```{r}
#| eval: false
#| include: false
colnames(dataset)
m0 <- glmer(comparaison_niv1 ~ 1 + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m1 <- glmer(comparaison_niv1 ~ participation_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m2 <- glmer(comparaison_niv1 ~ participation_shoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m3 <- glmer(comparaison_niv1 ~ participation_epoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m4 <- glmer(comparaison_niv1 ~ sexe + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m5 <- glmer(comparaison_niv1 ~ cocheur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m6 <- glmer(comparaison_niv1 ~ anciennete + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m7 <- glmer(comparaison_niv1 ~ bagueur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m8 <- glmer(comparaison_niv1 ~ expert + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m9 <- glmer(comparaison_niv1 ~ tendances_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m10 <- glmer(comparaison_niv1 ~ detectabilite + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m11 <- glmer(comparaison_niv1 ~ gregaire + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m12 <- glmer(comparaison_niv1 ~ fluctuante + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m13 <- glmer(comparaison_niv1 ~ migrateur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m14 <- glmer(comparaison_niv1 ~ abondance + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m15 <- glmer(comparaison_niv1 ~ regime + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
compare_performance(m0,m1,m2,m3,m4,m5,m6,m7,m8,m9,m10,m11,m12,m13,m14,m15)
summary(m4)

m4.1 <- glmer(comparaison_niv1 ~ sexe + participation_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.2 <- glmer(comparaison_niv1 ~ sexe + participation_shoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.3 <- glmer(comparaison_niv1 ~ sexe + participation_epoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.4 <- glmer(comparaison_niv1 ~ sexe + cocheur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.5 <- glmer(comparaison_niv1 ~ sexe + anciennete + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.6 <- glmer(comparaison_niv1 ~ sexe + bagueur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.7 <- glmer(comparaison_niv1 ~ sexe + expert + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.8 <- glmer(comparaison_niv1 ~ sexe + tendances_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.9 <- glmer(comparaison_niv1 ~ sexe + detectabilite + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.10 <- glmer(comparaison_niv1 ~ sexe + gregaire + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.11 <- glmer(comparaison_niv1 ~ sexe + fluctuante + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.12 <- glmer(comparaison_niv1 ~ sexe + migrateur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.13 <- glmer(comparaison_niv1 ~ sexe + abondance + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14 <- glmer(comparaison_niv1 ~ sexe + regime + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
compare_performance(m4.1,m4.2,m4.3,m4.4,m4.5,m4.6,m4.7,m4.8,m4.9,m4.10,m4.11,m4.12,m4.13,m4.14)
summary(m4.14)

m4.14.1 <- glmer(comparaison_niv1 ~ sexe + regime + participation_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.2 <- glmer(comparaison_niv1 ~ sexe + regime + participation_shoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.3 <- glmer(comparaison_niv1 ~ sexe + regime + participation_epoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.4 <- glmer(comparaison_niv1 ~ sexe + regime + cocheur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.6 <- glmer(comparaison_niv1 ~ sexe + regime + bagueur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.7 <- glmer(comparaison_niv1 ~ sexe + regime + expert + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.8 <- glmer(comparaison_niv1 ~ sexe + regime + tendances_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.9 <- glmer(comparaison_niv1 ~ sexe + regime + detectabilite + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.10 <- glmer(comparaison_niv1 ~ sexe + regime + gregaire + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.11 <- glmer(comparaison_niv1 ~ sexe + regime + fluctuante + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.12 <- glmer(comparaison_niv1 ~ sexe + regime + migrateur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.13 <- glmer(comparaison_niv1 ~ sexe + regime + abondance + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
compare_performance(m4.14.1,m4.14.2,m4.14.3,m4.14.4,m4.14.5,m4.14.6,m4.14.7,m4.14.8,m4.14.9,m4.14.10,m4.14.11,m4.14.11,m4.14.13)
summary(m4.14.5)

m4.14.5.1 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.2 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + participation_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.3 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + participation_shoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.4 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + participation_epoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.5 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + cocheur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.6 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + bagueur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.7 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + expert + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.8 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + tendances_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.9 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + detectabilite + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.10 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + gregaire + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.11 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + fluctuante + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.12 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + migrateur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.13 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + abondance + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
compare_performance(m4.14.5,m4.14.5.1,m4.14.5.2,m4.14.5.3,m4.14.5.4,m4.14.5.5,m4.14.5.6,m4.14.5.7,m4.14.5.8,m4.14.5.9,
                    m4.14.5.10,m4.14.5.11,m4.14.5.12,m4.14.5.13)
summary(m4.14.5)

```
