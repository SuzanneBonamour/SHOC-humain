---
title: "SHOC-humain"
format: html
editor: visual
---

```{r}
#| message: false
#| warning: false
#| include: false
library(readr)
library(tidyverse)
library(tidyr)
library(stringr)
library(dplyr)
library(stringi)
library(purrr)
library(readxl)
library(lme4)
library(MuMIn)
library(corrplot)
library(Hmisc)
library(vcd)
library(performance)
library(beepr)
library(DT)
library(ggplot2)
library(MASS)
library(forcats)
library(ordinal)
```

```{r}
load("SHOC-humain.RData")
sort(sapply(ls(), function(x) object.size(get(x))), decreasing = TRUE)
rm(dt_model_1 )
rm(list = ls(pattern = "^X_"))
```

# \*\*\* data

## quiz

```{r}
#| message: false
#| warning: false
#| include: false

# quiz__________________________________________________________________________
quiz <- read_csv("Data/Quiz SHOC.csv")

quiz_2 <- quiz %>% 
  rename(datetime = "Horodateur", 
         email = "Nom d'utilisateur", 
         departement = "Merci de renseigner votre code de département", 
         participation_stoc = "Participez-vous à : [STOC]", 
         participation_shoc = "Participez-vous à : [SHOC]", 
         participation_epoc = "Participez-vous à : [EPOC]", 
         participation_odj = "Participez-vous à : [Oiseaux des Jardins]", 
         anciennete = "Si vous participez à l'un de ces programmes, précisez le nombre d'années de participation. \n(Si vous participez à plusieurs programmes, renseignez celui dans lequel vous êtes actif depuis le plus longtemps.)")
  
participant <- quiz_2 %>% 
  dplyr::select(datetime, email, departement, participation_stoc, participation_shoc,
                participation_epoc, participation_odj, anciennete)

avis_large <- quiz_2 %>% 
  rename(`Accenteur mouchet` = "Quelle est la tendance hivernale de l'Accenteur mouchet depuis 2014 ?",
         `Accenteur mouchet fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....10", 
         `Alouette des champs` = "Quelle est la tendance hivernale de l'Alouette des champs ?",
         `Alouette des champs fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....12",
         `Bruant zizi` = "Quelle est la tendance hivernale du Bruant zizi ?", 
         `Bruant zizi fac` =  "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....14", 
         `Chardonneret élégant` = "Quelle est la tendance hivernale du Chardonneret élégant ?",
         `Chardonneret élégant fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....16",
         `Choucas des tours` = "Quelle est la tendance hivernale du Choucas des tours ?",
         `Choucas des tours fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....18", 
         `Etourneau sansonnet` = "Quelle est la tendance hivernale de l'Etourneau sansonnet ?",
         `Etourneau sansonnet fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....20",
         `Geai des chênes` = "Quelle est la tendance hivernale du Geai des chênes ?",
         `Geai des chênes fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....22", 
         `Grimpereau des jardins` = "Quelle est la tendance hivernale du Grimpereau des jardins ?",
         `Grimpereau des jardins fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....24",
         `Grive draine` = "Quelle est la tendance hivernale de la Grive draine ?",
         `Grive draine fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....26",       
         `Grive litorne` = "Quelle est la tendance hivernale de la Grive litorne ?",
         `Grive litorne fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....28", 
         `Grive mauvis` = "Quelle est la tendance hivernale de la Grive mauvis ?",
         `Grive mauvis fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....30",
         `Grosbec cassenoyaux` = "Quelle est la tendance hivernale du Grosbec cassenoyaux ?",
         `Grosbec cassenoyaux fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....32",
         `Merle noir` = "Quelle est la tendance hivernale du Merle noir ?", 
         `Merle noir fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....34",
         `Mésange bleue` = "Quelle est la tendance hivernale de la Mésange bleue ?",
         `Mésange bleue fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....36",                                                                        `Mésange nonnette` = "Quelle est la tendance hivernale de la Mésange nonnette ?",
         `Mésange nonnette fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....38",
         `Mésange noire` = "Quelle est la tendance hivernale de la Mésange noire ?",
         `Mésange noire fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....40",
         `Pic vert` = "Quelle est la tendance hivernale du Pic vert ?",
         `Pic vert fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....42",
         `Pie bavarde` = "Quelle est la tendance hivernale de la Pie bavarde ?",
         `Pie bavarde fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....44",
         `Pigeon ramier` = "Quelle est la tendance hivernale du Pigeon ramier?",
         `Pigeon ramier fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....46",
         `Pinson des arbres` = "Quelle est la tendance hivernale du Pinson des arbres ?",
         `Pinson des arbres fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....48",
         `Pipit farlouse` = "Quelle est la tendance hivernale du Pipit farlouse ?",
         `Pipit farlouse fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....50",
         `Pouillot véloce` = "Quelle est la tendance hivernale du Pouillot véloce ?",
         `Pouillot véloce fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....52",
         `Roitelet à triple bandeau` = "Quelle est la tendance hivernale du Roitelet à triple bandeau ?",
         `Roitelet à triple bandeau fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....54",
         `Roitelet huppé` = "Quelle est la tendance hivernale du Roitelet huppé ?",
         `Roitelet huppé fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....56",
         `Rougegorge familier` = "Quelle est la tendance hivernale du Rougegorge familier ?",
         `Rougegorge familier fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....58",
         `Tarin des aulnes` = "Quelle est la tendance hivernale du Tarin des aulnes ?",
         `Tarin des aulnes fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....60",
         `Tourterelle turque` = "Quelle est la tendance hivernale de la Tourterelle turque ?",
         `Tourterelle turque fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....62",
         `Troglodyte mignon` = "Quelle est la tendance hivernale du Troglodyte mignon ?",
         `Troglodyte mignon fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....64",
         `Verdier d'Europe` = "Quelle est la tendance hivernale du Verdier d'Europe ?",
         `Verdier d'Europe fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....66",
         `Bouscarle de Cetti` = "Quelle est la tendance hivernale de la Bourscarle de Cetti ?",
         `Bouscarle de Cetti fac` = "Facultatif : si vous avez coché \"En déclin\" ou \"En augmentation\", vous pouvez préciser votre réponse....68") %>% 
         dplyr::select(-datetime, -departement, -participation_stoc, -participation_shoc,
                       -participation_epoc, -participation_odj, -anciennete) 

avis <- avis_large %>%
  pivot_longer(
    cols = -email,
    names_to = "variable",
    values_to = "avis"
  ) %>%
  mutate(
    # déterminer si c'était une colonne niveau 2 (avec "fac")
    niv2 = str_detect(variable, "fac$"),

    # nom de l'espèce sans " fac"
    espece = str_remove(variable, " fac$")
  ) %>%
  # passer en format large : avis_niv1 / avis_niv2
  mutate(
    avis_niv1 = if_else(!niv2, avis, NA_character_),
    avis_niv2 = if_else(niv2, avis, NA_character_)
  ) %>%
  dplyr::select(email, espece, avis_niv1, avis_niv2) %>%
  distinct() %>%
  group_by(email, espece) %>%
  # fusionner les doublons niveau1/niveau2
  summarise(
    avis_niv1 = first(na.omit(avis_niv1)),
    avis_niv2 = first(na.omit(avis_niv2)),
    .groups = "drop"
  ) %>%
  arrange(email, espece)

# rm(quiz, quiz_2, longTermTrends, avis_large)
```

## participant.es

### sexe

Femme, homme, NA, en fonction des prénoms détectés dans les emails.

```{r}
#| include: false
prenoms_h <- c(
  "adrien","alain","alban","albert","alessandro","alex","alexandre","alexis",
  "alfred","allan","alphonse","amaury","ambroise","andré","anthony","antoine",
  "antonin","arnaud","arthur","auguste","augustin","axel","baptiste","benjamin",
  "bernard","bertrand","bruno","cédric","cesar","charles","christian","christophe",
  "claude","clément","colin","damien","dan","daniel","dany","david","denis",
  "didier","dimitri","dorian","edgar","edmond","edouard","eliot","elliot","emile",
  "emmanuel","enzo","etienne","fabien","fabio","fabrice","felix","fernand",
  "flavien","florian","francis","franck","francois","gabriel","gael","gaetan",
  "gaspard","gaston","gautier","georges","gerald","gérard","ghislain","gilbert",
  "gilles","gregoire","guillaume","gustave","guy","henri","herman","hervé","hugo",
  "hugues","ismail","jacques","jean","jérémie","jeremy","jérôme","joachim","joel",
  "jonathan","jordan","joseph","jules","julien","karl","kevin","laurent","léo",
  "leon","lilian","louis","loic","luca","lucas","ludovic","malik","malik","marc",
  "marcel","marius","martial","martin","mathieu","matheo","mathias","mathis",
  "matthias","matthieu","max","maxence","maxime","mehdi","michel","mickael",
  "milan","mohamed","nathan","nicolas","noe","noah","norbert","olivier","oscar",
  "pablo","paul","pierre","quentin","rafael","raphael","raymond","remi","rémi",
  "rené","richard","robert","robin","roger","romain","roméo","samuel","sebastien",
  "serge","simon","stephane","sylvain","tanguy","teo","théodore","thibault",
  "thomas","tim","timothe","tom","tony","tristan","valentin","victor","vincent",
  "yann","yannis","yohan","yves","zac","zacharie","pascal","manuel","thierry","willy",
  "eloi","andre","jerome","patrick","gerard","bastout","philippe","eric","rodolphe",
  "herve","yoann","theophile","joris","benoit","ancelin","Thibaud","jacob","regis","nico",
  "mark","jeff","henry","yoan","leo","corentin","vivian","clement","stanislas","remy","ugo",
  "gilmon","teddy"
)

prenoms_f <- c(
  "adele","adeline","adèle","agathe","agnès","aicha","aline","alice","alicia",
  "alison","amandine","amelie","anaïs","anais","anastasia","andrée","anita",
  "anna","anne","annette","annie","anthéa","antoinette","apolline","ariane",
  "arielle","armelle","astrid","audrey","augustine","aurélie","aurore",
  "babette","barbara","béatrice","blandine","brigitte","camille","capucine",
  "carine","caroline","cassandra","catherine","cecile","cécile","celeste",
  "celia","céline","chloé","chloe","christelle","christiane","christine",
  "clara","clarisse","claudine","colette","coline","constance","coralie",
  "corinne","danielle","daphne","daphné","delphine","denise","diane","djemila",
  "dominique","dorothée","edith","elaine","elea","elena","eliane","elisa",
  "elise","élise","elodie","elvira","emilie","emma","emmanuelle","estelle",
  "eugenie","eva","fabienne","fantine","felicie","fernande","flavie","flore",
  "florence","france","francesca","francoise","gabrielle","garance",
  "geneviève","georgette","geraldine","gisèle","gloria","hanna","hélène",
  "helena","henriette","huguette","imy","ines","ingrid","irma","isabelle",
  "jade","janine","jeanne","jennifer","jessica","joelle","josephine",
  "josiane","judith","julie","julienne","julia","juliette","justine","karine",
  "laetitia","laetitia","laetitia","laura","laure","laurence","lea","léa",
  "leila","lena","lene","line","lisa","lisette","lorraine","lou","louise",
  "lucette","lucie","lucile","lucille","lydia","maelle","maelle","magali",
  "maeva","manon","margaux","margot","marguerite","maria","mariama","marie",
  "marina","marine","marion","marjorie","marlène","marthe","martine","maryse",
  "mathilde","mélanie","melinda","meline","melissa","melodie","mercedes",
  "micheline","michelle","mireille","miriam","morgane","nadège","nadine",
  "naomi","nathalie","nicole","noémie","noemie","océane","odette","odile",
  "olivia","ophelie","ophélie","paola","patricia","paulette","pauline",
  "peggy","perrine","pierretta","priscilla","rachel","raphaelle","raymonde",
  "rebeca","rene","renée","romy","rosa","rosalie","rose","roxane","sabine",
  "sabrina","salomé","salome","samira","sandrine","sarah","scarlett",
  "séverine","sidonie","simone","sonia","sophie","stephanie","suzanne",
  "sylvie","tania","tatiana","thérèse","therese","valentina","valentine",
  "valérie","vanessa","véronique","victoria","virginie","viviane","yasmina",
  "yvette","yvonne","zoe","zoé","iris","julienne","jullienne","jocelyne",
  "claire","cathy","aurelie","maude","gervaise","armel","chantal","myriam",
  "monica","reine","lili","cecilia","marysia","lydie","valerie"
)

detect_prenom <- function(email, prenoms_h, prenoms_f) {
  deb <- tolower(str_extract(email, "^[^@]+"))  # partie avant @
  
  # concaténer tous les prénoms dans un seul vecteur
  all_names <- c(prenoms_h, prenoms_f)
  
  # chercher tous les prénoms présents quelque part dans l'adresse
  matches <- all_names[str_detect(deb, all_names)]
  
  if (length(matches) == 0) return(NA_character_)
  
  # s'il y a plusieurs prénoms trouvés → on garde le plus long (meilleure précision)
  prenom <- matches[which.max(nchar(matches))]
  return(prenom)
}

participant <- participant %>%
  rowwise() %>%
  mutate(
    prenom = detect_prenom(email, prenoms_h, prenoms_f),
    sexe = case_when(
      !is.na(prenom) & prenom %in% prenoms_h ~ "H",
      !is.na(prenom) & prenom %in% prenoms_f ~ "F",
      TRUE ~ NA_character_
    )
  ) %>%
  ungroup()

# a changer manuellement :

participant$sexe[participant$email %in% c("aurelie.laurent.971@gmail.com","degomouss@gmail.com",
                                          "briemuller@gmail.com","birgit.tollner@gmail.com","angele.bally@lpo.fr",
                                          "l.gourdel@free.fr","jplrousselet@orange.fr","isagiraud75@gmail.com",
                                          "chrisdieulafait@orange.fr","perdub@aol.com","ccressent@gmail.com",
                                          "benchomel@netcourrier.com","duvernay_fr@yahoo.fr","vers.un.voiseau@orange.fr",
                                          "mcrossard@yahoo.fr","vd.dousset@wanadoo.fr")] <- "F"

participant$sexe[participant$email %in% c("duchenne.f@gmail.com","jluc.a1@orange.fr","equilibre.var@gmail.com",
                                          "ybrouillard@orange.fr","cjm.chartendrault@gmail.com","delemonte.th@orange.fr",
                                          "orever@free.fr","mudirme@sfr.fr","gil.jacotot@gmail.com",
                                          "dufour.famili@orange.fr","fyvert@gmail.com","dphil2001@aol.com",
                                          "vmallet2@wanadoo.fr","vmallet3@yahoo.fr","jluc28800@yahoo.fr",
                                          "privallin@orange.fr","m.berges@natureo.org","bdinatale69@gmail.com",
                                          "Thibauddaumal@gmail.com","carle.coste@wanadoo.fr","y.detonquedec@free.fr",
                                          "manceaulionel@gmail.com","vincelecalvez@yahoo.fr","paris.oliv@wanadoo.fr",
                                          "jf.cherel@free.fr","julliard@mnhn.fr","nvissyrias@gmail.com",
                                          "siblet@mnhn.fr","delzons@mnhn.fr","fournier@mnhn.fr",
                                          "sachfldy@hotmail.com","dmuret@yahoo.fr","l.rouschmeyer@acer-campestre.fr",
                                          "fred.pelsy@gmail.com","jsouriou@gmail.com","dom.hemery@wanadoo.fr",
                                          "jp.gans@sfr.fr","dbizet@cogard.org","valsp@yahoo.fr",
                                          "auseth.gascon@yahoo.fr","gamineau@gmail.com","ghisr@otmail.fr",
                                          "xh12@outlook.fr","matprioul@wanadoo.fr","osoldi84@gmail.com",
                                          "blafargue46@gmail.com","ezzo33@gmail.com","urbi.pat@free.fr","fournip1@hotmail.com",
                                          "grimaudjpf@aol.com","dm.huyghe@gmail.com","fasuperla@riseup.net",
                                          "f.toulotte@gmail.com","tipoire@hotmail.com","f-grunert@netc.fr",
                                          "s_gardien@yahoo.fr","jc.dudicourt@gmail.com","botellas9135@sfr.fr",
                                          "gaaubry@wanadoo.fr","ldelpit@laposte.ner","d.svinarenko@trans-faire.net")] <- "H"

table(participant$sexe, useNA = "always")

participant$email[is.na(participant$sexe)==T]
```

### cocheurs

Correspondance des emails entre les répondant.es au quiz et les 1741 cocheurs sur cocheurs.fr

```{r}
#| echo: false
#| message: false
#| warning: false
cocheurs <- read_excel("Data/cocheurs.xlsx")
cocheurs <- cocheurs %>% 
  dplyr::select(Membres, France)

# --- Preparation des cocheurs ---
cocheurs2 <- cocheurs %>%
  mutate(
    clean = stri_trans_general(Membres, "Latin-ASCII") %>% tolower() %>% str_squish(),
    prenom = str_extract(clean, "^[a-z]+"),
    nom    = str_extract(clean, "[a-z]+$"),
    init   = substr(prenom, 1, 1)
  )

find_match <- function(email_start, ref) {
  
  if (is.na(email_start))
    return(list(member = NA, rule = NA))
  
  # tokens propres
  tokens <- str_split(email_start, "[._\\-+@]")[[1]] %>%
    str_remove_all("[0-9]") %>%
    str_remove_all("[^a-z]") %>%
    discard(~ .x == "" | is.na(.x) | nchar(.x) < 2)
  
  if (length(tokens) == 0)
    return(list(member = NA, rule = NA))
  
  # --- 1) MATCHS SUR NOM avec obligation d'avoir prenom ou initiale ---
  for (i in seq_len(nrow(ref))) {
    
    pr  <- ref$prenom[i]
    nm  <- ref$nom[i]
    ini <- ref$init[i]
    
    if (is.na(nm) || nm == "") next
    
    # A. nom et prenom/initiale presents comme tokens distincts
    if (any(tokens == nm) && (any(tokens == pr) || any(tokens == ini)))
      return(list(member = ref$Membres[i], rule = "nom_token + prenom_token"))
    
    # B. initiale + nom (ex jdupont)
    if (!is.na(ini) && ini != "" &&
        any(tokens == paste0(ini, nm)))
      return(list(member = ref$Membres[i], rule = "init+nom"))
    
    # C. prenom + nom colles (ex jeandupont)
    if (!is.na(pr) && pr != "" &&
        any(tokens == paste0(pr, nm)))
      return(list(member = ref$Membres[i], rule = "prenom_nom_colle"))
    
    # D. nom + prenom colles (ex dupontjean)
    if (!is.na(pr) && pr != "" &&
        any(tokens == paste0(nm, pr)))
      return(list(member = ref$Membres[i], rule = "nom_prenom_colle"))
    
    # E. token commence par nom + se poursuit par initiale ou prenom
    if (nchar(nm) >= 3 &&
        any(startsWith(tokens, nm))) {
      
      suffixes <- str_replace(tokens[startsWith(tokens, nm)], paste0("^", nm), "")
      
      if (any(suffixes == ini) || any(suffixes == pr))
        return(list(member = ref$Membres[i], rule = "nom_start + prenom"))
    }
  }
  
  # --- 2) prenom seul → NON ---
  for (i in seq_len(nrow(ref))) {
    pr <- ref$prenom[i]
    if (!is.na(pr) && pr != "" &&
        any(tokens == pr))
      return(list(member = ref$Membres[i], rule = "prenom_only"))
  }
  
  return(list(member = NA, rule = NA))
}

participant <- participant %>%
  mutate(
    email_clean = stri_trans_general(email, "Latin-ASCII") %>% tolower(),
    email_start = str_extract(email_clean, "^[^@]+")
  ) %>%
  rowwise() %>%
  mutate(
    out = list(find_match(email_start, cocheurs2)),
    matched_member = out$member,
    match_rule     = out$rule
  ) %>%
  ungroup() %>%
  mutate(
    cocheur = case_when(
      match_rule %in% c("nom_exact", "init+nom",
                        "prenom_nom_colle_oui", "nom_start", 
                        "nom_token + prenom_token", "prenom_nom_colle") ~ "Oui",
      TRUE ~ "Non"
    )
    ) %>%
  dplyr::select(-out)

participant <- participant %>%
  left_join(
    cocheurs %>% dplyr::select(Membres, France),
    by = c("matched_member" = "Membres")
  ) %>%
  mutate(
    nb_obs_cocheurs = if_else(cocheur == "Oui", France, NA_real_)
  )

participant <- participant %>% 
  dplyr::select(-match_rule, -matched_member, -email_clean, -email_start, -prenom, -France)
```

### ancienneté

Ancienneté déclaré par les répondant.es pour le.s suivis participatifs

```{r}
#| echo: false
#| message: false
#| warning: false
participant <- participant %>% 
  mutate(anciennete_clean = as.numeric(gsub(".*?([0-9]+).*", "\\1", anciennete)))  

participant$anciennete_clean[participant$anciennete_clean=="2028"] <- NA
participant$anciennete_clean[participant$anciennete_clean=="2024"] <- 2025-2024
participant$anciennete_clean[participant$anciennete_clean=="2023"] <- 2025-2023
participant$anciennete_clean[participant$anciennete_clean=="2022"] <- 2025-2022
participant$anciennete_clean[participant$anciennete_clean=="2021"] <- 2025-2021
participant$anciennete_clean[participant$anciennete_clean=="2020"] <- 2025-2020
participant$anciennete_clean[participant$anciennete_clean=="2019"] <- 2025-2019
participant$anciennete_clean[participant$anciennete_clean=="2018"] <- 2025-2018
participant$anciennete_clean[participant$anciennete_clean=="2017"] <- 2025-2017
participant$anciennete_clean[participant$anciennete_clean=="2016"] <- 2025-2016
participant$anciennete_clean[participant$anciennete_clean=="2015"] <- 2025-2015
participant$anciennete_clean[participant$anciennete_clean=="2014"] <- 2025-2014
participant$anciennete_clean[participant$anciennete_clean=="2013"] <- 2025-2013
participant$anciennete_clean[participant$anciennete_clean=="2012"] <- 2025-2012
participant$anciennete_clean[participant$anciennete_clean=="2007"] <- 2025-2007
participant$anciennete_clean[participant$anciennete_clean=="2002"] <- 2025-2002
participant$anciennete_clean[participant$anciennete_clean=="2001"] <- 2025-2001
participant$anciennete_clean[participant$anciennete_clean=="1984"] <- 2025-1984

participant <- participant %>% 
  dplyr::select(-anciennete, -datetime) %>% 
  rename(anciennete = anciennete_clean)

participant$anciennete[is.na(participant$anciennete)] <- 0
```

### departement

Département français métropolitain + suisse

```{r}
#| echo: false
participant <- participant %>% 
  filter(departement != "Je souhaiterais supprimer mes réponses svp (au questionnaire précédent). J'avais mal compris le principe de ce questionnaire ! Mes réponses n'avaient donc aucune pertinence car je n'ai pas assez de recul. Dommage qu'il n'y ait pas un email de contact.")

participant <- participant %>% 
  mutate(departement = case_when(departement == "04 et 06" ~ "04",
                                 departement == "2" ~ "02",
                                 departement == "maxjouve@hotmail.com" ~ NA,
                                 departement == "Eure-et-Loir (28)" ~ "28",
                                 departement %in% c("Allier") ~ "03",
                                 departement %in% c("Aube") ~ "10",
                                 departement %in% c("Finistère") ~ "29",
                                 departement %in% c("Gironde") ~ "33",
                                 departement %in% c("haute-garonne") ~ "31",
                                 departement %in% c("Ille et Vilaine") ~ "35",
                                 departement %in% c("Loir-et-cher") ~ "41",
                                 departement %in% c("Loire") ~ "42",
                                 departement %in% c("pyréénes orientales") ~ "66",
                                 departement %in% c("suisse") ~ "suisse",
                                 departement %in% c("Suisse GE") ~ "suisse",
                                 TRUE ~ departement),
         departement = strtrim(departement, 2))

table(participant$departement, useNA = "always")

participant <- participant[!is.na(participant$departement),]
```

### région, biorégion

Départements associés à une région admin, à une biorégion (INPN)

```{r}
#| echo: false
#| message: false
#| warning: false

code = c(
"01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","2A","2B",
"21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40",
"41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60",
"61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80",
"81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","su")

region = c(
"Auvergne-Rhône-Alpes","Hauts-de-France","Auvergne-Rhône-Alpes","Provence-Alpes-Côte d’Azur","Provence-Alpes-Côte d’Azur","Provence-Alpes-Côte d’Azur","Auvergne-Rhône-Alpes","Grand Est","Occitanie","Grand Est","Occitanie","Occitanie","Provence-Alpes-Côte d’Azur","Normandie","Auvergne-Rhône-Alpes","Nouvelle-Aquitaine","Nouvelle-Aquitaine","Centre-Val de Loire","Nouvelle-Aquitaine","Corse","Corse",
"Bourgogne-Franche-Comté","Bretagne","Nouvelle-Aquitaine","Nouvelle-Aquitaine","Bourgogne-Franche-Comté","Auvergne-Rhône-Alpes","Normandie","Centre-Val de Loire","Bretagne","Occitanie","Occitanie","Nouvelle-Aquitaine","Occitanie","Bretagne","Centre-Val de Loire","Centre-Val de Loire","Auvergne-Rhône-Alpes","Bourgogne-Franche-Comté","Nouvelle-Aquitaine",
"Centre-Val de Loire","Auvergne-Rhône-Alpes","Auvergne-Rhône-Alpes","Pays de la Loire","Centre-Val de Loire","Occitanie","Nouvelle-Aquitaine","Occitanie","Pays de la Loire","Normandie","Grand Est","Normandie","Grand Est","Grand Est","Bretagne","Grand Est","Bourgogne-Franche-Comté","Hauts-de-France","Hauts-de-France","Normandie",
"Hauts-de-France","Hauts-de-France","Auvergne-Rhône-Alpes","Nouvelle-Aquitaine","Occitanie","Occitanie","Grand Est","Grand Est","Auvergne-Rhône-Alpes","Bourgogne-Franche-Comté","Bourgogne-Franche-Comté","Pays de la Loire","Auvergne-Rhône-Alpes","Auvergne-Rhône-Alpes","Île-de-France","Normandie","Île-de-France","Île-de-France","Nouvelle-Aquitaine","Hauts-de-France",
"Occitanie","Occitanie","Provence-Alpes-Côte d’Azur","Provence-Alpes-Côte d’Azur","Pays de la Loire","Nouvelle-Aquitaine","Nouvelle-Aquitaine","Grand Est","Bourgogne-Franche-Comté","Bourgogne-Franche-Comté","Île-de-France","Île-de-France","Île-de-France","Île-de-France","Île-de-France","Île-de-France","su")

# Codes des biorégions (INPN) 
# ALP : alpin
# ATL : atlantique
# MATL : atlantique marin 
# CON : continental 
# MED : méditerranéen
# MMED : méditerranéen marin

bioregion <- c(
  # 01 à 09
  "CON","CON","CON","ALP","ALP","MMED","MED","CON","CON",
  # 10 à 19
  "CON","MED","CON","MMED","ATL","CON","MATL","MATL","CON","CON",
  # 2A, 2B
  "MMED","MMED",
  # 21 à 29
  "CON","MATL","CON","ATL","CON","ALP","ATL","CON","MATL",
  # 30 à 39
  "MMED","CON","CON","ATL","MMED","ATL","CON","ALP","CON",
  # 40 à 49
  "MATL","CON","ALP","CON","CON","ATL","ATL","MED","ATL","MATL",
  # 50 à 59
  "MATL","CON","MATL","CON","CON","MATL","CON","CON","CON","CON",
  # 60 à 69
  "CON","MATL","CON","MATL","CON","MED","CON","CON","CON","CON",
  # 70 à 79
  "CON","CON","ALP","ALP","CON","MATL","CON","CON","MATL","CON",
  # 80 à 89
  "MATL","CON","MMED","MMED","MATL","ATL","CON","CON","CON","CON",
  # 90 à 95
  "CON","CON","CON","CON","CON","CON","CON","ALP"
)

departement_info <- data.frame(
  departement = code,
  region = region,
  bioregion = bioregion)

participant <- participant %>% 
  left_join(departement_info)

participant$bioregion[participant$departement=="su"] <- "ALP"

departement_info %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

### bagueurs

Correspondances des emails entre les participant.es et les 32 premiers bagueurs (CRBPO)

```{r}
#| echo: false
#| message: false
#| warning: false
bagueurs <- read_excel("Data/bagueurs.xlsx", col_names = FALSE)

bagueurs <- bagueurs %>% 
  rename(email = "...1") %>% 
  mutate(bagueur = 1)

participant <- participant %>% 
  left_join(bagueurs)

participant$bagueur[participant$bagueur == 1] <- "Oui"
participant$bagueur[is.na(participant$bagueur)] <- "Non"
```

### expert SP

Si participation_stoc == "Oui", participation_shoc == "Oui", participation_epoc == "Oui", bagueur == "Oui" ou nb_obs_cocheurs \>= 300, alors la·e participant·e est considéré·e comme expert·e.

```{r}
#| echo: false
participant <- participant %>% 
  mutate(expert = case_when(participation_stoc == "Oui" | 
                              participation_shoc == "Oui" | 
                              participation_epoc == "Oui" | 
                              bagueur == "Oui" |
                              nb_obs_cocheurs >= 300 ~ "Oui",
                        TRUE ~ "Non"))
```

## species

Nom vernatuclaire et code espèce

```{r}
#| echo: false
#| message: false
#| warning: false
species <- read_csv("Data/species.csv", locale = locale(encoding = "ISO-8859-1"))

species$french_name[species$french_name=="Grosbec casse-noyaux"] <- "Grosbec cassenoyaux"

species_2 <- species %>% 
  dplyr::select(pk_species, french_name) %>% 
  rename(espece = french_name,
         code_espece = pk_species)

species_2 %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

### shoc

Tendances SHOC

```{r}
#| echo: false
#| message: false
#| warning: false
longTermTrends <- read_csv("Data/longTermTrends.csv")

tendances <- longTermTrends %>% 
  dplyr::select(species, trend) %>% 
  rename(code_espece = species,
         tendance_shoc = trend)

tendances <- tendances %>% 
  left_join(species_2)

tendances %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

table(tendances$tendance_shoc)
```

### stoc

Tendances SHOC et STOC

```{r}
#| echo: false
#| message: false
#| warning: false
tendances_stoc <- readr::read_csv("Data/STOC/shortTermTrends.csv", locale = locale(encoding = "UTF-8"))

tendances_stoc <- tendances_stoc %>% 
  dplyr::select(french_name, trend) %>% 
  rename(espece = french_name, tendances_stoc = trend) %>% 
  mutate(tendances_stoc_simplifie = case_when(tendances_stoc %in% c("Augmentation forte","Augmentation modérée","Augmentation modérée à forte") ~ "Augmentation",
                                              tendances_stoc %in% c("Déclin fort","Déclin modéré","Déclin modéré à fort") ~ "Déclin",
                                              TRUE ~ tendances_stoc),
         tendances_stoc_simplifie_2 = case_when(tendances_stoc_simplifie %in% c("Augmentation","Déclin") ~ "Changement",
                                              TRUE ~ "incertain ou stable"))
tendances <- tendances %>% 
  left_join(tendances_stoc)

tendances %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

### traits

```{r}
#| echo: false
#| message: false
#| warning: false
trait_SHOC_HUMAIN <- read_excel("Data/trait_SHOC-HUMAIN.xlsx")

trait_SHOC_HUMAIN$abondance_log <- log(trait_SHOC_HUMAIN$abondance)
trait_SHOC_HUMAIN$abondance_div <- trait_SHOC_HUMAIN$abondance/1000000

trait_SHOC_HUMAIN %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

## catégories de tendances

```{r}
#| echo: false
#| message: false
#| warning: false

# avis__________________________________________________________________________

print("avis quiz shoc")

table(avis$avis_niv1, useNA = "always")
table(avis$avis_niv2, useNA = "always")

avis$avis_niv1[avis$avis_niv1=="En augmentation"] <- "Augmentation"
avis$avis_niv1[avis$avis_niv1=="En déclin"] <- "Déclin"
avis$avis_niv1[avis$avis_niv1=="Je ne sais pas"] <- "Incertain"
table(avis$avis_niv1, useNA = "always")

avis$avis_niv2[avis$avis_niv2=="Fort"] <- "fort"
avis$avis_niv2[avis$avis_niv2=="Modéré"] <- "modéré"
avis$avis_niv2[avis$avis_niv2=="Modéré à fort"] <- "modéré à fort"
avis$avis_niv2 <- trimws(paste(
  ifelse(is.na(avis$avis_niv1), "", avis$avis_niv1),
  ifelse(is.na(avis$avis_niv2), "", avis$avis_niv2)
))
table(avis$avis_niv2, useNA = "always")

avis$avis_niv2[avis$avis_niv2=="Fluctuante modéré"] <- "Fluctuante"
avis$avis_niv2[avis$avis_niv2 %in% c("Incertain modéré","Incertain modéré à fort")] <- "Incertain"
avis$avis_niv2[avis$avis_niv2 %in% c("Stable fort","Stable modéré","Stable modéré à fort")] <- "Stable"
table(avis$avis_niv2, useNA = "always")

avis$avis_niv2[avis$avis_niv2=="Augmentation"] <- NA
avis$avis_niv2[avis$avis_niv2=="Déclin"] <- NA


print("catégoies quiz shoc après transformation en 2 nouveaux")
print("niveau 1")
table(avis$avis_niv1)
print("niveau 2")
table(avis$avis_niv2)

# tendances_____________________________________________________________________

tendances$tendance_shoc[tendances$tendance_shoc=="Augmentation modérée"] <- "Augmentation modéré"
tendances$tendance_shoc[tendances$tendance_shoc=="Augmentation modérée à forte"] <- "Augmentation modéré à fort"
tendances$tendance_shoc[tendances$tendance_shoc=="Augmentation forte"] <- "Augmentation fort"

tendances <- tendances %>% 
  mutate(tendance_shoc_niv1 = case_when(tendance_shoc %in% c("Augmentation fort","Augmentation modéré","Augmentation modéré à fort") ~ "Augmentation",
                                         tendance_shoc %in% c("Déclin fort","Déclin modéré","Déclin modéré à fort") ~ "Déclin",
                                         tendance_shoc %in% c("Incertain", "Fluctuante") ~ "Incertain",
                                         tendance_shoc == "Stable" ~ "Stable"),
         tendance_shoc_niv2 = tendance_shoc)

print("catégoies des tendances shoc")
print("niveau 1")
table(tendances$tendance_shoc_niv1)
print("niveau 2")
table(tendances$tendance_shoc_niv2)
```

## dataset

```{r}
#| echo: false
#| message: false
#| warning: false
dataset <- avis %>% 
  left_join(trait_SHOC_HUMAIN) %>% 
  left_join(participant) %>% 
  left_join(tendances) %>% 
  dplyr::select(-code_espece)

# on garde que les espèce en commun entre le quiz et le shoc
dataset <- dataset %>% 
  filter(espece != "Etourneau sansonnet") %>% 
  filter(espece != "Grive mauvis")

dataset <- dataset[!is.na(dataset$departement),]
  
```

## comparaison SHOC vs Humain

Si tendances SHOC et réponses identiques ou différentes

**Niveau 1 :**

Augmentation = augmentation

Déclin = déclin

Stable = stable

Incertain = je ne sais pas, fluctuante ou incertain

```{r}
#| echo: false
#| message: false
#| warning: false
dataset <- dataset %>%
  mutate(
    comparaison_niv1 = if_else(
      str_trim(avis_niv1) == str_trim(tendance_shoc_niv1), 
      "identique", 
      "different"
    ),
    comparaison_niv2 = if_else(
      str_trim(avis_niv2) == str_trim(tendance_shoc_niv2), 
      "identique", 
      "different"
    )
  )

# dataset <- dataset %>% 
#   dplyr::select(-avis_niv1, -avis_niv2, -participation_odj, -tendance_shoc, -tendance_shoc_niv1, -tendance_shoc_niv2) %>% 
#   na.omit()

# jeu de données propres à analyser :
print("Jeu de données propres à analyser")
dataset %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

verif_dt <- dataset %>% 
  dplyr::select(avis_niv1, avis_niv2, tendance_shoc, tendance_shoc_niv1, tendance_shoc_niv2, comparaison_niv1, comparaison_niv2)
```

```{r}
#| echo: false
rm(avis, avis_large, bagueurs, cocheurs, cocheurs2, departement_info, longTermTrends, participant, quiz, quiz_2,
   species, species_2, tendances, tendances_stoc)
```

# \*\*\* exploration données

```{r}
#| echo: false
summary(dataset)

# table(dataset$email, useNA = "always")
print("espece")
table(dataset$espece, useNA = "always")
print("departement")
table(dataset$departement, useNA = "always")
print("participation_stoc")
table(dataset$participation_stoc, useNA = "always")
print("participation_shoc")
table(dataset$participation_shoc, useNA = "always")
print("participation_epoc")
table(dataset$participation_epoc, useNA = "always")
print("sexe")
table(dataset$sexe, useNA = "always")
print("cocheur")
table(dataset$cocheur, useNA = "always")
print("anciennete")
table(dataset$anciennete, useNA = "always")
print("region")
table(dataset$region, useNA = "always")
print("bioregion")
table(dataset$bioregion, useNA = "always")
print("bagueur")
table(dataset$bagueur, useNA = "always")
print("expert")
table(dataset$expert, useNA = "always")
print("tendances_stoc")
table(dataset$tendances_stoc, useNA = "always")
print("tendances_stoc_simplifie")
table(dataset$tendances_stoc_simplifie, useNA = "always")
print("tendances_stoc_simplifie_2")
table(dataset$tendances_stoc_simplifie_2, useNA = "always")
print("detectabilite")
table(dataset$detectabilite, useNA = "always")
print("gregaire")
table(dataset$gregaire, useNA = "always")
print("fluctuante")
table(dataset$fluctuante, useNA = "always")
print("migrateur")
table(dataset$migrateur, useNA = "always")
print("migrateur simplifié")
table(dataset$migrateur_simplifie, useNA = "always")
print("abondance")
table(dataset$abondance, useNA = "always")
print("regime")
table(dataset$regime, useNA = "always")
print("popularite")
table(dataset$popularite, useNA = "always")
print("comparaison_niv1")
table(dataset$comparaison_niv1, useNA = "always")
print("comparaison_niv2")
table(dataset$comparaison_niv2, useNA = "always")

# variable type
dataset$comparaison_niv1 <- as.factor(dataset$comparaison_niv1)
dataset$comparaison_niv2 <- as.factor(dataset$comparaison_niv2)
```

# \*\*\* ordinales

## niv 1

### données

```{r}
#| include: false

dt1 <- dataset %>% 
  dplyr::select("email","espece","avis_niv1","migrateur","regime",
                "detectabilite","gregaire","popularite",
                "abondance_log","departement","sexe",
                "anciennete","region","bioregion","expert",
                "tendances_stoc",
                "tendance_shoc_niv1") %>% 
  filter(avis_niv1 != "Fluctuante",
         avis_niv1 != "Incertain") %>% 
  filter(tendance_shoc_niv1 != "Fluctuante",
         tendance_shoc_niv1 != "Incertain") %>%
  na.omit()

unique(dt1$avis_niv1)

dt1 <- dt1 %>%
  mutate(
    avis_niv1 = factor(
      avis_niv1,
      levels = c("Déclin" ,"Stable", "Augmentation"),
      ordered = TRUE
    ),
    tendance_shoc_niv1 = factor(
      tendance_shoc_niv1,
      levels = c("Déclin" ,"Stable", "Augmentation"),
      ordered = TRUE
    )
  ) %>% 
  na.omit()
```

### aléatoire

```{r}
#| eval: false
#| include: false

m_n1.1 <- clmm(avis_niv1 ~ 1 + 
                    (1 | email), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.2 <- clmm(avis_niv1 ~ 1 + 
                    (1 | region), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.3 <- clmm(avis_niv1 ~ 1 + 
                    (1 | bioregion), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.4 <- clmm(avis_niv1 ~ 1 + 
                    (1 | departement), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.5 <- clmm(avis_niv1 ~ 1 + 
                     (1 | email) + (1 | region), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.6 <- clmm(avis_niv1 ~ 1 + 
                     (1 | email) + (1 | bioregion), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
m_n1.7 <- clmm(avis_niv1 ~ 1 + 
                     (1 | email) + (1 | departement), data = dt1, link = "logit", Hess = TRUE, na.action = na.omit)
```

```{r}
#| echo: false
AIC_dt_n1_aleatoire <- as.data.frame(AIC(m_n1.1, m_n1.2, m_n1.3, m_n1.4, m_n1.5, m_n1.6, m_n1.7))

AIC_dt_n1_aleatoire <- AIC_dt_n1_aleatoire %>% 
  arrange(AIC) ; AIC_dt_n1_aleatoire

summary(m_n1.1)
```

### base

```{r}
#| eval: false
#| include: false
m_n1_base <- clmm(avis_niv1 ~ tendance_shoc_niv1 + (1 | email), data = dt1, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
summary(m_n1_base)
```

### (espece)

```{r}
#| eval: false
#| include: false
m_n1_esp <- clmm(avis_niv1 ~ tendance_shoc_niv1*espece + (1 | email), data = dt1, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
summary(m_n1_esp)
```

### trait

```{r}
#| eval: false
#| include: false

# abondance *** int ***
m_n1_trait_1 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + abondance_log + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_1, m_n1_base)
m_n1_trait_1int <- clmm(avis_niv1 ~ tendance_shoc_niv1*abondance_log + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_1, m_n1_trait_1int)

# popularite *** int ***
m_n1_trait_2 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + popularite + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_2, m_n1_base)
m_n1_trait_2int <- clmm(avis_niv1 ~ tendance_shoc_niv1*popularite + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_2, m_n1_trait_2int) 

# detectabilite *** int ***
m_n1_trait_3 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + detectabilite + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_3, m_n1_base)
m_n1_trait_3int <- clmm(avis_niv1 ~ tendance_shoc_niv1*detectabilite + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_3, m_n1_trait_3int) 

# regime *** int ***
m_n1_trait_4 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + regime + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_4, m_n1_base)
m_n1_trait_4int <- clmm(avis_niv1 ~ tendance_shoc_niv1*regime + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_4, m_n1_trait_4int)

# migrateur *** int ***
m_n1_trait_5 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + migrateur + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_5, m_n1_base)
m_n1_trait_5int <- clmm(avis_niv1 ~ tendance_shoc_niv1*migrateur + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_5, m_n1_trait_5int) 

# gregaire *** int ***
m_n1_trait_6 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + gregaire + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_6, m_n1_base)
m_n1_trait_6int <- clmm(avis_niv1 ~ tendance_shoc_niv1*gregaire + (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_trait_6, m_n1_trait_6int) 

# all
m_n1_trait_all <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + popularite + detectabilite + regime + migrateur + gregaire +
                    (1 | email), data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_allint <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + 
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + migrateur + gregaire) + 
                    (1 | email), data = dt1, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
AIC_dt_trait <- as.data.frame(AIC(m_n1_base, 
                                  m_n1_trait_1, m_n1_trait_2, m_n1_trait_3, m_n1_trait_4, m_n1_trait_5, m_n1_trait_6,
                                  m_n1_trait_3int, m_n1_trait_4int, m_n1_trait_5int, m_n1_trait_6int, m_n1_trait_all,
                                  m_n1_trait_allint))

AIC_dt_trait <- AIC_dt_trait %>% 
  arrange(AIC) ; AIC_dt_trait

summary(m_n1_trait_allint)
```

### participant

```{r}
#| eval: false
#| include: false

# sexe *** int ***
m_n1_participant_1 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + sexe + 
                                (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_1, m_n1_base)
m_n1_participant_1int <- clmm(avis_niv1 ~ tendance_shoc_niv1*sexe + 
                                   (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_1, m_n1_participant_1int) 

# anciennete int ***
m_n1_participant_2 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + anciennete + 
                                (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_2, m_n1_base)
m_n1_participant_2int <- clmm(avis_niv1 ~ tendance_shoc_niv1*anciennete + 
                                   (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_2, m_n1_participant_2int) 

# expert int ***
m_n1_participant_3 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + expert + 
                                (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_3, m_n1_base)
m_n1_participant_3int <- clmm(avis_niv1 ~ tendance_shoc_niv1*expert + 
                                   (1 | email), data = dt1, link = "logit", Hess = TRUE)
anova(m_n1_participant_3, m_n1_participant_3int) 

# all 
m_n1_participant_all <- clmm(avis_niv1 ~ tendance_shoc_niv1 +
                    sexe + anciennete + expert +
                    (1 | email), data = dt1, link = "logit", Hess = TRUE)
m_n1_participant_allint <- clmm(avis_niv1 ~ tendance_shoc_niv1 +
                    sexe + anciennete + expert + 
                    tendance_shoc_niv1:(sexe + anciennete + expert) +
                    (1 | email), data = dt1, link = "logit", Hess = TRUE)

```

```{r}
#| echo: false
AIC_dt_n1_participant <- as.data.frame(AIC(m_n1_base, 
                                m_n1_participant_1, m_n1_participant_2, m_n1_participant_3,
                                m_n1_participant_1int, m_n1_participant_2int, m_n1_participant_3int,
                                m_n1_participant_all, m_n1_participant_allint))

AIC_dt_n1_participant <- AIC_dt_n1_participant %>% 
  arrange(AIC) ; AIC_dt_n1_participant

summary(m_n1_participant_allint)
```

### espece + participant

```{r}
#| eval: false
#| include: false
m_n1_trait_participant_allint <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + 
                      sexe + anciennete + expert +
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + migrateur + gregaire + sexe + anciennete + expert) +
                    (1 | email), data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_participant_allint_1 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + 
                      sexe + anciennete + expert +
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + migrateur + gregaire) +
                    (1 | email), data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_participant_allint_2 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + 
                      sexe + anciennete + expert +
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + migrateur + gregaire + sexe) +
                    (1 | email), data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_participant_allint_3 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + 
                      sexe + anciennete + expert +
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + migrateur + gregaire + sexe + anciennete) +
                    (1 | email), data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_participant_allint_4 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + 
                      sexe + anciennete + expert +
                    tendance_shoc_niv1:(abondance_log + popularite + detectabilite + regime + migrateur + gregaire + sexe + expert) +
                    (1 | email), data = dt1, link = "logit", Hess = TRUE)
m_n1_trait_participant_allint_5 <- clmm(avis_niv1 ~ tendance_shoc_niv1 + 
                    abondance_log + regime + popularite + detectabilite + migrateur + gregaire + 
                      sexe + anciennete + expert +
                    tendance_shoc_niv1:(sexe + anciennete + expert) +
                    (1 | email), data = dt1, link = "logit", Hess = TRUE)

```

```{r}
#| echo: false
AIC_dt_all_n1 <- as.data.frame(AIC(m_n1_base,
                                   m_n1_trait_1, m_n1_trait_2, m_n1_trait_3, m_n1_trait_4, m_n1_trait_5, m_n1_trait_6,
                                   m_n1_trait_1int, m_n1_trait_2int, m_n1_trait_3int, m_n1_trait_4int, m_n1_trait_5int, m_n1_trait_6int,
                                   m_n1_trait_all, m_n1_trait_allint, 
                                   m_n1_participant_1, m_n1_participant_2, m_n1_participant_3,
                                   m_n1_participant_1int, m_n1_participant_2int, m_n1_participant_3int,
                                   m_n1_participant_all, m_n1_participant_allint,
                                   m_n1_trait_participant_allint_1, m_n1_trait_participant_allint_2, m_n1_trait_participant_allint_3,
                                   m_n1_trait_participant_allint_4, m_n1_trait_participant_allint_5))

AIC_dt_all_n1 <- AIC_dt_all_n1 %>% 
  arrange(AIC) ; AIC_dt_all_n1

summary(m_n1_trait_participant_allint_3)
```

## niv 2

### données

```{r}
#| include: false

dt2 <- dataset %>% 
  dplyr::select("email","espece","avis_niv2","migrateur","regime",
                "detectabilite","gregaire","popularite",
                "abondance_log","departement","sexe",
                "anciennete","region","bioregion","expert",
                "tendances_stoc",
                "tendance_shoc_niv2") %>% 
  filter(avis_niv2 != "Fluctuante",
         avis_niv2 != "Incertain") %>% 
  filter(tendance_shoc_niv2 != "Fluctuante",
         tendance_shoc_niv2 != "Incertain") %>%
  na.omit()

unique(dt2$avis_niv2)

dt2 <- dt2 %>%
  mutate(
    avis_niv2 = factor(
      avis_niv2,
      levels = c("Déclin fort", "Déclin modéré à fort", "Déclin modéré", 
                 "Stable", 
                 "Augmentation modéré", "Augmentation modéré à fort", "Augmentation fort"),
      ordered = TRUE
    ),
    tendance_shoc_niv2 = factor(
      tendance_shoc_niv2,
      levels = c("Déclin fort", "Déclin modéré à fort", "Déclin modéré", 
                 "Stable", 
                 "Augmentation modéré", "Augmentation modéré à fort", "Augmentation fort"),
      ordered = TRUE
    )
  ) %>% 
  na.omit()
```

### aléatoire

```{r}
#| eval: false
#| include: false

m_n2.1 <- clmm(avis_niv2 ~ 1 + (1 | email), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
m_n2.2 <- clmm(avis_niv2 ~ 1 + (1 | region), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
m_n2.3 <- clmm(avis_niv2 ~ 1 + (1 | bioregion), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
m_n2.4 <- clmm(avis_niv2 ~ 1 + (1 | departement), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
m_n2.5 <- clmm(avis_niv2 ~ 1 + (1 | email) + (1 | region), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
m_n2.6 <- clmm(avis_niv2 ~ 1 + (1 | email) + (1 | bioregion), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
m_n2.7 <- clmm(avis_niv2 ~ 1 + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)
```

```{r}
#| echo: false

AIC_dt_n2_aleatoire <- as.data.frame(AIC(m_n2.1, m_n2.2, m_n2.3, m_n2.4, m_n2.5, m_n2.6, m_n2.7))

AIC_dt_n2_aleatoire <- AIC_dt_n2_aleatoire %>% 
  arrange(AIC) ; AIC_dt_n2_aleatoire

summary(m_n2.01)
```

### base !!!!!!!!!!!!!! reprendre ici pour mettre au propre

```{r}
#| eval: false
#| include: false
m_niv_2_1 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
summary(m_niv_2_1)
```

### (espece)

```{r}
#| eval: false
#| include: false
m_niv_2_esp <- clmm(avis_niv2 ~ tendance_shoc_niv2*espece + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
summary(m_niv_2_esp)
```

### trait

```{r}
#| eval: false
#| include: false
# abondance ***
m_niv_2_2 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + abondance_log + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_2, m_niv_2_1)
# m_niv_2_2int <- clmm(avis_niv2 ~ tendance_shoc_niv2*abondance_log + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
# anova(m_niv_2_2, m_niv_2_2int)

# popularite *** int ***
m_niv_2_3 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + popularite + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_3, m_niv_2_1)
m_niv_2_3int <- clmm(avis_niv2 ~ tendance_shoc_niv2*popularite + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_3, m_niv_2_3int) 

# detectabilite *** int ***
m_niv_2_4 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + detectabilite + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_4, m_niv_2_1)
m_niv_2_4int <- clmm(avis_niv2 ~ tendance_shoc_niv2*detectabilite + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_4, m_niv_2_4int) 

# regime ***
m_niv_2_5 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + regime + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_5, m_niv_2_1)
m_niv_2_5int <- clmm(avis_niv2 ~ tendance_shoc_niv2*regime + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_5, m_niv_2_5int)

# migrateur *** int ***
m_niv_2_6 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + migrateur + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_6, m_niv_2_1)
m_niv_2_6int <- clmm(avis_niv2 ~ tendance_shoc_niv2*migrateur + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_6, m_niv_2_6int) 

# gregaire *** int ***
m_niv_2_7 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + gregaire + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_7, m_niv_2_1)
m_niv_2_7int <- clmm(avis_niv2 ~ tendance_shoc_niv2*gregaire + (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_7, m_niv_2_7int) 

# all
m_niv_2_all <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
                    abondance_log + popularite + detectabilite + regime + migrateur + gregaire +
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
m_niv_2_allint <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
                    abondance_log + regime + 
                      popularite + detectabilite + migrateur + gregaire + 
                    tendance_shoc_niv2:(popularite + detectabilite) + 
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
m_niv_2_allint_2 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
                    abondance_log + regime + 
                      popularite + detectabilite + migrateur + gregaire + 
                    tendance_shoc_niv2:(popularite + migrateur) + 
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
m_niv_2_allint_3 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
                    abondance_log + regime + 
                      popularite + detectabilite + migrateur + gregaire + 
                    tendance_shoc_niv2:(popularite + gregaire) + 
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
# m_niv_2_allint_4 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
#                     abondance_log + regime + 
#                       popularite + detectabilite + migrateur + gregaire + 
#                     tendance_shoc_niv2:(detectabilite + migrateur) + 
#                     (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
# m_niv_2_allint_5 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
#                     abondance_log + regime + 
#                       popularite + detectabilite + migrateur + gregaire + 
#                     tendance_shoc_niv2:(detectabilite + gregaire) + 
#                     (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
# m_niv_2_allint_6 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
#                     abondance_log + regime + 
#                       popularite + detectabilite + migrateur + gregaire + 
#                     tendance_shoc_niv2:(migrateur + gregaire) + 
#                     (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)

```

```{r}
#| echo: false

AIC_dt_trait_niv_2 <- as.data.frame(AIC(m_niv_2_1, m_niv_2_2, m_niv_2_3, m_niv_2_4, m_niv_2_5, m_niv_2_6,
    m_niv_2_3int, m_niv_2_4int, m_niv_2_5int, m_niv_2_6int,
    m_niv_2_all, 
    m_niv_2_allint, 
    m_niv_2_allint_2, m_niv_2_allint_3
    # m_niv_2_allint_4, m_niv_2_allint_5, m_niv_2_allint_6
    ))

AIC_dt_trait_niv_2 <- AIC_dt_trait_niv_2 %>% 
  arrange(AIC) ; AIC_dt_trait_niv_2

summary(m_niv_2_allint)
```

### participant

```{r}
#| eval: false
#| include: false
# sexe *** int ***
m_niv_2_participant_1 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + sexe + 
                                (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_participant_1, m_niv_2_1)
m_niv_2_participant_1int <- clmm(avis_niv2 ~ tendance_shoc_niv2*anciennete + 
                                   (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_participant_1, m_niv_2_participant_1int) 

# anciennete int ***
m_niv_2_participant_2 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + anciennete + 
                                (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_participant_2, m_niv_2_1)
m_niv_2_participant_2int <- clmm(avis_niv2 ~ tendance_shoc_niv2*anciennete + 
                                   (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_participant_2, m_niv_2_participant_2int) 

# expert int ***
m_niv_2_participant_3 <- clmm(avis_niv2 ~ tendance_shoc_niv2 + expert + 
                                (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_participant_3, m_niv_2_1)
m_niv_2_participant_3int <- clmm(avis_niv2 ~ tendance_shoc_niv2*expert + 
                                   (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
anova(m_niv_2_participant_3, m_niv_2_participant_3int) 

# all 
m_niv_2_participant_all <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
                    sexe + anciennete + expert +
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
m_niv_2_participant_allint <- clmm(avis_niv2 ~ tendance_shoc_niv2 +
                    sexe + anciennete + expert + 
                    tendance_shoc_niv2:(sexe + anciennete + expert) +
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
AIC_dt_niv_2_participant <- as.data.frame(AIC(m_niv_2_1, 
                                m_niv_2_participant_1, m_niv_2_participant_2, m_niv_2_participant_3,
                                m_niv_2_participant_1int, m_niv_2_participant_2int, m_niv_2_participant_3int,
                                m_niv_2_participant_all, m_niv_2_participant_allint))

AIC_dt_niv_2_participant <- AIC_dt_niv_2_participant %>% 
  arrange(AIC) ; AIC_dt_niv_2_participant

summary(m_niv_2_participant_allint)
```

### espece + participant

```{r}
#| eval: false
#| include: false
m_niv_2_trait_participant_allint <- clmm(avis_niv2 ~ tendance_shoc_niv2 + 
                    abondance_log + popularite + detectabilite + migrateur + gregaire + regime +  sexe + anciennete + expert + 
                    tendance_shoc_niv2:(popularite + detectabilite + sexe + anciennete + expert) + 
                    (1 | email) + (1 | departement), data = dt2, link = "logit", Hess = TRUE)
```

```{r}
#| echo: false
AIC_dt_trait_niv_2 <- as.data.frame(AIC(m_niv_2_1, 
                                m_niv_2_participant_1, m_niv_2_participant_2, m_niv_2_participant_3,
                                m_niv_2_participant_1int, m_niv_2_participant_2int,
                                m_niv_2_participant_3int,
                                m_niv_2_participant_all, m_niv_2_participant_allint,
                                m_niv_2_2, m_niv_2_3, m_niv_2_4, m_niv_2_5, m_niv_2_6,
                                m_niv_2_3int, m_niv_2_4int, m_niv_2_5int, m_niv_2_6int,
                                m_niv_2_all, 
                                m_niv_2_allint, 
                                m_niv_2_allint_2, m_niv_2_allint_3,
                                m_niv_2_trait_participant_allint))

AIC_dt_trait_niv_2 <- AIC_dt_trait_niv_2 %>% 
  arrange(AIC) ; AIC_dt_trait_niv_2

summary(m_niv_2_allint)
```

# \*\*\* Chi²

## shoc vs hasard

```{r}
#| echo: false

obs_shoc <- table(dataset$tendance_shoc_niv1)

chisq.test(obs_shoc)

res_shoc <- chisq.test(obs_shoc)

data.frame(
  Tendance = names(obs_shoc),
  Observé = as.numeric(obs_shoc),
  Attendu = res_shoc$expected,
  Résidu_std = res_shoc$stdres
)
```

p-value \< 0.05 → la distribution est significativement différente du hasard

## niv 1 vs hasard

```{r}
#| echo: false

obs_avis_niv1 <- table(dataset$avis_niv1)

chisq.test(obs_avis_niv1)

res_avis_niv1 <- chisq.test(obs_avis_niv1)

data.frame(
  Tendance = names(obs_avis_niv1),
  Observé = as.numeric(obs_avis_niv1),
  Attendu = res_avis_niv1$expected,
  Résidu_std = res_avis_niv1$stdres
)
```

p-value \< 0.05 → la distribution est significativement différente du hasard

## shoc vs niv 1

```{r}
categories_communes <- intersect(names(obs_shoc), names(obs_avis_niv1))

obs_shoc_c <- obs_shoc[categories_communes]
obs_avis_c <- obs_avis_niv1[categories_communes]

tab_chi2 <- rbind(
  SHOC = obs_shoc_c,
  AVIS = obs_avis_c
)

tab_chi2

chisq.test(tab_chi2)

res <- chisq.test(tab_chi2)

print("résidus")
res$stdres

print("proportions")
prop.table(tab_chi2, margin = 1)
```

p-value \< 0.05 → les distributions diffèrent significativement entre SHOC et AVIS

Conclusions :

**Interprétation catégorie par catégorie** 🔹 Augmentation

Résidus :

SHOC +27.6

AVIS −27.6

Proportions :

SHOC 30.0 %

AVIS 16.1 %

👉 Augmentation est massivement plus fréquente dans SHOC que dans AVIS C’est l’un des moteurs principaux du χ².

🔹 Déclin

Résidus :

SHOC +0.92

AVIS −0.92

Proportions :

SHOC 26.7 %

AVIS 26.2 %

👉 Aucune différence réelle Déclin se comporte de la même manière dans les deux sources.

🔹 Incertain

Résidus :

SHOC +16.1

AVIS −16.1

Proportions :

SHOC 26.7 %

AVIS 18.6 %

👉 Incertain est fortement sur-représenté dans SHOC Clairement différent entre les deux distributions.

🔹 Stable

Résidus :

SHOC −42.2

AVIS +42.2

Proportions :

SHOC 16.7 %

AVIS 39.1 %

👉 Stable est massivement plus fréquent dans AVIS que dans SHOC C’est le contraste le plus fort du tableau.

**En résumé**

Les distributions de tendances diffèrent fortement entre SHOC et AVIS (χ², p \< 0.001). Les écarts sont principalement dus à une sur-représentation des modalités « Augmentation » et « Incertain » dans SHOC, tandis que la modalité « Stable » est largement dominante dans AVIS. La modalité « Déclin » ne montre pas de différence significative entre les deux sources.

SHOC → profil plus dynamique / incertain : plus d’Augmentation, plus d’Incertain, peu de Stable

AVIS → profil nettement plus stable, Stable ≈ 40 %, moins d’Augmentation

👉 Ce n’est pas un effet d’échantillon, mais un changement structurel de profil.

**Interprétations possibles ?**

Chez les participant.es, biais vers le stable, et peu d'aumgmentation. En demandant de répondre pour des tendances, on pense moins facilement à répondre stable ? Et oin parle beaucoup des déclins (média, crise ecolo...), mais peu des augmentations, donc les gens n'y pensent pas ?

# \*\*\* proportion identique vs different

## niv 1

```{r}
#| echo: false
print("proportion de tendances d'identiques vs différentes, niveau 1")

print("toutes les tendances")
dt_prop_niv_1 <- as.data.frame(table(dataset$comparaison_niv1, useNA = "always"))
dt_prop_niv_1$prop <- dt_prop_niv_1$Freq / sum(dt_prop_niv_1$Freq)
dt_prop_niv_1

print("toutes declin et augmentation seulement")
dataset_DA <- dataset[dataset$tendance_shoc_niv1 %in% c("Déclin","Augmentation"),]
dt_prop_niv_1_DA <- as.data.frame(table(dataset_DA$comparaison_niv1, useNA = "always"))
dt_prop_niv_1_DA$prop <- dt_prop_niv_1_DA$Freq / sum(dt_prop_niv_1_DA$Freq)
dt_prop_niv_1_DA
```

## niv 2

```{r}
#| echo: false
print("proportion de tendances d'identiques vs différentes, niveau 2")

print("toutes les tendances")
dt_prop_niv_2 <- as.data.frame(table(dataset$comparaison_niv2, useNA = "always"))
dt_prop_niv_2$prop <- dt_prop_niv_2$Freq / sum(dt_prop_niv_2$Freq)
dt_prop_niv_2

print("toutes declin et augmentation seulement")
dataset_DA <- dataset[dataset$tendance_shoc_niv1 %in% c("Déclin","Augmentation"),]
dt_prop_niv_2_DA <- as.data.frame(table(dataset_DA$comparaison_niv1, useNA = "always"))
dt_prop_niv_2_DA$prop <- dt_prop_niv_2_DA$Freq / sum(dt_prop_niv_2_DA$Freq)
dt_prop_niv_2_DA
```

# \*\*\* intelligence collective

## variables

avis_niv1 = "Déclin" \~ -1,"Augmentation" \~ 1, "Stable" \~ 0

round

ou

mean avis \<= -0.2 \~ "Déclin", mean avis \>= 0.2 \~ "Augmentation", -0.2 \< mean avis \> 0.2 \~ "Stable"

```{r}
#| echo: false
dataset_intel <- dataset %>% 
  filter(avis_niv1 != "Incertain") %>% 
  mutate(avis_niv1_intel = case_when(avis_niv1 == "Déclin" ~ -1,
                                     avis_niv1 == "Augmentation" ~ 1,
                                     avis_niv1 == "Stable" ~ 0))

dataset_intel <- dataset_intel[!is.na(dataset_intel$avis_niv1_intel),]

table(dataset_intel$avis_niv1_intel, useNA = "always")

mean_intel_dt <- dataset_intel %>% 
  group_by(espece) %>%
  summarise(mean_avis_niv1_intel = mean(avis_niv1_intel),
            sd_avis_niv1_intel = sd(avis_niv1_intel)) %>% 
  # round
  mutate(round_avis_niv1_intel = round(mean_avis_niv1_intel),
         round_avis_niv1_intel_cat = case_when(round_avis_niv1_intel == "-1" ~ "Déclin",
                                     round_avis_niv1_intel == "1" ~ "Augmentation",
                                     round_avis_niv1_intel == "0" ~ "Stable")) %>%    
  # quartile02
  mutate(quantile02_avis_niv1_intel = round(mean_avis_niv1_intel),
         quantile02_avis_niv1_intel_cat = case_when(mean_avis_niv1_intel <= -0.2 ~ "Déclin",
                                          mean_avis_niv1_intel >= 0.2 ~ "Augmentation",
                                          between(mean_avis_niv1_intel, -0.2,0.2) ~ "Stable"))
  
```

## Chi² : shoc vs round

```{r}
#| echo: false
obs_round <- table(mean_intel_dt$round_avis_niv1_intel_cat)

tendance_shoc <- dataset %>% 
  dplyr::select(espece, tendance_shoc_niv1) %>% 
  distinct() 

obs_shoc <- table(tendance_shoc$tendance_shoc_niv1)

categories_communes <- intersect(names(obs_shoc), names(obs_round))

obs_shoc_c <- obs_shoc[categories_communes]
obs_round_c <- obs_round[categories_communes]

tab_chi2_round <- rbind(
  SHOC = obs_shoc_c,
  AVIS = obs_round
)

tab_chi2_round

chisq.test(tab_chi2_round)

res_round <- chisq.test(tab_chi2_round)

print("résidus")
res_round$stdres

print("proportions")
prop.table(tab_chi2_round, margin = 1)
```

## Chi² : shoc vs quantile 0.2

```{r}
#| echo: false
obs_quantile02 <- table(mean_intel_dt$quantile02_avis_niv1_intel_cat)

tendance_shoc <- dataset %>% 
  dplyr::select(espece, tendance_shoc_niv1) %>% 
  distinct() 

obs_shoc <- table(tendance_shoc$tendance_shoc_niv1)

categories_communes <- intersect(names(obs_shoc), names(obs_quantile02))

obs_shoc_c <- obs_shoc[categories_communes]
obs_quantile02_c <- obs_quantile02[categories_communes]

tab_chi2_quantile02 <- rbind(
  SHOC = obs_shoc_c,
  AVIS = obs_quantile02
)

tab_chi2_quantile02

chisq.test(tab_chi2_quantile02)

res_quantile02 <- chisq.test(tab_chi2_quantile02)

print("résidus")
res_quantile02$stdres

print("proportions")
prop.table(tab_chi2_quantile02, margin = 1)
```

## tendances par espece

```{r}
mean_intel_dt <- mean_intel_dt %>% 
  left_join(tendance_shoc)

dt_intel_quantile02 <- mean_intel_dt %>% 
  dplyr::select(espece, round_avis_niv1_intel_cat, quantile02_avis_niv1_intel_cat, tendance_shoc_niv1) %>% 
  rename(espece = espece, 
         `tendance moyenne arrondie quiz` = round_avis_niv1_intel_cat, 
         `tendance moyenne quantile (-0.2, 0.2) quiz` = quantile02_avis_niv1_intel_cat, 
         `tendance stat SHOC` = tendance_shoc_niv1)

dt_intel_quantile02 %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

dt_intel_quantile02
```

## variabilité des réponses par espece

Pas de correlation entre le tendances moyennes estimées collectivement et la variation (écart-type) dans les réponses

```{r}
plot(mean_intel_dt$mean_avis_niv1_intel, mean_intel_dt$sd_avis_niv1_intel)
summary(lm(mean_intel_dt$mean_avis_niv1_intel ~ mean_intel_dt$sd_avis_niv1_intel))
```

```{r}
save.image(file = "SHOC-humain.RData")
```

# !!!!!!

```{r}
#| eval: false
#| include: false













m_niv_2_1 <- clmm(avis_niv2 ~ 
                    tendance_shoc_niv2 + 
                    migrateur + regime + detectabilite + popularite + abondance_log +
                    (1 | espece) + (1 | email),
                  data = dt2, link = "logit", Hess = TRUE)

m_no_pop <- update(m_full, . ~ . - popularite)

anova(m_full, m_no_pop)



tendance_shoc_niv2:abondance_log

tendance_shoc_niv2:popularite

tendance_shoc_niv2:detectabilite

tendance_shoc_niv2:regime

tendance_shoc_niv2:migrateur








m_niv2.1 <- clmm(avis_niv2 ~ 
                   tendance_shoc_niv2 + 
                   (1 | espece) + (1 | email), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_all <- clmm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         migrateur + 
                         regime + 
                         detectabilite + 
                         popularite + 
                         abondance_log +
                         tendance_shoc_niv2:migrateur + 
                         tendance_shoc_niv2:regime + 
                         tendance_shoc_niv2:detectabilite + 
                         tendance_shoc_niv2:popularite + 
                         tendance_shoc_niv2:abondance_log + 
                         (1 | espece) + (1 | email), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_all_2 <- clm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         migrateur + 
                         regime + 
                         detectabilite + 
                         popularite + 
                         abondance_log +
                         tendance_shoc_niv2:migrateur + 
                         tendance_shoc_niv2:regime + 
                         tendance_shoc_niv2:detectabilite + 
                         tendance_shoc_niv2:popularite + 
                         tendance_shoc_niv2:abondance_log, data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_1 <- clmm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         abondance_log +
                         tendance_shoc_niv2:abondance_log + 
                         (1 | espece) + (1 | email), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_1_norandom <- clm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         abondance_log +
                         tendance_shoc_niv2:abondance_log,
                         data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_2 <- clmm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         popularite +
                         tendance_shoc_niv2:popularite + 
                         (1 | espece) + (1 | email), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_2_norandom <- clm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         popularite +
                         tendance_shoc_niv2:popularite
                         , data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_3 <- clmm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         detectabilite +
                         tendance_shoc_niv2:detectabilite + 
                         (1 | espece) + (1 | email), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_3_norandom <- clm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         detectabilite +
                         tendance_shoc_niv2:detectabilite
                         , data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_4 <- clmm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         regime +
                         tendance_shoc_niv2:regime + 
                         (1 | espece) + (1 | email), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_4_norandom <- clm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         regime +
                         tendance_shoc_niv2:regime
                         , data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_5 <- clmm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         migrateur +
                         tendance_shoc_niv2:migrateur + 
                         (1 | espece) + (1 | email), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_5_norandom <- clm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         migrateur +
                         tendance_shoc_niv2:migrateur
                         , data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_21 <- clmm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         popularite +
                         migrateur + 
                         tendance_shoc_niv2:popularite + 
                         tendance_shoc_niv2:migrateur + 
                         (1 | espece) + (1 | email), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_22 <- clmm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         popularite +
                         regime + 
                         tendance_shoc_niv2:popularite + 
                         tendance_shoc_niv2:regime + 
                         (1 | espece) + (1 | email), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_23 <- clmm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         popularite +
                         abondance_log + 
                         tendance_shoc_niv2:popularite + 
                         tendance_shoc_niv2:abondance_log + 
                         (1 | espece) + (1 | email), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

m_niv2.esp_24 <- clmm(avis_niv2 ~ 
                         tendance_shoc_niv2 + 
                         popularite +
                         detectabilite + 
                         tendance_shoc_niv2:popularite + 
                         tendance_shoc_niv2:detectabilite + 
                         (1 | espece) + (1 | email), data = dt2, link = "logit", Hess = TRUE, na.action = na.omit)

AIC_dt <- as.data.frame(AIC(m_niv2.021, 
    m_niv2.1, 
    # m_niv2.esp_1, m_niv2.esp_2, m_niv2.esp_3,
    # m_niv2.esp_all,
    m_niv2.esp_1, m_niv2.esp_2, m_niv2.esp_3, m_niv2.esp_4, m_niv2.esp_5,
    m_niv2.esp_21, 
    # m_niv2.esp_22, m_niv2.esp_23, m_niv2.esp_24,
    m_niv2.esp_1_norandom, m_niv2.esp_2_norandom, m_niv2.esp_3_norandom, m_niv2.esp_4_norandom, m_niv2.esp_5_norandom
    ))

AIC_dt <- AIC_dt %>% 
  arrange(AIC) ; AIC_dt























modele_base_niv2 <- polr(
   avis_niv2 ~ tendance_shoc_niv2,
    data = dt2,
  Hess = TRUE
)

modele_base_niv2 <- stepAIC(
  modele_base_niv2,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_base_niv2 <- coef(summary(modele_base_niv2))
p_values_base_niv2 <- pnorm(abs(ctable_base_niv2[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_base_niv2, "p value" = p_values_base_niv2)

# plot -------------------------------------------------------------------------

ctable_base_niv2 <- as.data.frame(ctable_base_niv2)

res_base_niv2 <- as.data.frame(ctable_base_niv2) %>%
  mutate(
    variable = rownames(ctable_base_niv2),
    p_value = p_values_base_niv2,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_base_niv2$`Std. Error`,
    upper = Value + 1.96 * ctable_base_niv2$`Std. Error`
  )

res_plot_base_niv2 <- res_base_niv2 %>%
  filter(!grepl("\\|", variable))

res_plot_base_niv2$variable <- factor(
  res_plot_base_niv2$variable,
  levels = res_plot_base_niv2$variable[order(res_plot_base_niv2$Value)]
)

res_plot_base_niv2 <- res_plot_base_niv2 %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# plot 
ggplot(res_plot_base_niv2, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### migrateur

```{r}
#| eval: false
#| include: false
# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      + regime + detectabilite + gregaire + popularite + abondance_log + #migrateur_simplifie
#     sexe + anciennete +
#     expert + # participation_stoc + participation_shoc + participation_epoc + cocheur + bagueur +
#     tendances_stoc, # + tendance_shoc + tendances_stoc_simplifie,
#   data = dt2,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_migrateur <- polr(
   avis_niv1 ~ tendance_shoc_niv1*migrateur,
    data = dt2,
  Hess = TRUE
)

modele_migrateur <- stepAIC(
  modele_migrateur,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_migrateur <- coef(summary(modele_migrateur))
p_values_migrateur <- pnorm(abs(ctable_migrateur[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_migrateur, "p value" = p_values_migrateur)

# plot -------------------------------------------------------------------------

ctable_migrateur <- as.data.frame(ctable_migrateur)

res_migrateur <- as.data.frame(ctable_migrateur) %>%
  mutate(
    variable = rownames(ctable_migrateur),
    p_value = p_values_migrateur,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_migrateur$`Std. Error`,
    upper = Value + 1.96 * ctable_migrateur$`Std. Error`
  )

res_plot_migrateur <- res_migrateur %>%
  filter(!grepl("\\|", variable))

res_plot_migrateur$variable <- factor(
  res_plot_migrateur$variable,
  levels = res_plot_migrateur$variable[order(res_plot_migrateur$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_migrateur <- res_plot_migrateur %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_migrateur$variable <- fct_recode(res_plot_migrateur$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_migrateur, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### regime

```{r}
#| eval: false
#| include: false
# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  + detectabilite + gregaire + popularite + abondance_log + #migrateur_simplifie
#     sexe + anciennete +
#     expert + # participation_stoc + participation_shoc + participation_epoc + cocheur + bagueur +
#     tendances_stoc, # + tendance_shoc + tendances_stoc_simplifie,
#   data = dt2,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_regime <- polr(
   avis_niv1 ~ tendance_shoc_niv1*regime,
    data = dt2,
  Hess = TRUE
)

modele_regime <- stepAIC(
  modele_regime,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_regime <- coef(summary(modele_regime))
p_values_regime <- pnorm(abs(ctable_regime[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_regime, "p value" = p_values_regime)

# plot -------------------------------------------------------------------------

ctable_regime <- as.data.frame(ctable_regime)

res_regime <- as.data.frame(ctable_regime) %>%
  mutate(
    variable = rownames(ctable_regime),
    p_value = p_values_regime,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_regime$`Std. Error`,
    upper = Value + 1.96 * ctable_regime$`Std. Error`
  )

res_plot_regime <- res_regime %>%
  filter(!grepl("\\|", variable))

res_plot_regime$variable <- factor(
  res_plot_regime$variable,
  levels = res_plot_regime$variable[order(res_plot_regime$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_regime <- res_plot_regime %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_regime$variable <- fct_recode(res_plot_regime$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_regime, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### detectabilite

```{r}
#| eval: false
#| include: false
# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  + gregaire + popularite + abondance_log + #migrateur_simplifie
#     sexe + anciennete +
#     expert + # participation_stoc + participation_shoc + participation_epoc + cocheur + bagueur +
#     tendances_stoc, # + tendance_shoc + tendances_stoc_simplifie,
#   data = dt2,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_detectabilite <- polr(
   avis_niv1 ~ tendance_shoc_niv1*detectabilite,
    data = dt2,
  Hess = TRUE
)

modele_detectabilite <- stepAIC(
  modele_detectabilite,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_detectabilite <- coef(summary(modele_detectabilite))
p_values_detectabilite <- pnorm(abs(ctable_detectabilite[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_detectabilite, "p value" = p_values_detectabilite)

# plot -------------------------------------------------------------------------

ctable_detectabilite <- as.data.frame(ctable_detectabilite)

res_detectabilite <- as.data.frame(ctable_detectabilite) %>%
  mutate(
    variable = rownames(ctable_detectabilite),
    p_value = p_values_detectabilite,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_detectabilite$`Std. Error`,
    upper = Value + 1.96 * ctable_detectabilite$`Std. Error`
  )

res_plot_detectabilite <- res_detectabilite %>%
  filter(!grepl("\\|", variable))

res_plot_detectabilite$variable <- factor(
  res_plot_detectabilite$variable,
  levels = res_plot_detectabilite$variable[order(res_plot_detectabilite$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_detectabilite <- res_plot_detectabilite %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_detectabilite$variable <- fct_recode(res_plot_detectabilite$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_detectabilite, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### gregaire

```{r}
#| eval: false
#| include: false
# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  + popularite + abondance_log + 
#     sexe + anciennete +
#     expert + 
#     tendances_stoc, 
#   data = dt2,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_gregaire <- polr(
   avis_niv1 ~ tendance_shoc_niv1*gregaire,
    data = dt2,
  Hess = TRUE
)

modele_gregaire <- stepAIC(
  modele_gregaire,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_gregaire <- coef(summary(modele_gregaire))
p_values_gregaire <- pnorm(abs(ctable_gregaire[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_gregaire, "p value" = p_values_gregaire)

# plot -------------------------------------------------------------------------

ctable_gregaire <- as.data.frame(ctable_gregaire)

res_gregaire <- as.data.frame(ctable_gregaire) %>%
  mutate(
    variable = rownames(ctable_gregaire),
    p_value = p_values_gregaire,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_gregaire$`Std. Error`,
    upper = Value + 1.96 * ctable_gregaire$`Std. Error`
  )

res_plot_gregaire <- res_gregaire %>%
  filter(!grepl("\\|", variable))

res_plot_gregaire$variable <- factor(
  res_plot_gregaire$variable,
  levels = res_plot_gregaire$variable[order(res_plot_gregaire$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_gregaire <- res_plot_gregaire %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_gregaire$variable <- fct_recode(res_plot_gregaire$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_gregaire, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### popularite

```{r}
#| eval: false
#| include: false
# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  +  + abondance_log + 
#     sexe + anciennete +
#     expert + 
#     tendances_stoc, 
#   data = dt2,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_popularite <- polr(
   avis_niv1 ~ tendance_shoc_niv1*popularite,
    data = dt2,
  Hess = TRUE
)

modele_popularite <- stepAIC(
  modele_popularite,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_popularite <- coef(summary(modele_popularite))
p_values_popularite <- pnorm(abs(ctable_popularite[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_popularite, "p value" = p_values_popularite)

# plot -------------------------------------------------------------------------

ctable_popularite <- as.data.frame(ctable_popularite)

res_popularite <- as.data.frame(ctable_popularite) %>%
  mutate(
    variable = rownames(ctable_popularite),
    p_value = p_values_popularite,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_popularite$`Std. Error`,
    upper = Value + 1.96 * ctable_popularite$`Std. Error`
  )

res_plot_popularite <- res_popularite %>%
  filter(!grepl("\\|", variable))

res_plot_popularite$variable <- factor(
  res_plot_popularite$variable,
  levels = res_plot_popularite$variable[order(res_plot_popularite$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_popularite <- res_plot_popularite %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_popularite$variable <- fct_recode(res_plot_popularite$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_popularite, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### abondance_log

```{r}
#| eval: false
#| include: false
# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  +  +  + 
#     sexe + anciennete +
#     expert + 
#     tendances_stoc, 
#   data = dt2,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_abondance_log <- polr(
   avis_niv1 ~ tendance_shoc_niv1*abondance_log,
    data = dt2,
  Hess = TRUE
)

modele_abondance_log <- stepAIC(
  modele_abondance_log,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_abondance_log <- coef(summary(modele_abondance_log))
p_values_abondance_log <- pnorm(abs(ctable_abondance_log[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_abondance_log, "p value" = p_values_abondance_log)

# plot -------------------------------------------------------------------------

ctable_abondance_log <- as.data.frame(ctable_abondance_log)

res_abondance_log <- as.data.frame(ctable_abondance_log) %>%
  mutate(
    variable = rownames(ctable_abondance_log),
    p_value = p_values_abondance_log,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_abondance_log$`Std. Error`,
    upper = Value + 1.96 * ctable_abondance_log$`Std. Error`
  )

res_plot_abondance_log <- res_abondance_log %>%
  filter(!grepl("\\|", variable))

res_plot_abondance_log$variable <- factor(
  res_plot_abondance_log$variable,
  levels = res_plot_abondance_log$variable[order(res_plot_abondance_log$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_abondance_log <- res_plot_abondance_log %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_abondance_log$variable <- fct_recode(res_plot_abondance_log$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_abondance_log, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### sexe

```{r}
#| eval: false
#| include: false
# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  +  +  + 
#      + anciennete +
#     expert + 
#     tendances_stoc, 
#   data = dt2,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_sexe <- polr(
   avis_niv1 ~ tendance_shoc_niv1*sexe,
    data = dt2,
  Hess = TRUE
)

modele_sexe <- stepAIC(
  modele_sexe,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_sexe <- coef(summary(modele_sexe))
p_values_sexe <- pnorm(abs(ctable_sexe[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_sexe, "p value" = p_values_sexe)

# plot -------------------------------------------------------------------------

ctable_sexe <- as.data.frame(ctable_sexe)

res_sexe <- as.data.frame(ctable_sexe) %>%
  mutate(
    variable = rownames(ctable_sexe),
    p_value = p_values_sexe,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_sexe$`Std. Error`,
    upper = Value + 1.96 * ctable_sexe$`Std. Error`
  )

res_plot_sexe <- res_sexe %>%
  filter(!grepl("\\|", variable))

res_plot_sexe$variable <- factor(
  res_plot_sexe$variable,
  levels = res_plot_sexe$variable[order(res_plot_sexe$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_sexe <- res_plot_sexe %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_sexe$variable <- fct_recode(res_plot_sexe$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_sexe, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### anciennete

```{r}
#| eval: false
#| include: false
# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  +  +  + 
#      +  +
#     expert + 
#     tendances_stoc, 
#   data = dt2,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_anciennete <- polr(
   avis_niv1 ~ tendance_shoc_niv1*anciennete,
    data = dt2,
  Hess = TRUE
)

modele_anciennete <- stepAIC(
  modele_anciennete,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_anciennete <- coef(summary(modele_anciennete))
p_values_anciennete <- pnorm(abs(ctable_anciennete[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_anciennete, "p value" = p_values_anciennete)

# plot -------------------------------------------------------------------------

ctable_anciennete <- as.data.frame(ctable_anciennete)

res_anciennete <- as.data.frame(ctable_anciennete) %>%
  mutate(
    variable = rownames(ctable_anciennete),
    p_value = p_values_anciennete,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_anciennete$`Std. Error`,
    upper = Value + 1.96 * ctable_anciennete$`Std. Error`
  )

res_plot_anciennete <- res_anciennete %>%
  filter(!grepl("\\|", variable))

res_plot_anciennete$variable <- factor(
  res_plot_anciennete$variable,
  levels = res_plot_anciennete$variable[order(res_plot_anciennete$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_anciennete <- res_plot_anciennete %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_anciennete$variable <- fct_recode(res_plot_anciennete$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_anciennete, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### expert

```{r}
#| eval: false
#| include: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  +  +  + 
#      +  +
#      + 
#     tendances_stoc, 
#   data = dt2,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_expert <- polr(
   avis_niv1 ~ tendance_shoc_niv1*expert,
    data = dt2,
  Hess = TRUE
)

modele_expert <- stepAIC(
  modele_expert,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_expert <- coef(summary(modele_expert))
p_values_expert <- pnorm(abs(ctable_expert[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_expert, "p value" = p_values_expert)

# plot -------------------------------------------------------------------------

ctable_expert <- as.data.frame(ctable_expert)

res_expert <- as.data.frame(ctable_expert) %>%
  mutate(
    variable = rownames(ctable_expert),
    p_value = p_values_expert,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_expert$`Std. Error`,
    upper = Value + 1.96 * ctable_expert$`Std. Error`
  )

res_plot_expert <- res_expert %>%
  filter(!grepl("\\|", variable))

res_plot_expert$variable <- factor(
  res_plot_expert$variable,
  levels = res_plot_expert$variable[order(res_plot_expert$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_expert <- res_plot_expert %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_expert$variable <- fct_recode(res_plot_expert$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_expert, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### tendances_stoc

```{r}
#| eval: false
#| include: false
# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  +  +  + 
#      +  +
#      + 
#     , 
#   data = dt2,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_tendances_stoc <- polr(
   avis_niv1 ~ tendance_shoc_niv1*tendances_stoc,
    data = dt2,
  Hess = TRUE
)

modele_tendances_stoc <- stepAIC(
  modele_tendances_stoc,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_tendances_stoc <- coef(summary(modele_tendances_stoc))
p_values_tendances_stoc <- pnorm(abs(ctable_tendances_stoc[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_tendances_stoc, "p value" = p_values_tendances_stoc)

# plot -------------------------------------------------------------------------

ctable_tendances_stoc <- as.data.frame(ctable_tendances_stoc)

res_tendances_stoc <- as.data.frame(ctable_tendances_stoc) %>%
  mutate(
    variable = rownames(ctable_tendances_stoc),
    p_value = p_values_tendances_stoc,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_tendances_stoc$`Std. Error`,
    upper = Value + 1.96 * ctable_tendances_stoc$`Std. Error`
  )

res_plot_tendances_stoc <- res_tendances_stoc %>%
  filter(!grepl("\\|", variable))

res_plot_tendances_stoc$variable <- factor(
  res_plot_tendances_stoc$variable,
  levels = res_plot_tendances_stoc$variable[order(res_plot_tendances_stoc$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_tendances_stoc <- res_plot_tendances_stoc %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_tendances_stoc$variable <- fct_recode(res_plot_tendances_stoc$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_tendances_stoc, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### all_espece

```{r}
#| eval: false
#| include: false
# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      + regime + detectabilite + gregaire + popularite + abondance_log + #migrateur_simplifie
#     sexe + anciennete +
#     expert + # participation_stoc + participation_shoc + participation_epoc + cocheur + bagueur +
#     tendances_stoc, # + tendance_shoc + tendances_stoc_simplifie,
#   data = dt2,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_all_espece <- polr(
   avis_niv1 ~ tendance_shoc_niv1 + 
     # migrateur + regime +
     detectabilite + gregaire + popularite + abondance_log +  
     # tendance_shoc_niv1:migrateur +
     # tendance_shoc_niv1:regime +
     tendance_shoc_niv1:detectabilite +
     tendance_shoc_niv1:gregaire +
     tendance_shoc_niv1:popularite +
     tendance_shoc_niv1:abondance_log, # +
     # tendance_shoc_niv1:tendances_stoc,
    data = dt2,
  Hess = TRUE
)

modele_all_espece <- stepAIC(
  modele_all_espece,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_all_espece <- coef(summary(modele_all_espece))
p_values_all_espece <- pnorm(abs(ctable_all_espece[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_all_espece, "p value" = p_values_all_espece)

# plot -------------------------------------------------------------------------

ctable_all_espece <- as.data.frame(ctable_all_espece)

res_all_espece <- as.data.frame(ctable_all_espece) %>%
  mutate(
    variable = rownames(ctable_all_espece),
    p_value = p_values_all_espece,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_all_espece$`Std. Error`,
    upper = Value + 1.96 * ctable_all_espece$`Std. Error`
  )

res_plot_all_espece <- res_all_espece %>%
  filter(!grepl("\\|", variable))

res_plot_all_espece$variable <- factor(
  res_plot_all_espece$variable,
  levels = res_plot_all_espece$variable[order(res_plot_all_espece$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_all_espece <- res_plot_all_espece %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
unique(res_plot_all_espece$variable)
res_plot_all_espece$variable <- fct_recode(res_plot_all_espece$variable,
                                "Detectabilite (Forte)" = "detectabiliteForte",
                                "Gregaire (Oui)" = "gregaireOui",
                                "Popularite (Oui)" = "populariteOui",
                                "Abondance" = "abondance_log",
                                "SHOC - Linéaire : Detectabilite (Forte)" = "tendance_shoc_niv1.L:detectabiliteForte",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L",
                                "SHOC - Linéaire : Detectabilite (Forte)" = "tendance_shoc_niv1.L:detectabiliteForte",
                                "SHOC - Linéaire : Gregaire (Oui)" = "tendance_shoc_niv1.L:gregaireOui",
                                "SHOC - Linéaire : Abondance" = "tendance_shoc_niv1.L:abondance_log",
                                "SHOC - Linéaire : Popularité (Oui)" = "tendance_shoc_niv1.L:populariteOui",
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Quadratique : Detectabilite (Forte)" = "tendance_shoc_niv1.Q:detectabiliteForte",
                                "SHOC - Quadratique : Gregaire (Oui)" = "tendance_shoc_niv1.Q:gregaireOui",
                                "SHOC - Quadratique : Abondance" = "tendance_shoc_niv1.Q:abondance_log",
                                "SHOC - Quadratique : Popularité (Oui)" = "tendance_shoc_niv1.Q:populariteOui")

# plot 
ggplot(res_plot_all_espece, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.015625, 0.03125, 0.0625, 0.125, 0.25, 0.5, 1, 2, 4, 8),
    labels = c("64X mois", "32X mois", "16X mois", "8X mois", "4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = ""
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### all_participant

```{r}
#| eval: false
#| include: false
# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      + regime + detectabilite + gregaire + popularite + abondance_log + #migrateur_simplifie
#     sexe + anciennete +
#     expert + # participation_stoc + participation_shoc + participation_epoc + cocheur + bagueur +
#     tendances_stoc, # + tendance_shoc + tendances_stoc_simplifie,
#   data = dt2,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_all_participant <- polr(
   avis_niv1 ~ tendance_shoc_niv1 + 
     sexe + anciennete + expert + 
     tendance_shoc_niv1:sexe +
     tendance_shoc_niv1:anciennete +
     tendance_shoc_niv1:expert, 
    data = dt2,
  Hess = TRUE
)

modele_all_participant <- stepAIC(
  modele_all_participant,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_all_participant <- coef(summary(modele_all_participant))
p_values_all_participant <- pnorm(abs(ctable_all_participant[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_all_participant, "p value" = p_values_all_participant)

# plot -------------------------------------------------------------------------

ctable_all_participant <- as.data.frame(ctable_all_participant)

res_all_participant <- as.data.frame(ctable_all_participant) %>%
  mutate(
    variable = rownames(ctable_all_participant),
    p_value = p_values_all_participant,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_all_participant$`Std. Error`,
    upper = Value + 1.96 * ctable_all_participant$`Std. Error`
  )

res_plot_all_participant <- res_all_participant %>%
  filter(!grepl("\\|", variable))

res_plot_all_participant$variable <- factor(
  res_plot_all_participant$variable,
  levels = res_plot_all_participant$variable[order(res_plot_all_participant$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_all_participant <- res_plot_all_participant %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
unique(res_plot_all_participant$variable)
res_plot_all_participant$variable <- fct_recode(res_plot_all_participant$variable,
                                "Sexe (H)" = "sexeH",
                                "Anciennete" = "anciennete",
                                "Expert (Oui)" = "expert",
                                "STOC (Déclin modéré)" = "tendances_stocDéclin modéré",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L",
                                "SHOC - Linéaire : Sexe (H)" = "tendance_shoc_niv1.L:sexeH",
                                "SHOC - Linéaire : Ancienneté" = "tendance_shoc_niv1.L:anciennete",
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Quadratique : Sexe (H)" = "tendance_shoc_niv1.Q:sexeH",
                                "SHOC - Quadratique : Ancienneté" = "tendance_shoc_niv1.Q:anciennete")

# plot 
ggplot(res_plot_all_participant, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.015625, 0.03125, 0.0625, 0.125, 0.25, 0.5, 1, 2, 4, 8),
    labels = c("64X mois", "32X mois", "16X mois", "8X mois", "4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = ""
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### all_1

```{r}
#| eval: false
#| include: false
# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      + regime + detectabilite + gregaire + popularite + abondance_log + #migrateur_simplifie
#     sexe + anciennete +
#     expert + # participation_stoc + participation_shoc + participation_epoc + cocheur + bagueur +
#     tendances_stoc, # + tendance_shoc + tendances_stoc_simplifie,
#   data = dt2,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_all_1 <- polr(
   avis_niv1 ~ tendance_shoc_niv1 + 
     # migrateur + regime +
     detectabilite + gregaire + popularite + abondance_log + sexe + anciennete + expert + 
     # tendance_shoc_niv1:migrateur +
     # tendance_shoc_niv1:regime +
     tendance_shoc_niv1:detectabilite +
     tendance_shoc_niv1:gregaire +
     tendance_shoc_niv1:popularite +
     tendance_shoc_niv1:abondance_log +
     tendance_shoc_niv1:sexe +
     tendance_shoc_niv1:anciennete +
     # tendance_shoc_niv1:tendances_stoc +
     tendance_shoc_niv1:expert, 
    data = dt2,
  Hess = TRUE
)

modele_all_1 <- stepAIC(
  modele_all_1,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_all_1 <- coef(summary(modele_all_1))
p_values_all_1 <- pnorm(abs(ctable_all_1[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_all_1, "p value" = p_values_all_1)

# plot -------------------------------------------------------------------------

ctable_all_1 <- as.data.frame(ctable_all_1)

res_all_1 <- as.data.frame(ctable_all_1) %>%
  mutate(
    variable = rownames(ctable_all_1),
    p_value = p_values_all_1,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_all_1$`Std. Error`,
    upper = Value + 1.96 * ctable_all_1$`Std. Error`
  )

res_plot_all_1 <- res_all_1 %>%
  filter(!grepl("\\|", variable))

res_plot_all_1$variable <- factor(
  res_plot_all_1$variable,
  levels = res_plot_all_1$variable[order(res_plot_all_1$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_all_1 <- res_plot_all_1 %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
unique(res_plot_all_1$variable)
res_plot_all_1$variable <- fct_recode(res_plot_all_1$variable,
                                "Detectabilite (Forte)" = "detectabiliteForte",
                                "Gregaire (Oui)" = "gregaireOui",
                                "Popularite (Oui)" = "populariteOui",
                                "Abondance" = "abondance_log",
                                "Sexe (H)" = "sexeH",
                                "Anciennete" = "anciennete",
                                "SHOC - Linéaire : Detectabilite (Forte)" = "tendance_shoc_niv1.L:detectabiliteForte",
                                "SHOC (Déclin) : Détectabilité (Forte)" = "tendance_shoc_niv1Déclin:detectabiliteForte",
                                "SHOC (Stable) : Détectabilité (Forte)" = "tendance_shoc_niv1Stable:detectabiliteForte ",
                                "SHOC (Augmentation) : Détectabilité (Forte)" = "tendance_shoc_niv1Augmentation:detectabiliteForte",
                                "SHOC (Déclin) : Grégaire (Oui)" = "tendance_shoc_niv1Déclin:gregaireOui",
                                "STOC (Déclin modéré)" = "tendances_stocDéclin modéré",
                                "SHOC (Stable) : Détectabilité (Forte)" = "tendance_shoc_niv1Stable:detectabiliteOui",
                                "SHOC (Stable) : Grégaire (Oui)" = "tendance_shoc_niv1Stable:gregaireOui",
                                "SHOC (Augmentation) : Grégaire (Oui)" = "tendance_shoc_niv1Augmentation:gregaireOui",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L",
                                "SHOC - Linéaire : Detectabilite (Forte)" = "tendance_shoc_niv1.L:detectabiliteForte",
                                "SHOC - Linéaire : Gregaire (Oui)" = "tendance_shoc_niv1.L:gregaireOui",
                                "SHOC - Linéaire : Abondance" = "tendance_shoc_niv1.L:abondance_log",
                                "SHOC - Linéaire : Popularité (Oui)" = "tendance_shoc_niv1.L:populariteOui",
                                "SHOC - Linéaire : Sexe (H)" = "tendance_shoc_niv1.L:sexeH",
                                "SHOC - Linéaire : Ancienneté" = "tendance_shoc_niv1.L:anciennete",
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Quadratique : Detectabilite (Forte)" = "tendance_shoc_niv1.Q:detectabiliteForte",
                                "SHOC - Quadratique : Gregaire (Oui)" = "tendance_shoc_niv1.Q:gregaireOui",
                                "SHOC - Quadratique : Abondance" = "tendance_shoc_niv1.Q:abondance_log",
                                "SHOC - Quadratique : Popularité (Oui)" = "tendance_shoc_niv1.Q:populariteOui",
                                "SHOC - Quadratique : Sexe (H)" = "tendance_shoc_niv1.Q:sexeH",
                                "SHOC - Quadratique : Ancienneté" = "tendance_shoc_niv1.Q:anciennete")

# plot 
ggplot(res_plot_all_1, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.015625, 0.03125, 0.0625, 0.125, 0.25, 0.5, 1, 2, 4, 8),
    labels = c("64X mois", "32X mois", "16X mois", "8X mois", "4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = ""
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

# save environnement

```{r}
save.image(file = "SHOC-humain.RData")
```

# OLD OLD OLD OLD

# glmer

Modèles biomiale, algorithme d'optimisation "bobyqa".

## niv1

Augmentation, stable, déclin

### effets aléatoires

Selection des effets aléatoires : email, espece, departement, region, bioregion

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
m_n10.1 <- glmer(comparaison_niv1 ~ 1 + (1 | email), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n10.2 <- glmer(comparaison_niv1 ~ 1 + (1 | espece), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n10.3 <- glmer(comparaison_niv1 ~ 1 + (1 | departement), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n10.4 <- glmer(comparaison_niv1 ~ 1 + (1 | region), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n10.5 <- glmer(comparaison_niv1 ~ 1 + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| echo: false
#| message: false
#| warning: false
niv1_random_comp1 <- compare_performance(m_n10.1, m_n10.2, m_n10.3, m_n10.4, m_n10.5) ; niv1_random_comp1
print("m_n10.2")
summary(m_n10.2)
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
m_n10.21 <- glmer(comparaison_niv1 ~ 1 + (1 | espece) + (1 | email), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n10.22 <- glmer(comparaison_niv1 ~ 1 + (1 | espece) + (1 | departement), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n10.23 <- glmer(comparaison_niv1 ~ 1 + (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n10.24 <- glmer(comparaison_niv1 ~ 1 + (1 | espece) + (1 | bioregion), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| echo: false
#| message: false
#| warning: false
niv1_random_comp2 <- compare_performance(m_n10.2, m_n10.21, m_n10.22, m_n10.23, m_n10.24) ; niv1_random_comp2
print("m_n10.23")
summary(m_n10.23)
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
m_n10.231 <- glmer(comparaison_niv1 ~ 1 + (1 | espece) + (1 | region) + (1 | email), 
                     data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n10.232 <- glmer(comparaison_niv1 ~ 1 + (1 | espece) + (1 | region) + (1 | departement), 
                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n10.233 <- glmer(comparaison_niv1 ~ 1 + (1 | espece) + (1 | region) + (1 | bioregion), 
                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| echo: false
#| message: false
#| warning: false
niv1_random_comp3 <- compare_performance(m_n10.23, m_n10.231, m_n10.232, m_n10.233) ; niv1_random_comp3
```

### effets fixes

selection des effets fixes

#### espece

Variables liées à la biologies des espèces : tendances_stoc, tendances_stoc_simplifie, tendances_stoc_simplifie_2, detectabilite, gregaire, fluctuante, migrateur, abondance, regime

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
m_n1.espece.0 <- glmer(comparaison_niv1 ~ 1 + 
                           (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.1 <- glmer(comparaison_niv1 ~ tendances_stoc 
                         + (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.2 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie +
                           (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.3 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + 
                           (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.4 <- glmer(comparaison_niv1 ~ detectabilite + 
                           (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.5 <- glmer(comparaison_niv1 ~ gregaire + 
                           (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.6 <- glmer(comparaison_niv1 ~ fluctuante + 
                           (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.7 <- glmer(comparaison_niv1 ~ migrateur + 
                           (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8 <- glmer(comparaison_niv1 ~ migrateur_simplifie + 
                           (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.9 <- glmer(comparaison_niv1 ~ regime + 
                           (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.10 <- glmer(comparaison_niv1 ~ popularite + 
                            (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.11 <- glmer(comparaison_niv1 ~ abondance_log + 
                            (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.12 <- glmer(comparaison_niv1 ~ abondance_div + 
                            (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.13 <- glmer(comparaison_niv1 ~ espece + 
                            (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.14 <- glmer(comparaison_niv1 ~ region + 
                            (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.15 <- glmer(comparaison_niv1 ~ bioregion + 
                            (1 | espece) + (1 | region), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
niv1_fixed_comp1 <- compare_performance(m_n1.espece.0,m_n1.espece.1,m_n1.espece.2,m_n1.espece.3,m_n1.espece.4,
                    m_n1.espece.5,m_n1.espece.6,m_n1.espece.7,m_n1.espece.8,
                    m_n1.espece.9,m_n1.espece.10,m_n1.espece.11,m_n1.espece.12,
                    m_n1.espece.13,m_n1.espece.14,m_n1.espece.15) ; niv1_fixed_comp1
# print("m_n1.espece.3")
# summary(m_n1.espece.3)
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
m_n1.espece.8.1 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + tendances_stoc + 
                             (1 | espece) + (1 | region), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.2 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + tendances_stoc_simplifie + 
                             (1 | espece) + (1 | region), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.3 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + detectabilite + 
                             (1 | espece) + (1 | region), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.4 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + gregaire + 
                             (1 | espece) + (1 | region), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.5 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + fluctuante + 
                             (1 | espece) + (1 | region), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.6 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + migrateur + 
                             (1 | espece) + (1 | region), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.7 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + migrateur_simplifie + 
                             (1 | espece) + (1 | region), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.8 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + abondance_log + 
                             (1 | espece) + (1 | region), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.9 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + abondance_div + 
                             (1 | espece) + (1 | region), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.10 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + espece + 
                             (1 | espece) + (1 | region), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.11 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + region + 
                             (1 | espece) + (1 | region), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.12 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + bioregion + 
                             (1 | espece) + (1 | region), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
niv1_fixed_comp2 <- compare_performance(m_n1.espece.8,m_n1.espece.8.1,m_n1.espece.8.2,m_n1.espece.8.3,m_n1.espece.8.4,
                    m_n1.espece.8.5,m_n1.espece.8.6,m_n1.espece.8.7,m_n1.espece.8.8,
                    m_n1.espece.8.9,m_n1.espece.8.10,m_n1.espece.8.11,m_n1.espece.8.12) ; niv1_fixed_comp2
# print("m_n1.espece.8.10")
summary(m_n1.espece.8.10)
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
m_n1.espece.8.3.1 <- glmer(comparaison_niv1 ~  tendances_stoc_simplifie_2 + espece + migrateur + 
                               (1 | espece) + (1 | region), 
                             data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.3.2 <- glmer(comparaison_niv1 ~  tendances_stoc_simplifie_2 + espece + migrateur_simplifie + 
                               (1 | espece) + (1 | region), 
                             data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.3.3 <- glmer(comparaison_niv1 ~  tendances_stoc_simplifie_2 + espece + gregaire + 
                               (1 | espece) + (1 | region), 
                             data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.3.4 <- glmer(comparaison_niv1 ~  tendances_stoc_simplifie_2 + espece + fluctuante + 
                               (1 | espece) + (1 | region), 
                             data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.3.5 <- glmer(comparaison_niv1 ~  tendances_stoc_simplifie_2 + espece + abondance_log + 
                               (1 | espece) + (1 | region), 
                             data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.3.6 <- glmer(comparaison_niv1 ~  tendances_stoc_simplifie_2 + espece + abondance_div + 
                               (1 | espece) + (1 | region), 
                             data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.8.3.7 <- glmer(comparaison_niv1 ~  tendances_stoc_simplifie_2 + espece + detectabilite + 
                               (1 | espece) + (1 | region), 
                             data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
niv1_fixed_comp3 <- compare_performance(m_n1.espece.8.3,m_n1.espece.8.3.1,m_n1.espece.8.3.2,m_n1.espece.8.3.3,
                                        m_n1.espece.8.3.4,m_n1.espece.8.3.5,m_n1.espece.8.3.6,m_n1.espece.8.3.7) ; niv1_fixed_comp3
print("m_n1.espece.8.3")
summary(m_n1.espece.8.3)
```

#### participant.es

Variables liées aux caractéristiques des participants : participation_stoc, participation_shoc, participation_epoc, sexe, cocheur, bagueur, expert

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
m_n1.participant.0 <- glmer(comparaison_niv1 ~ 1 + 
                                (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.1 <- glmer(comparaison_niv1 ~ participation_stoc + 
                                (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.2 <- glmer(comparaison_niv1 ~ participation_shoc + 
                                (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.3 <- glmer(comparaison_niv1 ~ participation_epoc + 
                                (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.4 <- glmer(comparaison_niv1 ~ sexe + 
                                (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.5 <- glmer(comparaison_niv1 ~ cocheur + 
                                (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.6 <- glmer(comparaison_niv1 ~ bagueur + 
                                (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.7 <- glmer(comparaison_niv1 ~ expert + 
                                (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
niv1_fixed_comp4 <- compare_performance(m_n1.participant.0,m_n1.participant.1,m_n1.participant.2,m_n1.participant.3,
                                        m_n1.participant.4,m_n1.participant.5,
                                        m_n1.participant.6,m_n1.participant.7) ; niv1_fixed_comp4
AIC(m_n1.participant.0,m_n1.participant.1,m_n1.participant.2,m_n1.participant.3,m_n1.participant.4,
    m_n1.participant.5,m_n1.participant.6,m_n1.participant.7)
# print("m_n1.participant.4")
# summary(m_n1.participant.4)
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
m_n1.participant.4.1 <- glmer(comparaison_niv1 ~ sexe + participation_stoc + 
                                  (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.4.2 <- glmer(comparaison_niv1 ~ sexe + participation_shoc + 
                                  (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.4.3 <- glmer(comparaison_niv1 ~ sexe + participation_epoc + 
                                  (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.4.4 <- glmer(comparaison_niv1 ~ sexe + cocheur + 
                                  (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.4.5 <- glmer(comparaison_niv1 ~ sexe + bagueur + 
                                  (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.4.6 <- glmer(comparaison_niv1 ~ sexe + expert + 
                                  (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
niv1_fixed_comp5 <- compare_performance(m_n1.participant.4,m_n1.participant.4.1,m_n1.participant.4.2,
                                        m_n1.participant.4.3,m_n1.participant.4.4,m_n1.participant.4.5,m_n1.participant.4.6) ; niv1_fixed_comp5
AIC(m_n1.participant.4,m_n1.participant.4.1,m_n1.participant.4.2,m_n1.participant.4.3,m_n1.participant.4.4,
    m_n1.participant.4.5,m_n1.participant.4.6)
# print("m_n1.participant.4.2")
# summary(m_n1.participant.4.2)
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false

m_n1.participant.4.22 <- glmer(comparaison_niv1 ~ sexe*participation_shoc + 
                                   (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.4.44 <- glmer(comparaison_niv1 ~ sexe*cocheur + 
                                   (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.4.24 <- glmer(comparaison_niv1 ~ sexe + participation_shoc + cocheur + 
                                   (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.4.241 <- glmer(comparaison_niv1 ~ sexe*participation_shoc + cocheur + 
                                   (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.4.242 <- glmer(comparaison_niv1 ~ sexe + participation_shoc*cocheur + 
                                   (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.4.243 <- glmer(comparaison_niv1 ~ sexe*cocheur + participation_shoc + 
                                   (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.participant.4.244 <- glmer(comparaison_niv1 ~ sexe*cocheur*participation_shoc + 
                                   (1 | espece) + (1 | region), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false

niv1_fixed_comp6 <- compare_performance(m_n1.participant.4.2,m_n1.participant.4.22,
                                        m_n1.participant.4.4,m_n1.participant.4.44,
                                        m_n1.participant.4.24,
                                        m_n1.participant.4.241,m_n1.participant.4.242,
                                        m_n1.participant.4.243,m_n1.participant.4.244) ; niv1_fixed_comp6
AIC(m_n1.participant.4.2,m_n1.participant.4.22,
                                        m_n1.participant.4.4,m_n1.participant.4.44,
                                        m_n1.participant.4.24,
                                        m_n1.participant.4.241,m_n1.participant.4.242,
                                        m_n1.participant.4.243,m_n1.participant.4.244)
# print("m_n1.participant.4.24")
# summary(m_n1.participant.4.24)
```

#### espece + participant

Selection des combinaisons de variables liées aux espèces et aux participant.es. Pré-selection des variables séparemment précédemment.

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
 
m_n1.espece.participant.1 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + detectabilite + sexe + participation_shoc + cocheur + 
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.2 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + detectabilite + sexe + participation_shoc + 
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.3 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + detectabilite + sexe +
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.4 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + detectabilite + 
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.5 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + sexe + participation_shoc + cocheur +  
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.6 <- glmer(comparaison_niv1 ~ sexe + participation_shoc + cocheur +  
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.7 <- glmer(comparaison_niv1 ~ detectabilite + sexe + participation_shoc + cocheur + 
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.8 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + detectabilite + participation_shoc + cocheur + 
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.9 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + sexe + 
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.10 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + detectabilite + sexe + 
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.11 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + sexe + cocheur +  
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.12 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + cocheur +  
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
niv1_fixed_comp7 <- compare_performance(m_n1.espece.participant.1,m_n1.espece.participant.2,
  m_n1.espece.participant.3,m_n1.espece.participant.4,m_n1.espece.participant.5,
  m_n1.espece.participant.6,m_n1.espece.participant.7,m_n1.espece.participant.8,
  m_n1.espece.participant.9,m_n1.espece.participant.10,m_n1.espece.participant.11,m_n1.espece.participant.12) ; niv1_fixed_comp7
AIC(m_n1.espece.participant.1,m_n1.espece.participant.2,m_n1.espece.participant.3,m_n1.espece.participant.4,m_n1.espece.participant.5)
# print("m_n1.espece.participant.5")
# summary(m_n1.espece.participant.5)
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
m_n1.espece.participant.5.1 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2*participation_shoc + sexe  + cocheur + 
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.5.2 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2*cocheur + sexe + participation_shoc + 
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.5.3 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + sexe*participation_shoc + cocheur + 
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_n1.espece.participant.5.4 <- glmer(comparaison_niv1 ~ tendances_stoc_simplifie_2 + sexe*cocheur + participation_shoc + 
                                  (1 | espece) + (1 | region), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
niv1_fixed_comp8 <- compare_performance(m_n1.espece.participant.5,m_n1.espece.participant.5.1,
                                        m_n1.espece.participant.5.2,m_n1.espece.participant.5.3,m_n1.espece.participant.5.4) ; niv1_fixed_comp8
AIC(m_n1.espece.participant.5,m_n1.espece.participant.5.1,
                                        m_n1.espece.participant.5.2,m_n1.espece.participant.5.3,m_n1.espece.participant.5.4)
# print("m_n1.espece.participant.5")
# summary(m_n1.espece.participant.5)
```

# niv1 dredge

## espece

```{r}
#| eval: false
#| include: false

# 1. Préparation________________________________________________________________

colnames(dataset)

# On force toutes les colonnes en facteur (sauf email déjà en facteur aléatoire)
vars <- c("espece","migrateur","migrateur_simplifie","regime","detectabilite","gregaire",
          "fluctuante","popularite","abondance_log","tendances_stoc_simplifie_2","tendance_shoc_niv1")

dataset[vars] <- lapply(dataset[vars], as.factor)

# cible binaire
dataset$comparaison_niv1 <- as.factor(dataset$comparaison_niv1)

# 2. Formule automatique avec toutes les interactions 2×2_______________________

# variables explicatives
X <- paste(vars, collapse = " + ")

# # interactions 2 à 2
# form <- as.formula(
#   paste("comparaison_niv1 ~ (", X, ")^2 + (1|email) + (1|departement)")
# )

# sans interaction
form <- as.formula(
  paste("comparaison_niv1 ~", X, "+ (1 | espece) + (1 | region)")
)

form

# 3. Modèle global GLMM binomial________________________________________________

dt_model <- dataset %>% 
  na.omit("espece","migrateur","migrateur_simplifie","regime","detectabilite","gregaire",
          "fluctuante","popularite","abondance_log","tendances_stoc_simplifie_2","tendance_shoc_niv1")

options(na.action = "na.fail")  # obligatoire pour dredge

m_full <- glmer(
  form,
  data = dt_model,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa")
)

# 4. Dredge automatique AIC_____________________________________________________

dd <- dredge(m_full, rank = "AIC")
dd

# 5. Modèle sélectionné (AIC min)_______________________________________________
best <- get.models(dd, 1)[[1]]
summary(best)

```

## participant.es

```{r}
#| eval: false
#| include: false

# 1. Préparation________________________________________________________________

colnames(dataset)

vars <- c("email","departement","participation_stoc","participation_shoc","participation_epoc","participation_odj",
          "sexe","anciennete","region","bioregion","bagueur","expert")

dataset[vars] <- lapply(dataset[vars], as.factor)

# cible binaire
dataset$comparaison_niv1 <- as.factor(dataset$comparaison_niv1)

# 2. Formule automatique avec toutes les interactions 2×2_______________________

# variables explicatives
X <- paste(vars, collapse = " + ")

# # interactions 2 à 2
# form <- as.formula(
#   paste("comparaison_niv1 ~ (", X, ")^2 + (1 | espece) + (1 | region)")
# )

# sans interaction
form <- as.formula(
  paste("comparaison_niv1 ~", X, "+ (1 | espece) + (1 | region)")
)

form

# 3. Modèle global GLMM binomial________________________________________________

dt_model_participant <- dataset %>% 
  na.omit("departement","participation_stoc","participation_shoc","participation_epoc","participation_odj",
          "sexe","anciennete","region","bioregion","bagueur","expert")

# /!\ cocheur > que des oui quand pas de NA...

dt_model_participant$anciennete <- as.numeric(dt_model_participant$anciennete)

options(na.action = "na.fail")  # obligatoire pour dredge

m_full_participant <- glmer(
  form,
  data = dt_model_participant,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa")
)

# 4. Dredge automatique AIC_____________________________________________________

dd_participant <- dredge(m_full_participant, rank = "AIC")
dd_participant

# 5. Modèle sélectionné (AIC min)_______________________________________________
best_participant <- get.models(dd_participant, 1)[[1]]
summary(best_participant)

```

# niv1 dredge MINI

```{r}
#| eval: false
#| include: false

# 1. Préparation________________________________________________________________

colnames(dataset)

# a tester : 
# "email","espece","migrateur","migrateur_simplifie","regime","detectabilite","gregaire","fluctuante","popularite","abondance_log",
#           "departement","participation_stoc","participation_shoc","participation_epoc","participation_odj","sexe","cocheur",
#           "anciennete","region","bioregion","bagueur","expert","tendance_shoc","tendances_stoc","tendances_stoc_simplifie",
#           "tendances_stoc_simplifie_2","tendance_shoc_niv1","tendance_shoc_niv2"

# class des variables
vars_1 <- c("email","espece","migrateur","migrateur_simplifie","regime","detectabilite","gregaire","fluctuante","popularite",
            "departement","participation_stoc","participation_shoc","participation_epoc","participation_odj","sexe","cocheur",
            "region","bioregion","bagueur","expert","tendance_shoc","tendances_stoc","tendances_stoc_simplifie",
            "tendances_stoc_simplifie_2","tendance_shoc_niv1","tendance_shoc_niv2","comparaison_niv1")

dataset[vars_1] <- lapply(dataset[vars_1], as.factor)

vars_2 <- c("abondance_log","anciennete")

dataset[vars_2] <- lapply(dataset[vars_2], as.numeric)
```

## \_espece

```{r}
dt_model_espece_alone <- dataset %>% 
  na.omit("espece","region")

dt_model_espece_alone$espece <- as.factor(dt_model_espece_alone$espece)

contrasts(dt_model_espece_alone$espece) <- contr.sum

dt_model_espece_alone$espece <- as.character(dt_model_espece_alone$espece)

m_espece_alone <- glmer(comparaison_niv1 ~ espece + 
                           (1 | region), 
                    data = dt_model_espece_alone, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
summary(m_espece_alone)
```

## \_step1

### \_1 trait

```{r}
#| echo: false

# 1. Préparation________________________________________________________________

vars_1 <- c("migrateur","migrateur_simplifie","regime","detectabilite","gregaire","fluctuante","popularite")

# 2. Formule automatique avec toutes les interactions 2×2_______________________

# variables explicatives
X_1 <- paste(vars_1, collapse = " + ")

# sans interaction
form <- as.formula(
  paste("comparaison_niv1 ~", X_1, "+ (1 | espece) + (1 | region)")
)

form

# 3. Modèle global GLMM binomial________________________________________________

dt_model_1 <- dataset %>% 
  na.omit("migrateur","migrateur_simplifie","regime","detectabilite")

options(na.action = "na.fail")  # obligatoire pour dredge

m_full_1 <- glmer(
  form,
  data = dt_model_1,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa")
)

# VIF collinearity 
performance::check_collinearity(m_full_1)
# singularity
isSingular(m_full_1)

# 4. Dredge automatique AIC_____________________________________________________

dd_1 <- dredge(m_full_1, rank = "AIC")
dd_1

# 5. Modèle sélectionné (AIC min)_______________________________________________
best_1 <- get.models(dd_1, 1)[[1]]
summary(best_1)
```

###\_2 SP

```{r}
#| eval: false
#| include: false

# 1. Préparation________________________________________________________________

vars_2 <- c("participation_stoc","participation_shoc","participation_epoc","participation_odj")

# 2. Formule automatique avec toutes les interactions 2×2_______________________

# variables explicatives
X_2 <- paste(vars_2, collapse = " + ")

# sans interaction
form <- as.formula(
  paste("comparaison_niv1 ~", X_2, "+ (1 | espece) + (1 | region)")
)

form

# 3. Modèle global GLMM binomial________________________________________________

dt_model_2 <- dataset %>% 
  na.omit("participation_stoc","participation_shoc","participation_epoc","participation_odj")

options(na.action = "na.fail")  # obligatoire pour dredge

m_full_2 <- glmer(
  form,
  data = dt_model_2,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa")
)

# VIF collinearity 
performance::check_collinearity(m_full_2)
# singularity
isSingular(m_full_2)

# 4. Dredge automatique AIC_____________________________________________________

dd_2 <- dredge(m_full_2, rank = "AIC")
dd_2

# 5. Modèle sélectionné (AIC min)_______________________________________________
best_2 <- get.models(dd_2, 1)[[1]]
summary(best_2)
```

### \_3 participant

```{r}
#| eval: false
#| include: false

# 1. Préparation________________________________________________________________

vars_3 <- c("sexe","anciennete","bagueur","expert")

# 2. Formule automatique avec toutes les interactions 2×2_______________________

# variables explicatives
X_3 <- paste(vars_3, collapse = " + ")

# sans interaction
form <- as.formula(
  paste("comparaison_niv1 ~", X_3, "+ (1 | espece) + (1 | region)")
)

form

# 3. Modèle global GLMM binomial________________________________________________

dt_model_3 <- dataset %>% 
  na.omit("participation_odj","sexe","anciennete","region")

options(na.action = "na.fail")  # obligatoire pour dredge

m_full_3 <- glmer(
  form,
  data = dt_model_3,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa")
)

# VIF collinearity 
performance::check_collinearity(m_full_3)
# singularity
isSingular(m_full_3)

# 4. Dredge automatique AIC_____________________________________________________

dd_3 <- dredge(m_full_3, rank = "AIC")
dd_3

# 5. Modèle sélectionné (AIC min)_______________________________________________
best_3 <- get.models(dd_3, 1)[[1]]
summary(best_3)
```

### \_4 tendances

```{r}
#| eval: false
#| include: false

# 1. Préparation________________________________________________________________

vars_4 <- c("tendance_shoc","tendances_stoc_simplifie","tendances_stoc_simplifie_2","tendance_shoc_niv1")

# 2. Formule automatique avec toutes les interactions 2×2_______________________

# variables explicatives
X_4 <- paste(vars_4, collapse = " + ")

# sans interaction
form <- as.formula(
  paste("comparaison_niv1 ~", X_4, "+ (1 | espece) + (1 | region)")
)

form

# 3. Modèle global GLMM binomial________________________________________________

dt_model_4 <- dataset %>% 
  na.omit("tendance_shoc","tendances_stoc_simplifie","tendances_stoc_simplifie_2","tendance_shoc_niv1")

options(na.action = "na.fail")  # obligatoire pour dredge

m_full_4 <- glmer(
  form,
  data = dt_model_4,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa")
)

# VIF collinearity 
performance::check_collinearity(m_full_4)
# singularity
isSingular(m_full_4)

# 4. Dredge automatique AIC_____________________________________________________

dd_4 <- dredge(m_full_4, rank = "AIC")
dd_4

# 5. Modèle sélectionné (AIC min)_______________________________________________
best_4 <- get.models(dd_4, 1)[[1]]
summary(best_4)
```

## \_step2

### \_1

```{r}
#| eval: false
#| include: false

formula(best_1)
formula(best_2)
formula(best_3)
formula(best_4)

# 1. Préparation________________________________________________________________

vars_2.1 <- c("anciennete","expert","tendance_shoc")

# 2. Formule automatique avec toutes les interactions 2×2_______________________

# variables explicatives
X_2.1 <- paste(vars_2.1, collapse = " + ")

# sans interaction
form <- as.formula(
  paste("comparaison_niv1 ~", X_2.1, "+ (1 | espece) + (1 | region)")
)

form

# 3. Modèle global GLMM binomial________________________________________________

dt_model_2.1 <- dataset %>% 
  na.omit("anciennete","expert","tendance_shoc")

options(na.action = "na.fail")  # obligatoire pour dredge

m_full_2.1 <- glmer(
  form,
  data = dt_model_2.1,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa")
)

# VIF collinearity 
performance::check_collinearity(m_full_2.1)
# singularity
isSingular(m_full_2.1)

# 4. Dredge automatique AIC_____________________________________________________

dd_2.1 <- dredge(m_full_2.1, rank = "AIC")
dd_2.1

# 5. Modèle sélectionné (AIC min)_______________________________________________
best_2.1 <- get.models(dd_2.1, 1)[[1]]
```

```{r}
#| echo: false
print("best final model !!!!!!!")
summary(best_2.1)
```

### \_2 interaction

```{r}
#| eval: false
#| include: false

formula(best_1)
formula(best_2)
formula(best_3)
formula(best_4)

# 1. Préparation________________________________________________________________

dataset$anciennete_scale <- scale(dataset$anciennete)

vars_2.2 <- c("anciennete_scale","expert","tendance_shoc","anciennete_scale:expert","anciennete_scale:tendance_shoc")

# 2. Formule automatique avec toutes les interactions 2×2_______________________

# variables explicatives
X_2.2 <- paste(vars_2.2, collapse = " + ")

form <- as.formula(
  paste("comparaison_niv1 ~", X_2.2, "+ (1 | espece) + (1 | region)")
)

form

# 3. Modèle global GLMM binomial________________________________________________

dt_model_2.2 <- dataset %>% 
  na.omit("anciennete_scale","expert","tendance_shoc")

options(na.action = "na.fail")  # obligatoire pour dredge

m_full_2.2 <- glmer(
  form,
  data = dt_model_2.2,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))
)

# VIF collinearity 
performance::check_collinearity(m_full_2.2)
# singularity
isSingular(m_full_2.2)

# 4. Dredge automatique AIC_____________________________________________________

dd_2.2 <- dredge(m_full_2.2, rank = "AIC")
dd_2.2

# 5. Modèle sélectionné (AIC min)_______________________________________________
best_2.2 <- get.models(dd_2.2, 1)[[1]]
summary(best_2.2)
```

## (niv2)

### effets aléatoires

```{r}
#| eval: false
#| include: false
m_niv2.0.1 <- glmer(comparaison_niv2 ~ 1 + (1 | email), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.0.2 <- glmer(comparaison_niv2 ~ 1 + (1 | espece), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.0.3 <- glmer(comparaison_niv2 ~ 1 + (1 | departement), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.0.4 <- glmer(comparaison_niv2 ~ 1 + (1 | region), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.0.5 <- glmer(comparaison_niv2 ~ 1 + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| include: false
compare_performance(m_niv2.0.1, m_niv2.0.2, m_niv2.0.3, m_niv2.0.4, m_niv2.0.5, m_niv2.0.6)
```

```{r}
#| eval: false
#| include: false
m_niv2.0.21 <- glmer(comparaison_niv2 ~ 1 + (1 | espece) + (1 | email), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.0.22 <- glmer(comparaison_niv2 ~ 1 + (1 | espece) + (1 | departement), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.0.23 <- glmer(comparaison_niv2 ~ 1 + (1 | espece) + (1 | region), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.0.24 <- glmer(comparaison_niv2 ~ 1 + (1 | espece) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| include: false
compare_performance(m_niv2.0.2, m_niv2.0.21, m_niv2.0.22, m_niv2.0.23, m_niv2.0.24, m_niv2.0.25)
```

```{r}
#| eval: false
#| include: false
m_niv2.0.221 <- glmer(comparaison_niv2 ~ 1 + (1 | espece) + (1 | departement) + (1 | email), 
                     data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.0.222 <- glmer(comparaison_niv2 ~ 1 + (1 | espece) + (1 | departement) + (1 | region), 
                     data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.0.223 <- glmer(comparaison_niv2 ~ 1 + (1 | espece) + (1 | departement) + (1 | bioregion), 
                     data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| include: false
compare_performance(m_niv2.0.22, m_niv2.0.221, m_niv2.0.222, m_niv2.0.223, m_niv2.0.224)
```

### effets fixes

#### espece

```{r}
#| eval: false
#| include: false
m_niv2.espece.0 <- glmer(comparaison_niv2 ~ 1 + (1 | espece) + (1 | departement) + (1 | email), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.1 <- glmer(comparaison_niv2 ~ tendances_stoc + (1 | espece) + (1 | departement) + (1 | email), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.2 <- glmer(comparaison_niv2 ~ tendances_stoc_simplifie + (1 | espece) + (1 | departement) + (1 | email), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.3 <- glmer(comparaison_niv2 ~ tendances_stoc_simplifie_2 + (1 | espece) + (1 | departement) + (1 | email), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.4 <- glmer(comparaison_niv2 ~ detectabilite + (1 | espece) + (1 | departement) + (1 | email), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.5 <- glmer(comparaison_niv2 ~ gregaire + (1 | espece) + (1 | departement) + (1 | email), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.6 <- glmer(comparaison_niv2 ~ fluctuante + (1 | espece) + (1 | departement) + (1 | email), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.7 <- glmer(comparaison_niv2 ~ migrateur + (1 | espece) + (1 | departement) + (1 | email), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.8 <- glmer(comparaison_niv2 ~ abondance + (1 | espece) + (1 | departement) + (1 | email), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.9 <- glmer(comparaison_niv2 ~ regime + (1 | espece) + (1 | departement) + (1 | email), 
                    data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| include: false
compare_performance(m_niv2.espece.0,m_niv2.espece.1,m_niv2.espece.2,m_niv2.espece.3,m_niv2.espece.4,
                    m_niv2.espece.5,m_niv2.espece.6,m_niv2.espece.7,m_niv2.espece.8,m_niv2.espece.9)
AIC(m_niv2.espece.0,m_niv2.espece.1,m_niv2.espece.2,m_niv2.espece.3,m_niv2.espece.4,
    m_niv2.espece.5,m_niv2.espece.6,m_niv2.espece.7,m_niv2.espece.8,m_niv2.espece.9)
summary(m_niv2.espece.9)
```

```{r}
#| eval: false
#| include: false
m_niv2.espece.8.1 <- glmer(comparaison_niv2 ~ regime + tendances_stoc + (1 | espece) + (1 | departement) + (1 | email), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.8.2 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie + (1 | espece) + (1 | departement) + (1 | email), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.8.3 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + (1 | espece) + (1 | departement) + (1 | email), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.8.4 <- glmer(comparaison_niv2 ~ regime + detectabilite + (1 | espece) + (1 | departement) + (1 | email), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.8.5 <- glmer(comparaison_niv2 ~ regime + gregaire + (1 | espece) + (1 | departement) + (1 | email), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.8.6 <- glmer(comparaison_niv2 ~ regime + fluctuante + (1 | espece) + (1 | departement) + (1 | email), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.8.7 <- glmer(comparaison_niv2 ~ regime + migrateur + (1 | espece) + (1 | departement) + (1 | email), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.8.8 <- glmer(comparaison_niv2 ~ regime + abondance + (1 | espece) + (1 | departement) + (1 | email), 
                      data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| include: false
compare_performance(m_niv2.espece.8,m_niv2.espece.8.1,m_niv2.espece.8.2,m_niv2.espece.8.3,m_niv2.espece.8.4,
                    m_niv2.espece.8.5,m_niv2.espece.8.6,m_niv2.espece.8.7,m_niv2.espece.8.8)
AIC(m_niv2.espece.8,m_niv2.espece.8.1,m_niv2.espece.8.2,m_niv2.espece.8.3,m_niv2.espece.8.4,
    m_niv2.espece.8.5,m_niv2.espece.8.6,m_niv2.espece.8.7,m_niv2.espece.8.8)
summary(m_niv2.espece.8.3)
```

```{r}
#| eval: false
#| include: false
m_niv2.espece.8.3.1 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + detectabilite + 
                               (1 | espece) + (1 | departement) + (1 | email), 
                             data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.8.3.2 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + gregaire + 
                               (1 | espece) + (1 | departement) + (1 | email), 
                             data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.8.3.3 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + fluctuante + 
                               (1 | espece) + (1 | departement) + (1 | email), 
                             data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.8.3.4 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + migrateur + 
                               (1 | espece) + (1 | departement) + (1 | email), 
                             data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.8.3.5 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + abondance + 
                               (1 | espece) + (1 | departement) + (1 | email), 
                             data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| include: false
compare_performance(m_niv2.espece.8.3,m_niv2.espece.8.3.1,m_niv2.espece.8.3.2,m_niv2.espece.8.3.3,m_niv2.espece.8.3.4,m_niv2.espece.8.3.5)
AIC(m_niv2.espece.8.3,m_niv2.espece.8.3.1,m_niv2.espece.8.3.2,m_niv2.espece.8.3.3,m_niv2.espece.8.3.4,m_niv2.espece.8.3.5)
summary(m_niv2.espece.8.3)
```

#### participant

```{r}
#| eval: false
#| include: false
m_niv2.participant.0 <- glmer(comparaison_niv2 ~ 1 + 
                                (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.participant.1 <- glmer(comparaison_niv2 ~ participation_stoc + 
                                (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.participant.2 <- glmer(comparaison_niv2 ~ participation_shoc + 
                                (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.participant.3 <- glmer(comparaison_niv2 ~ participation_epoc + 
                                (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.participant.4 <- glmer(comparaison_niv2 ~ sexe + 
                                (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.participant.5 <- glmer(comparaison_niv2 ~ cocheur + 
                                (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.participant.6 <- glmer(comparaison_niv2 ~ bagueur + 
                                (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.participant.7 <- glmer(comparaison_niv2 ~ expert + 
                                (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| include: false
compare_performance(m_niv2.participant.0,m_niv2.participant.1,m_niv2.participant.2,m_niv2.participant.3,m_niv2.participant.4,
                    m_niv2.participant.5,m_niv2.participant.6,m_niv2.participant.7)
AIC(m_niv2.participant.0,m_niv2.participant.1,m_niv2.participant.2,m_niv2.participant.3,m_niv2.participant.4,
    m_niv2.participant.5,m_niv2.participant.6,m_niv2.participant.7)
summary(m_niv2.participant.4)
```

```{r}
#| eval: false
#| include: false
m_niv2.participant.4.1 <- glmer(comparaison_niv2 ~ sexe + participation_stoc + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.participant.4.2 <- glmer(comparaison_niv2 ~ sexe + participation_shoc + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.participant.4.3 <- glmer(comparaison_niv2 ~ sexe + participation_epoc + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.participant.4.4 <- glmer(comparaison_niv2 ~ sexe + cocheur + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.participant.4.5 <- glmer(comparaison_niv2 ~ sexe + bagueur + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.participant.4.6 <- glmer(comparaison_niv2 ~ sexe + expert + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| include: false
compare_performance(m_niv2.participant.4,m_niv2.participant.4.1,m_niv2.participant.4.2,m_niv2.participant.4.3,m_niv2.participant.4.4,
                    m_niv2.participant.4.5,m_niv2.participant.4.6)
AIC(m_niv2.participant.4,m_niv2.participant.4.1,m_niv2.participant.4.2,m_niv2.participant.4.3,m_niv2.participant.4.4,
    m_niv2.participant.4.5,m_niv2.participant.4.6)
summary(m_niv2.participant.4.2)
```

```{r}
#| eval: false
#| include: false
m_niv2.participant.4.22 <- glmer(comparaison_niv2 ~ sexe*participation_shoc + (1 | espece) + (1 | departement) + (1 | email), 
                         data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| include: false
compare_performance(m_niv2.participant.4.2,m_niv2.participant.4.22)
AIC(m_niv2.participant.4.2,m_niv2.participant.4.22)
```

#### espece + participant

```{r}
#| eval: false
#| include: false
m_niv2.espece.participant.1 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + sexe + participation_shoc + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.participant.2 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + sexe + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.participant.3 <- glmer(comparaison_niv2 ~ regime + sexe + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.participant.4 <- glmer(comparaison_niv2 ~ tendances_stoc_simplifie_2 + sexe + participation_shoc + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.participant.5 <- glmer(comparaison_niv2 ~ tendances_stoc_simplifie_2 + sexe + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| include: false
compare_performance(m_niv2.espece.participant.1,m_niv2.espece.participant.2,m_niv2.espece.participant.3,
                    m_niv2.espece.participant.4,m_niv2.espece.participant.5)
AIC(m_niv2.espece.participant.1,m_niv2.espece.participant.2,m_niv2.espece.participant.3,
    m_niv2.espece.participant.4,m_niv2.espece.participant.5)
summary(m_niv2.espece.participant.1)
```

```{r}
#| eval: false
#| include: false
m_niv2.espece.participant.1 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + sexe + participation_shoc + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.participant.1.1 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + sexe + participation_shoc + 
                                  (1 | espece) + (1 | email), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.participant.1.2 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + sexe + participation_shoc + 
                                  (1 | espece), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.participant.1.3 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + sexe + participation_shoc + 
                                  (1 | espece) + (1 | bioregion), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| include: false
compare_performance(m_niv2.espece.participant.1,m_niv2.espece.participant.1.1,m_niv2.espece.participant.1.2,m_niv2.espece.participant.1.3)
AIC(m_niv2.espece.participant.1,m_niv2.espece.participant.1.1,m_niv2.espece.participant.1.2,m_niv2.espece.participant.1.3)
summary(m_niv2.espece.participant.1)
```

```{r}
#| eval: false
#| include: false
m_niv2.espece.participant.1 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + sexe + participation_shoc + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.participant.11 <- glmer(comparaison_niv2 ~ regime + tendances_stoc_simplifie_2 + sexe*participation_shoc + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.participant.12 <- glmer(comparaison_niv2 ~ regime*tendances_stoc_simplifie_2 + sexe + participation_shoc + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m_niv2.espece.participant.13 <- glmer(comparaison_niv2 ~ regime*tendances_stoc_simplifie_2 + sexe*participation_shoc + 
                                  (1 | espece) + (1 | departement) + (1 | email), 
                                data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
#| eval: false
#| include: false
compare_performance(m_niv2.espece.participant.1,m_niv2.espece.participant.11,m_niv2.espece.participant.12,m_niv2.espece.participant.13)
AIC(m_niv2.espece.participant.1,m_niv2.espece.participant.11,m_niv2.espece.participant.12,m_niv2.espece.participant.13)
summary(m_niv2.espece.participant.12)
```

## avis niv 1

### données

```{r}
#| include: false

colnames(dataset)

dt1 <- dataset %>% 
  dplyr::select("email","espece","avis_niv1","migrateur","migrateur_simplifie","regime",
                "detectabilite","gregaire","popularite",
                "abondance_log","departement","participation_stoc","participation_shoc",
                "participation_epoc","sexe","cocheur",
                "anciennete","region","bioregion","bagueur","expert","tendance_shoc",
                "tendances_stoc","tendances_stoc_simplifie",
                "tendance_shoc_niv1") %>% 
  na.omit()

dt1 <- dt1 %>%
  mutate(
    avis_niv1 = factor(
      avis_niv1,
      levels = c("Déclin", "Stable", "Augmentation"),
      ordered = TRUE
    ),
    tendance_shoc_niv1 = factor(
      tendance_shoc_niv1,
      levels = c("Déclin", "Stable", "Augmentation"),
      ordered = TRUE
    )
  ) %>% 
  na.omit()

```

### m0

```{r}
#| echo: false

# model ------------------------------------------------------------------------

modele_base <- polr(
   avis_niv1 ~ tendance_shoc_niv1,
    data = dt1,
  Hess = TRUE
)

modele_base <- stepAIC(
  modele_base,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_base <- coef(summary(modele_base))
p_values_base <- pnorm(abs(ctable_base[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_base, "p value" = p_values_base)

# plot -------------------------------------------------------------------------

ctable_base <- as.data.frame(ctable_base)

res_base <- as.data.frame(ctable_base) %>%
  mutate(
    variable = rownames(ctable_base),
    p_value = p_values_base,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_base$`Std. Error`,
    upper = Value + 1.96 * ctable_base$`Std. Error`
  )

res_plot_base <- res_base %>%
  filter(!grepl("\\|", variable))

res_plot_base$variable <- factor(
  res_plot_base$variable,
  levels = res_plot_base$variable[order(res_plot_base$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_base <- res_plot_base %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_base$variable <- fct_recode(res_plot_base$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_base, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### migrateur

```{r}
#| echo: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      + regime + detectabilite + gregaire + popularite + abondance_log + #migrateur_simplifie
#     sexe + anciennete +
#     expert + # participation_stoc + participation_shoc + participation_epoc + cocheur + bagueur +
#     tendances_stoc, # + tendance_shoc + tendances_stoc_simplifie,
#   data = dt1,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_migrateur <- polr(
   avis_niv1 ~ tendance_shoc_niv1*migrateur,
    data = dt1,
  Hess = TRUE
)

modele_migrateur <- stepAIC(
  modele_migrateur,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_migrateur <- coef(summary(modele_migrateur))
p_values_migrateur <- pnorm(abs(ctable_migrateur[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_migrateur, "p value" = p_values_migrateur)

# plot -------------------------------------------------------------------------

ctable_migrateur <- as.data.frame(ctable_migrateur)

res_migrateur <- as.data.frame(ctable_migrateur) %>%
  mutate(
    variable = rownames(ctable_migrateur),
    p_value = p_values_migrateur,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_migrateur$`Std. Error`,
    upper = Value + 1.96 * ctable_migrateur$`Std. Error`
  )

res_plot_migrateur <- res_migrateur %>%
  filter(!grepl("\\|", variable))

res_plot_migrateur$variable <- factor(
  res_plot_migrateur$variable,
  levels = res_plot_migrateur$variable[order(res_plot_migrateur$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_migrateur <- res_plot_migrateur %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_migrateur$variable <- fct_recode(res_plot_migrateur$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_migrateur, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### regime

```{r}
#| echo: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  + detectabilite + gregaire + popularite + abondance_log + #migrateur_simplifie
#     sexe + anciennete +
#     expert + # participation_stoc + participation_shoc + participation_epoc + cocheur + bagueur +
#     tendances_stoc, # + tendance_shoc + tendances_stoc_simplifie,
#   data = dt1,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_regime <- polr(
   avis_niv1 ~ tendance_shoc_niv1*regime,
    data = dt1,
  Hess = TRUE
)

modele_regime <- stepAIC(
  modele_regime,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_regime <- coef(summary(modele_regime))
p_values_regime <- pnorm(abs(ctable_regime[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_regime, "p value" = p_values_regime)

# plot -------------------------------------------------------------------------

ctable_regime <- as.data.frame(ctable_regime)

res_regime <- as.data.frame(ctable_regime) %>%
  mutate(
    variable = rownames(ctable_regime),
    p_value = p_values_regime,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_regime$`Std. Error`,
    upper = Value + 1.96 * ctable_regime$`Std. Error`
  )

res_plot_regime <- res_regime %>%
  filter(!grepl("\\|", variable))

res_plot_regime$variable <- factor(
  res_plot_regime$variable,
  levels = res_plot_regime$variable[order(res_plot_regime$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_regime <- res_plot_regime %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_regime$variable <- fct_recode(res_plot_regime$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_regime, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### detectabilite

```{r}
#| echo: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  + gregaire + popularite + abondance_log + #migrateur_simplifie
#     sexe + anciennete +
#     expert + # participation_stoc + participation_shoc + participation_epoc + cocheur + bagueur +
#     tendances_stoc, # + tendance_shoc + tendances_stoc_simplifie,
#   data = dt1,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_detectabilite <- polr(
   avis_niv1 ~ tendance_shoc_niv1*detectabilite,
    data = dt1,
  Hess = TRUE
)

modele_detectabilite <- stepAIC(
  modele_detectabilite,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_detectabilite <- coef(summary(modele_detectabilite))
p_values_detectabilite <- pnorm(abs(ctable_detectabilite[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_detectabilite, "p value" = p_values_detectabilite)

# plot -------------------------------------------------------------------------

ctable_detectabilite <- as.data.frame(ctable_detectabilite)

res_detectabilite <- as.data.frame(ctable_detectabilite) %>%
  mutate(
    variable = rownames(ctable_detectabilite),
    p_value = p_values_detectabilite,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_detectabilite$`Std. Error`,
    upper = Value + 1.96 * ctable_detectabilite$`Std. Error`
  )

res_plot_detectabilite <- res_detectabilite %>%
  filter(!grepl("\\|", variable))

res_plot_detectabilite$variable <- factor(
  res_plot_detectabilite$variable,
  levels = res_plot_detectabilite$variable[order(res_plot_detectabilite$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_detectabilite <- res_plot_detectabilite %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_detectabilite$variable <- fct_recode(res_plot_detectabilite$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_detectabilite, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### gregaire

```{r}
#| echo: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  + popularite + abondance_log + 
#     sexe + anciennete +
#     expert + 
#     tendances_stoc, 
#   data = dt1,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_gregaire <- polr(
   avis_niv1 ~ tendance_shoc_niv1*gregaire,
    data = dt1,
  Hess = TRUE
)

modele_gregaire <- stepAIC(
  modele_gregaire,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_gregaire <- coef(summary(modele_gregaire))
p_values_gregaire <- pnorm(abs(ctable_gregaire[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_gregaire, "p value" = p_values_gregaire)

# plot -------------------------------------------------------------------------

ctable_gregaire <- as.data.frame(ctable_gregaire)

res_gregaire <- as.data.frame(ctable_gregaire) %>%
  mutate(
    variable = rownames(ctable_gregaire),
    p_value = p_values_gregaire,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_gregaire$`Std. Error`,
    upper = Value + 1.96 * ctable_gregaire$`Std. Error`
  )

res_plot_gregaire <- res_gregaire %>%
  filter(!grepl("\\|", variable))

res_plot_gregaire$variable <- factor(
  res_plot_gregaire$variable,
  levels = res_plot_gregaire$variable[order(res_plot_gregaire$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_gregaire <- res_plot_gregaire %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_gregaire$variable <- fct_recode(res_plot_gregaire$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_gregaire, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### popularite

```{r}
#| echo: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  +  + abondance_log + 
#     sexe + anciennete +
#     expert + 
#     tendances_stoc, 
#   data = dt1,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_popularite <- polr(
   avis_niv1 ~ tendance_shoc_niv1*popularite,
    data = dt1,
  Hess = TRUE
)

modele_popularite <- stepAIC(
  modele_popularite,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_popularite <- coef(summary(modele_popularite))
p_values_popularite <- pnorm(abs(ctable_popularite[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_popularite, "p value" = p_values_popularite)

# plot -------------------------------------------------------------------------

ctable_popularite <- as.data.frame(ctable_popularite)

res_popularite <- as.data.frame(ctable_popularite) %>%
  mutate(
    variable = rownames(ctable_popularite),
    p_value = p_values_popularite,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_popularite$`Std. Error`,
    upper = Value + 1.96 * ctable_popularite$`Std. Error`
  )

res_plot_popularite <- res_popularite %>%
  filter(!grepl("\\|", variable))

res_plot_popularite$variable <- factor(
  res_plot_popularite$variable,
  levels = res_plot_popularite$variable[order(res_plot_popularite$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_popularite <- res_plot_popularite %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_popularite$variable <- fct_recode(res_plot_popularite$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_popularite, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### abondance_log

```{r}
#| echo: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  +  +  + 
#     sexe + anciennete +
#     expert + 
#     tendances_stoc, 
#   data = dt1,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_abondance_log <- polr(
   avis_niv1 ~ tendance_shoc_niv1*abondance_log,
    data = dt1,
  Hess = TRUE
)

modele_abondance_log <- stepAIC(
  modele_abondance_log,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_abondance_log <- coef(summary(modele_abondance_log))
p_values_abondance_log <- pnorm(abs(ctable_abondance_log[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_abondance_log, "p value" = p_values_abondance_log)

# plot -------------------------------------------------------------------------

ctable_abondance_log <- as.data.frame(ctable_abondance_log)

res_abondance_log <- as.data.frame(ctable_abondance_log) %>%
  mutate(
    variable = rownames(ctable_abondance_log),
    p_value = p_values_abondance_log,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_abondance_log$`Std. Error`,
    upper = Value + 1.96 * ctable_abondance_log$`Std. Error`
  )

res_plot_abondance_log <- res_abondance_log %>%
  filter(!grepl("\\|", variable))

res_plot_abondance_log$variable <- factor(
  res_plot_abondance_log$variable,
  levels = res_plot_abondance_log$variable[order(res_plot_abondance_log$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_abondance_log <- res_plot_abondance_log %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_abondance_log$variable <- fct_recode(res_plot_abondance_log$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_abondance_log, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### sexe

```{r}
#| echo: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  +  +  + 
#      + anciennete +
#     expert + 
#     tendances_stoc, 
#   data = dt1,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_sexe <- polr(
   avis_niv1 ~ tendance_shoc_niv1*sexe,
    data = dt1,
  Hess = TRUE
)

modele_sexe <- stepAIC(
  modele_sexe,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_sexe <- coef(summary(modele_sexe))
p_values_sexe <- pnorm(abs(ctable_sexe[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_sexe, "p value" = p_values_sexe)

# plot -------------------------------------------------------------------------

ctable_sexe <- as.data.frame(ctable_sexe)

res_sexe <- as.data.frame(ctable_sexe) %>%
  mutate(
    variable = rownames(ctable_sexe),
    p_value = p_values_sexe,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_sexe$`Std. Error`,
    upper = Value + 1.96 * ctable_sexe$`Std. Error`
  )

res_plot_sexe <- res_sexe %>%
  filter(!grepl("\\|", variable))

res_plot_sexe$variable <- factor(
  res_plot_sexe$variable,
  levels = res_plot_sexe$variable[order(res_plot_sexe$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_sexe <- res_plot_sexe %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_sexe$variable <- fct_recode(res_plot_sexe$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_sexe, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### anciennete

```{r}
#| echo: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  +  +  + 
#      +  +
#     expert + 
#     tendances_stoc, 
#   data = dt1,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_anciennete <- polr(
   avis_niv1 ~ tendance_shoc_niv1*anciennete,
    data = dt1,
  Hess = TRUE
)

modele_anciennete <- stepAIC(
  modele_anciennete,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_anciennete <- coef(summary(modele_anciennete))
p_values_anciennete <- pnorm(abs(ctable_anciennete[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_anciennete, "p value" = p_values_anciennete)

# plot -------------------------------------------------------------------------

ctable_anciennete <- as.data.frame(ctable_anciennete)

res_anciennete <- as.data.frame(ctable_anciennete) %>%
  mutate(
    variable = rownames(ctable_anciennete),
    p_value = p_values_anciennete,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_anciennete$`Std. Error`,
    upper = Value + 1.96 * ctable_anciennete$`Std. Error`
  )

res_plot_anciennete <- res_anciennete %>%
  filter(!grepl("\\|", variable))

res_plot_anciennete$variable <- factor(
  res_plot_anciennete$variable,
  levels = res_plot_anciennete$variable[order(res_plot_anciennete$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_anciennete <- res_plot_anciennete %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_anciennete$variable <- fct_recode(res_plot_anciennete$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_anciennete, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### expert

```{r}
#| echo: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  +  +  + 
#      +  +
#      + 
#     tendances_stoc, 
#   data = dt1,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_expert <- polr(
   avis_niv1 ~ tendance_shoc_niv1*expert,
    data = dt1,
  Hess = TRUE
)

modele_expert <- stepAIC(
  modele_expert,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_expert <- coef(summary(modele_expert))
p_values_expert <- pnorm(abs(ctable_expert[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_expert, "p value" = p_values_expert)

# plot -------------------------------------------------------------------------

ctable_expert <- as.data.frame(ctable_expert)

res_expert <- as.data.frame(ctable_expert) %>%
  mutate(
    variable = rownames(ctable_expert),
    p_value = p_values_expert,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_expert$`Std. Error`,
    upper = Value + 1.96 * ctable_expert$`Std. Error`
  )

res_plot_expert <- res_expert %>%
  filter(!grepl("\\|", variable))

res_plot_expert$variable <- factor(
  res_plot_expert$variable,
  levels = res_plot_expert$variable[order(res_plot_expert$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_expert <- res_plot_expert %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_expert$variable <- fct_recode(res_plot_expert$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_expert, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### tendances_stoc

```{r}
#| echo: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      +  +  +  +  +  + 
#      +  +
#      + 
#     , 
#   data = dt1,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_tendances_stoc <- polr(
   avis_niv1 ~ tendance_shoc_niv1*tendances_stoc,
    data = dt1,
  Hess = TRUE
)

modele_tendances_stoc <- stepAIC(
  modele_tendances_stoc,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_tendances_stoc <- coef(summary(modele_tendances_stoc))
p_values_tendances_stoc <- pnorm(abs(ctable_tendances_stoc[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_tendances_stoc, "p value" = p_values_tendances_stoc)

# plot -------------------------------------------------------------------------

ctable_tendances_stoc <- as.data.frame(ctable_tendances_stoc)

res_tendances_stoc <- as.data.frame(ctable_tendances_stoc) %>%
  mutate(
    variable = rownames(ctable_tendances_stoc),
    p_value = p_values_tendances_stoc,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_tendances_stoc$`Std. Error`,
    upper = Value + 1.96 * ctable_tendances_stoc$`Std. Error`
  )

res_plot_tendances_stoc <- res_tendances_stoc %>%
  filter(!grepl("\\|", variable))

res_plot_tendances_stoc$variable <- factor(
  res_plot_tendances_stoc$variable,
  levels = res_plot_tendances_stoc$variable[order(res_plot_tendances_stoc$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_tendances_stoc <- res_plot_tendances_stoc %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
res_plot_tendances_stoc$variable <- fct_recode(res_plot_tendances_stoc$variable,
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L")
                                
# plot 
ggplot(res_plot_tendances_stoc, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = "Effets des variables explicatives sur l’avis (odds ratios)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### all_espece

```{r}
#| echo: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      + regime + detectabilite + gregaire + popularite + abondance_log + #migrateur_simplifie
#     sexe + anciennete +
#     expert + # participation_stoc + participation_shoc + participation_epoc + cocheur + bagueur +
#     tendances_stoc, # + tendance_shoc + tendances_stoc_simplifie,
#   data = dt1,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_all_espece <- polr(
   avis_niv1 ~ tendance_shoc_niv1 + 
     # migrateur + regime +
     detectabilite + gregaire + popularite + abondance_log +  
     # tendance_shoc_niv1:migrateur +
     # tendance_shoc_niv1:regime +
     tendance_shoc_niv1:detectabilite +
     tendance_shoc_niv1:gregaire +
     tendance_shoc_niv1:popularite +
     tendance_shoc_niv1:abondance_log, # +
     # tendance_shoc_niv1:tendances_stoc,
    data = dt1,
  Hess = TRUE
)

modele_all_espece <- stepAIC(
  modele_all_espece,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_all_espece <- coef(summary(modele_all_espece))
p_values_all_espece <- pnorm(abs(ctable_all_espece[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_all_espece, "p value" = p_values_all_espece)

# plot -------------------------------------------------------------------------

ctable_all_espece <- as.data.frame(ctable_all_espece)

res_all_espece <- as.data.frame(ctable_all_espece) %>%
  mutate(
    variable = rownames(ctable_all_espece),
    p_value = p_values_all_espece,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_all_espece$`Std. Error`,
    upper = Value + 1.96 * ctable_all_espece$`Std. Error`
  )

res_plot_all_espece <- res_all_espece %>%
  filter(!grepl("\\|", variable))

res_plot_all_espece$variable <- factor(
  res_plot_all_espece$variable,
  levels = res_plot_all_espece$variable[order(res_plot_all_espece$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_all_espece <- res_plot_all_espece %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
unique(res_plot_all_espece$variable)
res_plot_all_espece$variable <- fct_recode(res_plot_all_espece$variable,
                                "Detectabilite (Forte)" = "detectabiliteForte",
                                "Gregaire (Oui)" = "gregaireOui",
                                "Popularite (Oui)" = "populariteOui",
                                "Abondance" = "abondance_log",
                                "SHOC - Linéaire : Detectabilite (Forte)" = "tendance_shoc_niv1.L:detectabiliteForte",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L",
                                "SHOC - Linéaire : Detectabilite (Forte)" = "tendance_shoc_niv1.L:detectabiliteForte",
                                "SHOC - Linéaire : Gregaire (Oui)" = "tendance_shoc_niv1.L:gregaireOui",
                                "SHOC - Linéaire : Abondance" = "tendance_shoc_niv1.L:abondance_log",
                                "SHOC - Linéaire : Popularité (Oui)" = "tendance_shoc_niv1.L:populariteOui",
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Quadratique : Detectabilite (Forte)" = "tendance_shoc_niv1.Q:detectabiliteForte",
                                "SHOC - Quadratique : Gregaire (Oui)" = "tendance_shoc_niv1.Q:gregaireOui",
                                "SHOC - Quadratique : Abondance" = "tendance_shoc_niv1.Q:abondance_log",
                                "SHOC - Quadratique : Popularité (Oui)" = "tendance_shoc_niv1.Q:populariteOui")

# plot 
ggplot(res_plot_all_espece, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.015625, 0.03125, 0.0625, 0.125, 0.25, 0.5, 1, 2, 4, 8),
    labels = c("64X mois", "32X mois", "16X mois", "8X mois", "4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = ""
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### all_participant

```{r}
#| echo: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      + regime + detectabilite + gregaire + popularite + abondance_log + #migrateur_simplifie
#     sexe + anciennete +
#     expert + # participation_stoc + participation_shoc + participation_epoc + cocheur + bagueur +
#     tendances_stoc, # + tendance_shoc + tendances_stoc_simplifie,
#   data = dt1,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_all_participant <- polr(
   avis_niv1 ~ tendance_shoc_niv1 + 
     sexe + anciennete + expert + 
     tendance_shoc_niv1:sexe +
     tendance_shoc_niv1:anciennete +
     tendance_shoc_niv1:expert, 
    data = dt1,
  Hess = TRUE
)

modele_all_participant <- stepAIC(
  modele_all_participant,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_all_participant <- coef(summary(modele_all_participant))
p_values_all_participant <- pnorm(abs(ctable_all_participant[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_all_participant, "p value" = p_values_all_participant)

# plot -------------------------------------------------------------------------

ctable_all_participant <- as.data.frame(ctable_all_participant)

res_all_participant <- as.data.frame(ctable_all_participant) %>%
  mutate(
    variable = rownames(ctable_all_participant),
    p_value = p_values_all_participant,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_all_participant$`Std. Error`,
    upper = Value + 1.96 * ctable_all_participant$`Std. Error`
  )

res_plot_all_participant <- res_all_participant %>%
  filter(!grepl("\\|", variable))

res_plot_all_participant$variable <- factor(
  res_plot_all_participant$variable,
  levels = res_plot_all_participant$variable[order(res_plot_all_participant$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_all_participant <- res_plot_all_participant %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
unique(res_plot_all_participant$variable)
res_plot_all_participant$variable <- fct_recode(res_plot_all_participant$variable,
                                "Sexe (H)" = "sexeH",
                                "Anciennete" = "anciennete",
                                "Expert (Oui)" = "expert",
                                "STOC (Déclin modéré)" = "tendances_stocDéclin modéré",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L",
                                "SHOC - Linéaire : Sexe (H)" = "tendance_shoc_niv1.L:sexeH",
                                "SHOC - Linéaire : Ancienneté" = "tendance_shoc_niv1.L:anciennete",
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Quadratique : Sexe (H)" = "tendance_shoc_niv1.Q:sexeH",
                                "SHOC - Quadratique : Ancienneté" = "tendance_shoc_niv1.Q:anciennete")

# plot 
ggplot(res_plot_all_participant, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.015625, 0.03125, 0.0625, 0.125, 0.25, 0.5, 1, 2, 4, 8),
    labels = c("64X mois", "32X mois", "16X mois", "8X mois", "4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = ""
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### all_1

```{r}
#| echo: false

# modele_full <- polr(
#    avis_niv1 ~ tendance_shoc_niv1 +
#      + regime + detectabilite + gregaire + popularite + abondance_log + #migrateur_simplifie
#     sexe + anciennete +
#     expert + # participation_stoc + participation_shoc + participation_epoc + cocheur + bagueur +
#     tendances_stoc, # + tendance_shoc + tendances_stoc_simplifie,
#   data = dt1,
#   Hess = TRUE
# )

# model ------------------------------------------------------------------------

modele_all_1 <- polr(
   avis_niv1 ~ tendance_shoc_niv1 + 
     # migrateur + regime +
     detectabilite + gregaire + popularite + abondance_log + sexe + anciennete + expert + 
     # tendance_shoc_niv1:migrateur +
     # tendance_shoc_niv1:regime +
     tendance_shoc_niv1:detectabilite +
     tendance_shoc_niv1:gregaire +
     tendance_shoc_niv1:popularite +
     tendance_shoc_niv1:abondance_log +
     tendance_shoc_niv1:sexe +
     tendance_shoc_niv1:anciennete +
     # tendance_shoc_niv1:tendances_stoc +
     tendance_shoc_niv1:expert, 
    data = dt1,
  Hess = TRUE
)

modele_all_1 <- stepAIC(
  modele_all_1,
  direction = "both",
  trace = FALSE
)

# p-value ----------------------------------------------------------------------

ctable_all_1 <- coef(summary(modele_all_1))
p_values_all_1 <- pnorm(abs(ctable_all_1[, "t value"]), lower.tail = FALSE) * 2
cbind(ctable_all_1, "p value" = p_values_all_1)

# plot -------------------------------------------------------------------------

ctable_all_1 <- as.data.frame(ctable_all_1)

res_all_1 <- as.data.frame(ctable_all_1) %>%
  mutate(
    variable = rownames(ctable_all_1),
    p_value = p_values_all_1,
    signif = case_when(
      p_value < 0.001 ~ "***", 
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"
    ),
    lower = Value - 1.96 * ctable_all_1$`Std. Error`,
    upper = Value + 1.96 * ctable_all_1$`Std. Error`
  )

res_plot_all_1 <- res_all_1 %>%
  filter(!grepl("\\|", variable))

res_plot_all_1$variable <- factor(
  res_plot_all_1$variable,
  levels = res_plot_all_1$variable[order(res_plot_all_1$Value)]
)

# OR, échelle interprétable 
# Un odds ratio (OR) se lit comme :
# « multiplicateur des chances d’être classé dans une catégorie d’avis plus élevée plutôt qu’une catégorie plus basse »

res_plot_all_1 <- res_plot_all_1 %>%
  mutate(
    OR = exp(Value),
    OR_lower = exp(lower),
    OR_upper = exp(upper)
  )

# nom des variables :
unique(res_plot_all_1$variable)
res_plot_all_1$variable <- fct_recode(res_plot_all_1$variable,
                                "Detectabilite (Forte)" = "detectabiliteForte",
                                "Gregaire (Oui)" = "gregaireOui",
                                "Popularite (Oui)" = "populariteOui",
                                "Abondance" = "abondance_log",
                                "Sexe (H)" = "sexeH",
                                "Anciennete" = "anciennete",
                                "SHOC - Linéaire : Detectabilite (Forte)" = "tendance_shoc_niv1.L:detectabiliteForte",
                                "SHOC (Déclin) : Détectabilité (Forte)" = "tendance_shoc_niv1Déclin:detectabiliteForte",
                                "SHOC (Stable) : Détectabilité (Forte)" = "tendance_shoc_niv1Stable:detectabiliteForte ",
                                "SHOC (Augmentation) : Détectabilité (Forte)" = "tendance_shoc_niv1Augmentation:detectabiliteForte",
                                "SHOC (Déclin) : Grégaire (Oui)" = "tendance_shoc_niv1Déclin:gregaireOui",
                                "STOC (Déclin modéré)" = "tendances_stocDéclin modéré",
                                "SHOC (Stable) : Détectabilité (Forte)" = "tendance_shoc_niv1Stable:detectabiliteOui",
                                "SHOC (Stable) : Grégaire (Oui)" = "tendance_shoc_niv1Stable:gregaireOui",
                                "SHOC (Augmentation) : Grégaire (Oui)" = "tendance_shoc_niv1Augmentation:gregaireOui",
                                "SHOC - Linéaire" = "tendance_shoc_niv1.L",
                                "SHOC - Linéaire : Detectabilite (Forte)" = "tendance_shoc_niv1.L:detectabiliteForte",
                                "SHOC - Linéaire : Gregaire (Oui)" = "tendance_shoc_niv1.L:gregaireOui",
                                "SHOC - Linéaire : Abondance" = "tendance_shoc_niv1.L:abondance_log",
                                "SHOC - Linéaire : Popularité (Oui)" = "tendance_shoc_niv1.L:populariteOui",
                                "SHOC - Linéaire : Sexe (H)" = "tendance_shoc_niv1.L:sexeH",
                                "SHOC - Linéaire : Ancienneté" = "tendance_shoc_niv1.L:anciennete",
                                "SHOC - Quadratique" = "tendance_shoc_niv1.Q",
                                "SHOC - Quadratique : Detectabilite (Forte)" = "tendance_shoc_niv1.Q:detectabiliteForte",
                                "SHOC - Quadratique : Gregaire (Oui)" = "tendance_shoc_niv1.Q:gregaireOui",
                                "SHOC - Quadratique : Abondance" = "tendance_shoc_niv1.Q:abondance_log",
                                "SHOC - Quadratique : Popularité (Oui)" = "tendance_shoc_niv1.Q:populariteOui",
                                "SHOC - Quadratique : Sexe (H)" = "tendance_shoc_niv1.Q:sexeH",
                                "SHOC - Quadratique : Ancienneté" = "tendance_shoc_niv1.Q:anciennete")

# plot 
ggplot(res_plot_all_1, aes(x = OR, y = variable, fill = signif)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
  geom_errorbarh(
    aes(xmin = OR_lower, xmax = OR_upper),
    height = 0.2
  ) +
  geom_point(size = 3, shape = 21, color = "grey") +
  scale_fill_manual(
    values = c("***" = "#177B5D", "**" = "#66c2a5", "*" = "#7CEAC7", "ns" = "white")
  ) +
  scale_x_log10(
    breaks = c(0.015625, 0.03125, 0.0625, 0.125, 0.25, 0.5, 1, 2, 4, 8),
    labels = c("64X mois", "32X mois", "16X mois", "8X mois", "4× moins", "2× moins", "pas d'effet", "2× plus", "4× plus", "8× plus")
  ) +
  labs(
    x = "Chances d’être classé dans une catégorie d’avis plus élevée",
    y = "",
    color = "Significativité",
    title = ""
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

# matrice de corrélation

```{r}
#| eval: false
#| include: false

# toutes les variables__________________________________________________________

colnames(dataset)

library(vcd)
library(corrplot)
library(Hmisc)

# Fonction robuste pour calculer V de Cramer et p-value
cramers_v_pval <- function(x, y) {
  tbl <- table(x, y)
  if (nrow(tbl) < 2 || ncol(tbl) < 2) return(list(cv = NA, pval = NA))

  test <- tryCatch(
    {
      chisq.test(tbl)
    },
    error = function(e) NULL
  )

  if (is.null(test) || any(is.na(test$expected)) || any(test$expected < 5)) {
    return(list(cv = NA, pval = NA))
  }

  cv <- suppressWarnings(assocstats(tbl)$cramer)
  pval <- test$p.value
  return(list(cv = cv, pval = pval))
}

# Préparation des données
X_categ <- dataset[, c("email","espece","detectabilite","departement","participation_stoc","participation_shoc",
                       "participation_epoc","participation_odj","cocheur","bagueur","sexe","fluctuante",
                       "tendance_shoc_niv1","tendance_shoc_niv2","tendances_stoc")]
X_categ <- X_categ[, sapply(X_categ, function(x) is.factor(x) || is.character(x))]
X_categ <- lapply(X_categ, as.factor)
X_categ <- as.data.frame(X_categ)

# Calcul des matrices
vars <- colnames(X_categ)
n <- length(vars)
v_matrix <- matrix(NA, nrow = n, ncol = n, dimnames = list(vars, vars))
p_matrix <- matrix(NA, nrow = n, ncol = n, dimnames = list(vars, vars))

for (i in 1:n) {
  for (j in i:n) {
    res <- cramers_v_pval(X_categ[[i]], X_categ[[j]])
    v_matrix[i, j] <- res$cv^2
    v_matrix[j, i] <- res$cv^2
    p_matrix[i, j] <- res$pval
    p_matrix[j, i] <- res$pval
  }
}

# Affichage
corrplot(v_matrix,
         method = "color",
         type = "upper",
         tl.cex = 0.8,
         tl.col = "black",
         p.mat = p_matrix,
         insig = "label_sig",
         sig.level = c(0.001, 0.01, 0.05),
         pch.cex = 0.7,
         pch.col = "black",
         addCoef.col = "transparent",
         na.label = " ")

# subset des variables__________________________________________________________

# colnames(dataset)
# 
# # Fonction robuste pour calculer V de Cramer et p-value
# cramers_v_pval <- function(x, y) {
#   tbl <- table(x, y)
#   if (nrow(tbl) < 2 || ncol(tbl) < 2) return(list(cv = NA, pval = NA))
# 
#   test <- tryCatch(
#     {
#       chisq.test(tbl)
#     },
#     error = function(e) NULL
#   )
# 
#   if (is.null(test) || any(is.na(test$expected)) || any(test$expected < 5)) {
#     return(list(cv = NA, pval = NA))
#   }
# 
#   cv <- suppressWarnings(assocstats(tbl)$cramer)
#   pval <- test$p.value
#   return(list(cv = cv, pval = pval))
# }
# 
# cramers_v_pval <- function(x, y) {
#   tbl <- table(x, y)
#   if (nrow(tbl) < 2 || ncol(tbl) < 2) return(list(cv = NA, pval = NA))
# 
#   # Test du chi² avec simulation si effectifs < 5
#   if (any(table(x, y) < 5, na.rm = TRUE)) {
#     test <- chisq.test(tbl, simulate.p.value = TRUE, B = 10000)
#   } else {
#     test <- chisq.test(tbl)
#   }
# 
#   cv <- suppressWarnings(assocstats(tbl)$cramer)
#   pval <- test$p.value
#   return(list(cv = cv, pval = pval))
# }
# 
# # Préparation des données
# X_categ <- dataset[, c("email","espece","detectabilite","departement","participation_stoc","participation_shoc",
#                        "participation_epoc","participation_odj","cocheur","bagueur")]
# X_categ <- X_categ[, sapply(X_categ, function(x) is.factor(x) || is.character(x))]
# X_categ <- lapply(X_categ, as.factor)
# X_categ <- as.data.frame(X_categ)
# 
# # Calcul des matrices
# vars <- colnames(X_categ)
# n <- length(vars)
# v_matrix <- matrix(NA, nrow = n, ncol = n, dimnames = list(vars, vars))
# p_matrix <- matrix(NA, nrow = n, ncol = n, dimnames = list(vars, vars))
# 
# for (i in 1:n) {
#   for (j in i:n) {
#     res <- cramers_v_pval(X_categ[[i]], X_categ[[j]])
#     v_matrix[i, j] <- res$cv^2
#     v_matrix[j, i] <- res$cv^2
#     p_matrix[i, j] <- res$pval
#     p_matrix[j, i] <- res$pval
#   }
# }
# 
# # Affichage
# corrplot(v_matrix,
#          method = "color",
#          type = "upper",
#          tl.cex = 0.8,
#          tl.col = "black",
#          p.mat = p_matrix,
#          insig = "label_sig",
#          sig.level = c(0.001, 0.01, 0.05),
#          pch.cex = 0.7,
#          pch.col = "black",
#          addCoef.col = "transparent",
#          na.label = " ")

```

# niveau 1

```{r}
#| eval: false
#| include: false

# 1. Préparation________________________________________________________________

colnames(dataset)

# On force toutes les colonnes en facteur (sauf email déjà en facteur aléatoire)
vars <- c("detectabilite","participation_stoc","participation_shoc",
                       "participation_epoc","participation_odj","cocheur","bagueur","sexe","fluctuante",
                       "tendance_shoc_niv1","tendance_shoc_niv2","tendances_stoc","anciennete")

dataset[vars] <- lapply(dataset[vars], as.factor)

# cible binaire
dataset$comparaison_niv1 <- as.factor(dataset$comparaison_niv1)

# 2. Formule automatique avec toutes les interactions 2×2_______________________

# variables explicatives
X <- paste(vars, collapse = " + ")

# # interactions 2 à 2
# form <- as.formula(
#   paste("comparaison_niv1 ~ (", X, ")^2 + (1|email) + (1|departement)")
# )

# sans interaction
form <- as.formula(
  paste("comparaison_niv1 ~", X, "+ (1|espece)")
)

form

# 3. Modèle global GLMM binomial________________________________________________

dataset$anciennete <- as.numeric(as.character(dataset$anciennete))

dt_model <- dataset %>% 
  na.omit("detectabilite","participation_stoc","participation_shoc",
                       "participation_epoc","participation_odj","cocheur","bagueur","sexe","fluctuante",
                       "tendance_shoc_niv1","tendance_shoc_niv2","tendances_stoc","anciennete")

options(na.action = "na.fail")  # obligatoire pour dredge

m_full <- glmer(
  form,
  data = dt_model,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa")
)

# 4. Dredge automatique AIC_____________________________________________________

dd <- dredge(m_full, rank = "AIC")
dd

# 5. Modèle sélectionné (AIC min)_______________________________________________
best <- get.models(dd, 1)[[1]]
summary(best)

```

# niveau 2

```{r}
#| eval: false
#| include: false

# 1. Préparation________________________________________________________________

colnames(dataset)

# On force toutes les colonnes en facteur (sauf email déjà en facteur aléatoire)
vars <- c("detectabilite","participation_stoc",
          "participation_shoc","bagueur")

dataset[vars] <- lapply(dataset[vars], as.factor)

# cible binaire
dataset$comparaison_niv2 <- as.factor(dataset$comparaison_niv2)

# 2. Formule automatique avec toutes les interactions 2×2_______________________

# variables explicatives
X <- paste(vars, collapse = " + ")

# # interactions 2 à 2
# form <- as.formula(
#   paste("comparaison_niv2 ~ (", X, ")^2 + (1|email) + (1|departement)")
# )

# sans interaction
form <- as.formula(
  paste("comparaison_niv2 ~", X, "+ (1|espece)")
)

form

# 3. Modèle global GLMM binomial________________________________________________

dt_model <- dataset %>% 
  na.omit("detectabilite","participation_stoc",
          "participation_shoc","bagueur")

options(na.action = "na.fail")  # obligatoire pour dredge

m_full <- glmer(
  form,
  data = dt_model,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa")
)

# 4. Dredge automatique AIC_____________________________________________________

dd <- dredge(m_full, rank = "AIC")
dd

# 5. Modèle sélectionné (AIC min)_______________________________________________
best <- get.models(dd, 1)[[1]]
summary(best)

```

```{r}
#| eval: false
#| include: false
colnames(dataset)
m0 <- glmer(comparaison_niv1 ~ 1 + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m1 <- glmer(comparaison_niv1 ~ participation_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m2 <- glmer(comparaison_niv1 ~ participation_shoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m3 <- glmer(comparaison_niv1 ~ participation_epoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m4 <- glmer(comparaison_niv1 ~ sexe + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m5 <- glmer(comparaison_niv1 ~ cocheur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m6 <- glmer(comparaison_niv1 ~ anciennete + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m7 <- glmer(comparaison_niv1 ~ bagueur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m8 <- glmer(comparaison_niv1 ~ expert + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m9 <- glmer(comparaison_niv1 ~ tendances_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m10 <- glmer(comparaison_niv1 ~ detectabilite + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m11 <- glmer(comparaison_niv1 ~ gregaire + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m12 <- glmer(comparaison_niv1 ~ fluctuante + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m13 <- glmer(comparaison_niv1 ~ migrateur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m14 <- glmer(comparaison_niv1 ~ abondance + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
m15 <- glmer(comparaison_niv1 ~ regime + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, control = glmerControl(optimizer = "bobyqa"))
compare_performance(m0,m1,m2,m3,m4,m5,m6,m7,m8,m9,m10,m11,m12,m13,m14,m15)
summary(m4)

m4.1 <- glmer(comparaison_niv1 ~ sexe + participation_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.2 <- glmer(comparaison_niv1 ~ sexe + participation_shoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.3 <- glmer(comparaison_niv1 ~ sexe + participation_epoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.4 <- glmer(comparaison_niv1 ~ sexe + cocheur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.5 <- glmer(comparaison_niv1 ~ sexe + anciennete + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.6 <- glmer(comparaison_niv1 ~ sexe + bagueur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.7 <- glmer(comparaison_niv1 ~ sexe + expert + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.8 <- glmer(comparaison_niv1 ~ sexe + tendances_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.9 <- glmer(comparaison_niv1 ~ sexe + detectabilite + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.10 <- glmer(comparaison_niv1 ~ sexe + gregaire + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.11 <- glmer(comparaison_niv1 ~ sexe + fluctuante + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.12 <- glmer(comparaison_niv1 ~ sexe + migrateur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.13 <- glmer(comparaison_niv1 ~ sexe + abondance + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14 <- glmer(comparaison_niv1 ~ sexe + regime + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
compare_performance(m4.1,m4.2,m4.3,m4.4,m4.5,m4.6,m4.7,m4.8,m4.9,m4.10,m4.11,m4.12,m4.13,m4.14)
summary(m4.14)

m4.14.1 <- glmer(comparaison_niv1 ~ sexe + regime + participation_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.2 <- glmer(comparaison_niv1 ~ sexe + regime + participation_shoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.3 <- glmer(comparaison_niv1 ~ sexe + regime + participation_epoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.4 <- glmer(comparaison_niv1 ~ sexe + regime + cocheur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.6 <- glmer(comparaison_niv1 ~ sexe + regime + bagueur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.7 <- glmer(comparaison_niv1 ~ sexe + regime + expert + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.8 <- glmer(comparaison_niv1 ~ sexe + regime + tendances_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.9 <- glmer(comparaison_niv1 ~ sexe + regime + detectabilite + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.10 <- glmer(comparaison_niv1 ~ sexe + regime + gregaire + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.11 <- glmer(comparaison_niv1 ~ sexe + regime + fluctuante + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.12 <- glmer(comparaison_niv1 ~ sexe + regime + migrateur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.13 <- glmer(comparaison_niv1 ~ sexe + regime + abondance + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
compare_performance(m4.14.1,m4.14.2,m4.14.3,m4.14.4,m4.14.5,m4.14.6,m4.14.7,m4.14.8,m4.14.9,m4.14.10,m4.14.11,m4.14.11,m4.14.13)
summary(m4.14.5)

m4.14.5.1 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.2 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + participation_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.3 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + participation_shoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.4 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + participation_epoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.5 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + cocheur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.6 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + bagueur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.7 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + expert + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.8 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + tendances_stoc + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.9 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + detectabilite + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.10 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + gregaire + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.11 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + fluctuante + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.12 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + migrateur + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
m4.14.5.13 <- glmer(comparaison_niv1 ~ sexe + regime + anciennete + abondance + (1 | espece) + (1 | email) + (1 | bioregion), data = dataset, family = binomial, 
              control = glmerControl(optimizer = "bobyqa"))
compare_performance(m4.14.5,m4.14.5.1,m4.14.5.2,m4.14.5.3,m4.14.5.4,m4.14.5.5,m4.14.5.6,m4.14.5.7,m4.14.5.8,m4.14.5.9,
                    m4.14.5.10,m4.14.5.11,m4.14.5.12,m4.14.5.13)
summary(m4.14.5)

```
